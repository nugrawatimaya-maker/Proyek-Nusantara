<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Rekonsiliasi Bank</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f0f9ff; }
    .chk-rekon { transform: scale(1.3); cursor: pointer; }
  </style>
</head>
<body class="p-6 text-gray-800">

  <div class="max-w-6xl mx-auto mb-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-sky-800"><i class="fas fa-balance-scale mr-2"></i>Rekonsiliasi Bank</h1>
      <p class="text-sm text-gray-500">Cocokkan data Sistem dengan Rekening Koran</p>
    </div>
    <a href="dashboard_operasional.html" class="bg-gray-600 text-white px-4 py-2 rounded shadow font-bold hover:bg-gray-700 text-sm">
      <i class="fas fa-arrow-left"></i> Dashboard
    </a>
  </div>

  <div class="max-w-6xl mx-auto bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-sky-600 flex flex-wrap gap-4 items-end">
      
      <div class="w-full md:w-1/4">
          <label class="block text-xs font-bold text-gray-600 mb-1">Pilih Akun Bank</label>
          <select id="pilihBank" class="w-full border p-2 rounded" onchange="loadTransaksi()">
              <option value="">-- Pilih Bank --</option>
              </select>
      </div>

      <div class="w-full md:w-1/4">
          <label class="block text-xs font-bold text-gray-600 mb-1">Saldo Akhir di Rekening Koran</label>
          <input type="number" id="saldoBank" class="w-full border p-2 rounded font-bold text-right" placeholder="0" onkeyup="hitungSelisih()">
      </div>

      <div class="w-full md:w-1/3 text-right ml-auto">
          <p class="text-xs text-gray-500 font-bold uppercase">Selisih (Unreconciled)</p>
          <h2 class="text-3xl font-bold text-red-600" id="displaySelisih">Rp 0</h2>
          <p class="text-[10px] text-gray-400">Target selisih harus Rp 0</p>
      </div>
  </div>

  <div class="max-w-6xl mx-auto bg-white rounded-lg shadow overflow-hidden">
    <div class="p-3 bg-sky-100 border-b border-sky-200 flex justify-between items-center">
        <h3 class="font-bold text-sky-800">Transaksi Belum Klop (Outstanding)</h3>
        <button onclick="simpanRekon()" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-1 rounded text-sm font-bold shadow">
            <i class="fas fa-check-double mr-1"></i> Simpan Hasil Rekon
        </button>
    </div>

    <table class="w-full text-left text-sm">
        <thead class="bg-sky-50 text-sky-900 font-bold uppercase">
            <tr>
                <th class="p-3 text-center w-12">Match</th>
                <th class="p-3">Tanggal</th>
                <th class="p-3">Keterangan</th>
                <th class="p-3 text-right text-green-700">Masuk (Debit)</th>
                <th class="p-3 text-right text-red-700">Keluar (Kredit)</th>
            </tr>
        </thead>
        <tbody id="bodyRekon" class="divide-y divide-gray-100">
            <tr><td colspan="5" class="p-6 text-center text-gray-400">Pilih bank dulu...</td></tr>
        </tbody>
        <tfoot class="bg-gray-50 font-bold text-gray-700">
            <tr>
                <td colspan="3" class="p-3 text-right">Total Tercatat di Sistem:</td>
                <td class="p-3 text-right text-green-700" id="totalMasuk">0</td>
                <td class="p-3 text-right text-red-700" id="totalKeluar">0</td>
            </tr>
            <tr>
                <td colspan="3" class="p-3 text-right">Saldo Buku (Sistem):</td>
                <td colspan="2" class="p-3 text-right text-xl text-blue-800" id="saldoBuku">Rp 0</td>
            </tr>
        </tfoot>
    </table>
  </div>

  <script>
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    const fmt = (n) => new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR'}).format(n);

    let listTrans = [];
    let saldoSistem = 0;

    // INIT
    async function init() {
        const { data } = await client.from('master_akun').select('nama_akun').order('nama_akun');
        const sel = document.getElementById("pilihBank");
        if(data) {
            data.forEach(a => {
                if(a.nama_akun.toLowerCase().includes('bank')) {
                    sel.innerHTML += `<option value="${a.nama_akun}">${a.nama_akun}</option>`;
                }
            });
        }
    }

    // LOAD TRANSAKSI
    async function loadTransaksi() {
        const bank = document.getElementById("pilihBank").value;
        if(!bank) return;

        // Ambil transaksi yg bank_sumber (keluar) atau akun (masuk) sesuai bank
        // Dan Status Rekon FALSE (Belum dicocokkan)
        const { data, error } = await client
            .from('transaksi')
            .select('*')
            .eq('is_reconciled', false) // Hanya yg belum rekon
            .or(`bank_sumber.eq.${bank},akun.eq.${bank}`) // Filter Bank
            .order('tanggal', { ascending: true });

        const tbody = document.getElementById("bodyRekon");
        tbody.innerHTML = "";
        listTrans = data || [];
        
        let totM = 0, totK = 0;
        saldoSistem = 0; // Seharusnya ambil saldo awal, tp kita simulasi dr mutasi

        if(listTrans.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-gray-400">Semua transaksi sudah rekon (klop)!</td></tr>`;
        }

        listTrans.forEach((t, idx) => {
            // Tentukan Masuk/Keluar relatif thd Bank
            let isMasuk = false;
            // Jika jenis MASUK dan akun tujuannya adalah Bank ini
            // ATAU jika jenis KELUAR tapi akun tujuannya Bank ini (transfer antar bank) - kasus jarang
            // Sederhananya: 
            if(t.jenis_transaksi === 'MASUK' && t.akun === bank) isMasuk = true; // Salah logika di sistem lama mgkn?
            // Perbaikan Logika Umum:
            // Kas Masuk: Akun = Sumber, Bank_Sumber = Tujuan? Tidak, struktur kas masuk biasanya: Akun=Pendapatan, Bank=Tujuan
            // Kas Keluar: Akun = Biaya, Bank_Sumber = Asal
            
            // Asumsi struktur data:
            // KELUAR -> bank_sumber = BANK INI
            // MASUK ->  bank_sumber (atau kolom target) = BANK INI. 
            // Mari kita cek struktur kas_masuk user (biasanya kolom 'bank_sumber' di kas masuk itu tujuan).
            
            // Simplifikasi Display:
            let displayMasuk = 0;
            let displayKeluar = 0;

            if (t.jenis_transaksi === 'MASUK') { 
                displayMasuk = t.jumlah; 
                totM += t.jumlah;
                saldoSistem += t.jumlah;
            } else { 
                displayKeluar = t.jumlah;
                totK += t.jumlah;
                saldoSistem -= t.jumlah;
            }

            tbody.innerHTML += `
                <tr class="hover:bg-sky-50 border-b">
                    <td class="p-3 text-center">
                        <input type="checkbox" class="chk-rekon" value="${t.id}" onchange="hitungSelisih()">
                    </td>
                    <td class="p-3 text-gray-600">${new Date(t.tanggal).toLocaleDateString('id-ID')}</td>
                    <td class="p-3 font-bold text-gray-700">${t.keterangan}</td>
                    <td class="p-3 text-right text-green-700 font-mono">${displayMasuk ? fmt(displayMasuk) : '-'}</td>
                    <td class="p-3 text-right text-red-700 font-mono">${displayKeluar ? fmt(displayKeluar) : '-'}</td>
                </tr>
            `;
        });

        document.getElementById("totalMasuk").innerText = fmt(totM);
        document.getElementById("totalKeluar").innerText = fmt(totK);
        
        // Saldo Buku dihitung simple dari mutasi outstanding (Asumsi saldo awal 0 untuk demo)
        // Di real app, saldo buku diambil dari Master Akun -> Saldo Saat Ini
        // Kita hitung selisih
        hitungSelisih();
    }

    function hitungSelisih() {
        // Logika Rekon:
        // Saldo Bank (Input User) - Saldo Buku (Sistem) + Cek Beredar (Yg blm dicentang)
        // Cara paling mudah:
        // User centang yg ADA di koran. 
        // Yg TIDAK dicentang adalah selisih (Outstanding).
        
        const saldoBankInput = Number(document.getElementById("saldoBank").value);
        
        // Hitung total item yang BELUM dicentang (Unreconciled Items)
        let outstandingBalance = 0;
        const checkboxes = document.querySelectorAll('.chk-rekon');
        
        checkboxes.forEach((chk, idx) => {
            if(!chk.checked) {
                // Item ini ada di sistem, tapi tidak ada di bank (Outstanding)
                // Jika Keluar (Cek Beredar) -> Menambah kembali saldo bank
                // Jika Masuk (Deposit in Transit) -> Mengurangi saldo bank
                
                // Ambil data dr array
                const t = listTrans.find(x => x.id == chk.value);
                if(t.jenis_transaksi === 'KELUAR') outstandingBalance += t.jumlah; // Uang blm keluar
                else outstandingBalance -= t.jumlah; // Uang blm masuk
            }
        });

        // Rumus Selisih Sederhana:
        // Jika semua dicentang, Saldo Bank harusnya match dengan Saldo Transaksi yg dicentang.
        // Disini kita hanya menampilkan total outstanding sebagai 'Selisih'
        
        document.getElementById("displaySelisih").innerText = fmt(outstandingBalance);
        
        const label = document.getElementById("displaySelisih");
        if(outstandingBalance === 0) {
            label.className = "text-3xl font-bold text-green-600";
            label.innerHTML += " <i class='fas fa-check-circle'></i> KLOP";
        } else {
            label.className = "text-3xl font-bold text-red-600";
        }
    }

    async function simpanRekon() {
        const checked = document.querySelectorAll('.chk-rekon:checked');
        if(checked.length === 0) return alert("Pilih transaksi yang sesuai rekening koran!");
        
        if(!confirm(`Yakin rekonsiliasi ${checked.length} transaksi ini? Data akan hilang dari list ini.`)) return;

        const ids = Array.from(checked).map(c => c.value);
        const tgl = new Date().toISOString().split('T')[0];

        const { error } = await client
            .from('transaksi')
            .update({ is_reconciled: true, tgl_rekon: tgl })
            .in('id', ids);

        if(error) alert("Gagal: " + error.message);
        else {
            alert("Rekonsiliasi Berhasil!");
            loadTransaksi();
        }
    }

    init();
  </script>
</body>
</html>