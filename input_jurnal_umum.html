<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Input Jurnal Umum / Saldo Awal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>body { font-family: "Segoe UI", sans-serif; background: #f8fafc; }</style>
</head>
<body class="p-6 text-gray-800">

  <div class="max-w-5xl mx-auto mb-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-slate-800">Input Jurnal Umum</h1>
      <p class="text-sm text-gray-500">Gunakan untuk Input Saldo Awal & Koreksi Pembukuan</p>
    </div>
    <a href="dashboard_operasional.html" class="bg-gray-600 text-white px-4 py-2 rounded shadow font-bold text-sm hover:bg-gray-700">
      <i class="fas fa-arrow-left"></i> Dashboard
    </a>
  </div>

  <div class="max-w-5xl mx-auto bg-white p-6 rounded-lg shadow-lg border-t-4 border-blue-600">
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">Tanggal Pembukuan</label>
              <input type="date" id="tglJurnal" class="w-full border p-2 rounded bg-slate-50 font-bold">
          </div>
          <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">Keterangan / Memo</label>
              <input type="text" id="keterangan" class="w-full border p-2 rounded bg-slate-50" placeholder="Contoh: Saldo Awal Pembukuan 2024">
          </div>
      </div>

      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
          <table class="w-full text-left text-sm">
              <thead class="text-gray-500 uppercase font-bold border-b">
                  <tr>
                      <th class="p-2 w-10">#</th>
                      <th class="p-2">Nama Akun</th>
                      <th class="p-2 w-40 text-right">Debit (Rp)</th>
                      <th class="p-2 w-40 text-right">Kredit (Rp)</th>
                      <th class="p-2 w-10 text-center">Hapus</th>
                  </tr>
              </thead>
              <tbody id="bodyJurnal">
                  </tbody>
              <tfoot class="font-bold bg-slate-200 text-slate-700">
                  <tr>
                      <td colspan="2" class="p-3 text-right">TOTAL:</td>
                      <td class="p-3 text-right" id="totalDebit">0</td>
                      <td class="p-3 text-right" id="totalKredit">0</td>
                      <td></td>
                  </tr>
              </tfoot>
          </table>

          <button onclick="tambahBaris()" class="mt-4 bg-blue-100 text-blue-700 px-4 py-2 rounded font-bold hover:bg-blue-200 text-sm flex items-center gap-2">
              <i class="fas fa-plus-circle"></i> Tambah Baris Akun
          </button>
      </div>

      <div class="flex justify-between items-center">
          <div id="statusBalance" class="text-sm font-bold text-red-600 bg-red-100 px-4 py-2 rounded-full">
              ⚠️ BELUM BALANCE (Selisih: Rp 0)
          </div>
          <button onclick="simpanJurnal()" id="btnSimpan" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded shadow font-bold disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-save mr-2"></i> POSTING JURNAL
          </button>
      </div>

  </div>

  <script>
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    const fmt = (n) => new Intl.NumberFormat('id-ID').format(n);

    let akunList = [];
    document.getElementById("tglJurnal").valueAsDate = new Date();

    // 1. LOAD MASTER AKUN
    async function loadAkun() {
        const { data } = await client.from('master_akun').select('nama_akun').order('nama_akun');
        if(data) akunList = data;
        tambahBaris(); // Baris 1
        tambahBaris(); // Baris 2 (Minimal 2 baris untuk jurnal)
    }

    // 2. TAMBAH BARIS
    function tambahBaris() {
        const tbody = document.getElementById("bodyJurnal");
        const idx = tbody.children.length;
        
        // Buat Dropdown Akun
        let options = `<option value="">-- Pilih Akun --</option>`;
        akunList.forEach(a => options += `<option value="${a.nama_akun}">${a.nama_akun}</option>`);

        const row = `
            <tr class="border-b bg-white">
                <td class="p-2 text-center text-gray-400">${idx + 1}</td>
                <td class="p-2">
                    <select class="input-akun w-full border p-2 rounded focus:ring-2 focus:ring-blue-400">${options}</select>
                </td>
                <td class="p-2">
                    <input type="number" class="input-debit w-full border p-2 rounded text-right focus:ring-2 focus:ring-blue-400" placeholder="0" onkeyup="hitungTotal()" value="0">
                </td>
                <td class="p-2">
                    <input type="number" class="input-kredit w-full border p-2 rounded text-right focus:ring-2 focus:ring-blue-400" placeholder="0" onkeyup="hitungTotal()" value="0">
                </td>
                <td class="p-2 text-center">
                    <button onclick="hapusBaris(this)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    }

    function hapusBaris(btn) {
        btn.closest('tr').remove();
        hitungTotal();
    }

    // 3. HITUNG TOTAL & VALIDASI BALANCE
    function hitungTotal() {
        let deb = 0, kre = 0;
        document.querySelectorAll('.input-debit').forEach(i => deb += Number(i.value));
        document.querySelectorAll('.input-kredit').forEach(i => kre += Number(i.value));

        document.getElementById("totalDebit").innerText = fmt(deb);
        document.getElementById("totalKredit").innerText = fmt(kre);

        const selisih = deb - kre;
        const status = document.getElementById("statusBalance");
        const btn = document.getElementById("btnSimpan");

        if (selisih === 0 && deb > 0) {
            status.className = "text-sm font-bold text-green-700 bg-green-100 px-4 py-2 rounded-full";
            status.innerHTML = `<i class="fas fa-check-circle"></i> BALANCE (Seimbang)`;
            btn.disabled = false;
        } else {
            status.className = "text-sm font-bold text-red-600 bg-red-100 px-4 py-2 rounded-full";
            status.innerHTML = `<i class="fas fa-exclamation-triangle"></i> TIDAK BALANCE (Selisih: ${fmt(selisih)})`;
            btn.disabled = true;
        }
    }

    // 4. SIMPAN KE DATABASE
    async function simpanJurnal() {
        const tgl = document.getElementById("tglJurnal").value;
        const ket = document.getElementById("keterangan").value;
        if(!tgl || !ket) return alert("Lengkapi Tanggal & Keterangan!");
        if(!confirm("Simpan Jurnal ini? Pastikan data sudah benar.")) return;

        const rows = document.querySelectorAll('#bodyJurnal tr');
        let payload = [];
        const refNo = "JV-" + Date.now(); // Journal Voucher ID

        rows.forEach(row => {
            const akun = row.querySelector('.input-akun').value;
            const deb = Number(row.querySelector('.input-debit').value);
            const kre = Number(row.querySelector('.input-kredit').value);

            if(akun && (deb > 0 || kre > 0)) {
                payload.push({
                    tanggal: tgl,
                    nomor_referensi: refNo,
                    keterangan: ket,
                    nama_akun: akun,
                    debit: deb,
                    kredit: kre
                });
            }
        });

        const { error } = await client.from('jurnal_umum').insert(payload);

        if(error) alert("Gagal: " + error.message);
        else {
            alert("✅ Jurnal Berhasil Disimpan!");
            location.reload();
        }
    }

    loadAkun();
  </script>
</body>
</html>