<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Siteplan - PT. Nusantara Land Development</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Peta Wrapper */
    #mapWrap { height: 70vh; cursor: grab; background-color: #f8fafc; }
    #mapWrap:active { cursor: grabbing; }
    
    /* SVG Styling */
    #siteplanSvg { width: 100%; height: 100%; display: block; touch-action: none; }
    
    /* Unit Styling */
    [data-unit-id] { transition: fill 0.3s ease, opacity 0.3s ease, stroke 0.2s; vector-effect: non-scaling-stroke; }
    [data-unit-id]:hover { stroke: #5; stroke-width: 5px; filter: brightness(0.9); }
    
    /* UI Components */
    .chip { display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .5rem; border-radius:9999px; border:1px solid rgb(226 232 240); font-size:.75rem; }
    .dot { width:.6rem; height:.6rem; border-radius:9999px; }
    .hidden-group { display: none; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">
  <main class="max-w-[1400px] mx-auto px-4 py-6">
    <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      
      <header class="flex items-center justify-between px-6 py-4 bg-slate-900 text-white">
        <div>
          <h1 class="text-lg font-bold">Sistem Manajemen Siteplan</h1>
          <p class="text-xs text-slate-300 mt-1">Update status real-time terhubung ke Database</p>
        </div>
        <a href="dashboard_marketing.html" class="flex items-center gap-2 text-sm font-semibold tracking-wide bg-slate-800/60 hover:bg-slate-800 px-3 py-2 rounded-full border border-white/20 transition">
          <i class="fas fa-arrow-left"></i> Kembali ke Marketing
        </a>
      </header>

      <section class="p-4 sm:p-6 bg-slate-50 border-t border-slate-200">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          
          <div class="lg:col-span-8 flex flex-col gap-4">
            
            <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm flex flex-col sm:flex-row justify-between items-center gap-4">
               <div>
                  <h2 class="text-xl font-extrabold text-slate-800 tracking-tight">PT. NUSANTARA LAND DEVELOPMENT</h2>
                  <p class="text-xs text-slate-500 font-medium">Siteplan Interactive View</p>
               </div>
               
               <div class="relative w-full sm:w-64">
                  <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-500">
                    <i class="fa-solid fa-filter text-xs"></i>
                  </div>
                  <select id="filterOverlay" class="w-full pl-9 pr-8 py-2 bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block">
                    <option value="all">üëÅÔ∏è Tampilkan Semua</option>
                    <optgroup label="Filter Warna (Overlay)">
                        <option value="ready-stock">‚ö™ Ready Stock</option>
                        <option value="booking">üü° Booking</option>
                        <option value="sold-out">üî¥ Sold Out</option>
                        <option value="proses-berkas">üü† Proses Berkas</option>
                        <option value="proses-bank">üîµ Proses Bank</option>
                        <option value="akad">üü£ Akad Kredit</option>
                        <option value="pembangunan">üü¢ Pembangunan</option>
                        <option value="serah-terima">üí† Serah Terima</option>
                        <option value="cancel">üîò Cancel</option>
                    </optgroup>
                  </select>
               </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl shadow-inner overflow-hidden relative">
              
              <div class="absolute top-4 left-4 z-10 flex flex-col gap-2">
                <button id="btnFit" class="bg-white p-2 rounded-lg shadow border border-slate-200 hover:bg-slate-50 text-slate-600" title="Fit to Screen">
                  <i class="fa-solid fa-compress"></i>
                </button>
                <button id="btnResetView" class="bg-white p-2 rounded-lg shadow border border-slate-200 hover:bg-slate-50 text-slate-600" title="Reset Zoom">
                   <i class="fa-solid fa-rotate-left"></i>
                </button>
              </div>

              <div id="mapWrap">
                  <div id="mapTooltip" class="hidden fixed z-50 pointer-events-none bg-slate-900/90 text-white text-xs px-3 py-2 rounded-lg shadow-xl backdrop-blur-sm border border-slate-700 transform -translate-x-1/2 -translate-y-full mt-[-10px]">
                    <div class="font-bold text-sm mb-1" id="tipTitle">Blok</div>
                    <div class="flex items-center gap-2">
                        <span id="tipDot" class="w-2 h-2 rounded-full bg-white"></span>
                        <span id="tipSub" class="text-slate-200 capitalize"></span>
                    </div>
                  </div>

                  <svg id="siteplanSvg" preserveAspectRatio="xMidYMid meet" xml:space="preserve" viewBox="0 0 29700 21000">
                    <defs>
                      <style type="text/css">
                        .str0 {stroke:#363333;stroke-width:35.28;stroke-miterlimit:22.9256}
                        .str1 {stroke:#373435;stroke-width:35.64;stroke-miterlimit:22.9256}
                        .fil2 {fill:none}
                        .fil1 {fill:#FEFEFE} 
                        .fil3 {fill:#FFF212}
                        .fil4 {fill:#A8CF45}
                        .fil5 {fill:#6B809B}
                        .fil6 {fill:#5CA47A}
                        .fil0 {fill:#5CA47A}
                      </style>
                    </defs>
                    <g id="Layer_x0020_1">
                      <path class="fil0" d="M26585.05 2731.37c-20.8,114.84 -388.6,1032.8 -388.6,1032.8l-312.27 555.04 -1246.48 106.83 -1273.83 323.56 -1612.15 38.65 -2195.44 647.55 -1378.17 -72.79 -2044.86 -254.49 -3327.15 -0.92 -1342.51 -58.24 -1405.95 -402.29 -640.18 127.2 -1280.92 254.55 -881.65 879.47 -1544.84 377.41 -1381.55 -218.46 -611.95 1882.29c0,0 -1084.7,375.83 -1057.1,350.92 27.59,-24.91 -1341.16,-15.2 -1341.16,-15.2l-515.09 243.21 404.77 1328.12 636.27 366.56 989.79 -689.68 581.54 800 1611.29 665.8 2545.49 1114.01 405.64 623.67 2004.33 517.27 2532.03 1046.26 1855.37 476.45 1137.89 55.6 2567.69 22.79 522.29 2628.36 2310.65 1135.17 1140.51 -490.04 1706.4 -1132.09 431.17 -4853.17 0 0 1683.27 379.49 412.07 338.79 825.7 1505.35 873.31 -3163.83 -1222.2 -6232.46 1009.74 -1448.62 -1183.16 -790.89z" />
                      
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22314.1 9426.76)" width="4445" height="8890" data-unit-id="C1" data-status="ready-stok" data-progress="0" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21033.7 9681.19)" width="4445" height="8890" data-unit-id="C9" data-progress="20" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21161 10321.4)" width="4445" height="8890" data-unit-id="C10" data-progress="40" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21288.2 10961.6)" width="4445" height="8890" data-unit-id="C11" data-progress="60" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21415.4 11601.7)" width="4445" height="8890" data-unit-id="C12" data-progress="80" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21542.6 12241.9)" width="4445" height="8890" data-unit-id="C13" data-progress="100" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21669.8 12882.1)" width="4445" height="8890" data-unit-id="C14" data-progress="19" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21797 13522.3)" width="4445" height="8890" data-unit-id="C15" data-progress="39" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21924.2 14162.4)" width="4445" height="8890" data-unit-id="C16" data-progress="59" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22051.5 14802.6)" width="4445" height="8890" data-unit-id="C17" data-progress="79" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22178.7 15442.8)" width="4445" height="8890" data-unit-id="C18" data-progress="99" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22305.9 16083)" width="4445" height="8890" data-unit-id="C19" data-progress="18" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22433.1 16723.2)" width="4445" height="8890" data-unit-id="C20" data-progress="38" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22441.3 10066.9)" width="4445" height="8890" data-unit-id="C2" data-progress="58" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22568.5 10707.1)" width="4445" height="8890" data-unit-id="C3" data-progress="78" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22695.7 11347.3)" width="4445" height="8890" data-unit-id="C4" data-progress="98" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22823 11987.5)" width="4445" height="8890" data-unit-id="C5" data-progress="17" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25213.3 7296.06)" width="4445" height="8890" data-unit-id="A4" data-progress="37" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 23933 7550.49)" width="4445" height="8890" data-unit-id="A7" data-progress="57" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 23805.8 6910.31)" width="4445" height="8890" data-unit-id="A6" data-progress="77" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 23678.6 6270.13)" width="4445" height="8890" data-unit-id="A5" data-progress="97" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25086.1 6655.88)" width="4445" height="8890" data-unit-id="A3" data-progress="16" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24958.9 6015.7)" width="4445" height="8890" data-unit-id="A2" data-progress="36" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24831.7 5375.52)" width="4445" height="8890" data-unit-id="A1" data-progress="56" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 26030.2 11354.6)" width="4445" height="8890" data-unit-id="B5" data-progress="76" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25903 10714.4)" width="4445" height="8890" data-unit-id="B4" data-progress="96" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25775.7 10074.3)" width="4445" height="8890" data-unit-id="B3" data-progress="15" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25648.5 9434.07)" width="4445" height="8890" data-unit-id="B2" data-progress="35" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25521.3 8793.89)" width="4445" height="8890" data-unit-id="B1" data-progress="55" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24241 9048.32)" width="4445" height="8890" data-unit-id="B6" data-progress="75" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24368.2 9688.5)" width="4445" height="8890" data-unit-id="B7" data-progress="95" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24495.4 10328.7)" width="4445" height="8890" data-unit-id="B8" data-progress="14" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24622.6 10968.9)" width="4445" height="8890" data-unit-id="B9" data-progress="34" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24749.8 11609)" width="4445" height="8890" data-unit-id="B10" data-progress="54" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19114.6 10060.9)" width="4445" height="8890" data-unit-id="D1" data-progress="74" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 17834.3 10315.3)" width="4445" height="8890" data-unit-id="D14" data-progress="94" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 17961.5 10955.5)" width="4445" height="8890" data-unit-id="D15" data-progress="13" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18088.7 11595.7)" width="4445" height="8890" data-unit-id="D16" data-progress="33" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18215.9 12235.8)" width="4445" height="8890" data-unit-id="D17" data-progress="53" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18343.1 12876)" width="4445" height="8890" data-unit-id="D18" data-progress="73" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18470.3 13516.2)" width="4445" height="8890" data-unit-id="D19" data-progress="93" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18597.5 14156.4)" width="4445" height="8890" data-unit-id="D20" data-progress="12" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18724.7 14796.6)" width="4445" height="8890" data-unit-id="D21" data-progress="32" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18852 15436.7)" width="4445" height="8890" data-unit-id="D22" data-progress="52" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18979.2 16076.9)" width="4445" height="8890" data-unit-id="D23" data-progress="72" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19106.4 16717.1)" width="4445" height="8890" data-unit-id="D24" data-progress="92" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19233.6 17357.3)" width="4445" height="8890" data-unit-id="D25" data-progress="11" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19241.8 10701.1)" width="4445" height="8890" data-unit-id="D2" data-progress="31" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19369 11341.2)" width="4445" height="8890" data-unit-id="D3" data-progress="51" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19496.3 11981.4)" width="4445" height="8890" data-unit-id="D4" data-progress="71" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19623.5 12621.6)" width="4445" height="8890" data-unit-id="D5" data-progress="91" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19750.7 13261.8)" width="4445" height="8890" data-unit-id="D6" data-progress="10" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19877.9 13902)" width="4445" height="8890" data-unit-id="D7" data-progress="30" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20005.1 14542.1)" width="4445" height="8890" data-unit-id="D8" data-progress="50" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20132.3 15182.3)" width="4445" height="8890" data-unit-id="D9" data-progress="70" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20259.5 15822.5)" width="4445" height="8890" data-unit-id="D10" data-progress="90" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20386.7 16462.7)" width="4445" height="8890" data-unit-id="D11" data-progress="9" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20514 17102.9)" width="4445" height="8890" data-unit-id="D12" data-progress="29" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20641.2 17743)" width="4445" height="8890" data-unit-id="D13" data-progress="49" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20768.4 18383.2)" width="4445" height="8890" data-unit-id="D13A" data-progress="69" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 15915.2 10697.8)" width="4445" height="8890" data-unit-id="G1" data-progress="89" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 14634.8 10952.2)" width="4445" height="8890" data-unit-id="G8" data-progress="8" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 14762 11592.4)" width="4445" height="8890" data-unit-id="G9" data-progress="28" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 14889.2 12232.6)" width="4445" height="8890" data-unit-id="G10" data-progress="48" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 15016.4 12872.8)" width="4445" height="8890" data-unit-id="G11" data-progress="68" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 15143.7 13512.9)" width="4445" height="8890" data-unit-id="G12" data-progress="88" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 15270.9 14153.1)" width="4445" height="8890" data-unit-id="G13" data-progress="7" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16042.4 11338)" width="4445" height="8890" data-unit-id="G2" data-progress="27" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16169.6 11978.2)" width="4445" height="8890" data-unit-id="G3" data-progress="47" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16296.8 12618.3)" width="4445" height="8890" data-unit-id="G4" data-progress="67" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16424 13258.5)" width="4445" height="8890" data-unit-id="G5" data-progress="87" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16551.2 13898.7)" width="4445" height="8890" data-unit-id="G6" data-progress="6" />
                      <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16678.4 14538.9)" width="4445" height="8890" data-unit-id="G7" data-progress="26" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 18687 7923.74)" width="4445" height="8890" data-unit-id="E4" data-progress="46" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 17406.6 8178.16)" width="4445" height="8890" data-unit-id="E9" data-progress="66" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 17279.4 7537.98)" width="4445" height="8890" data-unit-id="E8" data-progress="86" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 17152.2 6897.8)" width="4445" height="8890" data-unit-id="E7" data-progress="5" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 17025 6257.62)" width="4445" height="8890" data-unit-id="E6" data-progress="25" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 16897.8 5617.44)" width="4445" height="8890" data-unit-id="E5" data-progress="45" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 18559.8 7283.56)" width="4445" height="8890" data-unit-id="E3" data-progress="65" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 18432.5 6643.38)" width="4445" height="8890" data-unit-id="E2" data-progress="85" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 18305.3 6003.2)" width="4445" height="8890" data-unit-id="E1" data-progress="4" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 15489 8563.84)" width="4445" height="8890" data-unit-id="F6" data-progress="24" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 14208.6 8818.27)" width="4445" height="8890" data-unit-id="F13" data-progress="44" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 14081.4 8178.09)" width="4445" height="8890" data-unit-id="F12" data-progress="64" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 13954.2 7537.91)" width="4445" height="8890" data-unit-id="F11" data-progress="84" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 13827 6897.73)" width="4445" height="8890" data-unit-id="F10" data-progress="3" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 13699.7 6257.55)" width="4445" height="8890" data-unit-id="F9" data-progress="23" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 13572.5 5617.37)" width="4445" height="8890" data-unit-id="F8" data-progress="43" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 15361.7 7923.66)" width="4445" height="8890" data-unit-id="F5" data-progress="63" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 15234.5 7283.48)" width="4445" height="8890" data-unit-id="F4" data-progress="83" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 15107.3 6643.3)" width="4445" height="8890" data-unit-id="F3" data-progress="2" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 14980.1 6003.12)" width="4445" height="8890" data-unit-id="F2" data-progress="22" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 14852.9 5362.94)" width="4445" height="8890" data-unit-id="F1" data-progress="42" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 12289 9203.1)" width="4445" height="8890" data-unit-id="H7" data-progress="62" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10817.8 8497.26)" width="4445" height="8890" data-unit-id="H13" data-progress="82" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10690.6 7857.08)" width="4445" height="8890" data-unit-id="H12" data-progress="1" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10563.4 7216.9)" width="4445" height="8890" data-unit-id="H11" data-progress="21" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10436.2 6576.72)" width="4445" height="8890" data-unit-id="H10" data-progress="41" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10309 5936.54)" width="4445" height="8890" data-unit-id="H9" data-progress="61" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10181.8 5296.36)" width="4445" height="8890" data-unit-id="H8" data-progress="81" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 12161.8 8562.92)" width="4445" height="8890" data-unit-id="H6" data-progress="0" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 12034.6 7922.74)" width="4445" height="8890" data-unit-id="H5" data-progress="20" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 11907.4 7282.56)" width="4445" height="8890" data-unit-id="H4" data-progress="40" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 11780.2 6642.38)" width="4445" height="8890" data-unit-id="H3" data-progress="60" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 11652.9 6002.2)" width="4445" height="8890" data-unit-id="H2" data-progress="80" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 11525.7 5362.02)" width="4445" height="8890" data-unit-id="H1" data-progress="100" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 3751.47 10046)" width="4445" height="8890" data-unit-id="J20" data-progress="19" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 4348.84 10309)" width="4445" height="8890" data-unit-id="J19" data-progress="39" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 4946.21 10572)" width="4445" height="8890" data-unit-id="J18" data-progress="59" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 6738.33 11360.9)" width="4445" height="8890" data-unit-id="J15" data-progress="79" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 7335.7 11623.9)" width="4445" height="8890" data-unit-id="J14" data-progress="99" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 7933.07 11886.9)" width="4445" height="8890" data-unit-id="J13" data-progress="18" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 8530.44 12149.9)" width="4445" height="8890" data-unit-id="J12" data-progress="38" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 9127.81 12412.9)" width="4445" height="8890" data-unit-id="J11" data-progress="58" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 9725.18 12675.9)" width="4445" height="8890" data-unit-id="I1" data-progress="78" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 10322.6 12938.9)" width="4445" height="8890" data-unit-id="I2" data-progress="98" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 10919.9 13201.8)" width="4445" height="8890" data-unit-id="I3" data-progress="17" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 11517.3 13464.8)" width="4445" height="8890" data-unit-id="I4" data-progress="37" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 12114.7 13727.8)" width="4445" height="8890" data-unit-id="I5" data-progress="57" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 12712 13990.8)" width="4445" height="8890" data-unit-id="I6" data-progress="77" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 13309.4 14253.8)" width="4445" height="8890" data-unit-id="I7" data-progress="97" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 13906.8 14516.8)" width="4445" height="8890" data-unit-id="I8" data-progress="16" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 5543.58 10835)" width="4445" height="8890" data-unit-id="J17" data-progress="36" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 6140.95 11098)" width="4445" height="8890" data-unit-id="J16" data-progress="56" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 4632.22 8042.22)" width="4445" height="8890" data-unit-id="J9" data-progress="76" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 5229.6 8305.21)" width="4445" height="8890" data-unit-id="J8" data-progress="96" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 5826.97 8568.19)" width="4445" height="8890" data-unit-id="J7" data-progress="15" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 6424.34 8831.18)" width="4445" height="8890" data-unit-id="J6" data-progress="35" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 7021.71 9094.16)" width="4445" height="8890" data-unit-id="J5" data-progress="55" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 7619.08 9357.15)" width="4445" height="8890" data-unit-id="J4" data-progress="75" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 8216.45 9620.13)" width="4445" height="8890" data-unit-id="J3" data-progress="95" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 8813.82 9883.12)" width="4445" height="8890" data-unit-id="J2" data-progress="14" />
                      <rect class="fil1" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 9411.19 10146.1)" width="4445" height="8890" data-unit-id="J1" data-progress="34" />
                      <path class="fil2" d="M20906.54 9041.02l2566.6 -510.02m640.2 -127.22l2560.71 -508.86" />
                      <path class="fil2" d="M9867.44 10347.36l1.07 -0.21 631.43 -125.48 -631.43 125.48 -1.07 0.21zm10875.38 -2161.1l2560.72 -508.85m640.18 -127.21l2560.72 -508.85" />
                      <line class="fil2" x1="27947.01" y1="10952.07" x2="26758.46" y2="4970.88" />
                      <path class="fil2" d="M24750.25 11608.95l-636.92 -3205.18m-169.61 -853.57l-382 -1922.32" />
                      <g>
                       <path class="fil3" d="M22438.99 16722l-1526.56 -7682.16 1526.56 7682.16zm-1696.17 -8535.74l-509.85 -2565.73 2560.71 -508.87 509.86 2565.75 -2560.72 508.85z" />
                      </g>
                      <path class="fil2" d="M19237.77 17356.46l-1526.55 -7682.16m-169.3 -851.97l-637.14 -3206.28" />
                      <path class="fil2" d="M27189.37 10488.18l-515.32 -2593.26m-169.61 -853.57l-509.85 -2565.74" />
                      <path class="fil2" d="M23988.47 11124.25l-515.32 -2593.26m-169.61 -853.58l-509.85 -2565.74" />
                      <line class="fil2" x1="21733.84" y1="16522.26" x2="20272.25" y2="9167.05" />
                      <line class="fil2" x1="18597.59" y1="17483.67" x2="17071.35" y2="9803.12" />
                      <path class="fil2" d="M15273.81 14152.53l-763.28 -3841.08m-169.51 -853.05l-763.47 -3842.03" />
                      <line class="fil2" x1="14633.63" y1="14279.74" x2="14441.29" y2="13311.8" />
                      <path class="fil2" d="M11527.31 12042.95l-3.05 -15.33m-574.5 -2891.12l-892.12 -4489.44" />
                      <path class="fil2" d="M10798.05 11721.9l-3.04 -15.33m-295.07 -1484.9l-1082.48 -5447.39" />
                      <path class="fil2" d="M21733.84 16522.26l-4.75 -2.09m-2912.27 -1282.09l-4.76 -2.1m-3641.52 -1603.13l-3.35 -1.48m-725.9 -319.57l-10784.57 -4747.77" />
                      <path class="fil2" d="M22256.03 15801.29l-6.72 -2.96m-722.53 -318.09l-4.76 -2.09m-2912.27 -1282.09l-4.75 -2.1m-724.5 -318.95l-3.35 -1.47m-2913.67 -1282.71l-3.36 -1.48" />
                      <line class="fil2" x1="9867.44" y1="10347.36" x2="9411.19" y2="10146.1" />
                      <rect class="fil1" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 8136.54 5028.81)" width="4445" height="8890" data-unit-id="J10" data-progress="54" />
                      <line class="fil2" x1="10945.04" y1="9137.44" x2="12416.22" y2="9843.28" />
                      <circle class="fil4" transform="matrix(0.106697 -0.0212022 0.0212022 0.106697 13330.9 11321.1)" r="4762.5" />
                      <polygon class="fil5 str1" points="27630.41,3527.45 26758.47,4970.88 27947.01,10952.07 27310.53,11100.18 26674.05,7894.92 24113.74,8408.14 24750.25,11608.94 24103.32,11733.06 23467.25,8532.16 20906.53,9041.01 22629.48,17743.52 22048.75,18128.8 20272.26,9167.06 17711.22,9674.29 19237.77,17356.45 18597.59,17483.67 17068.31,9803.18 14507.59,10312.04 15273.81,14152.53 14633.63,14279.74 14441.28,13311.8 3680.07,8588.3 4034.85,7779.24 9868.5,10347.14 10499.95,10221.67 9417.46,4774.27 10057.64,4647.07 10945.05,9137.45 12416.22,9843.28 13696.58,9588.86 12806.1,5107.6 13504.88,5107.8 13577.55,5616.36 14335.81,9458.45 16896.53,8949.6 16133.25,5108.52 16849.13,5197.62 16904.77,5616.04 17533.82,8818.34 20094.54,8309.49 19585.69,5748.77 20232.97,5620.53 20742.81,8186.27 23303.54,7677.41 22793.68,5111.66 23363.87,4749.6 23943.72,7550.2 26493.7,7041.64 25884.18,4319.21 26239.19,3656.91 26585.05,2731.37 " />
                      <circle class="fil6 str1" cx="13003.06" cy="11264.92" r="715.25" />
                    </g>
                  </svg>
              </div>
            </div>  
          </div>

          <div class="lg:col-span-4">
            <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4 h-full flex flex-col sticky top-6">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h2 class="text-base font-bold text-slate-900">Update Blok</h2>
                  <p class="text-xs text-slate-500 mt-1">Status tersimpan otomatis ke Cloud.</p>
                </div>
                <div id="syncStatus" class="text-[10px] px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-500">
                  <i class="fa-solid fa-cloud"></i> Ready
                </div>
              </div>

              <div class="mb-4 p-4 rounded-xl bg-slate-50 border border-slate-200">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-xs text-slate-500 font-semibold uppercase tracking-wider">Blok Terpilih</div>
                        <div id="selectedUnit" class="text-3xl font-extrabold text-slate-800 mt-1">‚Äî</div>
                    </div>
                    <div id="selectedProgress" class="text-xs font-bold px-2 py-1 bg-white rounded border border-slate-200 text-slate-600">
                        0%
                    </div>
                </div>
                <div id="selectedMeta" class="text-xs text-slate-400 mt-2">Silakan klik blok di peta.</div>
              </div>

              <div id="updateForm" class="space-y-4 flex-1 overflow-y-auto pr-1 opacity-50 pointer-events-none transition-opacity">
                
                <div>
                  <label class="block text-xs font-bold text-slate-700 mb-1">Status Unit</label>
                  <div class="relative">
                    <select id="statusSelect" class="w-full appearance-none rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-sm font-semibold text-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-500 transition">
                        <option value="ready-stock">Ready Stock</option>
                        <option value="booking">Booking (Tanda Jadi)</option>
                        <option value="sold-out">Sold Out (Terjual)</option>
                        <option value="proses-berkas">Proses Berkas</option>
                        <option value="proses-bank">Proses Bank</option>
                        <option value="akad">Akad Kredit</option>
                        <option value="pembangunan">Pembangunan</option>
                        <option value="serah-terima">Serah Terima</option>
                        <option value="cancel">Cancel</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
                      <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                  </div>
                </div>

                <hr class="border-slate-100">

                <div id="formBooking" class="hidden-group space-y-3 p-3 bg-amber-50 rounded-xl border border-amber-100">
                    <div class="flex items-center gap-2 text-amber-700 text-xs font-bold mb-1">
                        <i class="fa-solid fa-address-book"></i> Data Booking
                    </div>
                    <div>
                        <label class="text-[11px] font-semibold text-slate-600">Nama Customer</label>
                        <input id="inputBookingName" type="text" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400 focus:outline-none" placeholder="Nama Lengkap">
                    </div>
                    <div>
                        <label class="text-[11px] font-semibold text-slate-600">No. WhatsApp</label>
                        <input id="inputBookingPhone" type="text" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400 focus:outline-none" placeholder="08...">
                    </div>
                    <div>
                        <label class="text-[11px] font-semibold text-slate-600">No. KTP</label>
                        <input id="inputBookingKTP" type="text" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400 focus:outline-none" placeholder="16 digit NIK">
                    </div>
                </div>

                <div id="formSold" class="hidden-group space-y-3 p-3 bg-rose-50 rounded-xl border border-rose-100">
                    <div class="flex items-center gap-2 text-rose-700 text-xs font-bold mb-1">
                        <i class="fa-solid fa-hand-holding-dollar"></i> Data Penjualan
                    </div>
                    <div>
                        <label class="text-[11px] font-semibold text-slate-600">Nama Pemilik</label>
                        <input id="inputSoldName" type="text" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2 text-sm focus:ring-2 focus:ring-rose-400 focus:outline-none" placeholder="Nama Pemilik">
                    </div>
                    <div>
                        <label class="text-[11px] font-semibold text-slate-600">Metode Pembayaran</label>
                        <select id="inputSoldPayment" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2 text-sm focus:ring-2 focus:ring-rose-400 focus:outline-none bg-white">
                            <option value="">-- Pilih --</option>
                            <option value="KPR">KPR (Kredit)</option>
                            <option value="Cash Bertahap">Cash Bertahap</option>
                            <option value="Cash Keras">Cash Keras</option>
                        </select>
                    </div>
                </div>

                <div>
                  <label class="text-xs font-semibold text-slate-700">Catatan Tambahan</label>
                  <textarea id="noteInput" rows="2" placeholder="Cth: Menunggu ACC Bank..." class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
                </div>

                <div class="pt-2 flex gap-2">
                  <button id="btnSave" class="flex-1 bg-slate-900 hover:bg-slate-800 text-white text-sm font-bold px-4 py-3 rounded-xl shadow-lg shadow-slate-300/50 transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> Simpan Data
                  </button>
                  <button id="btnClear" class="px-4 py-3 rounded-xl border border-slate-200 text-slate-600 hover:bg-slate-50 text-sm font-semibold transition">
                    Batal
                  </button>
                </div>
              </div>

              <div class="mt-4 pt-4 border-t border-slate-200">
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Legenda Peta</div>
                <div class="flex flex-wrap gap-2 select-none">
                    <span class="chip cursor-pointer hover:bg-slate-50"><span class="dot bg-white border border-slate-300"></span>Ready</span>
                    <span class="chip cursor-pointer hover:bg-slate-50"><span class="dot bg-amber-200"></span>Booking</span>
                    <span class="chip cursor-pointer hover:bg-slate-50"><span class="dot bg-rose-300"></span>Sold</span>
                    <span class="chip cursor-pointer hover:bg-slate-50"><span class="dot bg-orange-300"></span>Berkas</span>
                    <span class="chip cursor-pointer hover:bg-slate-50"><span class="dot bg-blue-300"></span>Bank</span>
                    <span class="chip cursor-pointer hover:bg-slate-50"><span class="dot bg-purple-300"></span>Akad</span>
                    <span class="chip cursor-pointer hover:bg-slate-50"><span class="dot bg-green-300"></span>Bangun</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ====== 1. KONFIGURASI SUPABASE ======
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    const STATUS_COLORS = {
      "ready-stock": "#ffffff",
      "booking": "#f502e9ff",      
      "sold-out": "#000000ff",     
      "proses-berkas": "#fdba74",
      "proses-bank": "#93c5fd",  
      "akad": "#c4b5fd",         
      "pembangunan": "#86efac",  
      "serah-terima": "#5eead4", 
      "cancel": "#e2e8f0"        
    };

    let globalUnitData = {};
    let currentSelectedId = null;

    // ====== 2. ELEMENT DOM ======
    const svg = document.getElementById("siteplanSvg");
    const mapWrap = document.getElementById("mapWrap");
    const tooltip = document.getElementById("mapTooltip");
    const tipTitle = document.getElementById("tipTitle");
    const tipSub = document.getElementById("tipSub");
    const tipDot = document.getElementById("tipDot");
    const syncStatus = document.getElementById("syncStatus");

    // Form
    const updateForm = document.getElementById("updateForm");
    const selectedUnitEl = document.getElementById("selectedUnit");
    const selectedMetaEl = document.getElementById("selectedMeta");
    const selectedProgressEl = document.getElementById("selectedProgress");
    
    const statusSelect = document.getElementById("statusSelect");
    const noteInput = document.getElementById("noteInput");
    
    // Groups
    const formBooking = document.getElementById("formBooking");
    const inputBookingName = document.getElementById("inputBookingName");
    const inputBookingPhone = document.getElementById("inputBookingPhone");
    const inputBookingKTP = document.getElementById("inputBookingKTP");
    const formSold = document.getElementById("formSold");
    const inputSoldName = document.getElementById("inputSoldName");
    const inputSoldPayment = document.getElementById("inputSoldPayment");

    const btnSave = document.getElementById("btnSave");
    const btnClear = document.getElementById("btnClear");
    const btnFit = document.getElementById("btnFit");
    const btnResetView = document.getElementById("btnResetView");
    const filterOverlay = document.getElementById("filterOverlay");

    // ====== 3. LOGIKA ZOOM & PAN (ANTI-JITTER) ======
    // Menggunakan pendekatan Delta Sederhana (Mouse Movement) agar stabil
    let isPanning = false;
    let startPoint = { x: 0, y: 0 };
    let startViewBox = { x: 0, y: 0, w: 0, h: 0 };
    
    // Simpan viewBox awal
    const vbBase = svg.viewBox.baseVal;
    const INITIAL_VB = { x: vbBase.x, y: vbBase.y, w: vbBase.width, h: vbBase.height };

    // Mencegah select text saat drag
    mapWrap.addEventListener("dragstart", e => e.preventDefault());

    mapWrap.addEventListener("pointerdown", (e) => {
        // Jangan geser jika klik unit
        if (e.target.closest("[data-unit-id]")) return;
        
        isPanning = true;
        mapWrap.setPointerCapture(e.pointerId);
        startPoint = { x: e.clientX, y: e.clientY };
        startViewBox = { x: vbBase.x, y: vbBase.y, w: vbBase.width, h: vbBase.height };
        mapWrap.style.cursor = "grabbing";
    });

    mapWrap.addEventListener("pointermove", (e) => {
        if (!isPanning) return;
        
        e.preventDefault();
        const dx = e.clientX - startPoint.x;
        const dy = e.clientY - startPoint.y;

        // Hitung skala (Seberapa besar zoom saat ini relative ke ukuran layar)
        // Semakin besar viewBox width, semakin cepat gesernya
        const style = window.getComputedStyle(mapWrap);
        const mapWidthPx = parseFloat(style.width);
        const scale = vbBase.width / mapWidthPx;

        vbBase.x = startViewBox.x - (dx * scale);
        vbBase.y = startViewBox.y - (dy * scale);
    });

    const stopPan = () => {
        isPanning = false;
        mapWrap.style.cursor = "grab";
    };
    mapWrap.addEventListener("pointerup", stopPan);
    mapWrap.addEventListener("pointerleave", stopPan);

    // Zoom Smooth
    mapWrap.addEventListener("wheel", (e) => {
        e.preventDefault();
        const scaleFactor = 1.1;
        const direction = e.deltaY > 0 ? 1 : -1;
        
        // Ambil posisi mouse relatif ke SVG
        const rect = mapWrap.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        
        // Ubah mouse pos ke koordinat SVG
        const svgW = vbBase.width;
        const svgH = vbBase.height;
        const ratioX = mx / rect.width;
        const ratioY = my / rect.height;

        // Hitung Viewbox baru
        let newW = direction > 0 ? svgW * scaleFactor : svgW / scaleFactor;
        let newH = direction > 0 ? svgH * scaleFactor : svgH / scaleFactor;
        
        // Batasi Zoom
        if (newW < INITIAL_VB.w / 10) return; // Max zoom in
        if (newW > INITIAL_VB.w * 2) return;  // Max zoom out

        let newX = vbBase.x + (svgW - newW) * ratioX;
        let newY = vbBase.y + (svgH - newH) * ratioY;

        vbBase.x = newX; vbBase.y = newY; vbBase.width = newW; vbBase.height = newH;
    }, { passive: false });

    // Reset Buttons
    btnResetView.onclick = () => {
        vbBase.x = INITIAL_VB.x; vbBase.y = INITIAL_VB.y;
        vbBase.width = INITIAL_VB.w; vbBase.height = INITIAL_VB.h;
    };
    btnFit.onclick = btnResetView.onclick;


    // ====== 4. LOGIKA SUPABASE ======
    async function loadData() {
        syncStatus.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Syncing...';
        try {
            const { data, error } = await client.from('unit_status').select('*');
            if (error) throw error;
            
            globalUnitData = {};
            if (data) data.forEach(row => globalUnitData[row.unit_id] = row);
            
            applyColorsToMap();
            syncStatus.innerHTML = '<i class="fa-solid fa-check text-green-500"></i> Online';
        } catch (err) {
            console.error(err);
            syncStatus.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500"></i> Offline';
        }
    }

    function applyColorsToMap() {
        const units = document.querySelectorAll("[data-unit-id]");
        const filter = filterOverlay.value;

        units.forEach(el => {
            const id = el.dataset.unitId;
            const data = globalUnitData[id];
            const st = data ? data.status : "ready-stock"; // Default Status
            el.dataset.status = st;

            // Logic Filter Overlay
            if (filter === 'all' || st === filter) {
                // Tampilkan warna asli
                el.style.fill = STATUS_COLORS[st] || "#ffffff";
                el.style.opacity = "1";
                el.style.pointerEvents = "all";
            } else {
                // Redupkan (Dimmed)
                el.style.fill = "#cbd5e1"; // Slate-300
                el.style.opacity = "0.3";
                el.style.pointerEvents = "none"; // Opsional: non-aktifkan klik
            }
        });
    }

    // Listener Filter Dropdown
    filterOverlay.addEventListener("change", applyColorsToMap);

    // ====== 5. INTERAKSI KLIK & HOVER ======
    let selectedEl = null;

    function selectUnit(el) {
        const id = el.dataset.unitId;
        currentSelectedId = id;

        // Highlight
        if(selectedEl) {
            selectedEl.style.stroke = "none";
            selectedEl.style.strokeWidth = "0";
        }
        selectedEl = el;
        // Kita gunakan style inline agar override CSS hover
        el.style.stroke = "#0ea5e9";
        el.style.strokeWidth = "2px"; 

        // Isi Panel
        updateForm.classList.remove("opacity-50", "pointer-events-none");
        selectedUnitEl.textContent = id;
        selectedProgressEl.textContent = `${el.dataset.progress || 0}%`;
        
        const data = globalUnitData[id] || {};
        const st = data.status || "ready-stock";
        
        statusSelect.value = st;
        noteInput.value = data.notes || "";
        selectedMetaEl.textContent = st.replace("-", " ").toUpperCase();

        inputBookingName.value = data.customer_name || "";
        inputBookingPhone.value = data.customer_phone || "";
        inputBookingKTP.value = data.customer_ktp || "";
        inputSoldName.value = data.customer_name || ""; 
        inputSoldPayment.value = data.payment_method || "";

        toggleDynamicForms(st);
    }

    svg.addEventListener("click", (evt) => {
        const t = evt.target.closest("[data-unit-id]");
        if (t) selectUnit(t);
    });

    // Tooltip Logic
    svg.addEventListener("mousemove", (evt) => {
        const t = evt.target.closest("[data-unit-id]");
        if(t && t !== selectedEl) {
            const id = t.dataset.unitId;
            const st = globalUnitData[id]?.status || "ready-stock";
            
            tooltip.classList.remove("hidden");
            tooltip.style.left = evt.clientX + "px";
            tooltip.style.top = evt.clientY + "px";
            
            tipTitle.textContent = "Blok " + id;
            tipSub.textContent = st.replace("-", " ");
            tipDot.style.backgroundColor = STATUS_COLORS[st];
        } else {
            tooltip.classList.add("hidden");
        }
    });

    // ====== 6. FORM LOGIC ======
    function toggleDynamicForms(status) {
        formBooking.classList.add("hidden-group");
        formSold.classList.add("hidden-group");

        if (status === "booking") formBooking.classList.remove("hidden-group");
        else if (status === "sold-out") formSold.classList.remove("hidden-group");
    }

    statusSelect.addEventListener("change", (e) => toggleDynamicForms(e.target.value));

    btnSave.addEventListener("click", async () => {
        if (!currentSelectedId) return;

        const oriText = btnSave.innerHTML;
        btnSave.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ...';
        btnSave.disabled = true;

        const st = statusSelect.value;
        let payload = {
            unit_id: currentSelectedId,
            status: st,
            notes: noteInput.value,
            updated_at: new Date()
        };

        if (st === "booking") {
            payload.customer_name = inputBookingName.value;
            payload.customer_phone = inputBookingPhone.value;
            payload.customer_ktp = inputBookingKTP.value;
            payload.payment_method = null;
        } else if (st === "sold-out") {
            payload.customer_name = inputSoldName.value;
            payload.payment_method = inputSoldPayment.value;
            payload.customer_phone = null;
            payload.customer_ktp = null;
        } else {
            payload.customer_name = null;
            payload.customer_phone = null;
            payload.customer_ktp = null;
            payload.payment_method = null;
        }

        try {
            const { error } = await client.from('unit_status').upsert(payload);
            if (error) throw error;

            globalUnitData[currentSelectedId] = { ...globalUnitData[currentSelectedId], ...payload };
            applyColorsToMap();
            alert("Berhasil disimpan!");

        } catch (err) {
            alert("Error: " + err.message);
        } finally {
            btnSave.innerHTML = oriText;
            btnSave.disabled = false;
        }
    });

    btnClear.addEventListener("click", () => {
        if(selectedEl) selectUnit(selectedEl);
    });

    // Init
    loadData();

  </script>
</body>
</html>