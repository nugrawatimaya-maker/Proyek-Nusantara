<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Gudang - Penerimaan Barang (GRN)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans text-gray-800 p-6">

  <div class="max-w-5xl mx-auto mb-6 flex flex-col gap-4">
    <div>
      <h1 class="text-2xl font-bold text-green-700">Penerimaan Barang (GRN)</h1>
      <p class="text-sm text-gray-500">Cek fisik barang, Validasi Harga & Posting Tagihan</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <button onclick="document.getElementById('modalTambahItem')?.classList.remove('hidden')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded shadow text-sm font-bold flex items-center gap-2">
        <i class="fas fa-plus"></i> Item Baru
      </button>
      <a href="inventory_grn.html" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow text-sm font-bold flex items-center gap-2">
        <i class="fas fa-truck-loading"></i> Terima Barang
      </a>
      <button onclick="bukaModal('PAKAI')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded shadow text-sm font-bold flex items-center gap-2">
        <i class="fas fa-hard-hat"></i> Catat Pemakaian
      </button>
      <button onclick="cekAksesOpname()" class="bg-purple-700 hover:bg-purple-800 text-white px-3 py-2 rounded shadow text-sm font-bold flex items-center gap-2">
        <i class="fas fa-lock text-yellow-300"></i> Opname (Admin)
      </button>
      <a href="dashboard_operasional.html" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded shadow text-sm font-bold flex items-center gap-2">
        <i class="fas fa-arrow-left"></i> Dashboard
      </a>
    </div>
  </div>

  <div class="max-w-5xl mx-auto space-y-6" id="containerPO">
    <div class="text-center p-10 bg-white rounded shadow animate-pulse">
        <p class="text-gray-500 font-bold">üîÑ Sedang menghubungkan ke database...</p>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    async function loadOpenPO() {
    try {
        // PERBAIKAN: Menghapus barang_id dari inventory_req untuk menghindari error kolom tidak ditemukan
        const { data, error } = await client
            .from('purchase_order')
            .select(`*, inventory_req!fk_req_id ( nama_barang, satuan, jumlah )`)
            .eq('status', 'OPEN')
            .order('created_at', { ascending: false });

        if (error) throw error;
        const container = document.getElementById("containerPO");
        container.innerHTML = "";

        if (!data || data.length === 0) {
            container.innerHTML = `<div class="text-center p-10 bg-white rounded shadow text-gray-400 font-bold">Semua barang telah diterima.</div>`;
            return;
        }

        data.forEach(po => {
            const req = po.inventory_req;
            // Gunakan barang_id dari tabel purchase_order langsung
            const bId = po.barang_id;
            const tglPO = new Date(po.created_at).toLocaleDateString('id-ID');

            container.innerHTML += `
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-5">
                <div class="p-5">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-blue-700">${po.nomor_po} - ${req?.nama_barang || 'Material'}</h3>
                        <span class="text-[10px] font-bold text-gray-400 italic">ID Stok: ${bId || 'Tidak Ada'}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold uppercase text-gray-500">Fisik Diterima</label>
                            <input type="number" id="qty-${po.id}" value="${req?.jumlah || 0}" class="w-full border p-2 rounded bg-gray-50 font-bold">
                        </div>
                        <div>
                            <label class="text-xs font-bold uppercase text-gray-500">Harga Nota Satuan</label>
                            <input type="number" id="harga-${po.id}" value="${po.harga_satuan}" class="w-full border p-2 rounded font-bold">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="text-xs font-bold uppercase text-gray-500">Foto Bukti Nota</label>
                        <input type="file" id="nota-${po.id}" class="w-full text-sm mt-1">
                    </div>

                    <div class="flex gap-2 mt-6">
                        <button onclick="prosesGRN(${po.id}, '${po.nomor_po}', ${bId})" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-md transition">
                            Konfirmasi Terima Barang
                        </button>
                        <button onclick="batalPO(${po.id}, '${po.nomor_po}')" 
                                class="bg-red-100 hover:bg-red-200 text-red-600 font-bold px-6 py-3 rounded-xl transition border border-red-200">
                            <i class="fas fa-times"></i> Batal PO
                        </button>
                    </div>
                </div>
            </div>`;
        });
      } catch (err) { 
          console.error(err);
          document.getElementById("containerPO").innerHTML = `<p class="text-red-500 text-center font-bold">‚ö†Ô∏è Gagal koneksi: ${err.message}</p>`;
      }
    }

    async function prosesGRN(id, noPO, bId) {
        if (!bId || bId === 0) {
            alert("‚ùå ERROR: ID Material tidak ditemukan pada PO ini. Hubungi Admin.");
            return;
        }

        const btn = event.currentTarget;
        const qty = Number(document.getElementById(`qty-${id}`).value);
        const fileInput = document.getElementById(`nota-${id}`);

        if(qty <= 0) return alert("Jumlah fisik tidak boleh 0!");
        if(fileInput.files.length === 0) return alert("Wajib upload foto nota!");

        if(!confirm(`Konfirmasi penerimaan ${qty} unit?`)) return;

        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Memproses...`;

        try {
            // A. UPLOAD FOTO
            const file = fileInput.files[0];
            const fileName = `Nota_PO_${noPO}_${Date.now()}.jpg`;
            const { error: errUp } = await client.storage.from('nota grn').upload(fileName, file);
            if(errUp) throw new Error("Gagal Upload Foto: " + errUp.message);

            // B. AMBIL STOK + HARGA LAMA
            const hargaNota = Number(document.getElementById(`harga-${id}`).value || 0);
            if (hargaNota <= 0) return alert("Harga nota wajib diisi!");

            const { data: cur, error: errGet } = await client
                .from('master_stok')
                .select('total_stok, harga_estimasi')
                .eq('id', bId)
                .single();
            if (errGet) throw new Error("Material (ID: " + bId + ") tidak ditemukan di Master Stok.");

            const stokLama = Number(cur.total_stok) || 0;
            const hargaLama = Number(cur.harga_estimasi) || 0;

            // C. UPDATE MASTER_STOK (stok + harga master)
            const payloadUpdate = {
                total_stok: stokLama + qty,
                harga_estimasi: hargaNota,
                harga_updated_source: 'GRN',
                harga_updated_ref: noPO
            };

            const { error: errUpdateStok } = await client
                .from('master_stok')
                .update(payloadUpdate)
                .eq('id', bId);
            if (errUpdateStok) throw errUpdateStok;

            // D. UPDATE STATUS PO
            await client.from('purchase_order').update({ status: 'DITERIMA' }).eq('id', id);

            alert("‚úÖ BERHASIL!\nBarang diterima dan stok gudang telah ditambahkan.");
            loadOpenPO();

        } catch (e) {
            alert("‚ùå GAGAL: " + e.message);
            btn.disabled = false;
            btn.innerHTML = `Konfirmasi Terima Barang`;
        }
    }

    async function batalPO(id, noPO) {
        const alasan = prompt(`‚ö†Ô∏è BATALKAN PO ${noPO}?\nMasukkan alasan pembatalan:`);
        if (alasan === null) return;
        if (alasan.trim() === "") return alert("Alasan pembatalan wajib diisi!");
        if (!confirm(`Apakah Anda yakin ingin menghapus PO ${noPO} dari antrean GRN?`)) return;

        try {
            const { error } = await client
                .from('purchase_order')
                .update({
                    status: 'CANCELLED',
                    keterangan: `BATAL DI GRN: ${alasan.trim()}`
                })
                .eq('id', id);

            if (error) throw error;

            alert(`‚úÖ PO ${noPO} telah berhasil dibatalkan.`);
            loadOpenPO();

        } catch (e) {
            alert("‚ùå Gagal membatalkan PO: " + e.message);
        }
    }

    loadOpenPO();
  </script>
</body>
</html>
