<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Input Transaksi Kas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  window.PN_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlBHrduAIgPZZrPMYAiEwaFUJOrGws1IbIzw09jXt9sdDNafaAzRS3RT2AWxVTop_oIQ/exec";
  // opsional kalau mau dipakai tombol download
  window.PN_SHEET_ID = "1s94wBnBjXVLclxw8i1P9J7uqHbZiMaONvzA2DMoQgNQ";
  </script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f4f6f8;
      color: #1f2933;
    }
    .page-header {
      padding: 28px 24px 12px;
      background: #ffffff;
      box-shadow: 0 4px 16px rgba(15, 23, 42, 0.08);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }
    .page-header h1 {
      margin: 0;
      font-size: 24px;
    }
    .page-header p {
      margin: 6px 0 0;
      color: #6b7280;
    }
    .nav-actions {
      display: flex;
      gap: 10px;
    }
    .back-btn, .home-btn, .add-btn {
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .back-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 10px 18px rgba(239, 68, 68, 0.25);
    }
    .back-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(239, 68, 68, 0.28);
    }
    .home-btn {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      box-shadow: 0 10px 18px rgba(2, 132, 199, 0.25);
    }
    .home-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(2, 132, 199, 0.28);
    }
    .add-btn {
      background: linear-gradient(135deg, #16a34a, #15803d);
      box-shadow: 0 10px 18px rgba(21, 128, 61, 0.25);
    }
    .add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(21, 128, 61, 0.28);
    }
    .wrap {
      width: 100%;
      max-width: 100%;
      margin: 0;
      padding: 0;
    }
    .card {
      background: #ffffff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
    }
    p {
      margin: 0 0 18px;
      color: #6b7280;
      font-size: 14px;
    }
    label {
      display: block;
      margin: 14px 0 6px;
      font-size: 13px;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d4d6dd;
      font-size: 14px;
      background: #fff;
    }
    /* Hilangkan teks default "Tidak ada file yang dipilih" pada input file */
    .file-input {
      color: transparent;
    }
    .file-input::-webkit-file-upload-text {
      visibility: hidden;
    }
    .file-input::file-selector-button,
    .file-input::-webkit-file-upload-button {
      color: #111;
      background: #f8fafc;
      border: 1px solid #d4d6dd;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    button {
      margin-top: 20px;
      padding: 11px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
    }
    .small {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 8px;
    }
    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
      display: none;
    }
    .status.show { display: block; }
    .status.success { background:#ecfdf3; color:#15803d; border:1px solid #bbf7d0; }
    .status.error { background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
    .status.info { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }
    dialog {
      border: none;
      border-radius: 14px;
      padding: 24px;
      width: 360px;
      max-width: calc(100% - 32px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.3);
    }
    dialog::backdrop {
      background: rgba(15, 23, 42, 0.45);
    }
    .dialog-actions {
      display: flex;
      gap: 10px;
      margin-top: 18px;
      justify-content: flex-end;
    }
    .btn-outline {
      border: 1px solid #d4d6dd;
      background: #fff;
      color: #1f2933;
    }
    .page-section {
      max-width: 1200px;
      margin: 24px auto 48px;
      padding: 0 24px;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 24px;
      align-items: start;
    }
    .stack {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .side-panel h2 { margin: 0 0 8px; }
    .side-panel p { margin: 0 0 12px; }
    .actions-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    /* Responsif */
    @media (min-width: 768px) {
      .wrap { max-width: 840px; }
      input, select { width: 75%; }
      .nav-actions { justify-content: flex-end; }
    }
    @media (max-width: 1023px) {
      .page-section {
        grid-template-columns: 1fr;
        padding: 0 16px;
      }
    }
    @media (max-width: 767px) {
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        padding: 20px 18px 10px;
      }
      .nav-actions {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
      .nav-actions button {
        width: 100%;
        justify-content: center;
      }
      .wrap {
        margin: 18px auto 28px;
        padding: 0 16px 36px;
      }
      .card { padding: 18px; }
      button { width: 100%; }
      .actions-row { flex-direction: column; gap: 8px; align-items: stretch; }
      table { font-size: 13px; }
      th, td { padding: 10px 6px !important; }
    }

    /* Panel Tambah */
    .add-panel-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 16px;
    }
    .add-panel {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18);
      width: min(520px, 96%);
      padding: 18px;
      color: #0f172a;
    }
    .add-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .add-panel-title {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
    }
    .add-panel-sub {
      margin: 0 0 12px;
      color: #475569;
      font-size: 14px;
    }
    .add-panel-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #475569;
      padding: 4px 8px;
    }
    .add-panel-actions {
      display: grid;
      gap: 10px;
    }
    .add-panel-actions button {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #f8fafc;
      padding: 10px 12px;
      text-align: left;
      font-weight: 700;
      color: #0f172a;
      cursor: pointer;
      transition: border-color 0.15s ease, background-color 0.15s ease;
    }
    .add-panel-actions button:hover {
      border-color: #cbd5e1;
      background: #e2e8f0;
    }

    /* Panel rekening */
    .rekening-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }
    .rekening-form label {
      font-weight: 700;
      color: #0f172a;
    }
    .rekening-form input, .rekening-form select {
      max-width: 100%;
      display: block;
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      font-size: 14px;
    }
    .rekening-form .inline-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .rekening-form .inline-actions button {
      flex: 1 1 48%;
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
    }
    .btn-save {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      box-shadow: 0 10px 18px rgba(2, 132, 199, 0.2);
    }
    .btn-delete {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 10px 18px rgba(239, 68, 68, 0.18);
    }
    .btn-back {
      background: #f1f5f9;
      color: #0f172a;
      border: 1px solid #e2e8f0;
      box-shadow: none;
    }
    .rekening-status {
      margin-top: 6px;
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 10px;
      display: none;
    }
    .rekening-status.info { background: #e0f2fe; color: #075985; }
    .rekening-status.error { background: #fee2e2; color: #991b1b; }
    .rekening-status.success { background: #dcfce7; color: #166534; }

    /* Panel akun transaksi */
    .akun-status {
      margin-top: 6px;
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 10px;
      display: none;
    }
    .akun-status.info { background: #e0f2fe; color: #075985; }
    .akun-status.error { background: #fee2e2; color: #991b1b; }
    .akun-status.success { background: #dcfce7; color: #166534; }

    /* Combobox dropdown */
    .combo {
      position: relative;
      width: 100%;
    }
    .combo input {
      width: 100%;
    }
    .combo-list {
      position: absolute;
      z-index: 10;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      max-height: 220px;
      overflow: auto;
      display: none;
      padding: 6px 0;
    }
    .combo-option {
      padding: 8px 12px;
      cursor: pointer;
    }
    .combo-option:hover {
      background: #f8fafc;
    }
  </style>
</head>
<body>
  <header class="page-header">
    <div>
      <h1>Input Transaksi Kas</h1>
      <p>Gunakan form ini untuk mencatat transaksi kas masuk/keluar sebagai bahan entry jurnal.</p>
    </div>
    <div class="nav-actions">
      <button class="add-btn" type="button" id="addBtn">Tambah</button>
      <button class="home-btn" type="button" onclick="window.location.href='index.html'">Home</button>
      <button class="back-btn" type="button" onclick="window.history.back()">Kembali</button>
    </div>
  </header>
  <div class="page-section">
    <div class="stack">
      <div class="card">

        <form id="formKas" method="POST" target="hidden_iframe" enctype="multipart/form-data">
          <label for="tanggal">Tanggal Transaksi</label>
          <input id="tanggal" name="tanggal" type="date" required />

          <label for="jenis">Jenis Transaksi</label>
          <select id="jenis" name="jenis" required>
            <option value="">Pilih jenis transaksi</option>
            <option value="kas-masuk">Kas Masuk</option>
            <option value="kas-keluar">Kas Keluar</option>
          </select>

          <div id="kasMasukFields" style="display:none;">
            <label for="kasMasukSumber">Kas Masuk dari</label>
            <div class="combo">
              <input
                type="text"
                id="kasMasukSumber"
                name="kasMasukSumber"
                placeholder="Ketik nama akun..."
                autocomplete="off"
                role="combobox"
                aria-expanded="false"
                aria-controls="kasMasukSumberList"
              />
              <div class="combo-list" id="kasMasukSumberList" role="listbox"></div>
            </div>
            <div id="kasMasukStatus" class="rekening-status info" style="display:none;"></div>
          </div>

          <div id="kasMasukDetail" style="display:none;">
            <label for="kasMasukJumlah">Jumlah (Rp)</label>
            <input id="kasMasukJumlah" name="kasMasukJumlah" type="number" min="0" step="1000" placeholder="Masukkan nominal" />

            <label for="kasMasukBank">Rekening penerima</label>
            <select id="kasMasukBank" name="kasMasukBank">
              <option value="">Menunggu data master...</option>
            </select>

            <label for="kasMasukKet">Keterangan (maks. 500 huruf)</label>
            <textarea id="kasMasukKet" name="kasMasukKet" maxlength="500" placeholder="Tambahkan informasi tambahan jika diperlukan" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #d4d6dd;font-size:14px;height:90px;"></textarea>

            <label for="kasMasukNoBukti">Nomor Bukti (Opsional)</label>
            <input type="text" id="kasMasukNoBukti" name="kasMasukNoBukti" placeholder="Biarkan kosong untuk auto-generate (00001)" />

            <label for="kasMasukBukti">Upload Bukti Transfer Jika ada</label>
            <input class="file-input" id="kasMasukBukti" name="kasMasukBukti" type="file" accept="image/*,.pdf" />
          </div>

          <div id="kasKeluarFields" style="display:none;">
          <label for="kasKeluarAkun">Kas Keluar ke</label>
          <div class="combo">
            <input
              type="text"
              id="kasKeluarAkun"
              name="kasKeluarAkun"
              placeholder="Ketik akun biaya/tujuan..."
              autocomplete="off"
              role="combobox"
              aria-expanded="false"
              aria-controls="kasKeluarAkunList"
            />
            <div class="combo-list" id="kasKeluarAkunList" role="listbox"></div>
          </div>

          <label for="kasKeluarBank">Transfer dari rekening</label>
          <select id="kasKeluarBank" name="kasKeluarBank">
            <option value="">Menunggu data master...</option>
          </select>

          <label for="kasKeluarJumlah">Jumlah (Rp)</label>
          <input id="kasKeluarJumlah" name="kasKeluarJumlah" type="number" min="0" step="1000" placeholder="Masukkan nominal" />

            <label for="kasKeluarKet">Keterangan (maks. 500 huruf)</label>
            <textarea id="kasKeluarKet" name="kasKeluarKet" maxlength="500" placeholder="Tambahkan informasi tambahan jika diperlukan" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #d4d6dd;font-size:14px;height:90px;"></textarea>

            <label for="kasKeluarNoBukti">Nomor Bukti (Opsional)</label>
            <input type="text" id="kasKeluarNoBukti" name="kasKeluarNoBukti" placeholder="Biarkan kosong untuk auto-generate (00001)" />

            <label for="kasKeluarBukti">Upload Bukti Pengeluaran</label>
            <input class="file-input" id="kasKeluarBukti" name="kasKeluarBukti" type="file" accept="image/*,.pdf" />
          </div>

          <input type="hidden" id="akunFinal" name="akun" />
          <input type="hidden" id="hiddenJumlah" name="jumlah" />
          <input type="hidden" id="hiddenBank" name="bank" />
          <input type="hidden" id="hiddenKet" name="keterangan" />
          <input type="hidden" id="buktiFinal" name="bukti" />
          <input type="hidden" id="hiddenNoBukti" name="no_bukti_manual" />

          <div class="actions-row">
            <button type="submit">Simpan</button>
          </div>
          <div class="small">Validasi: tanggal wajib diisi dan jenis transaksi harus dipilih.</div>
          <div id="statusBox" class="status" aria-live="polite"></div>
        </form>
        <iframe name="hidden_iframe" style="display:none;"></iframe>
      </div>

      <div class="card">
        <h2>Preview Input Terakhir</h2>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:1px solid #ececec;padding:8px;">Field</th>
              <th style="text-align:left;border-bottom:1px solid #ececec;padding:8px;">Nilai</th>
            </tr>
          </thead>
          <tbody id="previewBody">
            <tr><td colspan="2" style="padding:8px;color:#94a3b8;">Belum ada input.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <aside class="stack side-panel">
      <div class="card">
        <h2>Tarik Data</h2>
        <p>Filter rentang tanggal dan jenis transaksi untuk melihat ringkasannya.</p>
        <form id="filterForm">
          <label for="filterMulai">Mulai tanggal</label>
          <input id="filterMulai" name="mulai" type="date" />

          <label for="filterSampai">Sampai tanggal</label>
          <input id="filterSampai" name="sampai" type="date" />

          <label for="filterJenis">Jenis</label>
          <select id="filterJenis" name="filterJenis">
            <option value="">Semua</option>
            <option value="kas-masuk">Kas Masuk</option>
            <option value="kas-keluar">Kas Keluar</option>
          </select>

          <label for="filterKasMasuk">Kas Masuk dari</label>
          <select id="filterKasMasuk" name="filterKasMasuk">
            <option value="">Semua sumber kas masuk</option>
          </select>

          <label for="filterKasKeluar">Tujuan Kas Keluar</label>
          <select id="filterKasKeluar" name="filterKasKeluar">
            <option value="">Semua tujuan kas keluar</option>
          </select>

          <div class="actions-row">
            <button type="submit" style="background:linear-gradient(135deg,#16a34a,#15803d);">Terapkan Filter</button>
            <button type="button" id="filterSheetBtn" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);">Tarik Data</button>
          </div>
          <div id="filterStatus" class="status info" aria-live="polite" style="display:none;"></div>
        </form>
      </div>
    </aside>
  </div>

  <div id="addPanelOverlay" class="add-panel-backdrop" style="display:none;">
    <div class="add-panel" id="addChoicePanel" role="dialog" aria-modal="true" aria-labelledby="addPanelTitle">
      <div class="add-panel-header">
        <h3 id="addPanelTitle" class="add-panel-title">Tambah data</h3>
        <button type="button" class="add-panel-close" id="closeAddPanel" aria-label="Tutup panel">X</button>
      </div>
      <p class="add-panel-sub">Mau tambah apa?</p>
      <div class="add-panel-actions">
        <button type="button" data-action="rekening">Tambah Nomor Rekening</button>
        <button type="button" data-action="akun-transaksi">Tambah Akun Transaksi</button>
      </div>
    </div>

    <div class="add-panel" id="rekeningPanel" role="dialog" aria-modal="true" aria-labelledby="rekeningPanelTitle" style="display:none;">
      <div class="add-panel-header">
        <h3 id="rekeningPanelTitle" class="add-panel-title">Kelola Nomor Rekening</h3>
        <button type="button" class="add-panel-close" id="closeRekeningPanel" aria-label="Tutup panel">X</button>
      </div>
      <p class="add-panel-sub">Tambah atau hapus nomor rekening yang terhubung ke spreadsheet.</p>
      <form id="rekeningForm" class="rekening-form">
        <div>
          <label for="rekeningNama">Nama bank/akun</label>
          <select id="rekeningNama" name="rekeningNama" required>
            <option value="">Pilih bank/akun</option>
            <option value="Bank BRI">Bank BRI</option>
            <option value="Bank Mandiri">Bank Mandiri</option>
            <option value="BNI">BNI</option>
            <option value="BSI">BSI</option>
            <option value="Bank BTN">Bank BTN</option>
            <option value="Bank BCA">Bank BCA</option>
            <option value="Dana">Dana</option>
            <option value="Gopay">Gopay</option>
            <option value="OVO">OVO</option>
            <option value="Link Aja">Link Aja</option>
          </select>
        </div>
        <div>
          <label for="rekeningNomor">Nomor rekening</label>
          <input type="text" id="rekeningNomor" name="rekeningNomor" placeholder="Masukkan nomor rekening" required />
        </div>
        <div>
          <label for="rekeningJenis">Jenis</label>
          <select id="rekeningJenis" name="rekeningJenis">
            <option value="bank">Bank</option>
            <option value="ewallet">E-Wallet</option>
            <option value="lainnya">Lainnya</option>
          </select>
        </div>
        <div class="inline-actions">
          <button type="submit" class="btn-save">Simpan ke Spreadsheet</button>
          <button type="button" class="btn-delete" id="deleteRekeningBtn">Hapus nomor</button>
          <button type="button" class="btn-back" id="backToChoice">Kembali</button>
        </div>
        <div id="rekeningStatus" class="rekening-status info"></div>
      </form>
    </div>

    <div class="add-panel" id="akunPanel" role="dialog" aria-modal="true" aria-labelledby="akunPanelTitle" style="display:none;">
      <div class="add-panel-header">
        <h3 id="akunPanelTitle" class="add-panel-title">Tambah Akun Transaksi</h3>
        <button type="button" class="add-panel-close" id="closeAkunPanel" aria-label="Tutup panel">X</button>
      </div>
      <p class="add-panel-sub">Buat atau simpan akun transaksi ke spreadsheet.</p>
      <form id="akunForm" class="rekening-form">
        <div>
          <label for="akunKategori">Kategori</label>
          <select id="akunKategori" name="akunKategori">
            <option value="Harta Lancar">Harta Lancar</option>
            <option value="Aset Tetap">Aset Tetap</option>
            <option value="Kewajiban">Kewajiban</option>
            <option value="Modal">Modal</option>
            <option value="Pendapata">Pendapata</option>
            <option value="HPP">HPP</option>
            <option value="Beban">Beban</option>
            <option value="Lainlain">Lainlain</option>
          </select>
        </div>
        <div>
          <label for="akunNama">Nama Akun</label>
          <input type="text" id="akunNama" name="akunNama" list="akunNamaList" placeholder="Contoh: Kas Operasional" autocomplete="off" required />
          <datalist id="akunNamaList"></datalist>
        </div>
        <div>
          <label for="akunKode">Kode Akun (Otomatis)</label>
          <div style="display:flex; gap: 8px;">
            <input type="text" id="akunKode" name="akunKode" placeholder="Pilih kategori dulu" readonly required />
            <button type="button" id="btnGenerateKode" style="width:auto; padding:0 12px;">Generate</button>
          </div>
        </div>
        <div class="inline-actions">
          <button type="submit" class="btn-save">Simpan ke Spreadsheet</button>
          <button type="button" class="btn-back" id="backToChoiceAkun">Kembali</button>
        </div>
        <div id="akunStatus" class="akun-status info"></div>
      </form>
    </div>
  </div>

  <dialog id="configDialog">
    <form method="dialog" id="configForm">
      <h2>Pengaturan Spreadsheet</h2>
      <label for="configScriptUrl">Apps Script URL</label>
      <input type="url" id="configScriptUrl" placeholder="https://script.google.com/macros/s/..." />

      <label for="configSheetId">ID Spreadsheet</label>
      <input type="text" id="configSheetId" placeholder="1abcDEF..." />

      <div class="dialog-actions">
        <button class="btn-outline" type="button" id="cancelConfig">Batal</button>
        <button class="btn" type="submit">Simpan</button>
      </div>
    </form>
  </dialog>

  <script>
    // --- 1. KONFIGURASI SUPABASE ---
    // Ganti dengan URL dan ANON KEY dari Dashboard Supabase Anda
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "EYJ... (sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN) ...";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // --- 2. VARIABEL ELEMENT HTML (Sama seperti sebelumnya) ---
    const formKas = document.getElementById("formKas");
    const jenisSelect = document.getElementById("jenis");
    const statusBox = document.getElementById("statusBox");

    // Elemen Input
    const kasMasukFields = document.getElementById("kasMasukFields");
    const kasMasukDetail = document.getElementById("kasMasukDetail");
    const kasMasukSumber = document.getElementById("kasMasukSumber");
    const kasMasukJumlah = document.getElementById("kasMasukJumlah");
    const kasMasukBank = document.getElementById("kasMasukBank");
    const kasMasukKet = document.getElementById("kasMasukKet");
    const kasMasukBukti = document.getElementById("kasMasukBukti");

    const kasKeluarFields = document.getElementById("kasKeluarFields");
    const kasKeluarAkun = document.getElementById("kasKeluarAkun");
    const kasKeluarJumlah = document.getElementById("kasKeluarJumlah");
    const kasKeluarBank = document.getElementById("kasKeluarBank");
    const kasKeluarKet = document.getElementById("kasKeluarKet");
    const kasKeluarBukti = document.getElementById("kasKeluarBukti");

    // --- 3. LOGIKA TAMPILAN (UI) ---
    document.getElementById("tanggal").valueAsDate = new Date();

    jenisSelect.addEventListener("change", function () {
      resetTampilan();
      if (this.value === "kas-masuk") {
        kasMasukFields.style.display = "block";
        kasMasukDetail.style.display = "block";
      } else if (this.value === "kas-keluar") {
        kasKeluarFields.style.display = "block";
      }
    });

    function resetTampilan() {
      kasMasukFields.style.display = "none";
      kasMasukDetail.style.display = "none";
      kasKeluarFields.style.display = "none";
    }

    function setStatus(type, msg) {
      statusBox.className = "status " + type + " show";
      statusBox.innerText = msg;
      statusBox.style.display = "block";
    }

    // --- 4. LOGIKA KIRIM KE DATABASE (INTI PERUBAHAN) ---
    formKas.addEventListener("submit", async function (e) {
      e.preventDefault();
      setStatus("info", "Sedang mengirim ke Database...");

      const jenis = jenisSelect.value;
      const tanggal = document.getElementById("tanggal").value;

      let dataSiapKirim = {};

      if (jenis === "kas-masuk") {
        dataSiapKirim = {
          tanggal,
          jenis_transaksi: "MASUK",
          akun: kasMasukSumber.value,
          jumlah: kasMasukJumlah.value,
          bank_sumber: kasMasukBank.value,
          keterangan: kasMasukKet.value,
          nama_file_bukti: kasMasukBukti.files[0] ? kasMasukBukti.files[0].name : "Tanpa Bukti",
        };
      } else {
        dataSiapKirim = {
          tanggal,
          jenis_transaksi: "KELUAR",
          akun: kasKeluarAkun.value,
          jumlah: kasKeluarJumlah.value,
          bank_sumber: kasKeluarBank.value,
          keterangan: kasKeluarKet.value,
          nama_file_bukti: kasKeluarBukti.files[0] ? kasKeluarBukti.files[0].name : "Tanpa Bukti",
        };
      }

      try {
        const { data, error } = await supabase.from("transaksi").insert([dataSiapKirim]).select();

        if (error) throw error;

        setStatus("success", "✅ Berhasil! Data tersimpan di Database Supabase.");
        console.log("Data tersimpan:", data);

        setTimeout(() => {
          formKas.reset();
          resetTampilan();
          document.getElementById("tanggal").valueAsDate = new Date();
          setStatus("info", "Siap input lagi.");
        }, 2000);
      } catch (err) {
        console.error(err);
        setStatus("error", "❌ Gagal: " + err.message);
      }
    });

    // --- 5. DATA MASTER (OPSIONAL UNTUK TEST) ---
    function isiDropdownBank() {
      const dummyBank = ["Bank BCA", "Bank Mandiri", "Kas Kecil"];
      let html = '<option value="">-- Pilih --</option>';
      dummyBank.forEach((b) => (html += `<option value="${b}">${b}</option>`));
      if (kasMasukBank) kasMasukBank.innerHTML = html;
      if (kasKeluarBank) kasKeluarBank.innerHTML = html;
    }

    isiDropdownBank();
  </script>
</body>
</html>
