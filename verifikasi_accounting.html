<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accounting - Verifikasi & Pembayaran</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Use Shared Config -->
  <script src="app_config.js"></script>
  <script src="auth.js"></script>
  <script>PNAuth.requireAuth(['finance', 'superadmin', 'direksi']);</script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: #64748b;
      /* slate-500 */
      font-weight: 600;
      font-size: 0.9rem;
      border: 1px solid transparent;
    }

    .menu-item:hover {
      background-color: #f8fafc;
      color: #1e293b;
    }

    .menu-item.active {
      background-color: #eff6ff;
      /* blue-50 */
      color: #2563eb;
      /* blue-600 */
      border-color: #dbeafe;
      /* blue-100 */
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .menu-item .icon-box {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      background-color: #f1f5f9;
      color: #94a3b8;
    }

    .menu-item.active .icon-box {
      background-color: #dbeafe;
      color: #2563eb;
    }

    /* Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-up {
      animation: fadeInUp 0.4s ease-out forwards;
    }

    /* Menu Card Styles */
    .menu-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body class="bg-slate-50 font-sans h-screen flex flex-col overflow-hidden">

  <!-- HEADER -->
  <header class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center z-10">
    <div class="flex items-center gap-3">
      <div
        class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
        <i class="fas fa-wallet text-lg"></i>
      </div>
      <div>
        <h1 class="text-xl font-bold text-slate-800 tracking-tight leading-none">Accounting</h1>
        <p class="text-xs text-slate-400 font-medium mt-1">Verifikasi & Eksekusi Pembayaran</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <a href="dashboard_finance.html"
        class="text-slate-500 hover:text-slate-800 font-bold text-xs uppercase tracking-wide bg-slate-100 hover:bg-slate-200 px-4 py-2.5 rounded-lg transition flex items-center gap-2">
        <i class="fas fa-th-large"></i> Dashboard
      </a>
    </div>

  </header>

  <!-- MAIN LAYOUT -->
  <div class="flex flex-1 overflow-hidden">

    <!-- SIDEBAR MENU -->
    <aside class="w-72 bg-white border-r border-slate-200 p-6 flex flex-col gap-2 z-0">
      <div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-2 pl-2">Menu Utama</div>

      <!-- MENU: EKSEKUSI PEMBAYARAN -->
      <div class="menu-item active">
        <div class="icon-box">
          <i class="fas fa-hand-holding-dollar"></i>
        </div>
        <div class="flex-1">
          <div>Eksekusi Pembayaran</div>
          <div class="text-[10px] text-slate-400 font-normal mt-0.5">Siap bayar (Approved)</div>
        </div>
        <div id="badgePayment"
          class="hidden bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold">
          !</div>
      </div>

    </aside>

    <!-- CONTENT AREA -->
    <main class="flex-1 bg-slate-50/50 p-8 overflow-y-auto relative">
      <div id="debugPanel"
        class="hidden mb-4 p-4 bg-red-100 border border-red-300 text-red-700 text-xs rounded font-mono whitespace-pre-wrap overflow-auto max-h-40">
        <strong>DEBUG LOG:</strong>
        <div id="debugContent"></div>
      </div>

      <!-- VIEW: MENU (Dashboard) -->
      <div id="view-menu" class="max-w-5xl mx-auto animate-fade-in-up">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-slate-800">Eksekusi Pembayaran</h2>
          <p class="text-slate-500 mt-1">Pusat kendali pembayaran dan verifikasi transaksi.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- CARD 1: ANTRIAN PEMBAYARAN -->
          <div onclick="switchView('queue')"
            class="menu-card bg-white rounded-2xl p-6 border border-red-100 relative group overflow-hidden">
            <div
              class="absolute top-0 right-0 w-32 h-32 bg-red-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110">
            </div>
            <div class="relative z-10">
              <div class="w-12 h-12 bg-red-100 text-red-600 rounded-xl flex items-center justify-center text-xl mb-4">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              <h3 class="text-lg font-bold text-slate-800 mb-1">Antrian Pembayaran</h3>
              <p class="text-xs text-slate-500 mb-4">Wajib Transfer (Approved Direksi)</p>
              <div class="flex items-baseline gap-2">
                <span id="count-payment" class="text-4xl font-black text-red-600">0</span>
                <span class="text-xs font-bold text-red-400 uppercase">Pending</span>
              </div>
            </div>
          </div>

          <!-- CARD 2: VERIFIKASI KAS KELUAR -->
          <div onclick="switchView('verify')"
            class="menu-card bg-white rounded-2xl p-6 border border-blue-100 relative group overflow-hidden">
            <div
              class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110">
            </div>
            <div class="relative z-10">
              <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl mb-4">
                <i class="fas fa-file-invoice-dollar"></i>
              </div>
              <h3 class="text-lg font-bold text-slate-800 mb-1">Verifikasi Kas Keluar</h3>
              <p class="text-xs text-slate-500 mb-4">Sudah Transfer (Cek Bukti)</p>
              <div class="flex items-baseline gap-2">
                <span id="count-verify" class="text-4xl font-black text-blue-600">0</span>
                <span class="text-xs font-bold text-blue-400 uppercase">Pending</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VIEW: ANTRIAN PEMBAYARAN -->
      <div id="view-queue" class="hidden max-w-6xl mx-auto animate-fade-in-up">
        <div class="mb-6 flex justify-between items-end">
          <div>
            <button onclick="switchView('menu')"
              class="text-xs font-bold text-slate-400 hover:text-slate-600 mb-2 flex items-center gap-1 transition">
              <i class="fas fa-arrow-left"></i> KEMBALI KE MENU
            </button>
            <h2 class="text-2xl font-bold text-red-700">Antrian Pembayaran</h2>
            <p class="text-slate-500 mt-1">Segera lakukan transfer untuk transaksi di bawah ini.</p>
          </div>
          <button onclick="loadPaymentQueue()" class="text-slate-400 hover:text-green-600 transition"><i
              class="fas fa-sync-alt"></i></button>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-red-200 overflow-hidden mb-8">
          <div class="bg-red-50 border-b border-red-100 p-4 flex gap-3 items-center text-red-800 text-sm">
            <i class="fas fa-exclamation-circle text-lg"></i>
            <span>Data Pengajuan Biaya yang sudah <b>Approved Direksi</b>.</span>
          </div>
          <table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 text-slate-600 uppercase text-xs font-bold border-b border-slate-200">
              <tr>
                <th class="p-4 pl-6 w-32">Tanggal</th>
                <th class="p-4">Keterangan Pengajuan</th>
                <th class="p-4 text-right w-40">Nominal</th>
                <th class="p-4 text-center w-32">Status</th>
                <th class="p-4 text-center w-40 pr-6">Aksi</th>
              </tr>
            </thead>
            <tbody id="bodyPaymentQueue">
              <tr>
                <td colspan="5" class="p-10 text-center text-slate-400">Memuat antrian pembayaran...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- VIEW: VERIFIKASI KAS KELUAR -->
      <div id="view-verify" class="hidden max-w-6xl mx-auto animate-fade-in-up">
        <div class="mb-6 flex justify-between items-end">
          <div>
            <button onclick="switchView('menu')"
              class="text-xs font-bold text-slate-400 hover:text-slate-600 mb-2 flex items-center gap-1 transition">
              <i class="fas fa-arrow-left"></i> KEMBALI KE MENU
            </button>
            <h2 class="text-2xl font-bold text-blue-700">Verifikasi Kas Keluar</h2>
            <p class="text-slate-500 mt-1">Validasi bukti transfer dan posting jurnal.</p>
          </div>
          <button onclick="loadPaymentQueue()" class="text-slate-400 hover:text-blue-600 transition"><i
              class="fas fa-sync-alt"></i></button>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-blue-200 overflow-hidden">
          <div class="bg-blue-50 border-b border-blue-100 p-4 flex gap-3 items-center text-blue-800 text-sm">
            <i class="fas fa-check-circle text-lg"></i>
            <span>Data Kas Keluar yang sudah diinput/scan.</span>
          </div>
          <table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 text-slate-600 uppercase text-xs font-bold border-b border-slate-200">
              <tr>
                <th class="p-4 pl-6 w-32">Tanggal</th>
                <th class="p-4">Keterangan Transaksi</th>
                <th class="p-4 text-right w-40">Nominal</th>
                <th class="p-4 text-center w-32">Status</th>
                <th class="p-4 text-center w-40 pr-6">Aksi</th>
              </tr>
            </thead>
            <tbody id="bodyVerifQueue">
              <tr>
                <td colspan="5" class="p-10 text-center text-slate-400">Memuat antrian verifikasi...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <script>
    window.onerror = function (msg, url, line, col, error) {
      alert("Global Error: " + msg + "\nLine: " + line);
      document.getElementById('debugContent').innerHTML += `<div class="text-red-500 font-bold">FATAL: ${msg} at line ${line}</div>`;
      document.getElementById('debugPanel').classList.remove('hidden');
      return false;
    };
  </script>
  <script>
    // Use Shared Client
    // Use Shared Client & Format from app_config.js
    // Variables 'client' and 'fmt' are already globally available.
    // We only create local references if needed, but better to use global directly or alias safely.

    // Safety check
    if (typeof client === 'undefined') console.error("FATAL: Client not loaded from app_config.js");
    if (typeof fmt === 'undefined') console.error("FATAL: fmt function not loaded from app_config.js");

    // --- TAB SWITCHER (REMOVED - Single View Mode) ---
    // Previously used to switch between 'expense' and 'payment'.
    // Now defaults to Payment view only.

    window.onload = function () {
      loadPaymentQueue();
    };

    // --- 2. PAYMENT EXECUTION ---
    // --- NAVIGATION LOGIC ---
    function switchView(viewName) {
      const views = ['menu', 'queue', 'verify'];
      views.forEach(v => {
        document.getElementById(`view-${v}`).classList.add('hidden');
      });
      document.getElementById(`view-${viewName}`).classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    // --- 2. PAYMENT EXECUTION & VERIFICATION ---
    async function loadPaymentQueue() {
      const tbodyQueue = document.getElementById("bodyPaymentQueue");
      const tbodyVerif = document.getElementById("bodyVerifQueue");

      const loadingRow = `<tr><td colspan="5" class="p-12 text-center text-slate-400"><i class="fas fa-circle-notch fa-spin mr-2"></i> Memuat data...</td></tr>`;
      tbodyQueue.innerHTML = loadingRow;
      tbodyVerif.innerHTML = loadingRow;

      try {
        // 1. Fetch Transaksi (Pengajuan Biaya -> APPROVED, Kas Keluar -> APPROVED_BY_DIREKSI)
        const p1 = client.from('transaksi')
          .select('*')
          .in('jenis_transaksi', ['APPROVED', 'APPROVED_BY_DIREKSI'])
          .order('tanggal', { ascending: false });

        // 2. Fetch Transaksi Upah
        const p2 = client.from('transaksi_upah')
          .select('*')
          .in('status', ['APPROVED', 'APPROVED_BY_DIREKSI'])
          .order('tanggal_bayar', { ascending: false });

        const [resTrans, resUpah] = await Promise.all([p1, p2]);

        const dataTrans = resTrans.data || [];
        const dataUpah = resUpah.data || [];

        const queueData = []; // Antrian Pembayaran (APPROVED)
        const verifData = []; // Verifikasi Kas Keluar (APPROVED_BY_DIREKSI)

        // Map Transaksi
        dataTrans.forEach(t => {
          let desc = (t.keterangan || "").replace(/\[REQ:.*?\]/g, '').trim();
          if (desc.startsWith('[')) {
            const match = desc.match(/^\[(.*?)\] (.*)$/);
            if (match) desc = match[2];
          }
          const item = {
            type: 'EXPENSE', id: t.id, date: t.tanggal,
            desc: `[Biaya] ${desc}`, amount: t.jumlah,
            rawStatus: t.jenis_transaksi,
            // Helper to identify source
            isKasKeluar: (t.akun && t.bank_sumber)
          };

          if (t.jenis_transaksi === 'APPROVED') queueData.push(item);
          else if (t.jenis_transaksi === 'APPROVED_BY_DIREKSI') verifData.push(item);
        });

        // Map Upah
        dataUpah.forEach(u => {
          const item = {
            type: 'UPAH', id: u.id, date: u.tanggal_bayar,
            desc: `[Upah] ${u.nama_pekerjaan} (${u.kavling})`, amount: u.nilai_bayar,
            rawStatus: u.status
          };
          if (u.status === 'APPROVED') queueData.push(item);
          else if (u.status === 'APPROVED_BY_DIREKSI') verifData.push(item);
        });

        // Sort Both
        queueData.sort((a, b) => new Date(b.date) - new Date(a.date));
        verifData.sort((a, b) => new Date(b.date) - new Date(a.date));

        // Update DASHBOARD COUNTS
        const elCountPay = document.getElementById('count-payment');
        const elCountVerif = document.getElementById('count-verify');
        if (elCountPay) elCountPay.innerText = queueData.length;
        if (elCountVerif) elCountVerif.innerText = verifData.length;

        // Update Sidebar Badge (Total)
        const totalPending = queueData.length + verifData.length;
        const badge = document.getElementById('badgePayment');
        if (badge) {
          if (totalPending > 0) {
            badge.innerText = totalPending;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }

        // RENDER QUEUE (Antrian Pembayaran)
        if (queueData.length === 0) {
          tbodyQueue.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-400 italic">Tidak ada antrian pembayaran.</td></tr>`;
        } else {
          tbodyQueue.innerHTML = "";
          queueData.forEach(item => {
            tbodyQueue.innerHTML += `
                     <tr class="hover:bg-red-50/20 border-b border-slate-100 last:border-0 transition">
                         <td class="p-4 pl-6 text-sm text-slate-500">${new Date(item.date).toLocaleDateString()}</td>
                         <td class="p-4 text-sm font-bold text-slate-700">${item.desc}</td>
                         <td class="p-4 text-right font-mono font-bold text-slate-800">${fmt(item.amount)}</td>
                         <td class="p-4 text-center"><span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-[10px] font-bold">SIAP BAYAR</span></td>
                         <td class="p-4 text-center pr-6">
                            <button onclick="executePayment('${item.type}', ${item.id}, 'PAY')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded shadow-sm text-xs font-bold transition flex items-center gap-2 mx-auto">
                                <i class="fas fa-money-bill-wave"></i> BAYAR & CATAT
                            </button>
                         </td>
                     </tr>
                `;
          });
        }

        // RENDER VERIF (Verifikasi Kas Keluar)
        if (verifData.length === 0) {
          tbodyVerif.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-400 italic">Tidak ada data verifikasi kas keluar.</td></tr>`;
        } else {
          tbodyVerif.innerHTML = "";
          verifData.forEach(item => {
            tbodyVerif.innerHTML += `
                     <tr class="hover:bg-blue-50/20 border-b border-slate-100 last:border-0 transition">
                         <td class="p-4 pl-6 text-sm text-slate-500">${new Date(item.date).toLocaleDateString()}</td>
                         <td class="p-4 text-sm font-bold text-slate-700">${item.desc}</td>
                         <td class="p-4 text-right font-mono font-bold text-slate-800">${fmt(item.amount)}</td>
                         <td class="p-4 text-center"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold">SUDAH TRANSFER</span></td>
                         <td class="p-4 text-center pr-6">
                            <button onclick="executePayment('${item.type}', ${item.id}, 'VERIFY')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded shadow-sm text-xs font-bold transition flex items-center gap-2 mx-auto">
                                <i class="fas fa-check-double"></i> VALIDASI & POSTING
                            </button>
                         </td>
                     </tr>
                `;
          });
        }


      } catch (err) {
        console.error("Load Payment Error", err);
        tbodyQueue.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500">Error: ${err.message}</td></tr>`;
      }
    }

    async function executePayment(type, id, mode = 'PAY') {
      let confirmMsg = "⚠️ KONFIRMASI PEMBAYARAN\n\nPastikan Anda sudah melakukan transfer/pembayaran real.\nSistem akan mencatat aset Kas berkurang dan status menjadi LUNAS.\n\nLanjut?";

      if (mode === 'VERIFY') {
        confirmMsg = "✅ VALIDASI KAS KELUAR\n\nData ini sudah ditransfer (Ada Bukti).\nSistem akan memposting jurnal transaksi ini.\n\nLanjut Validasi?";
      }

      if (!confirm(confirmMsg)) return;

      try {
        if (type === 'EXPENSE') {
          // 1. Fetch Transaksi Detail
          const { data: tr, error: errFetch } = await client.from('transaksi').select('*').eq('id', id).single();
          if (errFetch || !tr) throw new Error("Data transaksi tidak ditemukan");

          // 2. AUTO JOURNAL LOGIC
          // For 'VERIFY', data usually complete (Kas Keluar).
          // For 'PAY', data from Request might lack Source Bank.

          // HARDCODE DEFAULT SOURCE IF MISSING (For 'PAY' mode usually)
          // Ideally UI should ask, but for speed we default to 'Kas Besar' or 'Bank BRI' if known, 
          // OR we just fail if missing. 
          // Current logic checks `tr.akun && tr.bank_sumber`.

          let sourceBank = tr.bank_sumber;
          // If PAY mode and no source, default to a Main Bank or keep null to trigger error?
          // Let's assume for now we strictly require it or maybe user will edit it. 
          // But user wants "Direct".
          // If 'PAY' mode, we might need to assume 'Bank BRI (Escrow)' if not set? 
          // Let's stick to existing logic: if missing, maybe we can't journal automatically?

          if (tr.akun && tr.bank_sumber) {
            // --- MODE: AUTO JOURNAL (KAS KELUAR / VERIFY) ---
            const refNo = (mode === 'VERIFY' ? "V-OUT-" : "PAY-") + tr.id;
            let jurnalPayload = [];

            // Split Logic (Proyek)
            if (tr.nama_proyek && tr.nama_proyek.includes(',')) {
              const listProyek = tr.nama_proyek.split(',').map(p => p.trim()).filter(Boolean);
              const nominalPerProyek = tr.jumlah / listProyek.length;

              listProyek.forEach(p => {
                jurnalPayload.push({
                  tanggal: tr.tanggal,
                  nomor_referensi: refNo,
                  keterangan: `${tr.keterangan} [Alokasi: ${p}]`,
                  nama_akun: tr.akun, // Debit (Beban)
                  debit: nominalPerProyek,
                  kredit: 0,
                  project_code: p
                });
                // Credit (Source)
                jurnalPayload.push({
                  tanggal: tr.tanggal,
                  nomor_referensi: refNo,
                  keterangan: `${tr.keterangan} [Credit]`,
                  nama_akun: sourceBank, // Credit (Kas)
                  debit: 0,
                  kredit: nominalPerProyek,
                  project_code: p
                });
              });
            } else {
              // Single Project
              jurnalPayload.push({
                tanggal: tr.tanggal,
                nomor_referensi: refNo,
                keterangan: tr.keterangan,
                nama_akun: tr.akun, // Debit
                debit: tr.jumlah,
                kredit: 0,
                project_code: tr.nama_proyek || 'UMUM'
              });
              jurnalPayload.push({
                tanggal: tr.tanggal,
                nomor_referensi: refNo,
                keterangan: tr.keterangan,
                nama_akun: sourceBank, // Credit
                debit: 0,
                kredit: tr.jumlah,
                project_code: tr.nama_proyek || 'UMUM'
              });
            }

            // POST JURNAL
            const { error: errJ } = await client.from('jurnal_umum').insert(jurnalPayload);
            if (errJ) throw new Error("Gagal posting jurnal: " + errJ.message);
          }
          // If 'PAY' mode and Accounts missing, we just update status to LUNAS (Manual Journal later?)
          // But User wanted "Posting ke Jurnal". 
          // If data comes from 'Pengajuan Biaya', commonly it lacks 'bank_sumber'.
          // We will update status to 'LUNAS' anyway.

          // 3. UPDATE STATUS
          const { error: errUp } = await client.from('transaksi')
            .update({ jenis_transaksi: 'LUNAS' }) // Final Status
            .eq('id', id);

          if (errUp) throw new Error("Gagal update status: " + errUp.message);

        } else if (type === 'UPAH') {
          // Upah Logic (Existing)
          const { error } = await client.from('transaksi_upah').update({ status: 'LUNAS' }).eq('id', id);
          if (error) throw error;
        }

        alert("✅ Transaksi Berhasil Diproses!");
        loadPaymentQueue(); // Reload
      } catch (err) {
        alert("Gagal: " + err.message);
      }
    }


    // --- 5. SELF-HEALING: SYNC MISSING APPROVALS ---
    // Fix case where Direksi Approved in Queue but Transaction status didn't update
    async function healMissedApprovals() {
      console.log("Starting Healing Routine...");
      try {
        // 1. Get Approved Queue Items from today
        const today = new Date().toISOString().split('T')[0];
        const { data: approvedQueue } = await client
          .from('approval_queue')
          .select('*')
          .eq('status', 'APPROVED')
          .gte('created_at', today);

        if (!approvedQueue || approvedQueue.length === 0) {
          console.log("No approved queue items found today.");
          return;
        }

        console.log(`Found ${approvedQueue.length} approved items. Checking trans status...`);

        let fixCount = 0;
        for (const q of approvedQueue) {
          // Determine Source Table
          if (q.source_table !== 'transaksi') continue;

          // If source_id is valid, check transaction status
          if (q.source_id && q.source_id != 0) {
            const { data: tr } = await client.from('transaksi').select('jenis_transaksi').eq('id', q.source_id).single();
            if (tr && tr.jenis_transaksi === 'PENGAJUAN') {
              console.log(`Fixing Sync ID ${q.source_id}`);
              await client.from('transaksi').update({ jenis_transaksi: 'APPROVED_BY_DIREKSI' }).eq('id', q.source_id);
              fixCount++;
            }
          }
          // If source_id is 0, we try to find the transaction by content
          else {
            // Find pending transaction with same amount & desc (approx)
            const { data: candidates } = await client
              .from('transaksi')
              .select('*')
              .eq('jenis_transaksi', 'PENGAJUAN')
              .eq('jumlah', q.amount)
              .gte('tanggal', today);

            if (candidates && candidates.length > 0) {
              // Pick matches
              const match = candidates.find(c => c.keterangan === q.description) || candidates[0];
              console.log(`Found orphaned transaction for Queue ${q.id} -> Trans ID ${match.id}`);

              // Fix Transaction
              await client.from('transaksi').update({ jenis_transaksi: 'APPROVED_BY_DIREKSI' }).eq('id', match.id);
              // Fix Queue Source ID
              await client.from('approval_queue').update({ source_id: match.id }).eq('id', q.id);
              fixCount++;
            }
          }
        }

        if (fixCount > 0) {
          console.log(`Healed ${fixCount} items. Reloading view.`);
          alert(`System: ${fixCount} data approval berhasil disinkronisasi.`);
          loadPaymentQueue();
        }

      } catch (err) {
        console.warn("Healing error:", err);
      }
    }

    // Init


    // Run Healing 2 seconds after load
    setTimeout(healMissedApprovals, 2000);

    // Auto refresh payment queue once
    setTimeout(loadPaymentQueue, 2500);

  </script>
  <div id="debugPanel"
    class="hidden fixed bottom-4 left-4 right-4 bg-black/80 text-green-400 p-4 rounded font-mono text-xs z-50 overflow-y-auto max-h-48">
    <div class="flex justify-between mb-2 border-b border-green-800 pb-1">
      <b>DEBUG LOG</b>
      <button onclick="document.getElementById('debugPanel').classList.add('hidden')"
        class="text-red-400 hover:text-white">x</button>
    </div>
    <div id="debugContent"></div>
  </div>
  <script>
    // Overwrite console.log to show in debug panel
    const dbg = document.getElementById('debugContent');
    const oldLog = console.log;
    console.log = function (...args) {
      oldLog.apply(console, args);
      if (dbg) dbg.innerHTML += `<div>> ${args.join(' ')}</div>`;
    };
    const oldErr = console.error;
    console.error = function (...args) {
      oldErr.apply(console, args);
      if (dbg) dbg.innerHTML += `<div class="text-red-400">> ERROR: ${args.join(' ')}</div>`;
    };
    const oldWarn = console.warn;
    console.warn = function (...args) {
      oldWarn.apply(console, args);
      if (dbg) dbg.innerHTML += `<div class="text-yellow-400">> WARN: ${args.join(' ')}</div>`;
    };

    // Show Debug Panel with hotkey (Shift + D)
    document.addEventListener('keydown', (e) => {
      if (e.shiftKey && e.key === 'D') {
        document.getElementById('debugPanel').classList.toggle('hidden');
      }
    });

    // Make debug visible if URL param debug=true
    if (window.location.search.includes('debug=true')) {
      document.getElementById('debugPanel').classList.remove('hidden');
    }
  </script>
</body>

</html>