<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upah Tukang - Siteplan & Progress</title>
  <style>
    :root {
      --bg: #f4f6f9;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .hidden { display: none !important; }
    header {
      padding: 18px 28px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(15,23,42,0.08);
    }
    .header-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
    }
    header p {
      margin: 4px 0 0;
      color: var(--muted);
    }
    .back-btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-weight: 600;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(239,68,68,0.3);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .back-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(239,68,68,0.3);
    }
    main {
      flex: 1;
      padding: 20px;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
      align-items: start;
      height: calc(100vh - 120px);
    }
    .panels-header {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
      margin: 0 0 4px;
      color: #0f172a;
      font-weight: 700;
      font-size: 14px;
    }
    .sitepanel {
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(15,23,42,0.12);
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 100%;
      min-height: 0;
    }
    .sitepanel iframe {
      width: 100%;
      height: 100%;
      border: none;
      min-height: 70vh;
    }
    .siteplan-wrapper {
      width: 100%;
      flex: 1;
      overflow: auto;
      background: #fff;
    }
    .legend {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px 4px;
      flex-wrap: nowrap;
      overflow-x: auto;
      white-space: nowrap;
    }
    .legend .title {
      font-weight: 700;
      font-size: 13px;
      color: #0f172a;
      margin-right: 6px;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #475569;
      padding: 4px 8px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #f8fafc;
    }
    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
    }
    .siteplan-wrapper svg {
      width: 100%;
      height: auto;
      display: block;
    }
    /* ===== INTERACTIVE LOTS (SAFE + UNIVERSAL) ===== */
.siteplan-wrapper svg [data-unit-id]{
  fill: var(--lot-fill, #ffffff);
  stroke: #0f172a !important;
  stroke-width: 1 !important;
  cursor: pointer;
  transition: fill .2s ease, stroke .2s ease, filter .2s ease, opacity .2s ease;
  vector-effect: non-scaling-stroke;
}
.siteplan-wrapper svg [data-unit-id]:hover{
  filter: drop-shadow(0 0 6px rgba(15,23,42,0.25));
}

/* selected: cocok dengan JS yang menambah class "selected" */
.siteplan-wrapper svg [data-unit-id].selected{
  stroke: #25eb32ff !important;
  stroke-width: 3 !important;
  filter: drop-shadow(0 0 8px rgba(15,23,42,0.25));
}

/* ===== STATUS COLORS ===== */
.siteplan-wrapper svg [data-unit-id][data-status="ready-stok"]{
  fill: #d1fae5 !important;
  stroke: #166534 !important;
}

.siteplan-wrapper svg [data-unit-id][data-status="sold"],
.siteplan-wrapper svg [data-unit-id][data-status="laku"]{
  fill: #cbd5e1 !important;
  stroke: #334155 !important;
  opacity: .95;
}

.siteplan-wrapper svg [data-unit-id][data-status="proses-berkas"],
.siteplan-wrapper svg [data-unit-id][data-status="berkas"]{
  fill: #fde68a !important;
  stroke: #92400e !important;
}

.siteplan-wrapper svg [data-unit-id][data-status="konstruksi"],
.siteplan-wrapper svg [data-unit-id][data-status="on-progress"]{
  fill: #bfdbfe !important;
  stroke: #1d4ed8 !important;
}

.siteplan-wrapper svg [data-unit-id][data-status="booking"],
.siteplan-wrapper svg [data-unit-id][data-status="hold"]{
  fill: #fbcfe8 !important;
  stroke: #9d174d !important;
}

    .detailpanel {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 15px 35px rgba(15,23,42,0.15);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border: 1px solid var(--border);
      max-height: 100%;
      min-height: 0;
      overflow: hidden;
    }
    .lot-info {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6;
    }
    .lot-info strong {
      color: var(--text);
    }
    .lot-summary{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-top:8px;
    }
    .edit-btn{
      border:none;
      border-radius:999px;
      padding:9px 16px;
      font-size:13px;
      font-weight:600;
      background:linear-gradient(135deg,#22c55e,#15803d);
      color:#fff;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(21,128,61,0.25);
    }
    .edit-panel{
      margin-top:12px;
      padding:14px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#f8fafc;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .edit-panel label{
      font-size:12px;
      font-weight:600;
      color:var(--text);
    }
    .edit-panel select,
    .edit-panel input{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:13px;
      background:#fff;
    }
    .edit-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:4px;
    }
    .edit-actions button{
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .edit-actions .secondary{
      background:#e2e8f0;
      color:#0f172a;
    }
    .edit-actions .primary{
      background:linear-gradient(135deg,#2563eb,#1d4ed8);
      color:#fff;
    }
    .table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 260px);
      flex: 1;
      min-height: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 520px;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #edeff3;
      font-size: 13px;
      text-align: left;
    }
    th {
      background: #d7e3f3;
      font-weight: 600;
      color: #0f172a;
    }
    .stage {
      text-align: center;
      font-weight: 600;
      background: #f8fafc;
    }
    .subtotal {
      background: #d1fadf;
      font-weight: 600;
    }
    .grand-total {
      background: #22c55e;
      color: #fff;
      font-weight: 700;
    }
    .amount {
      text-align: right;
      font-family: "Roboto Mono", "Courier New", monospace;
    }
    .date-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      position: relative;
    }
    .date-actions input {
      width: 120px;
      padding: 6px 8px;
      font-size: 12px;
    }
    .date-actions .native-date-input {
      position: absolute;
      left: 0;
      top: 0;
      width: 120px;
      height: 32px;
      opacity: 0;
      pointer-events: none;
      border: none;
    }
    .date-picker-btn {
      border: 1px solid #d4d6dd;
      background: #f8fafc;
      color: #0f172a;
    }
    .date-actions button {
      border: none;
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #16a34a, #15803d);
      color: #fff;
      box-shadow: 0 4px 12px rgba(21, 128, 61, 0.3);
    }
    .date-info {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }
    .placeholder {
      text-align: center;
      color: var(--muted);
      font-style: italic;
    }
    .muted {
      color: var(--muted);
    }
    .weight-cell {
      text-align: center;
      font-weight: 600;
    }
    .meta-note {
      font-size: 11px;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <div>
        <h1>Siteplan & Rincian Upah Tukang</h1>
        <p>Klik blok pada siteplan untuk melihat breakdown pekerjaan dan pencairan biaya.</p>
      </div>
      <button class="back-btn" type="button" onclick="window.history.back()">Kembali</button>
    </div>
  </header>
  <main>
    <div class="panels-header">
      <span>Siteplan</span>
      <span>Rincian Upah Tukang</span>
    </div>
    <section class="sitepanel">
      <div class="legend">
        <span class="title">Legenda Progres</span>
        <span class="legend-item"><span class="legend-dot" style="background:#ffffff;"></span>0-10%</span>
        <span class="legend-item"><span class="legend-dot" style="background:#f97316;"></span>11-30%</span>
        <span class="legend-item"><span class="legend-dot" style="background:#86efac;"></span>31-60%</span>
        <span class="legend-item"><span class="legend-dot" style="background:#15803d;"></span>61-90%</span>
        <span class="legend-item"><span class="legend-dot" style="background:#ef4444;"></span>91-100%</span>
      </div>
<div class="siteplan-wrapper" id="siteplanStandalone">
<svg xml:space="preserve" width="297mm" height="210mm" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 29700 21000">
 <defs>
  <style type="text/css">
   
    .str0 {stroke:#363333;stroke-width:35.28;stroke-miterlimit:22.9256}
    .str1 {stroke:#373435;stroke-width:17.64;stroke-miterlimit:22.9256}
    .fil2 {fill:none}
    .fil1 {fill:#FEFEFE}
    .fil3 {fill:#FFF212}
    .fil4 {fill:#A8CF45}
    .fil5 {fill:#6B809B}
    .fil6 {fill:#5CA47A}
    .fil0 {fill:#5CA47A}
   
  </style>
 </defs>
 <g id="Layer_x0020_1">
  <metadata id="CorelCorpID_0Corel-Layer" />
  <path class="fil0" d="M26585.05 2731.37c-20.8,114.84 -388.6,1032.8 -388.6,1032.8l-312.27 555.04 -1246.48 106.83 -1273.83 323.56 -1612.15 38.65 -2195.44 647.55 -1378.17 -72.79 -2044.86 -254.49 -3327.15 -0.92 -1342.51 -58.24 -1405.95 -402.29 -640.18 127.2 -1280.92 254.55 -881.65 879.47 -1544.84 377.41 -1381.55 -218.46 -611.95 1882.29c0,0 -1084.7,375.83 -1057.1,350.92 27.59,-24.91 -1341.16,-15.2 -1341.16,-15.2l-515.09 243.21 404.77 1328.12 636.27 366.56 989.79 -689.68 581.54 800 1611.29 665.8 2545.49 1114.01 405.64 623.67 2004.33 517.27 2532.03 1046.26 1855.37 476.45 1137.89 55.6 2567.69 22.79 522.29 2628.36 2310.65 1135.17 1140.51 -490.04 1706.4 -1132.09 431.17 -4853.17 0 0 1683.27 379.49 412.07 338.79 825.7 1505.35 873.31 -3163.83 -1222.2 -6232.46 1009.74 -1448.62 -1183.16 -790.89z" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22314.1 9426.76)" width="4445" height="8890" data-unit-id="C1" data-status="ready-stok" data-progress="0" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21033.7 9681.19)" width="4445" height="8890" data-unit-id="C9" data-progress="20" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21161 10321.4)" width="4445" height="8890" data-unit-id="C10" data-progress="40" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21288.2 10961.6)" width="4445" height="8890" data-unit-id="C11" data-progress="60" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21415.4 11601.7)" width="4445" height="8890" data-unit-id="C12" data-progress="80" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21542.6 12241.9)" width="4445" height="8890" data-unit-id="C13" data-progress="100" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21669.8 12882.1)" width="4445" height="8890" data-unit-id="C14" data-progress="19" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21797 13522.3)" width="4445" height="8890" data-unit-id="C15" data-progress="39" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 21924.2 14162.4)" width="4445" height="8890" data-unit-id="C16" data-progress="59" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22051.5 14802.6)" width="4445" height="8890" data-unit-id="C17" data-progress="79" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22178.7 15442.8)" width="4445" height="8890" data-unit-id="C18" data-progress="99" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22305.9 16083)" width="4445" height="8890" data-unit-id="C19" data-progress="18" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22433.1 16723.2)" width="4445" height="8890" data-unit-id="C20" data-progress="38" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22441.3 10066.9)" width="4445" height="8890" data-unit-id="C2" data-progress="58" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22568.5 10707.1)" width="4445" height="8890" data-unit-id="C3" data-progress="78" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22695.7 11347.3)" width="4445" height="8890" data-unit-id="C4" data-progress="98" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 22823 11987.5)" width="4445" height="8890" data-unit-id="C5" data-progress="17" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25213.3 7296.06)" width="4445" height="8890" data-unit-id="A4" data-progress="37" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 23933 7550.49)" width="4445" height="8890" data-unit-id="A7" data-progress="57" />
  <rect class="fil1 " transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 23805.8 6910.31)" width="4445" height="8890" data-unit-id="A6" data-progress="77" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 23678.6 6270.13)" width="4445" height="8890" data-unit-id="A5" data-progress="97" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25086.1 6655.88)" width="4445" height="8890" data-unit-id="A3" data-progress="16" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24958.9 6015.7)" width="4445" height="8890" data-unit-id="A2" data-progress="36" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24831.7 5375.52)" width="4445" height="8890" data-unit-id="A1" data-progress="56" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 26030.2 11354.6)" width="4445" height="8890" data-unit-id="B5" data-progress="76" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25903 10714.4)" width="4445" height="8890" data-unit-id="B4" data-progress="96" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25775.7 10074.3)" width="4445" height="8890" data-unit-id="B3" data-progress="15" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25648.5 9434.07)" width="4445" height="8890" data-unit-id="B2" data-progress="35" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 25521.3 8793.89)" width="4445" height="8890" data-unit-id="B1" data-progress="55" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24241 9048.32)" width="4445" height="8890" data-unit-id="B6" data-progress="75" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24368.2 9688.5)" width="4445" height="8890" data-unit-id="B7" data-progress="95" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24495.4 10328.7)" width="4445" height="8890" data-unit-id="B8" data-progress="14" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24622.6 10968.9)" width="4445" height="8890" data-unit-id="B9" data-progress="34" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 24749.8 11609)" width="4445" height="8890" data-unit-id="B10" data-progress="54" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19114.6 10060.9)" width="4445" height="8890" data-unit-id="D1" data-progress="74" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 17834.3 10315.3)" width="4445" height="8890" data-unit-id="D14" data-progress="94" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 17961.5 10955.5)" width="4445" height="8890" data-unit-id="D15" data-progress="13" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18088.7 11595.7)" width="4445" height="8890" data-unit-id="D16" data-progress="33" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18215.9 12235.8)" width="4445" height="8890" data-unit-id="D17" data-progress="53" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18343.1 12876)" width="4445" height="8890" data-unit-id="D18" data-progress="73" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18470.3 13516.2)" width="4445" height="8890" data-unit-id="D19" data-progress="93" />
  <rect class="fil1" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18597.5 14156.4)" width="4445" height="8890" data-unit-id="D20" data-progress="12" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18724.7 14796.6)" width="4445" height="8890" data-unit-id="D21" data-progress="32" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18852 15436.7)" width="4445" height="8890" data-unit-id="D22" data-progress="52" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 18979.2 16076.9)" width="4445" height="8890" data-unit-id="D23" data-progress="72" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19106.4 16717.1)" width="4445" height="8890" data-unit-id="D24" data-progress="92" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19233.6 17357.3)" width="4445" height="8890" data-unit-id="D25" data-progress="11" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19241.8 10701.1)" width="4445" height="8890" data-unit-id="D2" data-progress="31" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19369 11341.2)" width="4445" height="8890" data-unit-id="D3" data-progress="51" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19496.3 11981.4)" width="4445" height="8890" data-unit-id="D4" data-progress="71" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19623.5 12621.6)" width="4445" height="8890" data-unit-id="D5" data-progress="91" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19750.7 13261.8)" width="4445" height="8890" data-unit-id="D6" data-progress="10" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 19877.9 13902)" width="4445" height="8890" data-unit-id="D7" data-progress="30" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20005.1 14542.1)" width="4445" height="8890" data-unit-id="D8" data-progress="50" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20132.3 15182.3)" width="4445" height="8890" data-unit-id="D9" data-progress="70" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20259.5 15822.5)" width="4445" height="8890" data-unit-id="D10" data-progress="90" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20386.7 16462.7)" width="4445" height="8890" data-unit-id="D11" data-progress="9" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20514 17102.9)" width="4445" height="8890" data-unit-id="D12" data-progress="29" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20641.2 17743)" width="4445" height="8890" data-unit-id="D13" data-progress="49" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 20768.4 18383.2)" width="4445" height="8890" data-unit-id="D13A" data-progress="69" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 15915.2 10697.8)" width="4445" height="8890" data-unit-id="G1" data-progress="89" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 14634.8 10952.2)" width="4445" height="8890" data-unit-id="G8" data-progress="8" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 14762 11592.4)" width="4445" height="8890" data-unit-id="G9" data-progress="28" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 14889.2 12232.6)" width="4445" height="8890" data-unit-id="G10" data-progress="48" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 15016.4 12872.8)" width="4445" height="8890" data-unit-id="G11" data-progress="68" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 15143.7 13512.9)" width="4445" height="8890" data-unit-id="G12" data-progress="88" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 15270.9 14153.1)" width="4445" height="8890" data-unit-id="G13" data-progress="7" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16042.4 11338)" width="4445" height="8890" data-unit-id="G2" data-progress="27" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16169.6 11978.2)" width="4445" height="8890" data-unit-id="G3" data-progress="47" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16296.8 12618.3)" width="4445" height="8890" data-unit-id="G4" data-progress="67" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16424 13258.5)" width="4445" height="8890" data-unit-id="G5" data-progress="87" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16551.2 13898.7)" width="4445" height="8890" data-unit-id="G6" data-progress="6" />
  <rect class="fil1 str0" transform="matrix(-0.0286194 -0.144022 0.144022 -0.0286194 16678.4 14538.9)" width="4445" height="8890" data-unit-id="G7" data-progress="26" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 18687 7923.74)" width="4445" height="8890" data-unit-id="E4" data-progress="46" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 17406.6 8178.16)" width="4445" height="8890" data-unit-id="E9" data-progress="66" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 17279.4 7537.98)" width="4445" height="8890" data-unit-id="E8" data-progress="86" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 17152.2 6897.8)" width="4445" height="8890" data-unit-id="E7" data-progress="5" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 17025 6257.62)" width="4445" height="8890" data-unit-id="E6" data-progress="25" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 16897.8 5617.44)" width="4445" height="8890" data-unit-id="E5" data-progress="45" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 18559.8 7283.56)" width="4445" height="8890" data-unit-id="E3" data-progress="65" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 18432.5 6643.38)" width="4445" height="8890" data-unit-id="E2" data-progress="85" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 18305.3 6003.2)" width="4445" height="8890" data-unit-id="E1" data-progress="4" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 15489 8563.84)" width="4445" height="8890" data-unit-id="F6" data-progress="24" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 14208.6 8818.27)" width="4445" height="8890" data-unit-id="F13" data-progress="44" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 14081.4 8178.09)" width="4445" height="8890" data-unit-id="F12" data-progress="64" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 13954.2 7537.91)" width="4445" height="8890" data-unit-id="F11" data-progress="84" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 13827 6897.73)" width="4445" height="8890" data-unit-id="F10" data-progress="3" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 13699.7 6257.55)" width="4445" height="8890" data-unit-id="F9" data-progress="23" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 13572.5 5617.37)" width="4445" height="8890" data-unit-id="F8" data-progress="43" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 15361.7 7923.66)" width="4445" height="8890" data-unit-id="F5" data-progress="63" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 15234.5 7283.48)" width="4445" height="8890" data-unit-id="F4" data-progress="83" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 15107.3 6643.3)" width="4445" height="8890" data-unit-id="F3" data-progress="2" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 14980.1 6003.12)" width="4445" height="8890" data-unit-id="F2" data-progress="22" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 14852.9 5362.94)" width="4445" height="8890" data-unit-id="F1" data-progress="42" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 12289 9203.1)" width="4445" height="8890" data-unit-id="H7" data-progress="62" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10817.8 8497.26)" width="4445" height="8890" data-unit-id="H13" data-progress="82" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10690.6 7857.08)" width="4445" height="8890" data-unit-id="H12" data-progress="1" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10563.4 7216.9)" width="4445" height="8890" data-unit-id="H11" data-progress="21" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10436.2 6576.72)" width="4445" height="8890" data-unit-id="H10" data-progress="41" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10309 5936.54)" width="4445" height="8890" data-unit-id="H9" data-progress="61" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 10181.8 5296.36)" width="4445" height="8890" data-unit-id="H8" data-progress="81" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 12161.8 8562.92)" width="4445" height="8890" data-unit-id="H6" data-progress="0" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 12034.6 7922.74)" width="4445" height="8890" data-unit-id="H5" data-progress="20" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 11907.4 7282.56)" width="4445" height="8890" data-unit-id="H4" data-progress="40" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 11780.2 6642.38)" width="4445" height="8890" data-unit-id="H3" data-progress="60" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 11652.9 6002.2)" width="4445" height="8890" data-unit-id="H2" data-progress="80" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 11525.7 5362.02)" width="4445" height="8890" data-unit-id="H1" data-progress="100" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 3751.47 10046)" width="4445" height="8890" data-unit-id="J20" data-progress="19" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 4348.84 10309)" width="4445" height="8890" data-unit-id="J19" data-progress="39" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 4946.21 10572)" width="4445" height="8890" data-unit-id="J18" data-progress="59" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 6738.33 11360.9)" width="4445" height="8890" data-unit-id="J15" data-progress="79" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 7335.7 11623.9)" width="4445" height="8890" data-unit-id="J14" data-progress="99" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 7933.07 11886.9)" width="4445" height="8890" data-unit-id="J13" data-progress="18" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 8530.44 12149.9)" width="4445" height="8890" data-unit-id="J12" data-progress="38" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 9127.81 12412.9)" width="4445" height="8890" data-unit-id="J11" data-progress="58" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 9725.18 12675.9)" width="4445" height="8890" data-unit-id="I1" data-progress="78" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 10322.6 12938.9)" width="4445" height="8890" data-unit-id="I2" data-progress="98" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 10919.9 13201.8)" width="4445" height="8890" data-unit-id="I3" data-progress="17" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 11517.3 13464.8)" width="4445" height="8890" data-unit-id="I4" data-progress="37" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 12114.7 13727.8)" width="4445" height="8890" data-unit-id="I5" data-progress="57" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 12712 13990.8)" width="4445" height="8890" data-unit-id="I6" data-progress="77" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 13309.4 14253.8)" width="4445" height="8890" data-unit-id="I7" data-progress="97" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 13906.8 14516.8)" width="4445" height="8890" data-unit-id="I8" data-progress="16" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 5543.58 10835)" width="4445" height="8890" data-unit-id="J17" data-progress="36" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 6140.95 11098)" width="4445" height="8890" data-unit-id="J16" data-progress="56" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 4632.22 8042.22)" width="4445" height="8890" data-unit-id="J9" data-progress="76" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 5229.6 8305.21)" width="4445" height="8890" data-unit-id="J8" data-progress="96" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 5826.97 8568.19)" width="4445" height="8890" data-unit-id="J7" data-progress="15" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 6424.34 8831.18)" width="4445" height="8890" data-unit-id="J6" data-progress="35" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 7021.71 9094.16)" width="4445" height="8890" data-unit-id="J5" data-progress="55" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 7619.08 9357.15)" width="4445" height="8890" data-unit-id="J4" data-progress="75" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 8216.45 9620.13)" width="4445" height="8890" data-unit-id="J3" data-progress="95" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 8813.82 9883.12)" width="4445" height="8890" data-unit-id="J2" data-progress="14" />
  <rect class="fil1 str0" transform="matrix(-0.134392 -0.0591643 0.0591643 -0.134392 9411.19 10146.1)" width="4445" height="8890" data-unit-id="J1" data-progress="34" />
  <path class="fil2 str0" d="M20906.54 9041.02l2566.6 -510.02m640.2 -127.22l2560.71 -508.86" />
  <path class="fil2 str0" d="M9867.44 10347.36l1.07 -0.21 631.43 -125.48 -631.43 125.48 -1.07 0.21zm10875.38 -2161.1l2560.72 -508.85m640.18 -127.21l2560.72 -508.85" />
  <line class="fil2 str0" x1="27947.01" y1="10952.07" x2="26758.46" y2="4970.88" />
  <path class="fil2 str0" d="M24750.25 11608.95l-636.92 -3205.18m-169.61 -853.57l-382 -1922.32" />
  <g>
   <path class="fil3" d="M22438.99 16722l-1526.56 -7682.16 1526.56 7682.16zm-1696.17 -8535.74l-509.85 -2565.73 2560.71 -508.87 509.86 2565.75 -2560.72 508.85z" />
  </g>
  <path class="fil2 str0" d="M19237.77 17356.46l-1526.55 -7682.16m-169.3 -851.97l-637.14 -3206.28" />
  <path class="fil2 str0" d="M27189.37 10488.18l-515.32 -2593.26m-169.61 -853.57l-509.85 -2565.74" />
  <path class="fil2 str0" d="M23988.47 11124.25l-515.32 -2593.26m-169.61 -853.58l-509.85 -2565.74" />
  <line class="fil2 str0" x1="21733.84" y1="16522.26" x2="20272.25" y2="9167.05" />
  <line class="fil2 str0" x1="18597.59" y1="17483.67" x2="17071.35" y2="9803.12" />
  <path class="fil2 str0" d="M15273.81 14152.53l-763.28 -3841.08m-169.51 -853.05l-763.47 -3842.03" />
  <line class="fil2 str0" x1="14633.63" y1="14279.74" x2="14441.29" y2="13311.8" />
  <path class="fil2 str0" d="M11527.31 12042.95l-3.05 -15.33m-574.5 -2891.12l-892.12 -4489.44" />
  <path class="fil2 str0" d="M10798.05 11721.9l-3.04 -15.33m-295.07 -1484.9l-1082.48 -5447.39" />
  <path class="fil2 str0" d="M21733.84 16522.26l-4.75 -2.09m-2912.27 -1282.09l-4.76 -2.1m-3641.52 -1603.13l-3.35 -1.48m-725.9 -319.57l-10784.57 -4747.77" />
  <path class="fil2 str0" d="M22256.03 15801.29l-6.72 -2.96m-722.53 -318.09l-4.76 -2.09m-2912.27 -1282.09l-4.75 -2.1m-724.5 -318.95l-3.35 -1.47m-2913.67 -1282.71l-3.36 -1.48" />
  <line class="fil2 str0" x1="9867.44" y1="10347.36" x2="9411.19" y2="10146.1" />
  <rect class="fil1 str0" transform="matrix(0.0286194 0.144022 0.144022 -0.0286194 8136.54 5028.81)" width="4445" height="8890" data-unit-id="J10" data-progress="54" />
  <line class="fil2 str0" x1="10945.04" y1="9137.44" x2="12416.22" y2="9843.28" />
  <circle class="fil4 str0" transform="matrix(0.106697 -0.0212022 0.0212022 0.106697 13330.9 11321.1)" r="4762.5" />
  <polygon class="fil5 str1" points="27630.41,3527.45 26758.47,4970.88 27947.01,10952.07 27310.53,11100.18 26674.05,7894.92 24113.74,8408.14 24750.25,11608.94 24103.32,11733.06 23467.25,8532.16 20906.53,9041.01 22629.48,17743.52 22048.75,18128.8 20272.26,9167.06 17711.22,9674.29 19237.77,17356.45 18597.59,17483.67 17068.31,9803.18 14507.59,10312.04 15273.81,14152.53 14633.63,14279.74 14441.28,13311.8 3680.07,8588.3 4034.85,7779.24 9868.5,10347.14 10499.95,10221.67 9417.46,4774.27 10057.64,4647.07 10945.05,9137.45 12416.22,9843.28 13696.58,9588.86 12806.1,5107.6 13504.88,5107.8 13577.55,5616.36 14335.81,9458.45 16896.53,8949.6 16133.25,5108.52 16849.13,5197.62 16904.77,5616.04 17533.82,8818.34 20094.54,8309.49 19585.69,5748.77 20232.97,5620.53 20742.81,8186.27 23303.54,7677.41 22793.68,5111.66 23363.87,4749.6 23943.72,7550.2 26493.7,7041.64 25884.18,4319.21 26239.19,3656.91 26585.05,2731.37 " />
  <circle class="fil6 str1" cx="13003.06" cy="11264.92" r="715.25" />
 </g>
</svg>
</div>
</section>
    <section class="detailpanel">
      <div class="lot-panel">
        <h2 style="margin:0 0 6px;">Rincian Pekerjaan</h2>
        <div class="lot-summary">
          <div id="lotInfo" class="lot-info">Pilih blok pada siteplan untuk melihat detail pekerjaan.</div>
          <button type="button" class="edit-btn" id="editToggleBtn">Edit Pencairan</button>
        </div>
        <div class="edit-panel hidden" id="editPanel">
          <label for="editRowSelect">Pilih Pekerjaan</label>
          <select id="editRowSelect" disabled>
            <option value="">Pilih kavling terlebih dahulu</option>
          </select>
          <label for="editType">Apa yang mau dirubah?</label>
          <select id="editType">
            <option value="">Pilih jenis perubahan</option>
            <option value="tanggal">Tanggal Pencairan</option>
            <option value="nilai">Nilai Pencairan</option>
          </select>
          <div class="hidden" id="editDateField">
            <label for="editDateInput">Tanggal Baru</label>
            <input type="date" id="editDateInput">
          </div>
          <div class="hidden" id="editAmountField">
            <label for="editAmountInput">Nilai Pencairan Baru (Rp)</label>
            <input type="number" id="editAmountInput" min="0" step="1000" placeholder="Masukkan nominal">
            <label for="editStatusSelect">Keterangan Nilai</label>
            <select id="editStatusSelect">
              <option value="">Pilih keterangan</option>
              <option value="retensi">Tersisa Retensi</option>
              <option value="lainnya">Lainnya</option>
            </select>
            <input type="text" id="editNoteInput" class="hidden" maxlength="100" placeholder="Masukkan keterangan (maks. 100 karakter)">
          </div>
          <div class="edit-actions">
            <button type="button" class="secondary" id="editCancelBtn">Batal</button>
            <button type="button" class="primary" id="editSaveBtn">Simpan Perubahan</button>
          </div>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width:45px;">No</th>
              <th>Pekerjaan</th>
              <th style="width:90px;">Bobot</th>
              <th style="width:170px;">Tanggal Pencairan</th>
              <th style="width:140px;">Pencairan</th>
            </tr>
          </thead>
          <tbody id="progressTableBody">
            <tr><td colspan="5" class="placeholder">Belum ada data yang dipilih.</td></tr>
          </tbody>
          <tfoot id="progressTableFooter"></tfoot>
        </table>
      </div>
    </section>
  </main>

  <script>
    const lotInfoEl = document.getElementById("lotInfo");
    const editToggleBtn = document.getElementById("editToggleBtn");
    const editPanelEl = document.getElementById("editPanel");
    const editRowSelect = document.getElementById("editRowSelect");
    const editTypeSelect = document.getElementById("editType");
    const editDateField = document.getElementById("editDateField");
    const editDateInput = document.getElementById("editDateInput");
    const editAmountField = document.getElementById("editAmountField");
    const editAmountInput = document.getElementById("editAmountInput");
    const editStatusSelect = document.getElementById("editStatusSelect");
    const editNoteInput = document.getElementById("editNoteInput");
    const editSaveBtn = document.getElementById("editSaveBtn");
    const editCancelBtn = document.getElementById("editCancelBtn");
    const tableBody = document.getElementById("progressTableBody");
    const tableFooter = document.getElementById("progressTableFooter");

    const TEMPLATE = [
      {
        stage: 1,
        rows: [
          { name: "Bowplank", weight: 1, amount: 145000 },
          { name: "Pondasi", weight: 3, amount: 435000 },
          { name: "Sloof", weight: 3, amount: 435000 },
          { name: "Kolom", weight: 3, amount: 435000 },
          { name: "Urugan Tanah", weight: 1, amount: 145000 },
        ],
        total: { weight: 11, amount: 1595000 }
      },
      {
        stage: 2,
        rows: [
          { name: "Pasangan Batu Rata Kusen", weight: 7, amount: 1015000 },
          { name: "Ringbalk", weight: 4, amount: 580000 },
          { name: "Kuda-kuda", weight: 3, amount: 435000 },
          { name: "Tiang Cor", weight: 1, amount: 145000 },
        ],
        total: { weight: 25, amount: 2175000 }
      },
      {
        stage: 3,
        rows: [
          { name: "Plesteran Luar Dalam", weight: 10, amount: 1885000 },
          { name: "Topi-topi", weight: 3, amount: 290000 },
          { name: "Carport", weight: 2, amount: 290000 },
          { name: "Draianse", weight: 5, amount: 500000 },
        ],
        total: { weight: 19, amount: 2965000 }
      },
      {
        stage: 4,
        rows: [
          { name: "Rangka Atap", weight: 8, amount: 1015000 },
          { name: "Pemasangan Listplank", weight: 2, amount: 145000 },
          { name: "Plafond", weight: 5, amount: 725000 },
          { name: "Pemasangan Tegel Luar Dalam", weight: 7, amount: 1450000 },
          { name: "Plamour Luar Dalam dan Acian", weight: 2, amount: 435000 },
          { name: "WC", weight: 8, amount: 435000 },
          { name: "Pemasangan Cover Dinding Fasad", weight: 1, amount: 145000 },
        ],
        total: { weight: 26, amount: 4850000 }
      },
      {
        stage: 5,
        rows: [
          { name: "Pengecetan dinding Luar dalam", weight: 7, amount: 725000 },
          { name: "Pengecetan Kuseng", weight: 4, amount: 580000 },
          { name: "Finishing", weight: 10, amount: 3110000 },
        ],
        total: { weight: 19, amount: 4415000 }
      }
    ];

    const GOOGLE_SCRIPT_URL = window.PN_UPAH_SCRIPT_URL || "https://script.google.com/macros/s/AKfycbwlBHrduAIgPZZrPMYAiEwaFUJOrGws1IbIzw09jXt9sdDNafaAzRS3RT2AWxVTop_oIQ/exec";
    const PROGRESS_STORAGE_KEY = "upah_tukang_progress_data";
    const PROGRESS_DATA = loadProgressData();
    const ROW_STATE_KEY = "upah_tukang_row_state";

    function loadRowState(){
      try {
        return JSON.parse(localStorage.getItem(ROW_STATE_KEY)) || {};
      } catch (err) {
        console.warn("Gagal load row state", err);
        return {};
      }
    }
    function persistRowState(){
      try {
        localStorage.setItem(ROW_STATE_KEY, JSON.stringify(rowState));
      } catch (err) {
        console.warn("Gagal simpan row state", err);
      }
    }

    function loadProgressData(){
      try {
        return JSON.parse(localStorage.getItem(PROGRESS_STORAGE_KEY)) || {};
      } catch (err) {
        console.warn("Gagal load progress data", err);
        return {};
      }
    }
    function persistProgressData(){
      try {
        localStorage.setItem(PROGRESS_STORAGE_KEY, JSON.stringify(PROGRESS_DATA));
      } catch (err) {
        console.warn("Gagal simpan progress data", err);
      }
    }
    function cloneTemplate(){
      return TEMPLATE.map(section => ({
        stage: section.stage,
        rows: section.rows.map(row => ({ ...row })),
        total: { ...section.total }
      }));
    }
    function ensureLotProgress(lotKey){
      if (!PROGRESS_DATA[lotKey]){
        PROGRESS_DATA[lotKey] = cloneTemplate();
      }
      return PROGRESS_DATA[lotKey];
    }
    function findRowByKey(sections, rowKey){
      if (!rowKey) return null;
      const [stageStr, idxStr] = rowKey.split("-");
      const stage = Number(stageStr);
      const rowIndex = Number(idxStr);
      const sectionIndex = sections.findIndex(sec => sec.stage === stage);
      if (sectionIndex === -1 || !sections[sectionIndex].rows[rowIndex]) return null;
      return { sectionIndex, rowIndex, row: sections[sectionIndex].rows[rowIndex] };
    }

    const rowState = loadRowState();

    const GRAND_TOTAL = 16000000;

    const lotElements = document.querySelectorAll("#siteplanStandalone [data-unit-id]");

    let lastPayload = { lotId: "-", status: "-", progress: "-" };
    let currentLotKey = null;

    function renderDetail(payload = {}) {
      if (payload.lotId && payload.lotId !== "-") {
        lastPayload = payload;
      }
      const hasSelection = Boolean(lastPayload.lotId && lastPayload.lotId !== "-");
      if (!hasSelection) {
        showPlaceholder();
        applyLotColors();
        return;
      }
      const lotKey = getLotKey(lastPayload.lotId);
      const data = PROGRESS_DATA[lotKey] || TEMPLATE;
      currentLotKey = lotKey;
      populateRowOptions(data, lotKey);
      hideEditPanel();
      resetEditForm();
      const { html, totals } = buildRows(data, lotKey);
      const fallbackPercent = extractPercent(lastPayload.progress);
      const fallbackAmount = parseCurrency(lastPayload.upahKerja) || GRAND_TOTAL;
      const statusValue = totals.weight
        ? `${totals.weight}%`
        : (fallbackPercent !== null ? `${fallbackPercent}%` : "0%");
      const progressValue = totals.amount
        ? `Rp ${formatNumber(totals.amount)}`
        : `Rp ${formatNumber(fallbackAmount)}`;
      lotInfoEl.innerHTML = `
        Kavling = <strong>${lastPayload.lotId}</strong><br>
        Progress Bangunan: <strong>${statusValue}</strong><br>
        Total Pembayaran: <strong>${progressValue}</strong>
      `;
      tableBody.innerHTML = html;
      attachApplyHandlers();
      attachDatePickerHandlers();
      renderFooter(totals);
      applyLotColors();
    }

    function buildRows(sections, lotKey) {
      const lotState = rowState[lotKey] || {};
      let totalWeight = 0;
      let totalAmount = 0;
      const html = sections.map(section => {
        const rowSpan = section.rows.length + 1;
        let rowsHtml = "";
        let stageWeight = 0;
        let stageAmount = 0;
        section.rows.forEach((row, idx) => {
          const rowKey = `${section.stage}-${idx}`;
          const state = lotState[rowKey] || {};
          const applied = Boolean(state.date);
          if (applied) {
            stageWeight += row.weight;
            stageAmount += row.amount;
          }
          const noteHtml = state.note ? `<div class="meta-note">${state.note}</div>` : "";
          rowsHtml += `
            <tr>
              ${idx === 0 ? `<td class="stage" rowspan="${rowSpan}">${section.stage}</td>` : ""}
              <td>${row.name}</td>
              <td class="weight-cell">${row.weight}%</td>
              <td>
                <div class="date-actions">
                  <input
                    type="text"
                    inputmode="numeric"
                    placeholder="dd/mm/yyyy"
                    data-row-display="${rowKey}"
                    value="${formatInputDateValue(state.date)}">
                  <input
                    type="date"
                    class="native-date-input"
                    data-row-hidden="${rowKey}"
                    value="${normalizeDateInput(state.date)}">
                  <button type="button" class="date-picker-btn" data-row="${rowKey}">ðŸ“…</button>
                  <button type="button" class="apply-row" data-row="${rowKey}" data-lot="${lotKey}">Apply</button>
                </div>
                <div class="date-info">${state.date ? formatDate(state.date) : "Belum ditetapkan"}</div>
              </td>
              <td class="amount">
                Rp ${formatNumber(row.amount)}
                ${applied ? `<div class="meta-note">Dicairkan pada ${formatDate(state.date)}</div>` : `<div class="meta-note muted">Belum dicairkan</div>`}
                ${noteHtml}
              </td>
            </tr>
          `;
        });
        totalWeight += stageWeight;
        totalAmount += stageAmount;
        rowsHtml += `
          <tr class="subtotal">
            <td colspan="2">TOTAL</td>
            <td>${stageWeight ? `${stageWeight}%` : "0%"} <span class="muted">/ ${section.total.weight}%</span></td>
            <td class="muted">-</td>
            <td class="amount">
              Rp ${formatNumber(stageAmount || 0)}
              <div class="meta-note muted">Dari Rp ${formatNumber(section.total.amount)}</div>
            </td>
          </tr>
        `;
        return rowsHtml;
      }).join("");
      return { html, totals: { weight: totalWeight, amount: totalAmount } };
    }

    function formatNumber(value) {
      return Number(value || 0).toLocaleString("id-ID");
    }

    function getLotProgressPercent(lotKey) {
      const lotState = rowState[lotKey] || {};
      let total = 0;
      Object.keys(lotState).forEach(rowKey => {
        const state = lotState[rowKey];
        if (state?.date) {
          const found = findRowByKey(TEMPLATE, rowKey);
          const weight = Number(found?.row?.weight) || 0;
          total += weight;
        }
      });
      return Math.min(total, 100);
    }

    function getLotColorByProgress(percent) {
      if (percent >= 91) return "#ef4444"; // merah
      if (percent >= 61) return "#15803d"; // hijau tua
      if (percent >= 31) return "#86efac"; // hijau muda
      if (percent >= 11) return "#f97316"; // orange
      return "#ffffff"; // putih
    }

    function applyLotColors() {
      lotElements.forEach(el => {
        const lotKey = getLotKey(el.dataset.unitId || "-");
        const progressPercent = getLotProgressPercent(lotKey);
        const color = getLotColorByProgress(progressPercent);
        el.style.setProperty("--lot-fill", color);
        el.style.fill = color;
      });
    }

    function buildPayload(lotKey, rowKey, tanggal, keterangan, tipe) {
      const sections = ensureLotProgress(lotKey);
      const target = findRowByKey(sections, rowKey);
      const rowData = target?.row;
      return {
        kavling: lotKey,
        pekerjaan: rowData?.name || rowKey,
        bobot: rowData ? `${rowData.weight}%` : "",
        tanggal,
        nilai: rowData?.amount || 0,
        keterangan,
        tipe
      };
    }

    function extractPercent(text) {
      if (!text) return null;
      const num = parseFloat(String(text).replace(/[^0-9.,]/g, "").replace(",", "."));
      return isNaN(num) ? null : Math.round(num);
    }

    function parseCurrency(value) {
      if (!value) return 0;
      const num = Number(String(value).replace(/[^0-9.-]/g, ""));
      return isNaN(num) ? 0 : num;
    }

    function formatDate(value) {
      if (!value) return "";
      const date = new Date(value);
      if (isNaN(date)) return value;
      return date.toLocaleDateString("id-ID", {
        day: "2-digit",
        month: "long",
        year: "numeric"
      });
    }

    function normalizeDateInput(raw) {
      const val = (raw || "").trim();
      if (!val) return "";
      const cleaned = val.replace(/[.\-]/g, "/").replace(/\s+/g, "");
      const isoPattern = /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/;
      const dmyPattern = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/;
      let year, month, day;
      if (isoPattern.test(cleaned)) {
        [, year, month, day] = cleaned.match(isoPattern);
      } else if (dmyPattern.test(cleaned)) {
        [, day, month, year] = cleaned.match(dmyPattern);
        if (year.length === 2) year = `20${year}`;
      } else {
        return "";
      }
      const y = Number(year);
      const m = Number(month);
      const d = Number(day);
      if (!y || !m || !d || m > 12 || d > 31) return "";
      const iso = `${y.toString().padStart(4, "0")}-${m.toString().padStart(2, "0")}-${d.toString().padStart(2, "0")}`;
      const date = new Date(iso);
      return isNaN(date) ? "" : iso;
    }

    function formatInputDateValue(value) {
      const iso = normalizeDateInput(value);
      if (!iso) return value || "";
      const [y, m, d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }

    async function kirimKeBackend(payload) {
      if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("PASTE_URL_WEB_APP_ANDA_DISINI")) {
        console.warn("GOOGLE_SCRIPT_URL belum diisi. Lewati kirim ke Apps Script.");
        return;
      }
      const formData = new FormData();
      formData.append("target_sheet", "Laporan_Upah_Tukang");
      formData.append("kavling", payload.kavling || "");
      formData.append("pekerjaan", payload.pekerjaan || "");
      formData.append("bobot_persen", payload.bobot || "");
      formData.append("tanggal_cair", payload.tanggal || "");
      formData.append("nilai_pencairan", payload.nilai || "");
      formData.append("keterangan", payload.keterangan || "");
      formData.append("tipe_update", payload.tipe || "");
      formData.append("waktu_input", new Date().toLocaleString("id-ID"));
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: formData });
        const text = await response.text();
        console.log("Server Response:", text);
      } catch (err) {
        console.error("Gagal kirim ke Apps Script:", err);
        alert("Gagal kirim ke Google Sheets. Cek koneksi/URL.");
      }
    }

    function getLotKey(rawId) {
      return rawId && rawId !== "-" ? rawId : "_global";
    }

    function renderFooter(totals) {
      tableFooter.innerHTML = `
        <tr class="grand-total">
          <td colspan="2">Total Pencairan</td>
          <td>${totals.weight ? `${totals.weight}%` : "-"}</td>
          <td class="muted">-</td>
          <td class="amount">${totals.amount ? `Rp ${formatNumber(totals.amount)}` : "-"}</td>
        </tr>
        <tr>
          <td colspan="5" class="muted" style="text-align:right;">Nilai kontrak: Rp ${formatNumber(GRAND_TOTAL)}</td>
        </tr>
      `;
    }

    function populateRowOptions(sections, lotKey) {
      if (!sections || !sections.length || !lotKey) {
        editRowSelect.innerHTML = '<option value="">Pilih kavling terlebih dahulu</option>';
        editRowSelect.disabled = true;
        return;
      }
      const options = ['<option value="">Pilih item pekerjaan</option>'];
      sections.forEach(section => {
        section.rows.forEach((row, idx) => {
          const key = `${section.stage}-${idx}`;
          options.push(`<option value="${key}">Tahap ${section.stage} - ${row.name}</option>`);
        });
      });
      editRowSelect.innerHTML = options.join("");
      editRowSelect.disabled = false;
    }

    function hideEditPanel() {
      editPanelEl.classList.add("hidden");
    }

    function resetEditForm() {
      editRowSelect.value = "";
      editTypeSelect.value = "";
      editDateField.classList.add("hidden");
      editAmountField.classList.add("hidden");
      editDateInput.value = "";
      editAmountInput.value = "";
      editStatusSelect.value = "";
      editNoteInput.value = "";
      editNoteInput.classList.add("hidden");
    }

    function toggleEditFields() {
      const type = editTypeSelect.value;
      editDateField.classList.toggle("hidden", type !== "tanggal");
      editAmountField.classList.toggle("hidden", type !== "nilai");
    }

    function toggleNoteField() {
      const isOther = editStatusSelect.value === "lainnya";
      editNoteInput.classList.toggle("hidden", !isOther);
      if (!isOther) {
        editNoteInput.value = "";
      }
    }

    function handleEditSave() {
      if (!currentLotKey) {
        alert("Pilih blok terlebih dahulu.");
        return;
      }
      const rowKey = editRowSelect.value;
      if (!rowKey) {
        alert("Pilih pekerjaan yang ingin diubah.");
        return;
      }
      const type = editTypeSelect.value;
      if (!type) {
        alert("Pilih jenis perubahan terlebih dahulu.");
        return;
      }
      if (!rowState[currentLotKey]) {
        rowState[currentLotKey] = {};
      }
      const currentState = rowState[currentLotKey][rowKey] || {};
      if (type === "tanggal") {
        const normalized = normalizeDateInput(editDateInput.value);
        if (!normalized) {
          alert("Isi tanggal pencairan baru.");
          return;
        }
        currentState.date = normalized;
        rowState[currentLotKey][rowKey] = currentState;
        persistRowState();
        const payload = buildPayload(currentLotKey, rowKey, normalized, "Pencairan via Edit", "Edit Tanggal");
        kirimKeBackend(payload);
      } else if (type === "nilai") {
        const amount = Number(editAmountInput.value);
        if (!amount || amount <= 0) {
          alert("Masukkan nilai pencairan yang valid.");
          return;
        }
        const statusVal = editStatusSelect.value;
        if (!statusVal) {
          alert("Pilih keterangan nilai terlebih dahulu.");
          return;
        }
        let noteText = statusVal === "retensi" ? "Tersisa retensi" : editNoteInput.value.trim();
        if (statusVal === "lainnya" && !noteText) {
          alert("Masukkan keterangan lainnya (maks. 100 karakter).");
          return;
        }
        const sections = ensureLotProgress(currentLotKey);
        const target = findRowByKey(sections, rowKey);
        if (!target) {
          alert("Data pekerjaan tidak ditemukan.");
          return;
        }
        target.row.amount = amount;
        currentState.note = noteText;
        rowState[currentLotKey][rowKey] = currentState;
        persistProgressData();
        persistRowState();
        const payload = buildPayload(currentLotKey, rowKey, currentState.date || "", noteText || "Update nilai", "Edit Nilai");
        payload.nilai = amount;
        kirimKeBackend(payload);
      }
      hideEditPanel();
      resetEditForm();
      renderDetail(lastPayload);
    }

    editToggleBtn.addEventListener("click", () => {
      if (!currentLotKey) {
        alert("Pilih blok pada siteplan terlebih dahulu.");
        return;
      }
      editPanelEl.classList.toggle("hidden");
    });
    editTypeSelect.addEventListener("change", toggleEditFields);
    editStatusSelect.addEventListener("change", toggleNoteField);
    editCancelBtn.addEventListener("click", () => {
      hideEditPanel();
      resetEditForm();
    });
    editSaveBtn.addEventListener("click", handleEditSave);


    function attachApplyHandlers() {
      document.querySelectorAll(".apply-row").forEach(btn => {
        btn.addEventListener("click", () => {
          const rowKey = btn.dataset.row;
          const lotKey = btn.dataset.lot;
          const input = document.querySelector(`input[data-row-display="${rowKey}"]`);
          const rawValue = input?.value || "";
          const normalized = normalizeDateInput(rawValue);
          if (!normalized) {
            alert("Isi tanggal pencairan dengan format dd/mm/yyyy atau yyyy-mm-dd.");
            input?.focus();
            return;
          }
          if (!rowState[lotKey]) {
            rowState[lotKey] = {};
          }
          rowState[lotKey][rowKey] = { date: normalized };
          persistRowState();
          renderDetail(lastPayload);
          const payload = buildPayload(lotKey, rowKey, normalized, "Pencairan via Apply", "Apply Tanggal");
          kirimKeBackend(payload);
        });
      });
    }

    function attachDatePickerHandlers() {
      document.querySelectorAll(".date-picker-btn").forEach(btn => {
        const rowKey = btn.dataset.row;
        const hiddenInput = document.querySelector(`input[data-row-hidden="${rowKey}"]`);
        const displayInput = document.querySelector(`input[data-row-display="${rowKey}"]`);
        btn.addEventListener("click", () => {
          if (hiddenInput?.showPicker) {
            hiddenInput.showPicker();
          } else {
            hiddenInput?.click();
          }
        });
        hiddenInput?.addEventListener("change", () => {
          const normalized = normalizeDateInput(hiddenInput.value);
          if (normalized && displayInput) {
            displayInput.value = formatInputDateValue(normalized);
          }
        });
        displayInput?.addEventListener("blur", () => {
          const normalized = normalizeDateInput(displayInput.value);
          if (normalized && hiddenInput) {
            hiddenInput.value = normalized;
            displayInput.value = formatInputDateValue(normalized);
          }
        });
      });
    }

    function setupStandaloneSiteplan() {
      lotElements.forEach(el => {
        el.classList.add("lot-shape");
        el.addEventListener("click", () => handleLotClick(el));
      });
    }

    function handleLotClick(el) {
      lotElements.forEach(node => node.classList.remove("selected"));
      el.classList.add("selected");
      const payload = {
        lotId: el.dataset.unitId || "-",
        status: el.dataset.status ? el.dataset.status.replace(/-/g, " ") : "-",
        progress: el.dataset.progress ? `${el.dataset.progress}%` : "-"
      };
      renderDetail(payload);
    }

    function showPlaceholder() {
      lotInfoEl.innerHTML = "Pilih blok pada siteplan, lalu rincian pekerjaan akan muncul di sini.";
      tableBody.innerHTML = `<tr><td colspan="5" class="placeholder">Belum ada blok yang dipilih.</td></tr>`;
      tableFooter.innerHTML = "";
      populateRowOptions([], null);
      hideEditPanel();
      resetEditForm();
      currentLotKey = null;
    }

    setupStandaloneSiteplan();
    showPlaceholder();
    renderDetail(lastPayload);

  </script>
</body>
</html>
