<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoring Aktiva Tetap - Standard Akuntansi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.default.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      border: 1px solid #e2e8f0;
    }

    th {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }
  </style>
</head>

<body class="pb-20">

  <header class="bg-white border-b border-slate-200 sticky top-0 z-50 px-6 py-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg">
          <i class="fas fa-boxes-stacked text-xl"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold text-slate-800">Fixed Asset Monitoring</h1>
          <p class="text-xs text-slate-500">Standar Akuntansi Penyusutan Garis Lurus</p>
        </div>
      </div>
      <button onclick="window.location.href='dashboard_finance.html'"
        class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-full text-sm font-semibold transition flex items-center gap-2">
        <i class="fas fa-arrow-left"></i> Dashboard
      </button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 mt-8">

    <!-- VIEW: MENU GRID -->
    <div id="view-menu" class="animate-enter">
      <h3 class="text-slate-500 font-bold text-sm uppercase tracking-wider mb-6">Menu Utama</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">

        <!-- MENU 1: OVERVIEW -->
        <div onclick="switchApp('overview')"
          class="bg-white p-6 rounded-xl shadow-sm border hover:shadow-md hover:scale-105 transition cursor-pointer flex flex-col items-center text-center group">
          <div
            class="w-16 h-16 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-2xl mb-4 group-hover:rotate-12 transition">
            <i class="fas fa-chart-pie"></i>
          </div>
          <h3 class="font-bold text-slate-700">Overview & Analisis</h3>
          <p class="text-[10px] text-slate-400 mt-1">Grafik & KPI Aset</p>
        </div>

        <!-- MENU 2: DAFTAR ASET -->
        <div onclick="switchApp('list')"
          class="bg-white p-6 rounded-xl shadow-sm border hover:shadow-md hover:scale-105 transition cursor-pointer flex flex-col items-center text-center group">
          <div
            class="w-16 h-16 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-2xl mb-4 group-hover:-rotate-12 transition">
            <i class="fas fa-list"></i>
          </div>
          <h3 class="font-bold text-slate-700">Daftar Inventaris</h3>
          <p class="text-[10px] text-slate-400 mt-1">Tabel Detail Aset</p>
        </div>

        <!-- MENU 3: REGISTRASI -->
        <div onclick="switchApp('form')"
          class="bg-white p-6 rounded-xl shadow-sm border hover:shadow-md hover:scale-105 transition cursor-pointer flex flex-col items-center text-center group">
          <div
            class="w-16 h-16 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-2xl mb-4 group-hover:rotate-12 transition">
            <i class="fas fa-plus-circle"></i>
          </div>
          <h3 class="font-bold text-slate-700">Registrasi Aset</h3>
          <p class="text-[10px] text-slate-400 mt-1">Input Aktiva Baru</p>
        </div>

        <!-- MENU 4: LAPORAN -->
        <div onclick="downloadLaporanAsetPDF()"
          class="bg-white p-6 rounded-xl shadow-sm border hover:shadow-md hover:scale-105 transition cursor-pointer flex flex-col items-center text-center group">
          <div
            class="w-16 h-16 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-2xl mb-4 group-hover:-rotate-12 transition">
            <i class="fas fa-file-pdf"></i>
          </div>
          <h3 class="font-bold text-slate-700">Laporan PDF</h3>
          <p class="text-[10px] text-slate-400 mt-1">Download Laporan</p>
        </div>

      </div>
    </div>

    <!-- VIEW: OVERVIEW -->
    <div id="view-overview" class="hidden space-y-6">
      <button onclick="switchApp('menu')"
        class="flex items-center gap-2 text-slate-500 hover:text-blue-600 font-bold transition">
        <i class="fas fa-arrow-left"></i> Kembali ke Menu
      </button>

      <div class="card p-6 mb-8">
        <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
          <i class="fas fa-chart-bar text-purple-500"></i> Analisis Nilai Aset vs Penyusutan
        </h2>
        <div style="height: 300px;">
          <canvas id="assetChart"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-5 border-l-4 border-blue-500">
          <div class="text-xs font-bold text-slate-400 uppercase">Total Nilai Perolehan</div>
          <div class="text-2xl font-black text-slate-800 mt-1" id="sumPerolehan">Rp 0</div>
        </div>
        <div class="card p-5 border-l-4 border-red-500">
          <div class="text-xs font-bold text-slate-400 uppercase">Akumulasi Penyusutan</div>
          <div class="text-2xl font-black text-red-600 mt-1" id="sumPenyusutan">Rp 0</div>
        </div>
        <div class="card p-5 border-l-4 border-green-500">
          <div class="text-xs font-bold text-slate-400 uppercase">Total Nilai Buku (Net)</div>
          <div class="text-2xl font-black text-green-600 mt-1" id="sumNilaiBuku">Rp 0</div>
        </div>
        <div class="card p-5 border-l-4 border-purple-500">
          <div class="text-xs font-bold text-slate-400 uppercase">Depresiasi Bln Ini</div>
          <div class="text-2xl font-black text-purple-600 mt-1" id="sumDepresiasiBulanan">Rp 0</div>
        </div>
      </div>
    </div>

    <!-- VIEW: FORM REGISTRASI -->
    <div id="view-form" class="hidden space-y-6">
      <button onclick="switchApp('menu')"
        class="flex items-center gap-2 text-slate-500 hover:text-blue-600 font-bold transition">
        <i class="fas fa-arrow-left"></i> Kembali ke Menu
      </button>

      <div class="max-w-2xl mx-auto">
        <div class="card p-6">
          <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fas fa-plus-circle text-blue-500"></i> Register Aset Baru
          </h2>
          <form id="assetForm" class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1">Nama Aktiva</label>
              <input type="text" id="nama"
                class="w-full border rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Contoh: Toyota Dyna Dump Truck" required>
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1">Merek / Brand <span
                  class="text-slate-400 font-normal italic">(Opsional)</span></label>
              <input type="text" id="merek"
                class="w-full border rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Contoh: Toyota, Honda, Samsung...">
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Kategori</label>
                <select id="kategori" class="w-full border rounded-lg p-2.5 text-sm outline-none">
                  <option>Bangunan</option>
                  <option>Kendaraan</option>
                  <option>Mesin</option>
                  <option>Peralatan IT</option>
                  <option>Inventaris</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Tgl Perolehan</label>
                <input type="date" id="tgl_perolehan" class="w-full border rounded-lg p-2.5 text-sm outline-none"
                  required>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Lokasi Aset</label>
                <input type="text" id="lokasi_aset" class="w-full border rounded-lg p-2.5 text-sm outline-none"
                  placeholder="Contoh: Gudang Utama, Kantor Cabang..." required>
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Tahun Perolehan</label>
                <input type="number" id="tahun_perolehan"
                  class="w-full border rounded-lg p-2.5 text-sm outline-none bg-slate-50" placeholder="YYYY" required>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Nilai Perolehan</label>
                <input type="number" id="nilai_perolehan" class="w-full border rounded-lg p-2.5 text-sm outline-none"
                  placeholder="Rp" required>
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Umur (Tahun)</label>
                <input type="number" id="umur_ekonomis" class="w-full border rounded-lg p-2.5 text-sm outline-none"
                  placeholder="Thn" required>
              </div>
            </div>

            <!-- NEW: SUMBER DANA -->
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1">Sumber Dana (Kredit Akun)</label>
              <select id="sumber_dana" class="w-full border rounded-lg p-2.5 text-sm outline-none bg-yellow-50">
                <option value="" disabled selected>Sedang memuat data...</option>
              </select>
            </div>

            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
              <div class="flex justify-between text-[10px] font-bold text-blue-600 uppercase">Estimasi Depresiasi / Bln:
              </div>
              <div class="text-lg font-black text-blue-700" id="calcDepresiasi">Rp 0</div>
            </div>
            <button type="submit"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95">
              Simpan Aset & Hitung Jurnal
            </button>
          </form>
        </div>
      </div>
    </div>


    <!-- VIEW: LIST TABLE -->
    <div id="view-list" class="hidden space-y-6">
      <div class="flex justify-between items-center">
        <button onclick="switchApp('menu')"
          class="flex items-center gap-2 text-slate-500 hover:text-blue-600 font-bold transition">
          <i class="fas fa-arrow-left"></i> Kembali ke Menu
        </button>
        <div class="flex gap-2">
          <button onclick="postBulananDepresiasi()"
            class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold px-4 py-2 rounded-lg shadow transition">
            <i class="fas fa-sync-alt mr-2"></i> Posting Depresiasi Bulan Ini
          </button>
          <button onclick="downloadLaporanAsetPDF()"
            class="bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold px-4 py-2 rounded-lg shadow transition flex items-center gap-2">
            <i class="fas fa-file-pdf"></i> PDF
          </button>
        </div>
      </div>

      <div class="card overflow-hidden">
        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
          <h2 class="font-bold text-slate-700">Daftar Aktiva & Nilai Buku</h2>
          <div class="text-[10px] px-2 py-1 bg-green-100 text-green-700 rounded font-bold uppercase">Real-time
            Depreciation</div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th class="px-4 py-3">Aktiva</th>
                <th class="px-4 py-3 text-right">Perolehan</th>
                <th class="px-4 py-3 text-center">Umur</th>
                <th class="px-4 py-3 text-right">Akm. Penyusutan</th>
                <th class="px-4 py-3 text-right text-blue-600">Nilai Buku</th>
                <th class="px-4 py-3 text-center">Aksi</th>
              </tr>
            </thead>
            <tbody id="assetTableBody" class="divide-y">
              <!-- Dinamis -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </main>

  <!-- EDIT MODAL -->
  <div id="editModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
      <div class="bg-slate-800 p-4 flex justify-between items-center text-white">
        <h3 class="font-bold"><i class="fas fa-edit mr-2"></i> Edit Data Inventaris</h3>
        <button onclick="closeEditModal()" class="hover:text-red-400"><i class="fas fa-times"></i></button>
      </div>
      <form id="editForm" class="p-6 space-y-4">
        <input type="hidden" id="edit_id">

        <!-- Editable Fields -->
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-1">Nama Aktiva / Inventaris</label>
          <input type="text" id="edit_nama"
            class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
            required>
        </div>

        <div>
          <label class="block text-xs font-bold text-slate-500 mb-1">Kategori (Akun)</label>
          <select id="edit_kategori"
            class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            <!-- Populated via JS -->
          </select>
          <p class="text-[10px] text-blue-500 mt-1 italic">*Mengubah kategori akan memindahkan aset ke akun yang baru.
          </p>
        </div>

        <!-- Read Only Fields -->
        <div class="grid grid-cols-2 gap-4 bg-slate-50 p-3 rounded border border-slate-100">
          <div>
            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Nilai Perolehan</label>
            <input type="text" id="edit_nilai_display"
              class="w-full bg-transparent border-none p-0 text-sm font-bold text-slate-600 font-mono" readonly>
          </div>
          <div>
            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Tanggal Perolehan</label>
            <input type="text" id="edit_tgl_display"
              class="w-full bg-transparent border-none p-0 text-sm font-bold text-slate-600" readonly>
          </div>
          <div class="col-span-2 text-[10px] text-red-500 italic">
            <i class="fas fa-lock mr-1"></i> Nilai & Tanggal dikunci untuk menjaga integritas akuntansi.
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeEditModal()"
            class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold">Batal</button>
          <button type="submit"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-lg">Simpan
            Perubahan</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    const fmt = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    const fmtNum = (n) => new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);

    // --- KONFIGURASI SUPABASE ---
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN";
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    // --- NAVIGATION ---
    function switchApp(viewName) {
      ['view-menu', 'view-overview', 'view-list', 'view-form'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(`view-${viewName}`).classList.remove('hidden');
    }

    // Database Simulasi (Nanti hubungkan ke Supabase)
    let assets = [];

    async function calculateAccounting() {
      const { data, error } = await client
        .from('master_aktiva')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error("Gagal ambil data:", error.message);
        return;
      }

      assets = data || [];
      const today = new Date();
      let totalPerolehan = 0, totalPenyusutan = 0, totalNilaiBuku = 0, totalDeprBulan = 0;

      const tbody = document.getElementById('assetTableBody');
      tbody.innerHTML = '';

      assets.forEach(asset => {
        const tglPerolehan = new Date(asset.tgl_perolehan);
        const selisihBulan = (today.getFullYear() - tglPerolehan.getFullYear()) * 12 + (today.getMonth() - tglPerolehan.getMonth());

        const deprPerBulan = asset.nilai_perolehan / (asset.umur_ekonomis * 12);
        let akmPenyusutan = Math.min(asset.nilai_perolehan, Math.max(0, selisihBulan * deprPerBulan));
        const nilaiBuku = asset.nilai_perolehan - akmPenyusutan;

        totalPerolehan += asset.nilai_perolehan;
        totalPenyusutan += akmPenyusutan;
        totalNilaiBuku += nilaiBuku;
        totalDeprBulan += deprPerBulan;

        tbody.innerHTML += `
          <tr class="hover:bg-slate-50 transition border-b">
            <td class="px-4 py-4">
              <div class="font-bold text-slate-800">${asset.nama_aktiva}</div>
              <div class="text-[10px] text-slate-400 uppercase">
                ${asset.kategori} | ${asset.tahun || new Date(asset.tgl_perolehan).getFullYear()} 
                ${asset.merek ? `| <span class="font-bold text-slate-600">${asset.merek}</span>` : ''}
                ${asset.lokasi ? `| <i class="fas fa-map-marker-alt ml-1"></i> ${asset.lokasi}` : ''}
              </div>
            </td>
            <td class="px-4 py-4 text-right font-mono">${fmt(asset.nilai_perolehan)}</td>
            <td class="px-4 py-4 text-center text-xs font-bold text-slate-500">${asset.umur_ekonomis} Thn</td>
            <td class="px-4 py-4 text-right text-red-500 font-mono">${fmt(akmPenyusutan)}</td>
            <td class="px-4 py-4 text-right font-black text-blue-600 font-mono">${fmt(nilaiBuku)}</td>
            <td class="px-4 py-4 text-center">
               <button onclick="editAsset(${asset.id})" class="text-blue-500 hover:text-blue-700 transition mr-3" title="Edit Kategori"><i class="fas fa-edit"></i></button>
               <button onclick="deleteAsset(${asset.id})" class="text-slate-300 hover:text-red-500 transition" title="Hapus Aset"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`;
      });

      document.getElementById('sumPerolehan').innerText = fmt(totalPerolehan);
      document.getElementById('sumPenyusutan').innerText = fmt(totalPenyusutan);
      document.getElementById('sumNilaiBuku').innerText = fmt(totalNilaiBuku);
      document.getElementById('sumDepresiasiBulanan').innerText = fmt(totalDeprBulan);
      // --- LOGIKA GRAFIK CHART.JS ---
      const ctx = document.getElementById('assetChart').getContext('2d');
      if (window.myChart) { window.myChart.destroy(); }
      const labels = assets.map(a => a.nama_aktiva);
      const dataPerolehan = assets.map(a => a.nilai_perolehan);
      const dataNilaiBuku = assets.map(a => {
        const tgl = new Date(a.tgl_perolehan);
        const bln = (new Date().getFullYear() - tgl.getFullYear()) * 12 + (new Date().getMonth() - tgl.getMonth());
        const depr = a.nilai_perolehan / (a.umur_ekonomis * 12);
        return a.nilai_perolehan - Math.min(a.nilai_perolehan, Math.max(0, bln * depr));
      });

      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Nilai Perolehan',
              data: dataPerolehan,
              backgroundColor: 'rgba(59, 130, 246, 0.5)',
              borderColor: 'rgb(59, 130, 246)',
              borderWidth: 1
            },
            {
              label: 'Nilai Buku (Net)',
              data: dataNilaiBuku,
              backgroundColor: 'rgba(34, 197, 94, 0.5)',
              borderColor: 'rgb(34, 197, 94)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { callback: (value) => fmt(value) } }
          },
          plugins: {
            legend: { position: 'top' }
          }
        }
      });
    }

    // Listener Real-time calculation di form
    document.getElementById('nilai_perolehan').addEventListener('input', updateLiveCalc);
    document.getElementById('umur_ekonomis').addEventListener('input', updateLiveCalc);

    function updateLiveCalc() {
      const v = document.getElementById('nilai_perolehan').value || 0;
      const u = document.getElementById('umur_ekonomis').value || 0;
      const depr = u > 0 ? v / (u * 12) : 0;
      document.getElementById('calcDepresiasi').innerText = fmt(depr);
    }

    // Auto-fill Tahun dari Tgl Perolehan
    document.getElementById('tgl_perolehan').addEventListener('change', function () {
      if (this.value) {
        const year = new Date(this.value).getFullYear();
        document.getElementById('tahun_perolehan').value = year;
      }
    });

    // Simpan Data
    document.getElementById('assetForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const nama = document.getElementById('nama').value;
      const nilai = parseFloat(document.getElementById('nilai_perolehan').value);
      const tgl = document.getElementById('tgl_perolehan').value;
      const umur = parseInt(document.getElementById('umur_ekonomis').value);
      const sumberDana = document.getElementById('sumber_dana').value; // Get Value

      if (!document.getElementById('kategori').value) {
        alert("Mohon pilih Kategori Aset!");
        return;
      }
      if (!sumberDana) {
        alert("Mohon pilih Sumber Dana!");
        return;
      }

      const payload = {
        nama_aktiva: nama,
        kategori: document.getElementById('kategori').value,
        tgl_perolehan: tgl,
        nilai_perolehan: nilai,
        umur_ekonomis: umur,
        lokasi: document.getElementById('lokasi_aset').value,
        tahun: document.getElementById('tahun_perolehan').value,
        merek: document.getElementById('merek').value, // NEW
        status: 'Aktif'
      };

      console.log("Submitting Asset Payload:", payload); // Debugging

      const { data: assetData, error: errAsset } = await client.from('master_aktiva').insert([payload]).select();

      if (errAsset) {
        alert("Gagal simpan aset: " + errAsset.message);
        return;
      }

      const assetId = assetData[0].id; // Get the ID of the new asset
      const refJurnal = `AST-${assetId}`; // Use ID as linkage for Deletion Sync
      const jurnalPayload = [
        {
          tanggal: tgl,
          nomor_referensi: refJurnal,
          keterangan: `Perolehan Aset: ${nama}`,
          nama_akun: payload.kategori, // FIXED: Use Account Name from Category Dropdown
          debit: nilai,
          kredit: 0
        },
        {
          tanggal: tgl,
          nomor_referensi: refJurnal,
          keterangan: `Perolehan Aset: ${nama}`,
          nama_akun: sumberDana, // Dynamic Source Account
          debit: 0,
          kredit: nilai
        }
      ];

      const { error: errJurnal } = await client.from('jurnal_umum').insert(jurnalPayload);

      if (errJurnal) {
        console.error("Jurnal gagal terbentuk otomatis:", errJurnal.message);
        alert("⚠️ PERINGATAN: Aset tersimpan, TETAPI Jurnal Otomatis Gagal Terbentuk!\nError: " + errJurnal.message);
      } else {
        alert("✅ Aset Berhasil Diregistrasi & Jurnal Perolehan Terbentuk (" + sumberDana + ")!");
      }

      this.reset();
      updateLiveCalc();
      calculateAccounting();
    });

    async function postBulananDepresiasi() {
      if (!confirm("Posting beban penyusutan semua aset untuk bulan ini ke Jurnal Umum?")) return;

      const today = new Date();
      const tglJurnal = today.toISOString().split('T')[0];
      let totalBeban = 0;

      assets.forEach(asset => {
        const deprPerBulan = asset.nilai_perolehan / (asset.umur_ekonomis * 12);
        totalBeban += deprPerBulan;
      });

      const ref = `DEP-${today.getMonth() + 1}-${today.getFullYear()}`;
      const payload = [
        {
          tanggal: tglJurnal,
          nomor_referensi: ref,
          keterangan: `Beban Penyusutan Aktiva Tetap Bulanan`,
          nama_akun: 'Beban Penyusutan',
          debit: totalBeban,
          kredit: 0
        },
        {
          tanggal: tglJurnal,
          nomor_referensi: ref,
          keterangan: `Beban Penyusutan Aktiva Tetap Bulanan`,
          nama_akun: 'Akumulasi Penyusutan',
          debit: 0,
          kredit: totalBeban
        }
      ];

      const { error } = await client.from('jurnal_umum').insert(payload);

      if (error) alert("Gagal posting: " + error.message);
      else alert(`✅ Berhasil! Beban penyusutan sebesar ${fmt(totalBeban)} telah dijurnal.`);
    }

    async function deleteAsset(id) {
      if (confirm('Hapus aset ini secara permanen dari database?')) {
        const { error } = await client.from('master_aktiva').delete().eq('id', id);
        if (error) alert("Gagal hapus: " + error.message);
        else calculateAccounting();
      }
    }

    // --- FITUR EDIT ---
    function editAsset(id) {
      const asset = assets.find(a => a.id === id);
      if (!asset) return;

      // Populate Form
      document.getElementById('edit_id').value = asset.id;
      document.getElementById('edit_nama').value = asset.nama_aktiva;
      document.getElementById('edit_nilai_display').value = fmt(asset.nilai_perolehan);
      document.getElementById('edit_tgl_display').value = new Date(asset.tgl_perolehan).toLocaleDateString('id-ID', { dateStyle: 'long' });

      // Populate Select Kategori same as main form
      const mainSelect = document.getElementById('kategori');
      const editSelect = document.getElementById('edit_kategori');
      editSelect.innerHTML = mainSelect.innerHTML;
      editSelect.value = asset.kategori;

      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }

    document.getElementById('editForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const id = document.getElementById('edit_id').value;
      const newName = document.getElementById('edit_nama').value;
      const newCat = document.getElementById('edit_kategori').value;

      // Update Supabase
      const { error } = await client
        .from('master_aktiva')
        .update({ nama_aktiva: newName, kategori: newCat })
        .eq('id', id);

      if (error) {
        alert("Gagal update: " + error.message);
      } else {
        alert("✅ Data Inventaris Berhasil Diperbarui!");
        closeEditModal();
        calculateAccounting(); // Refresh Table
      }
    });

    async function downloadLaporanAsetPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      const tglCetak = new Date().toLocaleDateString('id-ID');

      doc.setFontSize(16); doc.setFont("helvetica", "bold");
      doc.text("PT. NUSANTARA LAND DEVELOPMENT", 14, 15);
      doc.setFontSize(9); doc.setFont("helvetica", "normal");
      doc.text("Jl. Sunset Boulevard Blok 5B/16 CitraLand City, Makassar, 90224, Indonesia", 14, 20);
      doc.text("Laporan Aktiva Tetap & Akumulasi Penyusutan (Fixed Asset Ledger)", 14, 25);
      doc.setLineWidth(0.5); doc.line(14, 28, 283, 28);

      doc.setFontSize(11); doc.setFont("helvetica", "bold");
      doc.text("DAFTAR INVENTARIS AKTIVA TETAP", 14, 38);
      doc.setFontSize(9); doc.setFont("helvetica", "italic");
      doc.text(`Per Tanggal: ${tglCetak}`, 14, 43);

      const body = assets.map((asset, index) => {
        const tgl = new Date(asset.tgl_perolehan);
        const today = new Date();
        const selisihBulan = (today.getFullYear() - tgl.getFullYear()) * 12 + (today.getMonth() - tgl.getMonth());
        const deprPerBulan = asset.nilai_perolehan / (asset.umur_ekonomis * 12);
        let akmPenyusutan = Math.min(asset.nilai_perolehan, Math.max(0, selisihBulan * deprPerBulan));
        const nilaiBuku = asset.nilai_perolehan - akmPenyusutan;

        return [
          index + 1,
          asset.nama_aktiva,
          asset.merek || '-', // NEW
          asset.kategori,
          asset.lokasi || '-',
          asset.tahun || new Date(asset.tgl_perolehan).getFullYear(),
          asset.umur_ekonomis + " Thn",
          fmtNum(asset.nilai_perolehan),
          fmtNum(akmPenyusutan),
          fmtNum(nilaiBuku)
        ];
      });

      doc.autoTable({
        startY: 48,
        head: [['No', 'Nama Aktiva', 'Merek', 'Kategori', 'Lokasi', 'Thn', 'Umur', 'Nilai Awal', 'Penyusutan', 'Nilai Buku']],
        body: body,
        theme: 'grid',
        headStyles: { fillColor: [30, 41, 59], textColor: 255, fontStyle: 'bold', fontSize: 8 },
        styles: { fontSize: 8, cellPadding: 3 },
        columnStyles: {
          5: { halign: 'right' },
          6: { halign: 'right' },
          7: { halign: 'right', fontStyle: 'bold' }
        },
        foot: [[
          { content: 'TOTAL KESELURUHAN', colSpan: 5, styles: { halign: 'right', fontStyle: 'bold' } },
          { content: document.getElementById('sumPerolehan').innerText.replace('Rp', '').trim(), styles: { halign: 'right', fontStyle: 'bold' } },
          { content: document.getElementById('sumPenyusutan').innerText.replace('Rp', '').trim(), styles: { halign: 'right', fontStyle: 'bold' } },
          { content: document.getElementById('sumNilaiBuku').innerText.replace('Rp', '').trim(), styles: { halign: 'right', fontStyle: 'bold' } }
        ]],
        footStyles: { fillColor: [241, 245, 249], textColor: 0 }
      });

      let finalY = doc.lastAutoTable.finalY + 20;
      if (finalY > 170) { doc.addPage(); finalY = 20; }

      doc.setFont("helvetica", "normal");
      doc.text(`Makassar, ${tglCetak}`, 220, finalY);
      doc.text("Diperiksa Oleh,", 20, finalY + 5);
      doc.text("Disetujui Oleh,", 120, finalY + 5);
      doc.text("Dibuat Oleh,", 220, finalY + 5);

      doc.setFont("helvetica", "bold");
      doc.text("( _________________ )", 20, finalY + 25);
      doc.text("Internal Auditor", 20, finalY + 30);

      doc.text("( _________________ )", 120, finalY + 25);
      doc.text("Direktur Utama", 120, finalY + 30);

      doc.text("( Wahyuni )", 220, finalY + 25);
      doc.text("Finance Manager", 220, finalY + 30);

      doc.save(`Laporan_Aktiva_Tetap_NLD_${tglCetak}.pdf`);
    }

    async function loadKategoriDariCOA() {
      const { data, error } = await client
        .from('master_akun')
        .select('nama_akun, kode_akun')
        .eq('kategori', 'Aset Tetap')
        .order('nama_akun', { ascending: true });

      if (error) {
        console.error("Gagal load kategori aset tetap:", error.message);
        return;
      }

      const selectKategori = document.getElementById("kategori");
      // Add placeholder for Tom Select
      selectKategori.innerHTML = '<option value="" disabled selected>Pilih Kategori Aset...</option>';

      if (data && data.length > 0) {
        data.forEach(akun => {
          const option = document.createElement('option');
          option.value = akun.nama_akun;
          option.innerText = `[${akun.kode_akun}] ${akun.nama_akun}`;
          selectKategori.appendChild(option);
        });

        // Initialize Tom Select
        new TomSelect('#kategori', {
          create: false,
          sortField: { field: "text", direction: "asc" },
          placeholder: "Cari Kategori...",
        });
      }
    }

    async function loadSumberDanaDariCOA() {
      const { data, error } = await client
        .from('master_akun')
        .select('nama_akun, kode_akun, kategori')
        .or('kategori.ilike.%kas%,kategori.ilike.%bank%,kategori.ilike.%kewajiban%,kategori.ilike.%hutang%,kategori.ilike.%modal%,kategori.ilike.%ekuitas%,kategori.ilike.%aset lancar%,kategori.ilike.%current asset%')
        .order('kategori', { ascending: true })
        .order('nama_akun', { ascending: true });

      if (error) {
        console.error("Gagal load sumber dana:", error.message);
        return;
      }

      const select = document.getElementById("sumber_dana");
      select.innerHTML = '<option value="" disabled selected>Pilih atau Ketik Sumber Dana...</option>';

      if (data && data.length > 0) {
        data.forEach(acc => {
          let type = 'Lainnya';
          const cat = (acc.kategori || '').toLowerCase();
          if (cat.includes('kas') || cat.includes('bank') || cat.includes('aset lancar') || cat.includes('current')) type = 'ASET LANCAR (KAS & BANK)';
          else if (cat.includes('hutang') || cat.includes('kewajiban')) type = 'KEWAJIBAN (HUTANG)';
          else if (cat.includes('modal') || cat.includes('ekuitas')) type = 'MODAL (EKUITAS)';

          // Jika belum ada optgroup untuk type ini
          let optGroup = select.querySelector(`optgroup[label="${type}"]`);
          if (!optGroup) {
            optGroup = document.createElement('optgroup');
            optGroup.label = type;
            select.appendChild(optGroup);
          }

          const option = document.createElement('option');
          option.value = acc.nama_akun;
          option.innerText = `[${acc.kode_akun}] ${acc.nama_akun}`;
          optGroup.appendChild(option);
        });

        // Initialize Tom Select
        new TomSelect('#sumber_dana', {
          create: false,
          sortField: { field: "text", direction: "asc" },
          placeholder: "Ketik untuk mencari...",
          maxOptions: 100
        });

      } else {
        select.innerHTML = '<option value="" disabled>Data COA Kosong</option>';
      }
    }

    // Jalankan Saat Start
    loadKategoriDariCOA();
    loadSumberDanaDariCOA(); // NEW
    calculateAccounting();
  </script>
</body>

</html>