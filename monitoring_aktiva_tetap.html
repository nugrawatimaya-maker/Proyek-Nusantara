<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoring Aktiva Tetap - Standard Akuntansi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
    th { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
  </style>
</head>
<body class="pb-20">

  <header class="bg-white border-b border-slate-200 sticky top-0 z-50 px-6 py-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg">
          <i class="fas fa-boxes-stacked text-xl"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold text-slate-800">Fixed Asset Monitoring</h1>
          <p class="text-xs text-slate-500">Standar Akuntansi Penyusutan Garis Lurus</p>
        </div>
      </div>
      <button onclick="window.location.href='dashboard_finance.html'" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-full text-sm font-semibold transition flex items-center gap-2">
        <i class="fas fa-arrow-left"></i> Dashboard
      </button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 mt-8 space-y-8">
    <div class="card p-6 mb-8">
      <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
        <i class="fas fa-chart-bar text-purple-500"></i> Analisis Nilai Aset vs Penyusutan
      </h2>
      <div style="height: 300px;">
        <canvas id="assetChart"></canvas>
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="card p-5 border-l-4 border-blue-500">
        <div class="text-xs font-bold text-slate-400 uppercase">Total Nilai Perolehan</div>
        <div class="text-2xl font-black text-slate-800 mt-1" id="sumPerolehan">Rp 0</div>
      </div>
      <div class="card p-5 border-l-4 border-red-500">
        <div class="text-xs font-bold text-slate-400 uppercase">Akumulasi Penyusutan</div>
        <div class="text-2xl font-black text-red-600 mt-1" id="sumPenyusutan">Rp 0</div>
      </div>
      <div class="card p-5 border-l-4 border-green-500">
        <div class="text-xs font-bold text-slate-400 uppercase">Total Nilai Buku (Net)</div>
        <div class="text-2xl font-black text-green-600 mt-1" id="sumNilaiBuku">Rp 0</div>
      </div>
      <div class="card p-5 border-l-4 border-purple-500">
        <div class="text-xs font-bold text-slate-400 uppercase">Depresiasi Bln Ini</div>
        <div class="text-2xl font-black text-purple-600 mt-1" id="sumDepresiasiBulanan">Rp 0</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-1 space-y-4">
        <div class="card p-6">
          <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fas fa-plus-circle text-blue-500"></i> Register Aset Baru
          </h2>
          <form id="assetForm" class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-1">Nama Aktiva</label>
              <input type="text" id="nama" class="w-full border rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Toyota Dyna Dump Truck" required>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Kategori</label>
                <select id="kategori" class="w-full border rounded-lg p-2.5 text-sm outline-none">
                  <option>Bangunan</option>
                  <option>Kendaraan</option>
                  <option>Mesin</option>
                  <option>Peralatan IT</option>
                  <option>Inventaris</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Tgl Perolehan</label>
                <input type="date" id="tgl_perolehan" class="w-full border rounded-lg p-2.5 text-sm outline-none" required>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Nilai Perolehan</label>
                <input type="number" id="nilai_perolehan" class="w-full border rounded-lg p-2.5 text-sm outline-none" placeholder="Rp" required>
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Umur (Tahun)</label>
                <input type="number" id="umur_ekonomis" class="w-full border rounded-lg p-2.5 text-sm outline-none" placeholder="Thn" required>
              </div>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
              <div class="flex justify-between text-[10px] font-bold text-blue-600 uppercase">Estimasi Depresiasi / Bln:</div>
              <div class="text-lg font-black text-blue-700" id="calcDepresiasi">Rp 0</div>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95">
              Simpan Aset & Hitung Jurnal
            </button>
          </form>
        </div>
      </div>

      <div class="lg:col-span-2">
        <div class="card overflow-hidden">
          <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
            <h2 class="font-bold text-slate-700">Daftar Aktiva & Nilai Buku</h2>
            <div class="text-[10px] px-2 py-1 bg-green-100 text-green-700 rounded font-bold uppercase">Real-time Depreciation</div>
          </div>
          <div class="flex justify-end mb-2 px-4">
            <button onclick="postBulananDepresiasi()" class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold px-4 py-2 rounded-lg shadow transition">
              <i class="fas fa-sync-alt mr-2"></i> Posting Depresiasi Bulan Ini
            </button>
          </div>
          <div class="flex justify-end px-4 py-2">
            <button onclick="downloadLaporanAsetPDF()" class="bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold px-4 py-2 rounded-lg shadow transition flex items-center gap-2">
              <i class="fas fa-file-pdf"></i> Cetak Laporan PDF
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="bg-slate-100 text-slate-600">
                <tr>
                  <th class="px-4 py-3">Aktiva</th>
                  <th class="px-4 py-3 text-right">Perolehan</th>
                  <th class="px-4 py-3 text-center">Umur</th>
                  <th class="px-4 py-3 text-right">Akm. Penyusutan</th>
                  <th class="px-4 py-3 text-right text-blue-600">Nilai Buku</th>
                  <th class="px-4 py-3 text-center">Aksi</th>
                </tr>
              </thead>
              <tbody id="assetTableBody" class="divide-y">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    </main>
    <button onclick="downloadLaporanAsetPDF()" class="bg-red-600 hover:bg-red-700 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center transition transform hover:scale-110 active:scale-90 fixed bottom-10 right-10 z-[100]" title="Cetak Laporan PDF">
      <i class="fas fa-file-pdf fa-lg"></i>
    </button>

  <script>
    const fmt = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    const fmtNum = (n) => new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);

    // --- KONFIGURASI SUPABASE ---
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN";
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    // Database Simulasi (Nanti hubungkan ke Supabase)
    let assets = [];

    async function calculateAccounting() {
      const { data, error } = await client
        .from('master_aktiva')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error("Gagal ambil data:", error.message);
        return;
      }

      assets = data || [];
      const today = new Date();
      let totalPerolehan = 0, totalPenyusutan = 0, totalNilaiBuku = 0, totalDeprBulan = 0;
      
      const tbody = document.getElementById('assetTableBody');
      tbody.innerHTML = '';

      assets.forEach(asset => {
        const tglPerolehan = new Date(asset.tgl_perolehan);
        const selisihBulan = (today.getFullYear() - tglPerolehan.getFullYear()) * 12 + (today.getMonth() - tglPerolehan.getMonth());
        
        const deprPerBulan = asset.nilai_perolehan / (asset.umur_ekonomis * 12);
        let akmPenyusutan = Math.min(asset.nilai_perolehan, Math.max(0, selisihBulan * deprPerBulan));
        const nilaiBuku = asset.nilai_perolehan - akmPenyusutan;

        totalPerolehan += asset.nilai_perolehan;
        totalPenyusutan += akmPenyusutan;
        totalNilaiBuku += nilaiBuku;
        totalDeprBulan += deprPerBulan;

        tbody.innerHTML += `
          <tr class="hover:bg-slate-50 transition border-b">
            <td class="px-4 py-4">
              <div class="font-bold text-slate-800">${asset.nama_aktiva}</div>
              <div class="text-[10px] text-slate-400 uppercase">${asset.kategori} | ${asset.tgl_perolehan}</div>
            </td>
            <td class="px-4 py-4 text-right font-mono">${fmt(asset.nilai_perolehan)}</td>
            <td class="px-4 py-4 text-center text-xs font-bold text-slate-500">${asset.umur_ekonomis} Thn</td>
            <td class="px-4 py-4 text-right text-red-500 font-mono">${fmt(akmPenyusutan)}</td>
            <td class="px-4 py-4 text-right font-black text-blue-600 font-mono">${fmt(nilaiBuku)}</td>
            <td class="px-4 py-4 text-center">
              <button onclick="deleteAsset(${asset.id})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`;
      });

      document.getElementById('sumPerolehan').innerText = fmt(totalPerolehan);
      document.getElementById('sumPenyusutan').innerText = fmt(totalPenyusutan);
      document.getElementById('sumNilaiBuku').innerText = fmt(totalNilaiBuku);
      document.getElementById('sumDepresiasiBulanan').innerText = fmt(totalDeprBulan);
      // --- LOGIKA GRAFIK CHART.JS ---
      const ctx = document.getElementById('assetChart').getContext('2d');
      if (window.myChart) { window.myChart.destroy(); }
      const labels = assets.map(a => a.nama_aktiva);
      const dataPerolehan = assets.map(a => a.nilai_perolehan);
      const dataNilaiBuku = assets.map(a => {
        const tgl = new Date(a.tgl_perolehan);
        const bln = (new Date().getFullYear() - tgl.getFullYear()) * 12 + (new Date().getMonth() - tgl.getMonth());
        const depr = a.nilai_perolehan / (a.umur_ekonomis * 12);
        return a.nilai_perolehan - Math.min(a.nilai_perolehan, Math.max(0, bln * depr));
      });

      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Nilai Perolehan',
              data: dataPerolehan,
              backgroundColor: 'rgba(59, 130, 246, 0.5)',
              borderColor: 'rgb(59, 130, 246)',
              borderWidth: 1
            },
            {
              label: 'Nilai Buku (Net)',
              data: dataNilaiBuku,
              backgroundColor: 'rgba(34, 197, 94, 0.5)',
              borderColor: 'rgb(34, 197, 94)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { callback: (value) => fmt(value) } }
          },
          plugins: {
            legend: { position: 'top' }
          }
        }
      });
    }

    // Listener Real-time calculation di form
    document.getElementById('nilai_perolehan').addEventListener('input', updateLiveCalc);
    document.getElementById('umur_ekonomis').addEventListener('input', updateLiveCalc);

    function updateLiveCalc() {
      const v = document.getElementById('nilai_perolehan').value || 0;
      const u = document.getElementById('umur_ekonomis').value || 0;
      const depr = u > 0 ? v / (u * 12) : 0;
      document.getElementById('calcDepresiasi').innerText = fmt(depr);
    }

    // Simpan Data
    document.getElementById('assetForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const nama = document.getElementById('nama').value;
      const nilai = parseFloat(document.getElementById('nilai_perolehan').value);
      const tgl = document.getElementById('tgl_perolehan').value;
      const umur = parseInt(document.getElementById('umur_ekonomis').value);

      const payload = {
        nama_aktiva: nama,
        kategori: document.getElementById('kategori').value,
        tgl_perolehan: tgl,
        nilai_perolehan: nilai,
        umur_ekonomis: umur,
        status: 'Aktif'
      };

      const { data: assetData, error: errAsset } = await client.from('master_aktiva').insert([payload]).select();

      if (errAsset) {
        alert("Gagal simpan aset: " + errAsset.message);
        return;
      }

      const refJurnal = `AST-${Date.now()}`;
      const jurnalPayload = [
        { 
          tanggal: tgl, 
          nomor_referensi: refJurnal, 
          keterangan: `Perolehan Aset: ${nama}`, 
          nama_akun: 'Aktiva Tetap', 
          debit: nilai, 
          kredit: 0 
        },
        { 
          tanggal: tgl, 
          nomor_referensi: refJurnal, 
          keterangan: `Perolehan Aset: ${nama}`, 
          nama_akun: 'Kas/Bank', 
          debit: 0, 
          kredit: nilai 
        }
      ];

      const { error: errJurnal } = await client.from('jurnal_umum').insert(jurnalPayload);

      if (errJurnal) {
        console.error("Jurnal gagal terbentuk otomatis:", errJurnal.message);
      }

      alert("✅ Aset Berhasil Diregistrasi & Jurnal Perolehan Terbentuk!");
      this.reset();
      updateLiveCalc();
      calculateAccounting();
    });

    async function postBulananDepresiasi() {
      if(!confirm("Posting beban penyusutan semua aset untuk bulan ini ke Jurnal Umum?")) return;

      const today = new Date();
      const tglJurnal = today.toISOString().split('T')[0];
      let totalBeban = 0;

      assets.forEach(asset => {
        const deprPerBulan = asset.nilai_perolehan / (asset.umur_ekonomis * 12);
        totalBeban += deprPerBulan;
      });

      const ref = `DEP-${today.getMonth() + 1}-${today.getFullYear()}`;
      const payload = [
        { 
          tanggal: tglJurnal, 
          nomor_referensi: ref, 
          keterangan: `Beban Penyusutan Aktiva Tetap Bulanan`, 
          nama_akun: 'Beban Penyusutan', 
          debit: totalBeban, 
          kredit: 0 
        },
        { 
          tanggal: tglJurnal, 
          nomor_referensi: ref, 
          keterangan: `Beban Penyusutan Aktiva Tetap Bulanan`, 
          nama_akun: 'Akumulasi Penyusutan', 
          debit: 0, 
          kredit: totalBeban 
        }
      ];

      const { error } = await client.from('jurnal_umum').insert(payload);
      
      if(error) alert("Gagal posting: " + error.message);
      else alert(`✅ Berhasil! Beban penyusutan sebesar ${fmt(totalBeban)} telah dijurnal.`);
    }

    async function deleteAsset(id) {
      if(confirm('Hapus aset ini secara permanen dari database?')) {
        const { error } = await client.from('master_aktiva').delete().eq('id', id);
        if (error) alert("Gagal hapus: " + error.message);
        else calculateAccounting();
      }
    }

    async function downloadLaporanAsetPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      const tglCetak = new Date().toLocaleDateString('id-ID');

      doc.setFontSize(16); doc.setFont("helvetica", "bold");
      doc.text("PT. NUSANTARA LAND DEVELOPMENT", 14, 15);
      doc.setFontSize(9); doc.setFont("helvetica", "normal");
      doc.text("Jl. Sunset Boulevard Blok 5B/16 CitraLand City, Makassar, 90224, Indonesia", 14, 20);
      doc.text("Laporan Aktiva Tetap & Akumulasi Penyusutan (Fixed Asset Ledger)", 14, 25);
      doc.setLineWidth(0.5); doc.line(14, 28, 283, 28);

      doc.setFontSize(11); doc.setFont("helvetica", "bold");
      doc.text("DAFTAR INVENTARIS AKTIVA TETAP", 14, 38);
      doc.setFontSize(9); doc.setFont("helvetica", "italic");
      doc.text(`Per Tanggal: ${tglCetak}`, 14, 43);

      const body = assets.map((asset, index) => {
        const tgl = new Date(asset.tgl_perolehan);
        const today = new Date();
        const selisihBulan = (today.getFullYear() - tgl.getFullYear()) * 12 + (today.getMonth() - tgl.getMonth());
        const deprPerBulan = asset.nilai_perolehan / (asset.umur_ekonomis * 12);
        let akmPenyusutan = Math.min(asset.nilai_perolehan, Math.max(0, selisihBulan * deprPerBulan));
        const nilaiBuku = asset.nilai_perolehan - akmPenyusutan;

        return [
          index + 1,
          asset.nama_aktiva,
          asset.kategori,
          asset.tgl_perolehan,
          asset.umur_ekonomis + " Thn",
          fmtNum(asset.nilai_perolehan),
          fmtNum(akmPenyusutan),
          fmtNum(nilaiBuku)
        ];
      });

      doc.autoTable({
        startY: 48,
        head: [['No', 'Nama Aktiva', 'Kategori (COA)', 'Tgl Perolehan', 'Umur', 'Nilai Perolehan', 'Akm. Penyusutan', 'Nilai Buku (Net)']],
        body: body,
        theme: 'grid',
        headStyles: { fillColor: [30, 41, 59], textColor: 255, fontStyle: 'bold', fontSize: 8 },
        styles: { fontSize: 8, cellPadding: 3 },
        columnStyles: {
          5: { halign: 'right' },
          6: { halign: 'right' },
          7: { halign: 'right', fontStyle: 'bold' }
        },
        foot: [[
          { content: 'TOTAL KESELURUHAN', colSpan: 5, styles: { halign: 'right', fontStyle: 'bold' } },
          { content: document.getElementById('sumPerolehan').innerText.replace('Rp', '').trim(), styles: { halign: 'right', fontStyle: 'bold' } },
          { content: document.getElementById('sumPenyusutan').innerText.replace('Rp', '').trim(), styles: { halign: 'right', fontStyle: 'bold' } },
          { content: document.getElementById('sumNilaiBuku').innerText.replace('Rp', '').trim(), styles: { halign: 'right', fontStyle: 'bold' } }
        ]],
        footStyles: { fillColor: [241, 245, 249], textColor: 0 }
      });

      let finalY = doc.lastAutoTable.finalY + 20;
      if (finalY > 170) { doc.addPage(); finalY = 20; }
      
      doc.setFont("helvetica", "normal");
      doc.text(`Makassar, ${tglCetak}`, 220, finalY);
      doc.text("Diperiksa Oleh,", 20, finalY + 5);
      doc.text("Disetujui Oleh,", 120, finalY + 5);
      doc.text("Dibuat Oleh,", 220, finalY + 5);

      doc.setFont("helvetica", "bold");
      doc.text("( _________________ )", 20, finalY + 25);
      doc.text("Internal Auditor", 20, finalY + 30);
      
      doc.text("( _________________ )", 120, finalY + 25);
      doc.text("Direktur Utama", 120, finalY + 30);
      
      doc.text("( Wahyuni )", 220, finalY + 25);
      doc.text("Finance Manager", 220, finalY + 30);

      doc.save(`Laporan_Aktiva_Tetap_NLD_${tglCetak}.pdf`);
    }

    async function loadKategoriDariCOA() {
      const { data, error } = await client
        .from('master_akun')
        .select('nama_akun')
        .eq('kategori', 'Aset Tetap');

      if (error) {
        console.error("Gagal load kategori aset tetap:", error.message);
        return;
      }

      if (data && data.length > 0) {
        const selectKategori = document.getElementById("kategori");
        selectKategori.innerHTML = data.map(akun =>
          `<option value="${akun.nama_akun}">${akun.nama_akun}</option>`
        ).join('');
      }
    }

    // Jalankan Saat Start
    loadKategoriDariCOA();
    calculateAccounting();
  </script>
</body>
</html>
