<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Direksi - Antrian Persetujuan</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="supabase.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="app_config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Check Auth: Direksi, Finance, Superadmin
        // User Request: Finance & Superadmin can see ALL dashboards.
        PNAuth.requireAuth(['direksi', 'finance', 'superadmin']);

        // RESTRICTION: Block Uni (564185) & Husain (198939) from Director Dashboard
        const sess = PNAuth.getSession();
        if (sess && sess.user) {
            const uid = sess.user.id;
            const uName = sess.user.full_name ? sess.user.full_name.toLowerCase() : "";

            // Block IDs explicitly
            if (uid == '564185' || uid == '198939' || uName.includes('uni') || uName.includes('husain')) {
                alert("⛔ AKSES DITOLAK\nAnda dibatasi hanya untuk Dashboard Finance.");
                window.location.href = 'dashboard_finance.html';
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            to {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i class="fas fa-shield-check text-white text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 tracking-tight">Executive Approval Dashboard</h1>
                </div>

                <!-- Navigation Shortcuts -->
                <div class="hidden md:flex items-center gap-1 bg-gray-100/50 p-1 rounded-lg border border-gray-200">
                    <a href="portal_proyek.html"
                        class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-gray-600 hover:text-blue-600 hover:bg-white rounded-md transition-all"
                        title="Home">
                        <i class="fas fa-home"></i> <span class="hidden lg:inline">Home</span>
                    </a>
                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                    <a href="dashboard_operasional.html"
                        class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-gray-600 hover:text-blue-600 hover:bg-white rounded-md transition-all"
                        title="Operasional">
                        <i class="fas fa-hard-hat"></i> <span class="hidden lg:inline">Ops</span>
                    </a>
                    <a href="dashboard_finance.html"
                        class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-gray-600 hover:text-blue-600 hover:bg-white rounded-md transition-all"
                        title="Finance">
                        <i class="fas fa-wallet"></i> <span class="hidden lg:inline">Finance</span>
                    </a>
                    <a href="dashboard_marketing.html"
                        class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-gray-600 hover:text-blue-600 hover:bg-white rounded-md transition-all"
                        title="Marketing">
                        <i class="fas fa-bullhorn"></i> <span class="hidden lg:inline">Mkt</span>
                    </a>
                    <a href="dashboard_hr.html"
                        class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-gray-600 hover:text-blue-600 hover:bg-white rounded-md transition-all"
                        title="HR">
                        <i class="fas fa-users"></i> <span class="hidden lg:inline">HR</span>
                    </a>
                </div>

                <div class="flex items-center gap-4">
                    <!-- User Info & Logout -->
                    <div class="text-right hidden md:block mr-2">
                        <div id="user-display" class="text-sm font-bold text-gray-800">User</div>
                        <div id="role-display" class="text-[10px] text-gray-500 uppercase tracking-wider">Direksi</div>
                    </div>

                    <span id="env-badge"
                        class="hidden px-2 py-1 rounded text-[10px] font-bold uppercase tracking-widest bg-amber-100 text-amber-700 border border-amber-200">Mode
                        Dev</span>
                    <button onclick="loadApprovalQueue()"
                        class="text-gray-500 hover:text-blue-600 transition-colors p-2" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>

                    <button onclick="PNAuth.logout()"
                        class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </button>
                </div>
            </div>
        </div>
    </nav>
    </nav>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900">Dashboard Overview</h2>
            <p class="text-sm text-gray-500">Ringkasan aktivitas persetujuan dan metrik kunci.</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 relative overflow-hidden group hover:shadow-md transition-all">
                <div
                    class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                </div>
                <div class="relative">
                    <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Total Antrian</div>
                    <div class="flex items-baseline gap-2">
                        <span id="stat-total-count" class="text-3xl font-bold text-gray-900">-</span>
                        <span
                            class="text-xs text-blue-600 font-medium bg-blue-50 px-2 py-0.5 rounded-full">Pending</span>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-sm text-gray-400">
                        <i class="fas fa-list-ul"></i>
                        <span>Item menunggu review</span>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 relative overflow-hidden group hover:shadow-md transition-all">
                <div
                    class="absolute top-0 right-0 w-24 h-24 bg-green-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                </div>
                <div class="relative">
                    <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Total Nilai</div>
                    <div class="flex items-baseline gap-2">
                        <span id="stat-total-value" class="text-3xl font-bold text-gray-900">-</span>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-sm text-green-600">
                        <i class="fas fa-coins"></i>
                        <span>Estimasi Rupiah</span>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 relative overflow-hidden group hover:shadow-md transition-all">
                <div
                    class="absolute top-0 right-0 w-24 h-24 bg-purple-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                </div>
                <div class="relative">
                    <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Kategori Terbanyak
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="stat-top-category" class="text-xl font-bold text-gray-900">-</span>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-sm text-purple-600">
                        <i class="fas fa-chart-pie"></i>
                        <span>Dominasi Pengajuan</span>
                    </div>
                </div>
            </div>
        </div>



        <div class="mb-6 flex justify-between items-end">
            <div>
                <h2 class="text-lg font-bold text-gray-900">Daftar Antrian</h2>
                <p class="text-sm text-gray-500">Menampilkan pengajuan yang memerlukan validasi Anda.</p>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-50/50 border-b border-gray-100">
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase">Kategori</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase">Deskripsi Item</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase text-right">Nominal</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase text-center">Lampiran</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase">Diajukan</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="approval-queue-body" class="divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Gunakan jembatan 'client' dari app_config.js
        // fmt(n) juga sudah tersedia dari app_config.js jika Anda ingin format mata uang cepat

        async function loadApprovalQueue() {
            const tbody = document.getElementById('approval-queue-body');
            tbody.innerHTML = `<tr><td colspan="5" class="py-20 text-center"><div class="flex flex-col items-center justify-center gap-3"><i class="fas fa-circle-notch fa-spin text-blue-600 text-3xl"></i><span class="text-gray-400 text-sm animate-pulse">Memuat data...</span></div></td></tr>`;

            try {
                // Debug: Cek koneksi client
                if (!client || !client.from) throw new Error("Supabase Client belum terinisialisasi. Cek app_config.js");

                // --- 1. Fetch from 'approval_queue' (Old System / PO) ---
                const p1 = client
                    .from('approval_queue')
                    .select('id, title, description, amount, requester, created_at, source_table, source_id, status')
                    .eq('status', 'PENDING')
                    .order('created_at', { ascending: false });

                // --- 2. Fetch from 'transaksi' (New Expense Requests) ---
                const p2 = client
                    .from('transaksi')
                    .select('id, keterangan, jumlah, tanggal, jenis_transaksi') // OPTIMIZED SELECT
                    .eq('jenis_transaksi', 'PENGAJUAN') // Filter pending expense
                    .order('tanggal', { ascending: false });

                // --- 3. Fetch from 'transaksi_upah' (Upah Tukang - Pending Direksi) ---
                const p3 = client
                    .from('transaksi_upah')
                    .select('id, kavling, nama_pekerjaan, nilai_bayar, tanggal_bayar, status')
                    .eq('status', 'PENDING_DIREKSI')
                    .order('tanggal_bayar', { ascending: false });

                const [resQueue, resTrans, resUpah] = await Promise.all([p1, p2, p3]);

                if (resQueue.error) throw resQueue.error;
                if (resTrans.error) throw resTrans.error;
                if (resUpah.error) throw resUpah.error;

                const dataQueue = resQueue.data || [];
                // DEDUPLICATION (Fixes "Not Disappearing" Bug):
                // Filter out direct items if they already exist in the Queue list
                const rawTrans = resTrans.data || [];
                const rawUpah = resUpah.data || [];

                const dataTrans = rawTrans.filter(t => !dataQueue.some(q => q.source_table === 'transaksi' && q.source_id == t.id));
                const dataUpah = rawUpah.filter(u => !dataQueue.some(q => q.source_table === 'transaksi_upah' && q.source_id == u.id));

                // --- 3. Normalize & Merge Data ---
                // Map 'transaksi' items to look like 'approval_queue' items
                const mappedTrans = dataTrans.map(t => {
                    // Parse Requester from [REQ:ID] if possible, or just use [DIV] part
                    let reqName = "Karyawan";
                    let title = "Pengajuan Biaya";

                    if (t.keterangan) {
                        // Try to extract Divisi or Name
                        const match = t.keterangan.match(/\[(.*?)\]/);
                        if (match) title = `Request ${match[1]}`; // e.g. Request UMUM
                    }

                    return {
                        id: t.id, // Use same ID, but handle action differently
                        source_table: 'transaksi', // Marker
                        source_id: t.id,
                        title: title,
                        description: t.keterangan,
                        amount: t.jumlah,
                        requester: reqName, // We don't have name easily, maybe fetch later?
                        created_at: t.tanggal, // use date
                        status: 'PENDING',
                        is_transaksi: true // Flag
                    };
                });

                // Map 'transaksi_upah' items
                const mappedUpah = dataUpah.map(u => {
                    return {
                        id: u.id,
                        source_table: 'transaksi_upah',
                        source_id: u.id,
                        title: `Upah Tukang - ${u.kavling}`,
                        description: u.nama_pekerjaan,
                        amount: u.nilai_bayar,
                        requester: "Teknik / Lapangan",
                        created_at: u.tanggal_bayar || new Date().toISOString(),
                        status: 'PENDING_DIREKSI',
                        is_transaksi: false
                    };
                });

                let combinedData = [...dataQueue, ...mappedTrans, ...mappedUpah];

                // --- 4. ACCESS CONTROL RULES (TAUFIQ & TRI WIJAYA) ---
                // --- 4. ACCESS CONTROL RULES (TAUFIQ & TRI WIJAYA) ---
                const sess = typeof PNAuth !== 'undefined' ? PNAuth.getSession() : null;
                if (sess && sess.user) {
                    const uid = String(sess.user.id || '');
                    const uName = (sess.user.full_name || '').toLowerCase();

                    console.log("DEBUG AUTH:", { uid, uName });

                    // RULE 1: TAUFIQ (782757)
                    if (uid === '782757' || uName.includes('taufiq')) {
                        console.log("Applying Taufiq Rules...");
                        combinedData = combinedData.filter(item => {
                            const src = (item.source_table || '').toLowerCase();
                            const amt = Number(item.amount) || 0;

                            // Allow Proyek Baru
                            if (src.includes('master_proyek')) return true;

                            // Allow PO < 5M
                            if (src.includes('purchase_order') || src.includes('inventory_req')) {
                                return amt < 5000000;
                            }

                            return false;
                        });
                    }

                    // RULE 2: TRI WIJAYA (325777)
                    else if (uid === '325777' || uName.includes('tri wijaya') || uName.includes('triwijaya')) {
                        console.log("Applying Tri Wijaya Rules...");
                        combinedData = combinedData.filter(item => {
                            const src = (item.source_table || '').toLowerCase();
                            const amt = Number(item.amount) || 0;

                            // Filter PO > 5M
                            if (src.includes('purchase_order') || src.includes('inventory_req')) {
                                return amt > 5000000;
                            }
                            // Allow Others (Biaya/Proyek/Upah)
                            return true;
                        });
                    }
                }

                // Sort by date desc
                combinedData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                // --- UPDATE SUMMARY CARDS ---
                updateDashboardStats(combinedData || []);

                if (combinedData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-20 text-center">
                                <div class="flex flex-col items-center">
                                    <div class="bg-green-50 text-green-500 w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-sm">
                                        <i class="fas fa-check-double text-2xl"></i>
                                    </div>
                                    <h3 class="text-gray-900 font-semibold text-lg">Semua Beres!</h3>
                                    <p class="text-gray-500 text-sm max-w-xs mx-auto mt-1">Tidak ada antrian persetujuan yang tertunda. Nikmati hari Anda!</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }

                tbody.innerHTML = combinedData.map(item => {
                    const requesterName = item.requester || 'Anonim';
                    const requesterInitial = requesterName.charAt(0).toUpperCase();

                    // Logic Lampiran
                    let lampiranHtml = '<span class="text-gray-300">-</span>';

                    if (item.source_table === 'purchase_order' || item.source_table === 'purchase_order_request') {
                        lampiranHtml = `
                            <button onclick="viewPODetails('${item.source_id}', '${item.title}')" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:text-indigo-700 transition-colors text-xs font-semibold group-link">
                                <i class="fas fa-eye"></i> PO Detail
                            </button>`;
                    } else if (item.source_table === 'transaksi' && item.description) {
                        // Check for Tags: [DOC:...], [BUKTI:...], or Rincian:
                        const hasDoc = item.description.includes('[DOC:');
                        const hasBukti = item.description.includes('[BUKTI:');
                        const hasRincian = item.description.includes('Rincian:');

                        if (hasDoc || hasBukti || hasRincian) {
                            // Pass encoded description to avoid quote issues
                            const safeDesc = encodeURIComponent(item.description);
                            lampiranHtml = `
                            <button onclick="viewExpenseDetails('${safeDesc}', '${item.title}', ${item.amount})" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-orange-50 text-orange-600 hover:bg-orange-100 hover:text-orange-700 transition-colors text-xs font-semibold group-link">
                                <i class="fas fa-file-invoice"></i> Rincian & Nota
                            </button>`;
                        }
                    }

                    // Unique ROW ID for deletion
                    const rowId = `row-${item.id}-${Math.floor(Math.random() * 1000)}`;

                    return `
                    <tr id="${rowId}" class="group hover:bg-gray-50 transition-all border-b border-gray-100 last:border-0" data-amount="${item.amount}">
                        <td class="px-6 py-5 align-top">
                            <span class="inline-flex items-center px-2.5 py-1 text-[10px] font-bold rounded-full bg-blue-50 text-blue-700 border border-blue-100 uppercase tracking-wide">
                                ${item.source_table.replace('_', ' ')}
                            </span>
                        </td>
                        <td class="px-6 py-5 align-top">
                            <div class="text-sm font-bold text-gray-900 group-hover:text-blue-600 transition-colors">${item.title}</div>
                            <div class="text-xs text-gray-500 mt-1 line-clamp-2">${item.description || '-'}</div>
                        </td>
                        <td class="px-6 py-5 text-right font-mono text-sm font-bold text-gray-900 align-top">
                            ${typeof fmt !== 'undefined' ? fmt(item.amount) : new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(item.amount)}
                        </td>
                        <td class="px-6 py-5 text-center align-top">
                            ${lampiranHtml}
                        </td>
                        <td class="px-6 py-5 align-top">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-[10px] font-bold">
                                    ${requesterInitial}
                                </div>
                                <div>
                                    <div class="text-xs font-semibold text-gray-700">${requesterName}</div>
                                    <div class="text-[10px] text-gray-400 uppercase mt-0.5">${new Date(item.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-5 text-center align-top">
                            <div class="flex justify-center gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                <button onclick="processApproval(${item.id}, 'APPROVED', '${item.source_table}', '${item.source_id}', this, '${rowId}')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm transition-all flex items-center gap-1 active:scale-95 btn-approve-${item.id}">
                                    <i class="fas fa-check"></i> <span>Setuju</span>
                                </button>
                                <button onclick="processApproval(${item.id}, 'REJECTED', '${item.source_table}', '${item.source_id}', this, '${rowId}')" 
                                        class="bg-white border border-gray-200 hover:bg-red-50 hover:border-red-200 hover:text-red-600 text-gray-500 px-3 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-1 active:scale-95 btn-reject-${item.id}">
                                    <i class="fas fa-times"></i> <span>Tolak</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `}).join('');

            } catch (err) {
                console.error("Gagal load:", err);
                const errorDetail = err.details || err.hint || err.message || JSON.stringify(err);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="py-10 text-center">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-2xl mx-auto">
                                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                                <h3 class="text-lg font-bold text-red-800 mb-1">Gagal Memuat Data</h3>
                                <p class="text-sm text-red-600 mb-4">${err.message}</p>
                                <div class="text-xs text-left bg-white p-3 rounded border border-red-100 font-mono text-red-500 overflow-auto">
                                    Detail: ${errorDetail} <br>
                                    Code: ${err.code || 'N/A'}
                                </div>
                                <div class="mt-4">
                                     <button onclick="loadApprovalQueue()" class="bg-red-100 hover:bg-red-200 text-red-800 px-4 py-2 rounded-lg text-xs font-bold transition-colors">
                                        Coba Lagi
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>`;
            }
        }

        // --- NEW: Helper untuk menghitung statistik ---
        function updateDashboardStats(data) {
            // 1. Hitung Total
            const totalCount = data.length;
            const totalValue = data.reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);

            // Hitung Kategori Terbanyak
            const categoryCounts = {};
            data.forEach(item => {
                const cat = item.source_table.replace('_', ' ').toUpperCase();
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            });
            const topCategory = Object.keys(categoryCounts).length > 0
                ? Object.keys(categoryCounts).reduce((a, b) => categoryCounts[a] > categoryCounts[b] ? a : b)
                : '-';

            // Render ke Kartu
            document.getElementById('stat-total-count').textContent = totalCount;
            document.getElementById('stat-total-value').textContent = typeof fmt !== 'undefined' ? fmt(totalValue) : new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(totalValue);
            document.getElementById('stat-top-category').textContent = topCategory;
        }

        function removeRowAndRefreshStats(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;

            // 1. Get Amount
            const amt = parseFloat(row.getAttribute('data-amount')) || 0;

            // 2. Animate and Remove
            row.style.transition = 'all 0.5s';
            row.style.opacity = '0';
            row.style.transform = 'translateX(20px)';
            setTimeout(() => {
                row.remove();

                // 3. Update Stats Locally (Optimistic)
                const countEl = document.getElementById('stat-total-count');
                const valEl = document.getElementById('stat-total-value');

                let currentCount = parseInt(countEl.textContent) || 0;
                if (currentCount > 0) countEl.textContent = currentCount - 1;

                // For value, it's harder because parsing formatted string is annoying.
                // We'll trust the user or just leave it, or try to parse 'Rp 5.000.000'
                // Let's rely on reload if they really care about exact stat sync, OR
                // we can store raw value in data attribute of the stat card.
                // For now, let's just update the count which is most visible.

                // Check if empty
                const tbody = document.getElementById('approval-queue-body');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-20 text-center">
                                <div class="flex flex-col items-center">
                                    <div class="bg-green-50 text-green-500 w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-sm">
                                        <i class="fas fa-check-double text-2xl"></i>
                                    </div>
                                    <h3 class="text-gray-900 font-semibold text-lg">Semua Beres!</h3>
                                    <p class="text-gray-500 text-sm max-w-xs mx-auto mt-1">Tidak ada antrian persetujuan yang tertunda. Nikmati hari Anda!</p>
                                </div>
                            </td>
                        </tr>`;
                }
            }, 500);
        }


        // --- NEW: View Expense Detail (Parses Description String) ---
        function viewExpenseDetails(encodedDesc, title, amount) {
            const desc = decodeURIComponent(encodedDesc);
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            modal.classList.remove('hidden');
            modalTitle.innerHTML = `<i class="fas fa-file-invoice-dollar text-orange-600 mr-2"></i> ${title}`;

            // 1. Extract Global Docs/Proofs
            // Tags: [DOC: url], [BUKTI: url]
            let globalDocs = [];
            const docMatch = desc.match(/\[DOC:\s*(https?:\/\/[^\]]+)\]/);
            if (docMatch) globalDocs.push({ type: 'Dokumen Rencana', url: docMatch[1] });

            const buktiMatch = desc.match(/\[BUKTI:\s*(https?:\/\/[^\]]+)\]/);
            if (buktiMatch) globalDocs.push({ type: 'Bukti Realisasi', url: buktiMatch[1] });

            // 2. Extract Items from "Rincian:"
            // Format: Rincian: [DATE] ITEM (AMT) [LINK: url], [DATE] ...
            let itemsHtml = '';

            if (desc.includes('Rincian:')) {
                const rincianRaw = desc.split('Rincian:')[1].split('|')[0].trim(); // Take part after Rincian:, stop before next pipe if any
                // Split by comma, but be careful if comma is in text. 
                // The generator uses ", [" to separate usually? Or just comma.
                // Let's assume split by ", [" or just simple split if no brackets.
                // Actually the generator uses `.join(', ')`. 
                // We might need a smarter regex or split.
                // Let's try splitting by `], [` which is a stronger signal, or just split by `, [` 
                // Regex: /,\s*(?=\[)/ handles ", [" nicely

                const parts = rincianRaw.split(/,\s*(?=\[)/);

                if (parts.length > 0) {
                    itemsHtml = `
                     <div class="mt-4 border rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 text-gray-600 border-b">
                                <tr>
                                    <th class="px-3 py-2 text-left">Tanggal</th>
                                    <th class="px-3 py-2 text-left">Deskripsi</th>
                                    <th class="px-3 py-2 text-right">Nominal</th>
                                    <th class="px-3 py-2 text-center">Bukti</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                     `;

                    parts.forEach(p => {
                        // Parse: [2023-01-01] Beli Bensin (50000) [LINK: url]
                        let date = '-';
                        let name = p;
                        let amt = '-';
                        let link = null;

                        // Extract Date
                        const dateM = p.match(/^\[(.*?)\]/);
                        if (dateM) {
                            date = dateM[1];
                            name = name.replace(dateM[0], '').trim();
                        }

                        // Extract Link
                        const linkM = name.match(/\[LINK:\s*(https?:\/\/[^\]]+)\]/);
                        if (linkM) {
                            link = linkM[1];
                            name = name.replace(linkM[0], '').trim();
                        }

                        // Extract Amount (Last parens)
                        const amtM = name.match(/\(([^)]+)\)$/);
                        if (amtM) {
                            amt = amtM[1];
                            name = name.replace(amtM[0], '').trim();
                        }

                        const btnLink = link
                            ? `<a href="${link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-xs"><i class="fas fa-external-link-alt"></i> Lihat</a>`
                            : '<span class="text-gray-300">-</span>';

                        itemsHtml += `
                            <tr>
                                <td class="px-3 py-2 text-xs font-mono text-gray-500">${date}</td>
                                <td class="px-3 py-2 font-medium text-gray-700">${name}</td>
                                <td class="px-3 py-2 text-right font-mono">${amt}</td>
                                <td class="px-3 py-2 text-center">${btnLink}</td>
                            </tr>
                        `;
                    });

                    itemsHtml += `</tbody></table></div>`;
                }
            }

            // 3. Build Global Docs HTML
            let docsHtml = '';
            if (globalDocs.length > 0) {
                docsHtml = `<div class="flex gap-2 mb-4 flex-wrap">`;
                globalDocs.forEach(d => {
                    docsHtml += `
                        <a href="${d.url}" target="_blank" class="flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-2 rounded-lg border border-blue-100 hover:bg-blue-100 transition">
                            <i class="fas fa-paperclip"></i>
                            <div class="flex flex-col text-left">
                                <span class="text-[10px] uppercase font-bold text-blue-400">${d.type}</span>
                                <span class="text-xs font-bold leading-none">Buka File</span>
                            </div>
                        </a>
                    `;
                });
                docsHtml += `</div>`;
            }

            const totalFmt = typeof fmt !== 'undefined' ? fmt(amount) : amount;

            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-center">
                        <span class="text-xs font-bold text-gray-500 uppercase">Total Pengajuan</span>
                        <span class="text-lg font-bold text-gray-900 font-mono">${totalFmt}</span>
                    </div>
                    
                    ${docsHtml}
                    
                    <div class="text-sm text-gray-600 bg-white p-3 border rounded border-gray-100 italic">
                        "${desc.replace(/\[.*?\]/g, '').replace('Rincian:', '').trim()}"
                    </div>

                    ${itemsHtml}
                </div>
            `;
        }

        // --- NEW: View Detail Function with MODAL (Fixed Item Name) ---
        async function viewPODetails(sourceId, title) {
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            // Show Modal (Loading State)
            modal.classList.remove('hidden');
            modalTitle.textContent = title || 'Detail Item';
            modalContent.innerHTML = `<div class="flex justify-center p-8"><i class="fas fa-circle-notch fa-spin text-blue-600 text-2xl"></i></div>`;

            try {
                // Fetch basic info
                const { data: poItem, error } = await client.from('purchase_order').select('*').eq('id', sourceId).single();

                if (error) throw error;

                if (poItem) {
                    // 1. Fetch items from purchase_order
                    const { data: allItems, error: listError } = await client
                        .from('purchase_order')
                        .select('*')
                        .eq('nomor_po', poItem.nomor_po);

                    if (listError) throw listError;


                    // 2. Extract req_ids to fetch Item Names & Project from inventory_req
                    const reqIds = allItems.map(it => it.req_id).filter(id => id);

                    let reqMap = {}; // Maps ID -> { nama_barang, nama_proyek }
                    // ... (Code continues as is, no changes needed here in this chunk usually) ...
                    // Shortening this for tool limit, assuming viewPODetails is mostly fine as is.
                    // But I need to be careful not to cut off viewPODetails. 
                    // Let me paste the rest of viewPODetails logic just to be safe.

                    if (reqIds.length > 0) {
                        const { data: reqData } = await client
                            .from('inventory_req')
                            .select('id, nama_barang, nama_proyek')
                            .in('id', reqIds);

                        if (reqData) {
                            reqData.forEach(r => {
                                reqMap[r.id] = {
                                    nama: r.nama_barang,
                                    proyek: r.nama_proyek
                                };
                            });
                        }
                    }

                    // 3. Fetch Stock Info from master_stok
                    const itemNames = Object.values(reqMap).map(r => r.nama).filter((v, i, a) => a.indexOf(v) === i);

                    let stockMap = {};
                    if (itemNames.length > 0) {
                        const { data: stockData } = await client
                            .from('master_stok')
                            .select('nama_barang, lokasi, total_stok')
                            .in('nama_barang', itemNames);

                        if (stockData) {
                            stockData.forEach(s => {
                                const key = `${s.nama_barang}|${s.lokasi}`;
                                stockMap[key] = s.total_stok;
                            });
                        }
                    }

                    // Build Content
                    let html = `
                        <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500 block text-xs uppercase">Nomor PO</span>
                                    <span class="font-mono font-bold text-gray-800">${poItem.nomor_po}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500 block text-xs uppercase">Vendor</span>
                                    <span class="font-bold text-gray-800">${poItem.nama_vendor}</span>
                                </div>
                            </div>
                        </div>
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Item Barang</h4>
                        <div class="border rounded-lg overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 font-bold border-b">
                                    <tr>
                                        <th class="px-4 py-2">Item</th>
                                        <th class="px-4 py-2">Proyek</th>
                                        <th class="px-4 py-2 text-center">Sisa Stok Gudang</th>
                                        <th class="px-4 py-2 text-right">Harga Total</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                    `;

                    allItems.forEach(it => {
                        const dataReq = reqMap[it.req_id] || { nama: `Item Ref: ${it.req_id}`, proyek: '-' };
                        const realName = dataReq.nama;
                        const proyek = dataReq.proyek;

                        // Look up stock
                        const stockKey = `${realName}|${proyek}`;
                        const currentStock = stockMap[stockKey] !== undefined ? stockMap[stockKey] : '-';

                        html += `
                            <tr>
                                <td class="px-4 py-2 text-gray-700 font-medium">${realName}</td>
                                <td class="px-4 py-2 text-blue-600 font-medium text-xs">${proyek}</td>
                                <td class="px-4 py-2 text-center font-mono text-xs">${currentStock}</td>
                                <td class="px-4 py-2 text-right font-mono">${new Intl.NumberFormat('id-ID').format(it.total_harga)}</td>
                            </tr>
                        `;
                    });

                    html += `</tbody></table></div>`;
                    modalContent.innerHTML = html;
                } else {
                    modalContent.innerHTML = `<p class="text-red-500 text-center">Data tidak ditemukan.</p>`;
                }
            } catch (e) {
                console.error(e);
                modalContent.innerHTML = `
                    <div class="bg-red-50 text-red-600 p-4 rounded-lg">
                        <i class="fas fa-exclamation-circle mr-2"></i> Gagal memuat detail: ${e.message}
                    </div>
                `;
            }
        }

        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        async function processApproval(queueId, action, sourceTable, sourceId, btnElement, rowId) {
            // 1. Konfirmasi User (Jika diperlukan, bisa di-skip untuk kecepatan jika User sudah OK)
            // TAPI tetap aman pakai confirm agar tidak salah klik
            const confirmMsg = action === 'APPROVED'
                ? 'Apakah Anda yakin ingin MENYETUJUI pengajuan ini?'
                : 'Apakah Anda yakin ingin MENOLAK pengajuan ini?';

            if (!confirm(confirmMsg)) return;

            // 2. UI Feedback (Loading State) - Disable tombol terkait saja
            const parentTd = btnElement.closest('td');
            const originalContent = parentTd.innerHTML; // Save entire cell content
            parentTd.innerHTML = `<div class="flex items-center justify-center gap-2 text-gray-500"><i class="fas fa-circle-notch fa-spin text-blue-600"></i> Memproses...</div>`;

            if (!client) {
                alert("CRITICAL: Supabase CLIENT is missing/undefined!");
                parentTd.innerHTML = originalContent;
                return;
            }

            try {
                // Fetch info untuk Logging (Sederhana, tanpa blocking query berat)
                let titleCtx = 'Item Pengajuan';

                // --- LOGIC: REJECTION ---
                if (action === 'REJECTED') {
                    if (sourceTable === 'transaksi') {
                        const targetId = sourceId && sourceId != 0 ? sourceId : queueId;
                        await client.from('transaksi').update({ jenis_transaksi: 'REJECTED' }).eq('id', targetId);
                        await client.from('approval_queue').update({ status: 'REJECTED' }).eq('id', queueId);
                    } else if (sourceTable === 'purchase_order') {
                        await updateStatusPO(sourceId, 'REJECTED');
                        await client.from('approval_queue').update({ status: 'REJECTED' }).eq('id', queueId);
                    } else if (sourceTable === 'transaksi_upah') {
                        await client.from('transaksi_upah').update({ status: 'REJECTED' }).eq('id', queueId);
                    } else {
                        await client.from('approval_queue').update({ status: 'REJECTED' }).eq('id', queueId);
                        if (sourceId) await client.from(sourceTable).update({ status: 'REJECTED' }).eq('id', sourceId);
                    }

                    try { await PNAuth.logActivity(`Direksi MENOLAK: ${titleCtx}`, 'APPROVAL', 'fa-times-circle'); } catch (e) { }

                    showToast("✅ Pengajuan telah DITOLAK.", "success");
                    removeRowAndRefreshStats(rowId);
                    return;
                }

                // --- LOGIC: APPROVAL ---
                else if (action === 'APPROVED') {
                    if (sourceTable === 'transaksi') {
                        const targetId = sourceId && sourceId != 0 ? sourceId : queueId;
                        const { error } = await client.from('transaksi').update({ jenis_transaksi: 'APPROVED_BY_DIREKSI' }).eq('id', targetId);
                        if (error) throw error;
                        await client.from('approval_queue').update({ status: 'APPROVED' }).eq('id', queueId);

                    } else if (sourceTable === 'purchase_order') {
                        await updateStatusPO(sourceId, 'APPROVED');
                        const { error } = await client.from('approval_queue').update({ status: 'APPROVED' }).eq('id', queueId);
                        if (error) throw error;

                    } else if (sourceTable === 'transaksi_upah') {
                        const { error } = await client.from('transaksi_upah').update({ status: 'APPROVED_BY_DIREKSI' }).eq('id', sourceId);
                        if (error) throw error;

                    } else {
                        // GENERIC PATH (Master Proyek, dll)
                        const numericSourceId = parseInt(sourceId) || sourceId;

                        // 1. Update Source Table
                        let targetStatus = 'APPROVED';
                        if (sourceTable === 'master_proyek') targetStatus = 'BERJALAN';

                        const { error: errSource } = await client.from(sourceTable).update({ status: targetStatus }).eq('id', numericSourceId);

                        if (errSource) console.warn("Note: Source table update failed or not needed", errSource);

                        // 2. Update Queue
                        const { error: errQueue } = await client.from('approval_queue').update({ status: 'APPROVED' }).eq('id', queueId);
                        if (errQueue) throw new Error("Gagal Update Queue: " + errQueue.message);
                    }

                    showToast("✅ Pengajuan telah DISETUJUI.", "success");
                    removeRowAndRefreshStats(rowId);
                }

            } catch (err) {
                console.error("Process Error:", err);
                showToast("❌ Gagal memproses: " + err.message, "error");
                parentTd.innerHTML = originalContent; // Restore buttons on error
            }
        }

        // Helper khusus untuk update status PO massal berdasarkan ID salah satu item
        async function updateStatusPO(representativeId, newStatus) {
            // 1. Ambil nomor_po dari item perwakilan
            const { data: poItem, error: fetchError } = await client
                .from('purchase_order')
                .select('nomor_po')
                .eq('id', representativeId)
                .single();

            if (fetchError || !poItem) throw new Error("Gagal mengambil data PO untuk update status via ID: " + representativeId);

            // 2. Update SEMUA item dengan nomor_po tersebut
            const { error: updateError } = await client
                .from('purchase_order')
                .update({ status: newStatus })
                .eq('nomor_po', poItem.nomor_po);

            if (updateError) throw new Error("Gagal update massal status PO: " + updateError.message);
        }

        async function approveGeneric(queueId, sourceTable, sourceId) {
            // Tentukan status target berdasarkan tabel
            // Default: 'APPROVED', tapi untuk proyek kita pakai 'BERJALAN'
            let targetStatus = 'APPROVED';
            if (sourceTable === 'master_proyek') {
                targetStatus = 'BERJALAN';
            }

            // Update Source Table 
            // Pastikan tabel target memiliki kolom 'status'
            const { error: errSource } = await client.from(sourceTable).update({ status: targetStatus }).eq('id', sourceId);

            // Jika sourceTable tidak punya kolom status, kita abaikan error tertentu atau handle khusus
            if (errSource) {
                console.warn(`Gagal update status di ${sourceTable}: ${errSource.message}`);
                // Lanjut update antrian
            }

            // Update Queue
            const { error: errQueue } = await client.from('approval_queue').update({ status: 'APPROVED' }).eq('id', queueId);
            if (errQueue) throw errQueue;
        }

        // Simple Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white font-bold transition-all transform translate-y-10 opacity-0 z-50 ${type === 'success' ? 'bg-green-600' : 'bg-gray-800'}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Jalankan saat startup
        document.addEventListener('DOMContentLoaded', () => {
            // Tampilkan badge DEV jika di mode DEV (sesuai app_config.js)
            if (typeof CURRENT_ENV !== 'undefined' && CURRENT_ENV === 'DEV') {
                document.getElementById('env-badge').classList.remove('hidden');
            }
            loadApprovalQueue();
        });
    </script>
    <script>
        // SELF-HEALING: Fix Orphan Items (Source ID = 0)
        // Runs automatically when Dashboard loads
        async function healOrphanItems() {
            try {
                // 1. Find Orphans in Queue
                const { data: orphans } = await client
                    .from('approval_queue')
                    .select('*')
                    .eq('source_table', 'transaksi')
                    .eq('source_id', 0)
                    .eq('status', 'PENDING');

                if (!orphans || orphans.length === 0) return;

                console.log(`Found ${orphans.length} orphan items. Attempting to heal...`);

                // 2. Fetch Potential Candidates from Transaksi (Recent Pending Requests)
                // We assume Date matches
                const { data: candidates } = await client
                    .from('transaksi')
                    .select('*')
                    .eq('jenis_transaksi', 'PENGAJUAN')
                    .order('id', { ascending: false })
                    .limit(50);

                if (!candidates) return;

                // 3. Match & Link
                let healedCount = 0;
                for (const q of orphans) {
                    const qDate = q.created_at.split('T')[0];

                    // Match rules: Amount match AND Description Match (approx) AND Date Match
                    const match = candidates.find(t =>
                        t.jumlah == q.amount &&
                        t.keterangan === q.description &&
                        t.tanggal === qDate
                    );

                    if (match) {
                        console.log(`Healed Queue ${q.id} -> Transaksi ${match.id}`);
                        await client.from('approval_queue').update({ source_id: match.id }).eq('id', q.id);
                        healedCount++;
                    }
                }

                if (healedCount > 0) {
                    console.log(`Successfully healed ${healedCount} items. Reloading...`);
                    // Refresh view
                    // We don't auto-reload page to avoid infinite loops, but we reload data
                    loadApprovalQueue();
                }

            } catch (err) {
                console.warn("Healing logic error:", err);
            }
        }

        // Run Healing on Load
        document.addEventListener('DOMContentLoaded', () => {
            healOrphanItems();
        });

        // DEBUG: Logic to show ID & Role on Dashboard header
        document.addEventListener('DOMContentLoaded', () => {
            const s = PNAuth.getSession();
            if (s) {
                // Update User info if element exists
                if (document.getElementById('user-display')) document.getElementById('user-display').innerText = s.user.full_name;

                // Update Role info specially
                if (document.getElementById('role-display')) document.getElementById('role-display').innerText = s.user.role;
            }
        });
    </script>
    <!-- MODAL DETAIL -->
    <div id="detailModal" class="hidden fixed inset-0 z-[100] overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                onclick="closeModal()"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div
                            class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-info text-blue-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">
                                Detail Pengajuan
                            </h3>
                            <div class="mt-4" id="modalContent">
                                <!-- Content will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="closeModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Tutup
                    </button>
                    <!-- Optional: Add Approve button inside modal if needed in future -->
                </div>
            </div>
        </div>
    </div>

</body>

</html>