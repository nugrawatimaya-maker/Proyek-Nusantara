<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Direksi - Antrian Persetujuan</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="app_config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Check Auth: Direksi, Finance, Superadmin
        // User Request: Finance & Superadmin can see ALL dashboards.
        PNAuth.requireAuth(['direksi', 'finance', 'superadmin']);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            to {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i class="fas fa-shield-check text-white text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 tracking-tight">Executive Approval Dashboard</h1>
                </div>
                <div class="flex items-center gap-4">
                    <!-- User Info & Logout -->
                    <div class="text-right hidden md:block mr-2">
                        <div id="user-display" class="text-sm font-bold text-gray-800">User</div>
                        <div id="role-display" class="text-[10px] text-gray-500 uppercase tracking-wider">Direksi</div>
                    </div>

                    <span id="env-badge"
                        class="hidden px-2 py-1 rounded text-[10px] font-bold uppercase tracking-widest bg-amber-100 text-amber-700 border border-amber-200">Mode
                        Dev</span>
                    <button onclick="loadApprovalQueue()"
                        class="text-gray-500 hover:text-blue-600 transition-colors p-2" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>

                    <button onclick="PNAuth.logout()"
                        class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </button>
                </div>
            </div>
        </div>
    </nav>
    </nav>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900">Dashboard Overview</h2>
            <p class="text-sm text-gray-500">Ringkasan aktivitas persetujuan dan metrik kunci.</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 relative overflow-hidden group hover:shadow-md transition-all">
                <div
                    class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                </div>
                <div class="relative">
                    <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Total Antrian</div>
                    <div class="flex items-baseline gap-2">
                        <span id="stat-total-count" class="text-3xl font-bold text-gray-900">-</span>
                        <span
                            class="text-xs text-blue-600 font-medium bg-blue-50 px-2 py-0.5 rounded-full">Pending</span>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-sm text-gray-400">
                        <i class="fas fa-list-ul"></i>
                        <span>Item menunggu review</span>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 relative overflow-hidden group hover:shadow-md transition-all">
                <div
                    class="absolute top-0 right-0 w-24 h-24 bg-green-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                </div>
                <div class="relative">
                    <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Total Nilai</div>
                    <div class="flex items-baseline gap-2">
                        <span id="stat-total-value" class="text-3xl font-bold text-gray-900">-</span>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-sm text-green-600">
                        <i class="fas fa-coins"></i>
                        <span>Estimasi Rupiah</span>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 relative overflow-hidden group hover:shadow-md transition-all">
                <div
                    class="absolute top-0 right-0 w-24 h-24 bg-purple-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                </div>
                <div class="relative">
                    <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1">Kategori Terbanyak
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="stat-top-category" class="text-xl font-bold text-gray-900">-</span>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-sm text-purple-600">
                        <i class="fas fa-chart-pie"></i>
                        <span>Dominasi Pengajuan</span>
                    </div>
                </div>
            </div>
        </div>



        <div class="mb-6 flex justify-between items-end">
            <div>
                <h2 class="text-lg font-bold text-gray-900">Daftar Antrian</h2>
                <p class="text-sm text-gray-500">Menampilkan pengajuan yang memerlukan validasi Anda.</p>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-50/50 border-b border-gray-100">
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase">Kategori</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase">Deskripsi Item</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase text-right">Nominal</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase text-center">Lampiran</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase">Diajukan</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-400 uppercase text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="approval-queue-body" class="divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Gunakan jembatan 'client' dari app_config.js
        // fmt(n) juga sudah tersedia dari app_config.js jika Anda ingin format mata uang cepat

        async function loadApprovalQueue() {
            const tbody = document.getElementById('approval-queue-body');
            tbody.innerHTML = `<tr><td colspan="5" class="py-20 text-center"><div class="flex flex-col items-center justify-center gap-3"><i class="fas fa-circle-notch fa-spin text-blue-600 text-3xl"></i><span class="text-gray-400 text-sm animate-pulse">Memuat data...</span></div></td></tr>`;

            try {
                // Debug: Cek koneksi client
                if (!client || !client.from) throw new Error("Supabase Client belum terinisialisasi. Cek app_config.js");

                // --- 1. Fetch from 'approval_queue' (Old System / PO) ---
                const p1 = client
                    .from('approval_queue')
                    .select('id, title, description, amount, requester, created_at, source_table, source_id, status')
                    .eq('status', 'PENDING')
                    .order('created_at', { ascending: false });

                // --- 2. Fetch from 'transaksi' (New Expense Requests) ---
                const p2 = client
                    .from('transaksi')
                    .select('*')
                    .eq('jenis_transaksi', 'PENGAJUAN') // Filter pending expense
                    .order('tanggal', { ascending: false });

                // --- 3. Fetch from 'transaksi_upah' (Upah Tukang - Pending Direksi) ---
                const p3 = client
                    .from('transaksi_upah')
                    .select('id, kavling, nama_pekerjaan, nilai_bayar, tanggal_bayar, status')
                    .eq('status', 'PENDING_DIREKSI')
                    .order('tanggal_bayar', { ascending: false });

                const [resQueue, resTrans, resUpah] = await Promise.all([p1, p2, p3]);

                if (resQueue.error) throw resQueue.error;
                if (resTrans.error) throw resTrans.error;
                if (resUpah.error) throw resUpah.error;

                const dataQueue = resQueue.data || [];
                const dataTrans = resTrans.data || [];
                const dataUpah = resUpah.data || [];

                // --- 3. Normalize & Merge Data ---
                // Map 'transaksi' items to look like 'approval_queue' items
                const mappedTrans = dataTrans.map(t => {
                    // Parse Requester from [REQ:ID] if possible, or just use [DIV] part
                    let reqName = "Karyawan";
                    let title = "Pengajuan Biaya";

                    if (t.keterangan) {
                        // Try to extract Divisi or Name
                        const match = t.keterangan.match(/\[(.*?)\]/);
                        if (match) title = `Request ${match[1]}`; // e.g. Request UMUM
                    }

                    return {
                        id: t.id, // Use same ID, but handle action differently
                        source_table: 'transaksi', // Marker
                        source_id: t.id,
                        title: title,
                        description: t.keterangan,
                        amount: t.jumlah,
                        requester: reqName, // We don't have name easily, maybe fetch later?
                        created_at: t.tanggal, // use date
                        status: 'PENDING',
                        is_transaksi: true // Flag
                    };
                });

                // Map 'transaksi_upah' items
                const mappedUpah = dataUpah.map(u => {
                    return {
                        id: u.id,
                        source_table: 'transaksi_upah',
                        source_id: u.id,
                        title: `Upah Tukang - ${u.kavling}`,
                        description: u.nama_pekerjaan,
                        amount: u.nilai_bayar,
                        requester: "Teknik / Lapangan",
                        created_at: u.tanggal_bayar || new Date().toISOString(),
                        status: 'PENDING_DIREKSI',
                        is_transaksi: false
                    };
                });

                const combinedData = [...dataQueue, ...mappedTrans, ...mappedUpah];

                // Sort by date desc
                combinedData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                // --- UPDATE SUMMARY CARDS ---
                updateDashboardStats(combinedData || []);
                // -------------------------------------

                if (combinedData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-20 text-center">
                                <div class="flex flex-col items-center">
                                    <div class="bg-green-50 text-green-500 w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-sm">
                                        <i class="fas fa-check-double text-2xl"></i>
                                    </div>
                                    <h3 class="text-gray-900 font-semibold text-lg">Semua Beres!</h3>
                                    <p class="text-gray-500 text-sm max-w-xs mx-auto mt-1">Tidak ada antrian persetujuan yang tertunda. Nikmati hari Anda!</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }

                tbody.innerHTML = combinedData.map(item => {
                    const requesterName = item.requester || 'Anonim';
                    const requesterInitial = requesterName.charAt(0).toUpperCase();

                    // Logic Lampiran PO
                    let lampiranHtml = '<span class="text-gray-300">-</span>';
                    // Note: source_table inserted by purchase_order_entry.html is 'purchase_order', not 'purchase_order_request'
                    if (item.source_table === 'purchase_order' || item.source_table === 'purchase_order_request') {
                        lampiranHtml = `
                            <button onclick="viewPODetails('${item.source_id}', '${item.title}')" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:text-indigo-700 transition-colors text-xs font-semibold group-link">
                                <i class="fas fa-eye"></i> Detail
                            </button>`;
                    }

                    return `
                    <tr class="group hover:bg-gray-50 transition-all border-b border-gray-100 last:border-0">
                        <td class="px-6 py-5 align-top">
                            <span class="inline-flex items-center px-2.5 py-1 text-[10px] font-bold rounded-full bg-blue-50 text-blue-700 border border-blue-100 uppercase tracking-wide">
                                ${item.source_table.replace('_', ' ')}
                            </span>
                        </td>
                        <td class="px-6 py-5 align-top">
                            <div class="text-sm font-bold text-gray-900 group-hover:text-blue-600 transition-colors">${item.title}</div>
                            <div class="text-xs text-gray-500 mt-1 line-clamp-2">${item.description || '-'}</div>
                        </td>
                        <td class="px-6 py-5 text-right font-mono text-sm font-bold text-gray-900 align-top">
                            ${typeof fmt !== 'undefined' ? fmt(item.amount) : new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(item.amount)}
                        </td>
                        <td class="px-6 py-5 text-center align-top">
                            ${lampiranHtml}
                        </td>
                        <td class="px-6 py-5 align-top">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-[10px] font-bold">
                                    ${requesterInitial}
                                </div>
                                <div>
                                    <div class="text-xs font-semibold text-gray-700">${requesterName}</div>
                                    <div class="text-[10px] text-gray-400 uppercase mt-0.5">${new Date(item.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-5 text-center align-top">
                            <div class="flex justify-center gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                <button onclick="processApproval(${item.id}, 'APPROVED', '${item.source_table}', '${item.source_id}', this)" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm transition-all flex items-center gap-1 active:scale-95 btn-approve-${item.id}">
                                    <i class="fas fa-check"></i> <span>Setuju</span>
                                </button>
                                <button onclick="processApproval(${item.id}, 'REJECTED', '${item.source_table}', '${item.source_id}', this)" 
                                        class="bg-white border border-gray-200 hover:bg-red-50 hover:border-red-200 hover:text-red-600 text-gray-500 px-3 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-1 active:scale-95 btn-reject-${item.id}">
                                    <i class="fas fa-times"></i> <span>Tolak</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `}).join('');

            } catch (err) {
                console.error("Gagal load:", err);
                const errorDetail = err.details || err.hint || err.message || JSON.stringify(err);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="py-10 text-center">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-2xl mx-auto">
                                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                                <h3 class="text-lg font-bold text-red-800 mb-1">Gagal Memuat Data</h3>
                                <p class="text-sm text-red-600 mb-4">${err.message}</p>
                                <div class="text-xs text-left bg-white p-3 rounded border border-red-100 font-mono text-red-500 overflow-auto">
                                    Detail: ${errorDetail} <br>
                                    Code: ${err.code || 'N/A'}
                                </div>
                                <div class="mt-4">
                                     <button onclick="loadApprovalQueue()" class="bg-red-100 hover:bg-red-200 text-red-800 px-4 py-2 rounded-lg text-xs font-bold transition-colors">
                                        Coba Lagi
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>`;
            }
        }

        // --- NEW: Helper untuk menghitung statistik ---
        function updateDashboardStats(data) {
            // 1. Hitung Total
            const totalCount = data.length;
            const totalValue = data.reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);

            // Hitung Kategori Terbanyak
            const categoryCounts = {};
            data.forEach(item => {
                const cat = item.source_table.replace('_', ' ').toUpperCase();
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            });
            const topCategory = Object.keys(categoryCounts).reduce((a, b) => categoryCounts[a] > categoryCounts[b] ? a : b, '-');

            // Render ke Kartu
            document.getElementById('stat-total-count').textContent = totalCount;
            document.getElementById('stat-total-value').textContent = typeof fmt !== 'undefined' ? fmt(totalValue) : new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(totalValue); // Fallback formatting
            document.getElementById('stat-top-category').textContent = topCategory;
        }


        // --- NEW: View Detail Function (Placeholder until we implement full detail view) ---
        // --- NEW: View Detail Function with MODAL (Fixed Item Name) ---
        async function viewPODetails(sourceId, title) {
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            // Show Modal (Loading State)
            modal.classList.remove('hidden');
            modalTitle.textContent = title || 'Detail Item';
            modalContent.innerHTML = `<div class="flex justify-center p-8"><i class="fas fa-circle-notch fa-spin text-blue-600 text-2xl"></i></div>`;

            try {
                // Fetch basic info
                const { data: poItem, error } = await client.from('purchase_order').select('*').eq('id', sourceId).single();

                if (error) throw error;

                if (poItem) {
                    // 1. Fetch items from purchase_order
                    const { data: allItems, error: listError } = await client
                        .from('purchase_order')
                        .select('*')
                        .eq('nomor_po', poItem.nomor_po);

                    if (listError) throw listError;


                    // 2. Extract req_ids to fetch Item Names & Project from inventory_req
                    const reqIds = allItems.map(it => it.req_id).filter(id => id);

                    let reqMap = {}; // Maps ID -> { nama_barang, nama_proyek }
                    if (reqIds.length > 0) {
                        const { data: reqData } = await client
                            .from('inventory_req')
                            .select('id, nama_barang, nama_proyek')
                            .in('id', reqIds);

                        if (reqData) {
                            reqData.forEach(r => {
                                reqMap[r.id] = {
                                    nama: r.nama_barang,
                                    proyek: r.nama_proyek
                                };
                            });
                        }
                    }

                    // 3. Fetch Stock Info from master_stok
                    // We need a list of unique (nama_barang, nama_proyek) pairs to query or just query by nama_barang and filter later
                    const itemNames = Object.values(reqMap).map(r => r.nama).filter((v, i, a) => a.indexOf(v) === i);

                    let stockMap = {}; // Maps "nama_barang|nama_proyek" -> total_stok
                    if (itemNames.length > 0) {
                        const { data: stockData } = await client
                            .from('master_stok')
                            .select('nama_barang, lokasi, total_stok') // lokasi = nama_proyek
                            .in('nama_barang', itemNames);

                        if (stockData) {
                            stockData.forEach(s => {
                                const key = `${s.nama_barang}|${s.lokasi}`;
                                stockMap[key] = s.total_stok;
                            });
                        }
                    }

                    // Build Content
                    let html = `
                        <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500 block text-xs uppercase">Nomor PO</span>
                                    <span class="font-mono font-bold text-gray-800">${poItem.nomor_po}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500 block text-xs uppercase">Vendor</span>
                                    <span class="font-bold text-gray-800">${poItem.nama_vendor}</span>
                                </div>
                            </div>
                        </div>
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Item Barang</h4>
                        <div class="border rounded-lg overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 font-bold border-b">
                                    <tr>
                                        <th class="px-4 py-2">Item</th>
                                        <th class="px-4 py-2">Proyek</th>
                                        <th class="px-4 py-2 text-center">Sisa Stok Gudang</th>
                                        <th class="px-4 py-2 text-right">Harga Total</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                    `;

                    allItems.forEach(it => {
                        const dataReq = reqMap[it.req_id] || { nama: `Item Ref: ${it.req_id}`, proyek: '-' };
                        const realName = dataReq.nama;
                        const proyek = dataReq.proyek;

                        // Look up stock
                        const stockKey = `${realName}|${proyek}`;
                        const currentStock = stockMap[stockKey] !== undefined ? stockMap[stockKey] : '-';

                        html += `
                            <tr>
                                <td class="px-4 py-2 text-gray-700 font-medium">${realName}</td>
                                <td class="px-4 py-2 text-blue-600 font-medium text-xs">${proyek}</td>
                                <td class="px-4 py-2 text-center font-mono text-xs">${currentStock}</td>
                                <td class="px-4 py-2 text-right font-mono">${new Intl.NumberFormat('id-ID').format(it.total_harga)}</td>
                            </tr>
                        `;
                    });

                    html += `</tbody></table></div>`;
                    modalContent.innerHTML = html;
                } else {
                    modalContent.innerHTML = `<p class="text-red-500 text-center">Data tidak ditemukan.</p>`;
                }
            } catch (e) {
                console.error(e);
                modalContent.innerHTML = `
                    <div class="bg-red-50 text-red-600 p-4 rounded-lg">
                        <i class="fas fa-exclamation-circle mr-2"></i> Gagal memuat detail: ${e.message}
                    </div>
                `;
            }
        }

        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        async function processApproval(queueId, action, sourceTable, sourceId, btnElement) {
            // 1. Konfirmasi User
            const confirmMsg = action === 'APPROVED'
                ? 'Apakah Anda yakin ingin MENYETUJUI pengajuan ini?'
                : 'Apakah Anda yakin ingin MENOLAK pengajuan ini?';

            if (!confirm(confirmMsg)) return;

            // 2. UI Feedback (Loading State) - Disable semua tombol & Show Spinner
            const allBtns = document.querySelectorAll('button');
            allBtns.forEach(btn => btn.disabled = true);

            // Set Loading Icon on clicked button
            const originalContent = btnElement.innerHTML;
            btnElement.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Proses...`;

            try {
                // Fetch info untuk Logging
                let titleCtx = 'Pengajuan';
                if (sourceTable === 'transaksi_upah') {
                    const { data: upahItem } = await client.from('transaksi_upah').select('nama_pekerjaan').eq('id', queueId).single();
                    titleCtx = upahItem?.nama_pekerjaan || 'Upah Tukang';
                } else {
                    const { data: queueItem } = await client.from('approval_queue').select('title').eq('id', queueId).single();
                    titleCtx = queueItem?.title || 'Pengajuan';
                }

                // --- LOGIC: REJECTION ---
                if (action === 'REJECTED') {
                    if (sourceTable === 'transaksi') {
                        const { error } = await client.from('transaksi').update({ jenis_transaksi: 'REJECTED' }).eq('id', queueId);
                        if (error) throw error;
                    } else if (sourceTable === 'purchase_order') {
                        // REJECT PO -> Update ALL items with same nomor_po
                        await updateStatusPO(sourceId, 'REJECTED');

                        const { error } = await client
                            .from('approval_queue')
                            .update({ status: 'REJECTED' })
                            .eq('id', queueId);
                        if (error) throw error;
                    } else if (sourceTable === 'transaksi_upah') {
                        // REJECT Upah Tukang -> Status REJECTED
                        const { error } = await client
                            .from('transaksi_upah')
                            .update({ status: 'REJECTED' })
                            .eq('id', queueId);
                        if (error) throw error;
                    } else {
                        const { error } = await client
                            .from('approval_queue')
                            .update({ status: 'REJECTED' })
                            .eq('id', queueId);
                        if (error) throw error;

                        // Try update source status if column exists
                        await client.from(sourceTable).update({ status: 'REJECTED' }).eq('id', sourceId).then(res => {
                            if (res.error) console.warn("Generic reject update failed for", sourceTable);
                        });
                    }

                    // Log
                    await PNAuth.logActivity(`Direksi MENOLAK: ${titleCtx}`, 'APPROVAL', 'fa-times-circle');

                    showToast('Pengajuan telah ditolak.', 'info');
                }

                // --- LOGIC: APPROVAL ---
                else if (action === 'APPROVED') {
                    if (sourceTable === 'transaksi') {
                        // FIX: Use sourceId (Real Transaction ID), not queueId
                        // Also handle case where sourceId might be 0 (Orphan) -> We hope Heal function fixed it, or we try to use queueId as fallback if mapped directly.

                        const targetId = sourceId && sourceId != 0 ? sourceId : queueId;

                        console.log(`Approving Transaksi. Target ID: ${targetId}, Source: ${sourceTable}`);

                        // Approve Transaksi -> Status 'APPROVED_BY_DIREKSI' (Finance Execution Pending)
                        const { error } = await client.from('transaksi').update({ jenis_transaksi: 'APPROVED_BY_DIREKSI' }).eq('id', targetId);

                        if (error) {
                            console.error("Trans Update Error:", error);
                            throw new Error("Gagal update status transaksi: " + error.message);
                        }

                        // Also update Queue status to remove it from list
                        await client.from('approval_queue').update({ status: 'APPROVED' }).eq('id', queueId);

                    } else if (sourceTable === 'purchase_order') {
                        await updateStatusPO(sourceId, 'APPROVED');

                        // Update Queue
                        const { error: errQueue } = await client.from('approval_queue').update({ status: 'APPROVED' }).eq('id', queueId);
                        if (errQueue) throw errQueue;
                    } else if (sourceTable === 'transaksi_upah') {
                        // Approve Upah Tukang -> Status 'APPROVED_BY_DIREKSI'
                        const { error } = await client
                            .from('transaksi_upah')
                            .update({ status: 'APPROVED_BY_DIREKSI' })
                            .eq('id', queueId);
                        if (error) throw error;
                    }

                } else {
                    await approveGeneric(queueId, sourceTable, sourceId);
                }

                // Log
                await PNAuth.logActivity(`Direksi MENYETUJUI: ${titleCtx}`, 'APPROVAL', 'fa-check-circle');

                // 3. Refresh Data
                await loadApprovalQueue();

            } catch (err) {
                console.error("Process Error:", err);
                alert("Gagal memproses: " + err.message);
                // Restore button content if error, because we might not reload
                btnElement.innerHTML = originalContent;
                allBtns.forEach(btn => btn.disabled = false);
            }
        }

        // Helper khusus untuk update status PO massal berdasarkan ID salah satu item
        async function updateStatusPO(representativeId, newStatus) {
            // 1. Ambil nomor_po dari item perwakilan
            const { data: poItem, error: fetchError } = await client
                .from('purchase_order')
                .select('nomor_po')
                .eq('id', representativeId)
                .single();

            if (fetchError || !poItem) throw new Error("Gagal mengambil data PO untuk update status via ID: " + representativeId);

            // 2. Update SEMUA item dengan nomor_po tersebut
            const { error: updateError } = await client
                .from('purchase_order')
                .update({ status: newStatus })
                .eq('nomor_po', poItem.nomor_po);

            if (updateError) throw new Error("Gagal update massal status PO: " + updateError.message);
        }

        async function approveGeneric(queueId, sourceTable, sourceId) {
            // Tentukan status target berdasarkan tabel
            // Default: 'APPROVED', tapi untuk proyek kita pakai 'BERJALAN'
            let targetStatus = 'APPROVED';
            if (sourceTable === 'master_proyek') {
                targetStatus = 'BERJALAN';
            }

            // Update Source Table 
            // Pastikan tabel target memiliki kolom 'status'
            const { error: errSource } = await client.from(sourceTable).update({ status: targetStatus }).eq('id', sourceId);

            // Jika sourceTable tidak punya kolom status, kita abaikan error tertentu atau handle khusus
            if (errSource) {
                console.warn(`Gagal update status di ${sourceTable}: ${errSource.message}`);
                // Lanjut update antrian
            }

            // Update Queue
            const { error: errQueue } = await client.from('approval_queue').update({ status: 'APPROVED' }).eq('id', queueId);
            if (errQueue) throw errQueue;
        }

        // Simple Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white font-bold transition-all transform translate-y-10 opacity-0 z-50 ${type === 'success' ? 'bg-green-600' : 'bg-gray-800'}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Jalankan saat startup
        document.addEventListener('DOMContentLoaded', () => {
            // Tampilkan badge DEV jika di mode DEV (sesuai app_config.js)
            if (typeof CURRENT_ENV !== 'undefined' && CURRENT_ENV === 'DEV') {
                document.getElementById('env-badge').classList.remove('hidden');
            }
            loadApprovalQueue();
        });
    </script>
    <script>
        // SELF-HEALING: Fix Orphan Items (Source ID = 0)
        // Runs automatically when Dashboard loads
        async function healOrphanItems() {
            try {
                // 1. Find Orphans in Queue
                const { data: orphans } = await client
                    .from('approval_queue')
                    .select('*')
                    .eq('source_table', 'transaksi')
                    .eq('source_id', 0)
                    .eq('status', 'PENDING');

                if (!orphans || orphans.length === 0) return;

                console.log(`Found ${orphans.length} orphan items. Attempting to heal...`);

                // 2. Fetch Potential Candidates from Transaksi (Recent Pending Requests)
                // We assume Date matches
                const { data: candidates } = await client
                    .from('transaksi')
                    .select('*')
                    .eq('jenis_transaksi', 'PENGAJUAN')
                    .order('id', { ascending: false })
                    .limit(50);

                if (!candidates) return;

                // 3. Match & Link
                let healedCount = 0;
                for (const q of orphans) {
                    const qDate = q.created_at.split('T')[0];

                    // Match rules: Amount match AND Description Match (approx) AND Date Match
                    const match = candidates.find(t =>
                        t.jumlah == q.amount &&
                        t.keterangan === q.description &&
                        t.tanggal === qDate
                    );

                    if (match) {
                        console.log(`Healed Queue ${q.id} -> Transaksi ${match.id}`);
                        await client.from('approval_queue').update({ source_id: match.id }).eq('id', q.id);
                        healedCount++;
                    }
                }

                if (healedCount > 0) {
                    console.log(`Successfully healed ${healedCount} items. Reloading...`);
                    // Refresh view
                    // We don't auto-reload page to avoid infinite loops, but we reload data
                    loadApprovalQueue();
                }

            } catch (err) {
                console.warn("Healing logic error:", err);
            }
        }

        // Run Healing on Load
        document.addEventListener('DOMContentLoaded', () => {
            healOrphanItems();
        });

        // DEBUG: Logic to show ID & Role on Dashboard header
        document.addEventListener('DOMContentLoaded', () => {
            const s = PNAuth.getSession();
            if (s) {
                // Update User info if element exists
                if (document.getElementById('user-display')) document.getElementById('user-display').innerText = s.user.full_name;

                // Update Role info specially
                if (document.getElementById('role-display')) document.getElementById('role-display').innerText = s.user.role;
            }
        });
    </script>
    <!-- MODAL DETAIL -->
    <div id="detailModal" class="hidden fixed inset-0 z-[100] overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                onclick="closeModal()"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div
                            class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-info text-blue-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">
                                Detail Pengajuan
                            </h3>
                            <div class="mt-4" id="modalContent">
                                <!-- Content will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="closeModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Tutup
                    </button>
                    <!-- Optional: Add Approve button inside modal if needed in future -->
                </div>
            </div>
        </div>
    </div>

</body>

</html>