<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kas Keluar - Dashboard Finance</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f4f6f8;
      color: #1f2933;
    }
    header {
      padding: 18px 26px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      color: #0f172a;
    }
    header small {
      display: block;
      color: #475467;
    }
    .back-btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-weight: 600;
      color: #ffffff;
      background: linear-gradient(135deg, #22c55e, #15803d);
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .back-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3);
    }
    .container {
      max-width: 900px;
      margin: 32px auto;
      padding: 0 24px 48px;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.1);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .form-field label {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      font-family: inherit;
      background: #f8fafc;
    }
    .form-field textarea {
      resize: vertical;
      min-height: 90px;
    }
    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .actions button {
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    .submit-btn {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.25);
    }
    .status {
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      display: none;
    }
    .status.info { background: #e0f2fe; color: #0c4a6e; }
    .status.success { background: #dcfce7; color: #14532d; }
    .status.error { background: #fee2e2; color: #7f1d1d; }
    .preview-card {
      border-top: 1px solid #e2e8f0;
      padding-top: 12px;
    }
    .preview-card table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .preview-card td {
      padding: 6px 0;
    }
    .preview-card td:first-child { width: 130px; color: #475467; }
    .saved-notice {
      margin: 0;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #86efac;
      background: #dcfce7;
      color: #166534;
      font-weight: 600;
      display: none;
    }
    @media (max-width: 640px) {
      .actions {
        justify-content: stretch;
      }
      .actions button {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Kas Keluar</h1>
      <small>Catat detail pemasukan kas secara cepat</small>
    </div>
    <button class="back-btn" onclick="window.location.href='dashboard_finance.html'">Kembali Dashboard</button>
  </header>

  <main class="container">
    <form id="kasMasukForm" class="card">
      <div class="form-field">
        <label for="tanggal">Tanggal</label>
        <input type="date" id="tanggal" name="tanggal" required />
      </div>
      <div class="form-field">
        <label for="akun">Untuk Pembayaran</label>
        <select id="akun" name="akun" required>
          <option value="">-- Pilih Akun --</option>
          <option disabled>Loading data...</option>
        </select>
      </div>
      <div class="form-field">
        <label for="jumlah">Jumlah</label>
        <input type="number" id="jumlah" name="jumlah" placeholder="Masukkan nominal" min="0" step="0.01" required />
      </div>
      <div class="form-field">
        <label for="bank">Sumber Dana</label>
        <select id="bank" name="bank">
          <option value="">-- Pilih Bank/Kas --</option>
          <option disabled>Loading data...</option>
        </select>
      </div>
      <div class="form-field">
        <label for="keterangan">Keterangan</label>
        <textarea id="keterangan" name="keterangan" placeholder="Tujuan transaksi atau penerima"></textarea>
      </div>
      <div class="form-field">
        <label for="bukti">Bukti File (opsional)</label>
        <input type="file" id="bukti" name="bukti" accept=".jpg,.png,.pdf,.doc,.docx" />
      </div>
      <div id="statusBox" class="status info">Siap mengirim data.</div>
      <div class="actions">
        <button class="submit-btn" type="submit">Simpan</button>
      </div>
      <p id="savedNotice" class="saved-notice" aria-live="polite">Data telah terekam.</p>
      <div class="preview-card">
        <h3>Preview Terakhir</h3>
        <table>
          <tbody id="previewBody">
            <tr><td colspan="2" style="color:#94a3b8;">Belum ada data tersimpan</td></tr>
          </tbody>
        </table>
      </div>
    </form>
  </main>

  <script>
    // 1. SETUP KONEKSI
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; // Sesuai data Anda

    // PERBAIKAN DI SINI: Ganti nama variabel jadi 'client'
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    const form = document.getElementById("kasMasukForm");
    const statusBox = document.getElementById("statusBox");
    const previewBody = document.getElementById("previewBody");
    const tanggalInput = document.getElementById("tanggal");
    const savedNotice = document.getElementById("savedNotice");

    // --- FUNGSI BARU: AMBIL DATA AKUN ---
    async function loadMasterAkun() {
      const selectAkun = document.getElementById("akun");
      const selectBank = document.getElementById("bank");
      if (!selectAkun || !selectBank) return;

      const { data, error } = await client
        .from("master_akun")
        .select("*")
        .order("nama_akun", { ascending: true });

      if (error) {
        console.error("Gagal ambil akun:", error);
        return;
      }

      selectAkun.innerHTML = '<option value="">-- Pilih Sumber --</option>';
      selectBank.innerHTML = '<option value="">-- Pilih Tujuan --</option>';

      (data || []).forEach((item) => {
        const label = item.nama_akun || item.nama || "-";
        const option = document.createElement("option");
        option.value = label;
        option.textContent = label;

        selectAkun.appendChild(option.cloneNode(true));
        selectBank.appendChild(option);
      });
    }

    tanggalInput.valueAsDate = new Date();
    loadMasterAkun();

    function setStatus(type, msg) {
      statusBox.className = "status " + type + " show";
      statusBox.innerText = msg;
      statusBox.style.display = "block";
    }

    function updatePreview(data) {
      previewBody.innerHTML = `
        <tr><td>Tanggal</td><td>${data.tanggal}</td></tr>
        <tr><td>Akun</td><td>${data.akun}</td></tr>
        <tr><td>Jumlah</td><td>Rp ${Number(data.jumlah).toLocaleString("id-ID")}</td></tr>
        <tr><td>Bank</td><td>${data.bank_sumber || "-"}</td></tr>
        <tr><td>Keterangan</td><td>${data.keterangan || "-"}</td></tr>
        <tr><td>Bukti</td><td>${data.nama_file_bukti || "-"}</td></tr>
      `;
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      setStatus("info", "Sedang mengirim data ke Supabase...");

      const payload = {
        tanggal: tanggalInput.value,
        jenis_transaksi: "MASUK",
        akun: document.getElementById("akun").value,
        // PERBAIKAN: Pakai Number() agar terbaca sebagai angka
        jumlah: Number(document.getElementById("jumlah").value) || 0,
        bank_sumber: document.getElementById("bank").value,
        keterangan: document.getElementById("keterangan").value,
        nama_file_bukti: document.getElementById("bukti").files[0]?.name || "Tanpa Bukti",
      };

      try {
        // PERBAIKAN: Panggil 'client'
        const { data, error } = await client.from("transaksi").insert([payload]).select();

        if (error) throw error;

        setStatus("success", "✅ Data kas masuk tersimpan.");
        updatePreview(payload);
        showSavedNotice("Data kas masuk telah terekam.");

        setTimeout(() => {
          form.reset();
          tanggalInput.valueAsDate = new Date();
          setStatus("info", "Siap input data kas masuk lagi.");
        }, 1500);
      } catch (err) {
        console.error(err);
        setStatus("error", "❌ Gagal menyimpan: " + err.message);
        hideSavedNotice();
      }
    });

    // Helper UI lainnya
    function showSavedNotice(message) {
      if (savedNotice) { savedNotice.textContent = message; savedNotice.style.display = "block"; }
    }
    function hideSavedNotice() {
      if (savedNotice) savedNotice.style.display = "none";
    }
    form.addEventListener("input", hideSavedNotice);
  </script>
</body>
</html>
