<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Setup Marketing DB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="supabase.js"></script>
    <script src="app_config.js"></script>
</head>

<body class="bg-slate-100 p-10 flex flex-col items-center min-h-screen">

    <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg w-full text-center space-y-4">
        <h1 class="text-2xl font-bold text-slate-800">üõ†Ô∏è Setup Database Marketing</h1>
        <p class="text-slate-600">Script ini akan membuat tabel <code>marketing_files</code> untuk menyimpan data file
            brosur, pricelist, dan legalitas.</p>

        <div id="status" class="hidden p-3 rounded-lg text-sm font-bold text-left whitespace-pre-wrap font-mono"></div>

        <button onclick="runSetup()" id="btnRun"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold w-full transition shadow-lg">
            Mulai Setup
        </button>
    </div>

    <script>
        async function runSetup() {
            const btn = document.getElementById('btnRun');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.innerHTML = "Memproses...";
            status.className = "block bg-slate-800 text-green-400 p-4 rounded-lg text-xs overflow-auto h-64";
            status.innerText = "> Inisialisasi...\n";

            const log = (msg) => status.innerText += `> ${msg}\n`;

            try {
                // 1. Cek User Auth (Optional validation)
                if (!window.client) throw new Error("Supabase Client tidak terdeteksi!");

                // 2. Create Table via SQL (RPC) is ideal, but if not available, we assume table exists or we try to insert to trigger error/check.
                // Since we cannot run DDL directly from JS Client easily without an RPC function `exec_sql`, 
                // we will attempt to call a generic 'create_marketing_table' rpc if it exists, OR
                // provide the SQL for the user to run in Supabase SQL Editor.

                // DATA DUMMY UNTUK TEST INSERT (Jika tabel sudah ada)
                const dummyFiles = [
                    { title: "Brosur Digital 2026", file_url: "#", file_type: "pdf", category: "marketing_kit", size: "5.2 MB" },
                    { title: "Pricelist Januari", file_url: "#", file_type: "xlsx", category: "marketing_kit", size: "120 KB" },
                    { title: "Template SP", file_url: "#", file_type: "docx", category: "legalitas", size: "500 KB" }
                ];

                log("Mencoba insert dummy data untuk cek eksistensi tabel...");

                const { error } = await client.from('marketing_files').select('count').limit(1);

                if (error && error.code === '42P01') { // Undefined Table
                    log("‚ùå Tabel 'marketing_files' BELUM ADA.");
                    log("\n‚ö†Ô∏è PERHATIAN: Karena keterbatasan akses client-side, Anda perlu membuat tabel ini manual di Supabase SQL Editor.");
                    log("\n=== SILAKAN COPY SQL DI BAWAH INI KE SUPABASE SQL EDITOR ===");
                    log(`
CREATE TABLE IF NOT EXISTS marketing_files (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    title TEXT NOT NULL,
    file_url TEXT NOT NULL,
    file_type TEXT, -- pdf, xlsx, docx, jpg
    category TEXT, -- marketing_kit, legalitas
    size TEXT,
    is_public BOOLEAN DEFAULT TRUE
);

-- Enable RLS (Optional, for now public access)
ALTER TABLE marketing_files ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Read" ON marketing_files FOR SELECT USING (true);
CREATE POLICY "Admin Insert" ON marketing_files FOR INSERT WITH CHECK (true);
CREATE POLICY "Admin Update" ON marketing_files FOR UPDATE USING (true);
CREATE POLICY "Admin Delete" ON marketing_files FOR DELETE USING (true);
                    `);
                    log("\nSetelah menjalankan SQL di atas, refresh halaman ini dan klik Mulai Setup lagi.");
                } else if (error) {
                    throw error;
                } else {
                    log("‚úÖ Tabel 'marketing_files' DITEMUKAN.");

                    // Cek apakah kosong
                    const { count } = await client.from('marketing_files').select('*', { count: 'exact', head: true });
                    if (count === 0) {
                        log("Tabel kosong. Mengisi data awal...");
                        const { error: errIns } = await client.from('marketing_files').insert(dummyFiles);
                        if (errIns) throw errIns;
                        log("‚úÖ Data awal berhasil ditambahkan!");
                    } else {
                        log(`Tabel sudah berisi ${count} data. Setup selesai.`);
                    }

                    btn.innerHTML = "Selesai";
                    btn.classList.replace("bg-blue-600", "bg-green-600");
                }

            } catch (e) {
                console.error(e);
                log(`\n‚ùå ERROR: ${e.message}`);
                btn.disabled = false;
                btn.innerHTML = "Coba Lagi";
            }
        }
    </script>
</body>

</html>