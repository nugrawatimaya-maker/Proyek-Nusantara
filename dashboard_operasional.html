<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Dashboard Operasional NLD</title>

  <script src="supabase.js"></script>
  <script src="app_config.js"></script>
  <script src="auth.js"></script>
  <script>
    // Check Auth: Operasional + Global Roles (Finance, Direksi, Superadmin)
    PNAuth.requireAuth(['operasional', 'finance', 'direksi', 'superadmin']);

    document.addEventListener('DOMContentLoaded', () => {
      const session = PNAuth.getSession();
      if (session) {
        document.getElementById('nav-user-name').innerText = session.user.full_name;
        document.getElementById('nav-user-role').innerText = session.user.role;
      }
    });
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #F8FAFC;
    }

    .glass-header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid #e2e8f0;
    }

    .menu-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
  </style>

  <script>
    const activeProject = sessionStorage.getItem('active_project_name');
    if (!activeProject) {
      window.location.href = 'portal_proyek.html';
    }

    async function loadDashboardStats() {
      try {
        document.getElementById('projectTitle').innerText = activeProject;

        const { count: countProyek } = await client
          .from('master_proyek')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'BERJALAN')
          .ilike('nama_proyek', `%${activeProject}%`);

        // Update: Mengambil Pending Req dari tabel inventory_req
        const { count: countReq } = await client
          .from('inventory_req')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'PENDING')
        // Asumsi tabel Inventory_req punya kolom nama_proyek (biasanya ada untuk filtering)
        // Jika tidak ada, mungkin perlu join. Tapi untuk sekarang kita filter apa adanya.
        // Cek inventory.html, dia insert 'nama_proyek'?
        // Ternyata inventory_req biasanya punya relasi ke master_stok atau user.
        // Tapi activeProject session disimpan di localStorage.
        // Kita filter by 'nama_proyek' jika ada.
        // Jika ragu, kita skip filter proyek untuk Req dulu TAPI purchase_order punya 'nama_proyek'.
        // Cek inventory_grn.html -> ambil purchase_order WHERE nama_proyek = activeProject.
        // Jadi PO support.

        const { count: countPO } = await client
          .from('purchase_order')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'APPROVED') // Update: Gudang melihat APPROVED, bukan OPEN lagi
          .eq('nama_proyek', activeProject);

        const { count: countStok } = await client
          .from('master_stok')
          .select('*', { count: 'exact', head: true })
          .lt('total_stok', 5)
          .eq('nama_proyek', activeProject);

        animateValue('statProyek', countProyek || 1);
        animateValue('statReq', countReq || 0);
        animateValue('statPO', countPO || 0);
        animateValue('statStok', countStok || 0);

      } catch (error) {
        console.error('Gagal memuat statistik:', error);
      }
    }

    function animateValue(id, end) {
      const obj = document.getElementById(id);
      if (!obj) return;
      obj.innerHTML = end;
    }

    document.addEventListener('DOMContentLoaded', loadDashboardStats);
  </script>
</head>

<body class="text-slate-800">

  <header class="glass-header fixed top-0 w-full z-50 px-6 py-3 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <a href="portal_proyek.html"
        class="flex items-center justify-center w-10 h-10 bg-slate-100 hover:bg-slate-200 rounded-xl text-slate-500 transition"
        title="Ganti Proyek">
        <i class="fas fa-th-large"></i>
      </a>

      <div>
        <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Lokasi Proyek Aktif</p>
        <h1 class="text-lg font-black text-slate-800 leading-tight" id="projectTitle">Memuat...</h1>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <a href="index.html"
        class="w-10 h-10 bg-slate-100 text-slate-500 rounded-xl flex items-center justify-center hover:bg-slate-200 transition"
        title="Home">
        <i class="fas fa-home"></i>
      </a>
      <div class="text-right hidden md:block">
        <p class="text-sm font-bold text-slate-700" id="nav-user-name">User</p>
        <p class="text-[10px] text-emerald-500 font-bold bg-emerald-50 px-2 rounded-full inline-block uppercase"
          id="nav-user-role">Role</p>
      </div>
      <div
        class="w-10 h-10 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full flex items-center justify-center text-white shadow-lg">
        <i class="fas fa-hard-hat"></i>
      </div>
      <button onclick="PNAuth.logout()" class="text-slate-400 hover:text-red-500 ml-2" title="Logout">
        <i class="fas fa-power-off"></i>
      </button>
    </div>
  </header>

  <main class="pt-24 pb-12 px-4 md:px-8 max-w-5xl mx-auto">

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Status Proyek</p>
        <div class="flex justify-between items-center">
          <h3 class="text-2xl font-black text-slate-800" id="statProyek">-</h3>
          <i class="fas fa-building text-blue-500 bg-blue-50 p-2 rounded-lg"></i>
        </div>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Stok Alert</p>
        <div class="flex justify-between items-center">
          <h3 class="text-2xl font-black text-red-600" id="statStok">-</h3>
          <i class="fas fa-box text-red-500 bg-red-50 p-2 rounded-lg"></i>
        </div>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Pending Req</p>
        <div class="flex justify-between items-center">
          <h3 class="text-2xl font-black text-amber-500" id="statReq">-</h3>
          <i class="fas fa-clock text-amber-500 bg-amber-50 p-2 rounded-lg"></i>
        </div>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Incoming PO</p>
        <div class="flex justify-between items-center">
          <h3 class="text-2xl font-black text-emerald-600" id="statPO">-</h3>
          <i class="fas fa-truck-loading text-emerald-500 bg-emerald-50 p-2 rounded-lg"></i>
        </div>
      </div>
    </div>

    <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-4">Menu Operasional</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-12">

      <div onclick="window.location.href='inventory.html'"
        class="menu-card bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-5 group">
        <div
          class="w-14 h-14 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-sm group-hover:bg-blue-600 group-hover:text-white">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <div>
          <h4 class="text-lg font-bold text-slate-800 group-hover:text-blue-600 transition">Request Material</h4>
          <p class="text-xs text-slate-400 mt-1">Buat permintaan barang ke logistik pusat.</p>
        </div>
        <i class="fas fa-chevron-right ml-auto text-slate-300"></i>
      </div>

      <div onclick="window.location.href='inventory_grn.html'"
        class="menu-card bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-5 group">
        <div
          class="w-14 h-14 rounded-2xl bg-yellow-50 text-yellow-600 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-sm group-hover:bg-yellow-500 group-hover:text-white">
          <i class="fas fa-box-open"></i>
        </div>
        <div>
          <h4 class="text-lg font-bold text-slate-800 group-hover:text-yellow-600 transition">Penerimaan (GRN)</h4>
          <p class="text-xs text-slate-400 mt-1">Validasi barang masuk dari vendor/gudang.</p>
        </div>
        <i class="fas fa-chevron-right ml-auto text-slate-300"></i>
      </div>

      <div onclick="window.location.href='stok_proyek.html'"
        class="menu-card bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-5 group">
        <div
          class="w-14 h-14 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-sm group-hover:bg-purple-600 group-hover:text-white">
          <i class="fas fa-cubes"></i>
        </div>
        <div>
          <h4 class="text-lg font-bold text-slate-800 group-hover:text-purple-600 transition">Stok Proyek</h4>
          <p class="text-xs text-slate-400 mt-1">Kartu stok, opname, dan pemakaian harian.</p>
        </div>
        <i class="fas fa-chevron-right ml-auto text-slate-300"></i>
      </div>

      <div onclick="window.location.href='upah_tukang.html'"
        class="menu-card bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-5 group">
        <div
          class="w-14 h-14 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-sm group-hover:bg-indigo-600 group-hover:text-white">
          <i class="fas fa-hard-hat"></i>
        </div>
        <div>
          <h4 class="text-lg font-bold text-slate-800 group-hover:text-indigo-600 transition">Upah Tukang</h4>
          <p class="text-xs text-slate-400 mt-1">Ajukan pembayaran progress kerja tukang.</p>
        </div>
        <i class="fas fa-chevron-right ml-auto text-slate-300"></i>
      </div>

      <div onclick="window.location.href='hpp_final.html'"
        class="menu-card bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-5 group">
        <div
          class="w-14 h-14 rounded-2xl bg-pink-50 text-pink-600 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-sm group-hover:bg-pink-600 group-hover:text-white">
          <i class="fas fa-calculator"></i>
        </div>
        <div>
          <h4 class="text-lg font-bold text-slate-800 group-hover:text-pink-600 transition">HPP Final</h4>
          <p class="text-xs text-slate-400 mt-1">Analisa biaya dan margin proyek ini.</p>
        </div>
        <i class="fas fa-chevron-right ml-auto text-slate-300"></i>
      </div>

      <div onclick="window.location.href='master_proyek.html'"
        class="menu-card bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-5 group">
        <div
          class="w-14 h-14 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-sm group-hover:bg-emerald-600 group-hover:text-white">
          <i class="fas fa-network-wired"></i>
        </div>
        <div>
          <h4 class="text-lg font-bold text-slate-800 group-hover:text-emerald-600 transition">Master Data</h4>
          <p class="text-xs text-slate-400 mt-1">Kelola data kavling dan RAB (Admin).</p>
        </div>
        <i class="fas fa-chevron-right ml-auto text-slate-300"></i>
      </div>

      <div onclick="window.location.href='update_progress_fisik.html'"
        class="menu-card bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-5 group">
        <div
          class="w-14 h-14 rounded-2xl bg-orange-50 text-orange-600 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-sm group-hover:bg-orange-600 group-hover:text-white">
          <i class="fas fa-hammer"></i>
        </div>
        <div>
          <h4 class="text-lg font-bold text-slate-800 group-hover:text-orange-600 transition">Update Progress</h4>
          <p class="text-xs text-slate-400 mt-1">Input progress fisik bangunan.</p>
        </div>
        <i class="fas fa-chevron-right ml-auto text-slate-300"></i>
      </div>


    </div>

  </main>
</body>

</html>