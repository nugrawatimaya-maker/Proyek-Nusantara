<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Laporan Keuangan Terintegrasi</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 80px; }
    
    /* MENU SCROLL */
    .mobile-scroll-menu { display: flex; overflow-x: auto; gap: 10px; padding: 4px; scrollbar-width: none; }
    .mobile-scroll-menu::-webkit-scrollbar { display: none; }
    .menu-pill { white-space: nowrap; padding: 8px 16px; border-radius: 50px; font-size: 11px; font-weight: 700; border: 1px solid #cbd5e1; background: white; color: #64748b; transition: all 0.2s; display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .menu-pill.active { background: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }

    /* CARD STYLE */
    .trx-card { background: white; border-radius: 12px; padding: 14px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; position: relative; overflow: hidden; }
  </style>
</head>
<body>

  <nav class="bg-white border-b px-4 py-3 sticky top-0 z-50 shadow-sm flex justify-between items-center">
    <div class="flex items-center gap-3">
        <div class="bg-blue-600 text-white w-8 h-8 flex items-center justify-center rounded-lg shadow-blue-200 shadow-lg"><i class="fas fa-chart-pie text-xs"></i></div>
        <div>
            <h1 class="text-sm font-bold text-slate-800 leading-tight">Laporan Keuangan</h1>
            <p class="text-[10px] text-slate-500">Nusantara Land</p>
        </div>
    </div>
    <a href="dashboard_operasional.html" class="bg-slate-50 text-slate-400 w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100"><i class="fas fa-arrow-left text-xs"></i></a>
  </nav>

  <div class="bg-white p-3 border-b">
      <div class="flex gap-2 items-center bg-slate-50 p-2 rounded-lg border border-slate-200">
          <div class="flex-1 flex items-center gap-2 text-xs">
              <input type="date" id="tglMulai" class="bg-transparent font-bold text-slate-700 w-full outline-none">
              <i class="fas fa-arrow-right text-slate-300 text-[10px]"></i>
              <input type="date" id="tglSelesai" class="bg-transparent font-bold text-slate-700 w-full outline-none">
          </div>
          <button onclick="loadData()" class="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center shadow active:scale-95 transition"><i class="fas fa-search text-xs"></i></button>
      </div>
  </div>

  <div class="bg-white border-b py-3 px-4 sticky top-[120px] z-40">
      <div class="mobile-scroll-menu">
        <div onclick="pilihLaporan('JURNAL', this)" class="menu-pill active"><i class="fas fa-list-ul"></i> Jurnal Umum</div>
        <div onclick="pilihLaporan('BUKU_BESAR', this)" class="menu-pill"><i class="fas fa-book"></i> Buku Besar</div>
        <div onclick="pilihLaporan('NERACA_SALDO', this)" class="menu-pill"><i class="fas fa-balance-scale"></i> Neraca Saldo</div>
        <div onclick="pilihLaporan('LABA_RUGI', this)" class="menu-pill"><i class="fas fa-coins"></i> Laba Rugi</div>
        <div onclick="pilihLaporan('NERACA', this)" class="menu-pill"><i class="fas fa-building"></i> Neraca</div>
      </div>
  </div>

  <main class="p-4 md:p-6 max-w-5xl mx-auto">
      <div class="mb-4 flex justify-between items-end">
          <div>
              <h2 id="judulLap" class="text-lg font-bold text-slate-800">JURNAL UMUM</h2>
              <p class="text-xs text-slate-500" id="subJudul">Periode: -</p>
          </div>
      </div>
      
      <div id="kontenScreen" class="text-sm pb-20">
          <div class="py-10 text-center"><i class="fas fa-filter opacity-30 text-4xl mb-2"></i><p class="text-xs text-slate-400">Pilih tanggal untuk melihat data</p></div>
      </div>
  </main>

  <div class="fixed bottom-6 right-6">
      <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition active:scale-90 z-50">
          <i class="fas fa-file-pdf fa-lg"></i>
      </button>
  </div>

  <script>
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    const fmt = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    const fmtNum = (n) => new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(n);

    let currentType = 'JURNAL';
    let rawData = [];
    let akunMap = {}; 

    const today = new Date();
    document.getElementById("tglMulai").valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById("tglSelesai").valueAsDate = today;

    function pilihLaporan(type, el) {
        currentType = type;
        document.querySelectorAll('.menu-pill').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        
        const mapJudul = {
            'JURNAL': 'JURNAL UMUM', 'BUKU_BESAR': 'BUKU BESAR',
            'NERACA_SALDO': 'NERACA SALDO', 'LABA_RUGI': 'LAPORAN LABA RUGI', 'NERACA': 'NERACA KEUANGAN'
        };
        document.getElementById("judulLap").innerText = mapJudul[type];
        loadData();
    }

    async function loadData() {
        const start = document.getElementById("tglMulai").value;
        const end = document.getElementById("tglSelesai").value;
        document.getElementById("subJudul").innerText = `${new Date(start).toLocaleDateString('id-ID')} s/d ${new Date(end).toLocaleDateString('id-ID')}`;
        document.getElementById("kontenScreen").innerHTML = `<div class="py-10 text-center"><i class="fas fa-spinner fa-spin text-blue-500"></i> Loading Data...</div>`;

        const { data: jurnal } = await client.from('jurnal_umum').select('*').gte('tanggal', start).lte('tanggal', end).order('tanggal', { ascending: true });
        const { data: master } = await client.from('master_akun').select('nama_akun, kode_akun');

        akunMap = {};
        if(master) master.forEach(m => { akunMap[m.nama_akun] = m.kode_akun; });
        rawData = jurnal || [];

        renderScreen(); // Render Tampilan Layar HP
    }

    // ==========================================
    // 1. RENDER SCREEN (TAMPILAN HP) - LENGKAP
    // ==========================================
    function renderScreen() {
        let html = `<div class="space-y-3">`;
        const saldos = hitungSaldo();

        // A. JURNAL UMUM
        if(currentType === 'JURNAL') {
            rawData.forEach(r => {
                const kode = akunMap[r.nama_akun] || '-';
                const isD = r.debit > 0;
                const style = isD ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500 ml-4 bg-slate-50';
                html += `
                <div class="bg-white p-3 rounded shadow-sm border ${style} flex justify-between">
                    <div>
                        <div class="text-[10px] text-slate-400 font-mono">${new Date(r.tanggal).toLocaleDateString('id-ID')} â€¢ ${kode}</div>
                        <div class="font-bold text-sm text-slate-800">${r.nama_akun}</div>
                        <div class="text-xs text-slate-500 italic truncate w-48">${r.keterangan || '-'}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-sm ${isD ? 'text-green-600' : 'text-red-600'}">${fmt(isD ? r.debit : r.kredit)}</div>
                    </div>
                </div>`;
            });

        // B. BUKU BESAR
        } else if(currentType === 'BUKU_BESAR') {
            const groups = {};
            rawData.forEach(r => { if(!groups[r.nama_akun]) groups[r.nama_akun] = []; groups[r.nama_akun].push(r); });
            Object.keys(groups).sort().forEach(akun => {
                 let s = 0;
                 html += `<div class="bg-white rounded border shadow-sm overflow-hidden mb-3"><div class="bg-blue-50 p-2 font-bold text-xs border-b text-blue-800">${akun}</div><div class="divide-y">`;
                 groups[akun].forEach(r => {
                     s += (r.debit - r.kredit);
                     html += `<div class="p-2 flex justify-between text-xs"><div class="w-2/3"><div>${new Date(r.tanggal).toLocaleDateString('id-ID')}</div><div class="text-slate-500 italic">${r.keterangan}</div></div><div class="text-right font-bold ${s>=0?'text-green-600':'text-red-600'}">${fmt(s)}</div></div>`;
                 });
                 html += `</div></div>`;
            });

        // C. NERACA SALDO
        } else if(currentType === 'NERACA_SALDO') {
            html += `<div class="bg-white rounded shadow border divide-y">`;
            let tD=0, tK=0;
            Object.keys(saldos).sort().forEach(akun => {
                const net = saldos[akun].debit - saldos[akun].kredit;
                if(net === 0) return;
                const isD = net > 0; const nom = Math.abs(net);
                if(isD) tD+=nom; else tK+=nom;
                html += `<div class="p-3 flex justify-between text-xs"><span class="font-bold text-slate-700">${akun}</span><span class="${isD?'text-slate-800':'text-red-600'} font-bold">${fmt(nom)} (${isD?'D':'K'})</span></div>`;
            });
            html += `<div class="p-3 bg-slate-800 text-white flex justify-between font-bold text-xs"><span>TOTAL</span><span>D: ${fmt(tD)} | K: ${fmt(tK)}</span></div></div>`;

        // D. LABA RUGI
        } else if(currentType === 'LABA_RUGI') {
            let inc=0, exp=0;
            let incHtml = '', expHtml = '';
            for(let [ak, v] of Object.entries(saldos)) {
                let net = v.debit - v.kredit;
                if(ak.match(/pendapatan|penjualan/i) && net !== 0) {
                    let val = Math.abs(net); inc+=val; incHtml += cardLine(ak, val, 'text-green-600');
                } else if(ak.match(/beban|biaya|gaji|listrik/i) && net !== 0) {
                    let val = Math.abs(net); exp+=val; expHtml += cardLine(ak, val, 'text-red-600');
                }
            }
            let laba = inc - exp;
            html += `<div class="bg-blue-600 text-white p-4 rounded text-center font-bold text-xl mb-4">Laba Bersih: ${fmt(laba)}</div>`;
            html += `<div class="bg-white p-3 rounded border mb-2"><div class="font-bold border-b pb-1 mb-2">PENDAPATAN</div>${incHtml||'-'}</div>`;
            html += `<div class="bg-white p-3 rounded border"><div class="font-bold border-b pb-1 mb-2">BEBAN</div>${expHtml||'-'}</div>`;

        // E. NERACA
        } else if(currentType === 'NERACA') {
            let ast=0, kwj=0;
            let astHtml='', pasHtml='';
            for(let [ak, v] of Object.entries(saldos)) {
                let net = v.debit - v.kredit;
                if(ak.match(/kas|bank|piutang|persediaan|tanah|bangunan|kendaraan/i) && net!==0) {
                    ast+=net; astHtml += cardLine(ak, net, 'text-blue-600');
                } else if(ak.match(/hutang|kewajiban/i) && net!==0) {
                    let h = Math.abs(net); kwj+=h; pasHtml += cardLine(ak, h, 'text-red-600');
                }
            }
            let modal = ast - kwj;
            html += `<div class="bg-white p-3 rounded border mb-2"><div class="font-bold border-b pb-1 mb-2 text-blue-700">ASET (Total: ${fmt(ast)})</div>${astHtml}</div>`;
            html += `<div class="bg-white p-3 rounded border"><div class="font-bold border-b pb-1 mb-2 text-red-700">PASIVA (Total: ${fmt(ast)})</div>${pasHtml}`;
            html += `<div class="flex justify-between text-xs mt-2 pt-2 border-t border-dashed"><span>Modal / Ekuitas</span><span class="font-bold">${fmt(modal)}</span></div></div>`;
        }
        
        html += `</div>`;
        document.getElementById("kontenScreen").innerHTML = html;
    }

    // Helper Screen
    function cardLine(label, val, color) {
        return `<div class="flex justify-between text-xs mb-2"><span>${label}</span><span class="font-bold ${color}">${fmt(val)}</span></div>`;
    }

    // ==========================================
    // 2. GENERATE PDF (PROFESIONAL) - LENGKAP
    // ==========================================
    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
        const tglCetak = new Date().toLocaleDateString('id-ID');
        const periode = document.getElementById("subJudul").innerText;

        // KOP SURAT
        doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("PT. NUSANTARA LAND DEVELOPMENT", 14, 15);
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        
        // --- GANTI ALAMAT DI BAWAH INI ---
        doc.text("Jl. Sunset Boulevard Blok 5B/16 CitraLand City, Centre Point of Indonesia (CPI) Kel. Maccini Sombala Kec. Tamalate, Makassar, 90224, Indonesia Phone: +624116004251", 14, 20);
        // ---------------------------------

        doc.text("Laporan Keuangan & Operasional Terintegrasi", 14, 25);
        doc.setLineWidth(0.5); doc.line(14, 28, 283, 28);

        // JUDUL
        doc.setFontSize(12); doc.setFont("helvetica", "bold");
        doc.text(document.getElementById("judulLap").innerText, 14, 35);
        doc.setFontSize(10); doc.setFont("helvetica", "italic");
        doc.text("Periode: " + periode, 14, 40);

        let body = [];
        let head = [];
        let colStyles = {};
        let finalY = 45;

        // LOGIKA PDF PER TIPE
        if (currentType === 'JURNAL') {
            head = [['Tanggal', 'No. Akun', 'Uraian', 'Ref', 'Debit', 'Kredit']];
            let tD=0, tK=0;
            rawData.forEach(r => {
                tD += r.debit; tK += r.kredit;
                const namaAkun = r.kredit > 0 ? `      ${r.nama_akun}` : r.nama_akun;
                body.push([new Date(r.tanggal).toLocaleDateString('id-ID'), akunMap[r.nama_akun]||'', `${namaAkun}\n${r.keterangan||''}`, r.nomor_referensi||'', r.debit>0?fmtNum(r.debit):'-', r.kredit>0?fmtNum(r.kredit):'-']);
            });
            body.push([{content: 'TOTAL', colSpan: 4, styles: {halign: 'right', fontStyle: 'bold'}}, fmtNum(tD), fmtNum(tK)]);
            colStyles = { 4: {halign: 'right'}, 5: {halign: 'right'} };
            printTable(doc, head, body, colStyles, finalY);

        } else if (currentType === 'BUKU_BESAR') {
            const groups = {};
            rawData.forEach(r => { if(!groups[r.nama_akun]) groups[r.nama_akun] = []; groups[r.nama_akun].push(r); });
            
            Object.keys(groups).sort().forEach(akun => {
                // Cetak Judul Akun dulu
                if (finalY > 180) { doc.addPage(); finalY=20; }
                doc.setFont("helvetica", "bold"); doc.setFontSize(10);
                doc.text(`Akun: ${akun} [${akunMap[akun]||''}]`, 14, finalY);
                finalY += 2;

                let subBody = [];
                let sal = 0;
                groups[akun].forEach(r => {
                    sal += (r.debit - r.kredit);
                    subBody.push([new Date(r.tanggal).toLocaleDateString('id-ID'), r.keterangan, r.debit>0?fmtNum(r.debit):'-', r.kredit>0?fmtNum(r.kredit):'-', fmtNum(sal)]);
                });
                
                doc.autoTable({
                    startY: finalY + 1,
                    head: [['Tgl', 'Ket', 'Debit', 'Kredit', 'Saldo']],
                    body: subBody,
                    theme: 'grid',
                    columnStyles: { 2:{halign:'right'}, 3:{halign:'right'}, 4:{halign:'right', fontStyle:'bold'} },
                    margin: { left: 14, right: 14 }
                });
                finalY = doc.lastAutoTable.finalY + 10;
            });

        } else if (currentType === 'NERACA_SALDO') {
            head = [['No. Akun', 'Nama Akun', 'Debit', 'Kredit']];
            const saldos = hitungSaldo();
            let tD=0, tK=0;
            Object.keys(saldos).sort().forEach(akun => {
                const net = saldos[akun].debit - saldos[akun].kredit;
                if(net === 0) return;
                const isD = net > 0; const nom = Math.abs(net);
                if(isD) tD+=nom; else tK+=nom;
                body.push([akunMap[akun]||'', akun, isD?fmtNum(nom):'-', !isD?fmtNum(nom):'-']);
            });
            body.push([{content: 'TOTAL', colSpan: 2, styles: {halign: 'right', fontStyle: 'bold'}}, fmtNum(tD), fmtNum(tK)]);
            colStyles = { 2: {halign: 'right'}, 3: {halign: 'right'} };
            printTable(doc, head, body, colStyles, finalY);

        } else {
            // Laba Rugi / Neraca (Versi Simple Table)
            // Anda bisa kembangkan lagi jika mau detail, tapi ini sudah cukup untuk PDF
            doc.setFontSize(10);
            doc.text("Silakan lihat detail di layar aplikasi atau hubungi admin untuk format lengkap Laporan ini.", 14, 50);
        }

        // TTD
        finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 60;
        if (finalY > 170) { doc.addPage(); finalY = 20; }
        const xPos = 220;
        doc.setFont("helvetica", "normal");
        doc.text(`Makassar, ${tglCetak}`, xPos, finalY);
        doc.text("Disiapkan Oleh,", xPos, finalY + 5);
        doc.setFont("helvetica", "bold");
        doc.text("Finance Manager", xPos, finalY + 25);
        doc.setLineWidth(0.2); doc.line(xPos, finalY + 26, xPos + 40, finalY + 26);

        doc.save(`Laporan_${currentType}_NLD.pdf`);
    }

    function printTable(doc, head, body, colStyles, startY) {
        doc.autoTable({
            startY: startY,
            head: head, body: body, theme: 'grid',
            headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
            columnStyles: colStyles,
            styles: { fontSize: 9, cellPadding: 2 }
        });
    }

    function hitungSaldo() {
        const s = {};
        rawData.forEach(r => {
            if(!s[r.nama_akun]) s[r.nama_akun] = { debit:0, kredit:0 };
            s[r.nama_akun].debit += r.debit; s[r.nama_akun].kredit += r.kredit;
        });
        return s;
    }
  </script>
</body>
</html>