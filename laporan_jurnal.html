<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Laporan Keuangan Terintegrasi</title>

    <script src="supabase.js"></script>
    <script src="app_config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="auth.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            background-color: #f1f5f9;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px;
        }

        /* CUSTOM STYLES */
        .nav-tab.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .paper-look {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            min-height: 500px;
        }
    </style>
</head>

<body>

    <nav class="bg-white border-b px-4 py-3 sticky top-0 z-50 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div
                class="bg-blue-600 text-white w-8 h-8 flex items-center justify-center rounded-lg shadow-blue-200 shadow-lg">
                <i class="fas fa-chart-pie text-xs"></i>
            </div>
            <div>
                <h1 class="text-sm font-bold text-slate-800 leading-tight">Laporan Keuangan</h1>
                <p class="text-[10px] text-slate-500">Nusantara Land</p>
            </div>
        </div>
        <a href="dashboard_operasional.html"
            class="bg-slate-50 text-slate-400 w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100"><i
                class="fas fa-arrow-left text-xs"></i></a>
    </nav>

    <!-- CONTAINER UTAMA -->
    <main class="flex-grow max-w-7xl mx-auto w-full p-4 md:p-6 space-y-6">

        <!-- VIEW: MENU GRID (DEFAULT) -->
        <div id="view-menu" class="animate-enter">
            <h3 class="text-slate-500 font-bold text-sm uppercase tracking-wider mb-6 ml-1">Pilih Laporan</h3>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">

                <!-- CARD: JURNAL UMUM -->
                <div id="card-jurnal-umum" onclick="pilihLaporan('JURNAL', null)"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 bg-white rounded-xl shadow border border-slate-100 transition-all">
                    <div
                        class="w-16 h-16 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-3xl mb-4 group-hover:-rotate-12 transition">
                        <i class="fas fa-list-ul"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Jurnal Umum</h3>
                    <p class="text-xs text-slate-400 mt-1">Log Transaksi Lengkap</p>
                </div>

                <!-- CARD: BUKU BESAR -->
                <div onclick="pilihLaporan('BUKU_BESAR', null)"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 bg-white rounded-xl shadow border border-slate-100 transition-all">
                    <div
                        class="w-16 h-16 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center text-3xl mb-4 group-hover:rotate-12 transition">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Buku Besar</h3>
                    <p class="text-xs text-slate-400 mt-1">Rincian Per Akun</p>
                </div>

                <!-- CARD: NERACA SALDO -->
                <div onclick="pilihLaporan('NERACA_SALDO', null)"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 bg-white rounded-xl shadow border border-slate-100 transition-all">
                    <div
                        class="w-16 h-16 rounded-2xl bg-emerald-100 text-emerald-600 flex items-center justify-center text-3xl mb-4 group-hover:-rotate-12 transition">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Neraca Saldo</h3>
                    <p class="text-xs text-slate-400 mt-1">Ringkasan Saldo Akun</p>
                </div>

                <!-- CARD: ARUS KAS -->
                <div onclick="pilihLaporan('ARUS_KAS', null)"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 bg-white rounded-xl shadow border border-slate-100 transition-all">
                    <div
                        class="w-16 h-16 rounded-2xl bg-teal-100 text-teal-600 flex items-center justify-center text-3xl mb-4 group-hover:rotate-12 transition">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Arus Kas</h3>
                    <p class="text-xs text-slate-400 mt-1">Cash Flow In/Out</p>
                </div>

                <!-- CARD: LABA RUGI -->
                <div onclick="pilihLaporan('LABA_RUGI', null)"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 bg-white rounded-xl shadow border border-slate-100 transition-all">
                    <div
                        class="w-16 h-16 rounded-2xl bg-orange-100 text-orange-600 flex items-center justify-center text-3xl mb-4 group-hover:-rotate-12 transition">
                        <i class="fas fa-coins"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Laba Rugi</h3>
                    <p class="text-xs text-slate-400 mt-1">Profit & Loss</p>
                </div>

                <!-- CARD: NERACA -->
                <div onclick="pilihLaporan('NERACA', null)"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 bg-white rounded-xl shadow border border-slate-100 transition-all">
                    <div
                        class="w-16 h-16 rounded-2xl bg-cyan-100 text-cyan-600 flex items-center justify-center text-3xl mb-4 group-hover:rotate-12 transition">
                        <i class="fas fa-building"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Neraca</h3>
                    <p class="text-xs text-slate-400 mt-1">Posisi Keuangan</p>
                </div>

                <!-- CARD: ANALISIS KEUANGAN -->
                <div onclick="pilihLaporan('ANALISIS', null)"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 bg-white rounded-xl shadow border border-slate-100 transition-all">
                    <div
                        class="w-16 h-16 rounded-2xl bg-purple-100 text-purple-600 flex items-center justify-center text-3xl mb-4 group-hover:-rotate-12 transition">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Analisis</h3>
                    <p class="text-xs text-slate-400 mt-1">Rasio & Kesehatan</p>
                </div>

                <!-- CARD: NERACA LAJUR (NEW) -->
                <div onclick="pilihLaporan('NERACA_LAJUR', null)"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 bg-white rounded-xl shadow border border-slate-100 transition-all">
                    <div
                        class="w-16 h-16 rounded-2xl bg-pink-100 text-pink-600 flex items-center justify-center text-3xl mb-4 group-hover:rotate-12 transition">
                        <i class="fas fa-table"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Neraca Lajur</h3>
                    <p class="text-xs text-slate-400 mt-1">Worksheet 10 Kolom</p>
                </div>

                <!-- CARD: SETUP SALDO AWAL -->
                <div onclick="loadSetupSaldo()"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 bg-white rounded-xl shadow border border-slate-200 transition-all ring-2 ring-slate-100">
                    <div
                        class="w-16 h-16 rounded-2xl bg-slate-800 text-white flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition shadow-lg">
                        <i class="fas fa-balance-scale-left"></i>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg">Saldo Awal</h3>
                    <p class="text-xs text-slate-500 mt-1">Setup Cut-Off Awal</p>
                </div>

            </div>
        </div>

        <!-- VIEW: REPORT DETAIL (HIDDEN INITIALLY) -->
        <div id="view-report" class="hidden space-y-4">

            <!-- Back Button -->
            <button onclick="switchView('menu')"
                class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-bold transition mb-2">
                <i class="fas fa-arrow-left"></i> Kembali ke Menu Laporan
            </button>

            <!-- FILTER SECTION (Moved Inside) -->
            <div class="bg-white border rounded-xl shadow-sm p-4">
                <div class="flex flex-col md:flex-row gap-3 items-center justify-between">

                    <!-- Date Filter -->
                    <div class="flex items-center gap-2 bg-slate-100 p-1.5 rounded-lg border border-slate-200">
                        <input type="date" id="tglMulai"
                            class="bg-transparent text-sm font-bold text-slate-700 outline-none px-2">
                        <span class="text-slate-400 text-xs">s/d</span>
                        <input type="date" id="tglSelesai"
                            class="bg-transparent text-sm font-bold text-slate-700 outline-none px-2">
                        <button onclick="loadData()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-md text-xs font-bold transition shadow-sm">
                            <i class="fas fa-filter mr-1"></i> Terapkan
                        </button>
                    </div>

                    <!-- Mini Tabs (Optional for quick switching) -->
                    <div class="w-full md:w-auto overflow-x-auto">
                        <div class="flex gap-2 p-1 bg-slate-100 rounded-lg">
                            <button onclick="pilihLaporan('JURNAL', this)"
                                class="nav-tab active px-3 py-1 rounded text-[10px] font-bold transition whitespace-nowrap"
                                id="tab-JURNAL">Jurnal</button>
                            <button onclick="pilihLaporan('BUKU_BESAR', this)"
                                class="nav-tab px-3 py-1 rounded text-[10px] font-bold transition whitespace-nowrap"
                                id="tab-BUKU_BESAR">Buku Besar</button>
                            <button onclick="pilihLaporan('NERACA_SALDO', this)"
                                class="nav-tab px-3 py-1 rounded text-[10px] font-bold transition whitespace-nowrap"
                                id="tab-NERACA_SALDO">Neraca Saldo</button>
                            <button onclick="pilihLaporan('ARUS_KAS', this)"
                                class="nav-tab px-3 py-1 rounded text-[10px] font-bold transition whitespace-nowrap"
                                id="tab-ARUS_KAS">Arus Kas</button>
                            <button onclick="pilihLaporan('LABA_RUGI', this)"
                                class="nav-tab px-3 py-1 rounded text-[10px] font-bold transition whitespace-nowrap"
                                id="tab-LABA_RUGI">Laba Rugi</button>
                            <button onclick="pilihLaporan('NERACA', this)"
                                class="nav-tab px-3 py-1 rounded text-[10px] font-bold transition whitespace-nowrap"
                                id="tab-NERACA">Neraca</button>
                            <button onclick="pilihLaporan('ANALISIS', this)"
                                class="nav-tab px-3 py-1 rounded text-[10px] font-bold transition whitespace-nowrap"
                                id="tab-ANALISIS">Analisis</button>
                            <button onclick="pilihLaporan('NERACA_LAJUR', this)"
                                class="nav-tab px-3 py-1 rounded text-[10px] font-bold transition whitespace-nowrap"
                                id="tab-NERACA_LAJUR">Neraca Lajur</button>
                        </div>
                    </div>

                </div>
            </div>



            <!-- REPORT CONTAINER (PAPER LOOK) -->
            <div class="paper-look rounded-xl overflow-hidden">

                <!-- Report Header inside Paper -->
                <div class="bg-slate-50 border-b p-6 flex justify-between items-start">
                    <div>
                        <h2 id="judulLap" class="text-2xl font-black text-slate-800 tracking-tight">JURNAL UMUM</h2>
                        <p class="text-sm font-medium text-slate-500 mt-1" id="subJudul">Periode: -</p>
                    </div>
                    <div
                        class="bg-indigo-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-lg">
                        <i class="fas fa-file-invoice-dollar text-lg"></i>
                    </div>
                </div>

                <!-- Quick Search -->
                <div class="px-6 py-2 bg-white border-b flex items-center gap-2">
                    <i class="fas fa-search text-slate-300"></i>
                    <input type="text" id="quickSearch" onkeyup="filterLaporan()"
                        placeholder="Cari akun, nominal, atau keterangan..."
                        class="w-full outline-none text-sm font-bold text-slate-600 placeholder:font-normal h-8">
                </div>

                <div id="kontenScreen" class="p-6 text-sm min-h-[400px]">
                    <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                        <i class="fas fa-filter text-4xl mb-3 opacity-20"></i>
                        <p>Silakan pilih periode laporan di atas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: SETUP SALDO AWAL -->
        <div id="view-setup-saldo" class="hidden animate-enter">
            <button onclick="switchView('menu')"
                class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-bold transition mb-4">
                <i class="fas fa-arrow-left"></i> Kembali ke Menu
            </button>

            <div class="bg-white rounded-xl shadow-lg border overflow-hidden">
                <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-black text-slate-800">Setup Saldo Awal (Cut-Off)</h2>
                        <p class="text-xs text-slate-500 mt-1">Masukkan saldo awal akun per tanggal cut-off.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold text-slate-600">Tanggal Cut-Off:</label>
                        <input type="date" id="tglCutOff" class="border rounded px-2 py-1 text-sm font-bold bg-white">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-[600px]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 text-slate-600 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-4 w-32">Kode</th>
                                <th class="p-4">Nama Akun</th>
                                <th class="p-4 w-48 text-right text-blue-700">Debit</th>
                                <th class="p-4 w-48 text-right text-red-700">Kredit</th>
                            </tr>
                        </thead>
                        <tbody id="tbodySaldoAwal" class="divide-y divide-gray-100">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Footer Balance Indicator -->
                <div
                    class="p-4 border-t bg-slate-50 font-bold flex justify-between items-center sticky bottom-0 z-20 shadow-inner">
                    <div class="text-xs text-slate-500">
                        Total Input: <span id="countInputSaldo">0</span> Akun
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-right">
                            <div class="text-[10px] text-blue-600 uppercase">Total Debit</div>
                            <div class="text-lg text-blue-800" id="totalDebitSaldo">Rp 0</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-red-600 uppercase">Total Kredit</div>
                            <div class="text-lg text-red-800" id="totalKreditSaldo">Rp 0</div>
                        </div>
                        <div class="h-10 w-[1px] bg-slate-300"></div>
                        <div class="flex flex-col items-end">
                            <div id="balanceStatus" class="flex items-center gap-1 text-green-600">
                                <i class="fas fa-check-circle"></i> <span>BALANCE</span>
                            </div>
                            <button onclick="simpanSaldoAwal()" id="btnSimpanSaldo"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm shadow-lg transition active:scale-95 mt-1">
                                <i class="fas fa-save mr-2"></i> Simpan Saldo Awal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- SECURE EDIT JOURNAL MODAL -->
    <div id="editJurnalModal"
        class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-md md:max-w-2xl overflow-hidden transform transition-all scale-100 border border-slate-200 flex flex-col max-h-[90vh]">

            <!-- Header -->
            <div class="bg-indigo-600 p-4 md:p-5 flex justify-between items-center text-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-full">
                        <i class="fas fa-shield-alt text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg leading-tight">Secure Journal Editor</h3>
                        <p class="text-xs text-indigo-100 opacity-90">Edit transaksi dengan Audit Log</p>
                    </div>
                </div>
                <button onclick="closeEditJurnal()"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition text-white/80 hover:text-white">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Scrollable Body -->
            <div class="overflow-y-auto p-4 md:p-6 custom-scrollbar">
                <form id="formEditJurnal" class="space-y-5">
                    <input type="hidden" id="edit_jurnal_id">

                    <!-- Info Box -->
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-600 mt-0.5 text-lg"></i>
                        <div class="text-xs text-blue-800 leading-relaxed">
                            <strong>Note:</strong> Setiap perubahan akan dicatat dalam <strong>Audit Log</strong>. Data
                            historis sebelum perubahan akan diarsipkan untuk keperluan audit trail.
                        </div>
                    </div>

                    <!-- Account Dropdown (Master) -->
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wider">Akun (Dari
                            Master)</label>
                        <div class="relative">
                            <select id="edit_jurnal_akun"
                                class="w-full border border-slate-300 rounded-lg py-2.5 pl-3 pr-8 text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm appearance-none transition"
                                required>
                                <option value="">-- Pilih Akun Valid --</option>
                                <!-- Populated by JS -->
                            </select>
                            <div
                                class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wider">Keterangan
                            / Uraian</label>
                        <textarea id="edit_jurnal_desc" rows="3"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition resize-none"
                            placeholder="Deskripsi transaksi..." required></textarea>
                    </div>

                    <!-- Debit / Credit -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wider">Debit
                                (Rp)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-slate-400 font-bold text-xs">Rp</span>
                                <input type="number" id="edit_jurnal_debit"
                                    class="w-full border border-slate-200 bg-slate-50 rounded-lg py-2.5 pl-8 pr-3 text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-indigo-500 font-mono text-right font-bold text-slate-700 shadow-sm transition"
                                    placeholder="0">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wider">Kredit
                                (Rp)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-slate-400 font-bold text-xs">Rp</span>
                                <input type="number" id="edit_jurnal_kredit"
                                    class="w-full border border-slate-200 bg-slate-50 rounded-lg py-2.5 pl-8 pr-3 text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-indigo-500 font-mono text-right font-bold text-slate-700 shadow-sm transition"
                                    placeholder="0">
                            </div>
                        </div>
                    </div>

                    <!-- Reason (Required) -->
                    <div>
                        <label
                            class="block text-xs font-bold text-red-600 mb-1.5 uppercase tracking-wider flex items-center justify-between">
                            <span>Alasan Perubahan (Wajib)</span>
                            <span class="text-[10px] font-normal text-red-400 normal-case italic">*Min. 5
                                karakter</span>
                        </label>
                        <input type="text" id="edit_jurnal_reason"
                            class="w-full border border-red-200 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-red-500 bg-red-50/50 focus:bg-white placeholder-red-300 transition shadow-sm text-red-700"
                            placeholder="Contoh: Salah input akun, Typo nominal..." required>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3 shrink-0">
                <button type="button" onclick="closeEditJurnal()"
                    class="px-5 py-2.5 text-slate-600 hover:text-slate-800 hover:bg-slate-200/50 rounded-lg text-sm font-bold transition">
                    Batal
                </button>
                <button type="submit" form="formEditJurnal"
                    class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow-lg shadow-indigo-200 transition active:scale-95 flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    <span>Simpan & Audit</span>
                </button>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 right-6">
        <button onclick="downloadPDF()"
            class="bg-red-600 hover:bg-red-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition active:scale-90 z-50">
            <i class="fas fa-file-pdf fa-lg"></i>
        </button>
    </div>

    <script>
        // Menggunakan client dari app_config.js
        const client = window.client;

        // fmt sudah ada di app_config.js sebagai global window.fmt
        // const fmt = (n) => ... (DIHAPUS SUPAYA TIDAK KONFLIK)

        const fmtNum = (n) => new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(n);

        let currentType = 'JURNAL';
        let rawData = [];
        let akunMap = {};
        let akunKategori = {};
        let saldoAwalMap = {}; // Global Opening Balance Map

        const today = new Date();
        document.getElementById("tglMulai").valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById("tglSelesai").valueAsDate = today;

        // CHECK URL PARAMS for Actions
        document.addEventListener('DOMContentLoaded', () => {
            // --- SECURITY CHECK ---
            // Ensure Auth is ready
            if (window.PNAuth) {
                window.PNAuth.requireAuth(['admin', 'finance', 'direksi', 'accounting', 'superadmin']);
            }

            const session = window.PNAuth?.getSession();
            // Role Based Access Control for Sensitive Reports (Jurnal Umum)
            // Restricted roles cannot see Jurnal Umum
            const restrictedRoles = ['marketing', 'operasional', 'hr']; // Example restricted roles if any specific logic needed

            // For specifically requested restriction: Only Superadmin/Finance/Accounting usually need deep dive.
            // If user is just 'Direksi' without Finance/Admin background, they might be restricted from raw journal.
            // But per request we remove the "Taufiq" hardcode.

            // Logic: If we want to hide "Jurnal Umum" from certain people, implement here based on ROLE.
            // Currently assuming standard RBAC is enough.

            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            if (action === 'setup') {
                loadSetupSaldo();
            }
        });

        function switchView(viewName) {
            ['view-menu', 'view-report', 'view-setup-saldo'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
        }

        function pilihLaporan(type, el) {
            // DEBUG CLICK
            // alert("DEBUG: Menu Clicked -> " + type);

            // SECURITY BLOCK - Role Based
            // Example: If user is strictly 'viewer' or specific role, block JURNAL
            // For now we trust the RBAC above.

            if (!client) {
                alert("Error: Database connection not ready.");
                return;
            }

            currentType = type;
            switchView('report');

            // Reset active class on mini tabs
            document.querySelectorAll('.nav-tab').forEach(c => {
                c.classList.remove('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                c.classList.add('text-slate-500');
            });

            // Set Active only if el is provided (clicked from tab)
            // If clicked from Menu Grid, we auto-select the matching tab
            let tabEl = el || document.getElementById(`tab-${type}`);
            if (tabEl) {
                tabEl.classList.add('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                tabEl.classList.remove('text-slate-500');
            }

            const mapJudul = {
                'JURNAL': 'JURNAL UMUM', 'BUKU_BESAR': 'BUKU BESAR',
                'NERACA_SALDO': 'NERACA SALDO', 'LABA_RUGI': 'LAPORAN LABA RUGI',
                'NERACA': 'NERACA KEUANGAN', 'ARUS_KAS': 'LAPORAN ARUS KAS',
                'ANALISIS': 'ANALISIS KEUANGAN', 'NERACA_LAJUR': 'NERACA LAJUR (WORKSHEET)'
            };
            document.getElementById("judulLap").innerText = mapJudul[type];
            loadData();
        }

        async function loadData() {
            try {
                const start = document.getElementById("tglMulai").value;
                const end = document.getElementById("tglSelesai").value;
                document.getElementById("subJudul").innerText = `${new Date(start).toLocaleDateString('id-ID')} s/d ${new Date(end).toLocaleDateString('id-ID')}`;
                document.getElementById("kontenScreen").innerHTML = `<div class="py-10 text-center"><i class="fas fa-spinner fa-spin text-blue-500"></i> Loading Data...</div>`;

                // 1. Fetch Jurnal Data
                const { data: jurnal, error: errJ } = await client.from('jurnal_umum').select('*').gte('tanggal', start).lte('tanggal', end).order('tanggal', { ascending: true });
                if (errJ) throw new Error("Fetch Jurnal: " + errJ.message);

                // 2. Fetch Master Akun for Category Mapping
                const { data: master, error: errM } = await client.from('master_akun').select('nama_akun, kode_akun, kategori');
                if (errM) throw new Error("Fetch Master: " + errM.message);

                akunMap = {};
                akunKategori = {};
                if (master) {
                    master.forEach(m => {
                        akunMap[m.nama_akun] = m.kode_akun;
                        akunKategori[m.nama_akun] = m.kategori;
                    });
                }

                // 3. FETCH SALDO AWAL (Opening Balance)
                saldoAwalMap = {};
                const { data: prevData, error: errP } = await client
                    .from('jurnal_umum')
                    .select('nama_akun, debit, kredit')
                    .lt('tanggal', start);

                if (errP) throw new Error("Fetch Saldo Awal: " + errP.message);

                if (prevData) {
                    prevData.forEach(r => {
                        if (!saldoAwalMap[r.nama_akun]) saldoAwalMap[r.nama_akun] = 0;
                        saldoAwalMap[r.nama_akun] += (r.debit - r.kredit);
                    });
                }

                rawData = jurnal || [];

                renderScreen(); // Render Tampilan Layar HP
            } catch (e) {
                console.error(e);
                alert("Gagal memuat data: " + e.message);
                document.getElementById("kontenScreen").innerHTML = `<div class="text-red-500 p-8 text-center font-bold">Error: ${e.message}</div>`;
            }
        }

        // ==========================================
        // 1. RENDER SCREEN (TAMPILAN HP) - INTERAKTIF
        // ==========================================
        function renderScreen() {
            try {
                // DEBUG: Temporary check for user status
                // console.log("User:", window.PNAuth?.getSession()?.user?.full_name, "Restricted:", window.isRestrictedUser);

                let html = `<div class="space-y-3" id="reportValues">`;
                const saldos = hitungSaldo();


                // A. JURNAL UMUM
                // A. JURNAL UMUM (Double Entry Style)
                if (currentType === 'JURNAL') {
                    html += `
                <div class="overflow-auto max-h-[calc(100vh-280px)] border rounded-lg shadow-inner relative custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-100 text-slate-600 text-[10px] uppercase tracking-wider border-b border-slate-200 sticky top-0 z-20 shadow-sm">
                                <th class="p-3 font-bold w-24 text-center whitespace-nowrap bg-slate-100">Tanggal</th>
                                <th class="p-3 font-bold w-24 text-center whitespace-nowrap bg-slate-100">Ref</th>
                                <th class="p-3 font-bold bg-slate-100">Keterangan / Akun</th>
                                <th class="p-3 font-bold w-20 text-center whitespace-nowrap bg-slate-100">Ref Post</th>
                                <th class="p-3 font-bold w-32 text-right border-l border-slate-200 bg-slate-100 whitespace-nowrap">Debit</th>
                                <th class="p-3 font-bold w-32 text-right border-l border-slate-200 bg-slate-100 whitespace-nowrap">Kredit</th>
                                <th class="p-3 font-bold w-24 text-center border-l border-slate-200 bg-slate-100 whitespace-nowrap">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm divide-y divide-slate-100 table-auto">`;

                    rawData.forEach((r, idx) => {
                        const kode = akunMap[r.nama_akun] || '-';
                        const isDebit = r.debit > 0;
                        const isCredit = r.kredit > 0;

                        // Indentasi & Styling untuk Kredit
                        const indentClass = isCredit ? 'pl-8 text-slate-600' : 'font-bold text-slate-800';
                        const rowBg = idx % 2 === 0 ? 'bg-white' : 'bg-[#f8fafc]'; // Zebra Striping subtle

                        // Search Keyword Check
                        const searchStr = `${r.nama_akun} ${r.keterangan} ${kode} ${r.debit} ${r.kredit}`.toLowerCase();

                        // Edit Button Logic (Restricted to SUPERADMIN only)
                        const session = window.PNAuth?.getSession();
                        const isSuperAdmin = session?.user?.role === 'superadmin';
                        const showEdit = isSuperAdmin;

                        const btnEdit = showEdit ?
                            `<button onclick="openEditJurnal(${r.id})" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 mx-auto shadow-sm border border-indigo-200 w-full"><i class="fas fa-edit"></i> Edit</button>` : '<span class="text-xs text-slate-300">-</span>';

                        const btnDel = (showEdit && r.nomor_referensi) ?
                            `<button onclick="confirmDelete(${r.id}, '${r.nomor_referensi}')" class="bg-red-50 hover:bg-red-100 text-red-700 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 mt-1 mx-auto shadow-sm border border-red-200 w-full" title="Hapus Group Transaksi"><i class="fas fa-trash-alt"></i> Hapus</button>` : '';

                        const actionContent = `
                        ${btnEdit}
                        ${btnDel}
                    `;

                        html += `
                    <tr class="${rowBg} hover:bg-yellow-50 transition report-item" data-search="${searchStr}">
                        <td class="p-2.5 text-center text-xs text-slate-500 align-top border-r border-slate-100">
                           ${new Date(r.tanggal).toLocaleDateString('id-ID')}
                        </td>
                        <td class="p-2.5 text-center text-[10px] text-slate-400 font-mono align-top border-r border-slate-100 truncate max-w-[80px]">
                           ${r.nomor_referensi || '-'}
                        </td>
                        <td class="p-2.5 align-top">
                            <div class="${indentClass}">${r.nama_akun}</div>
                            ${isDebit ? `<div class="text-[10px] text-slate-400 italic mt-0.5 truncate">${r.keterangan || ''}</div>` : ''} 
                        </td>
                         <td class="p-2.5 text-center text-xs font-mono text-slate-500 align-top border-l border-slate-100">
                           ${kode}
                        </td>
                        <td class="p-2.5 text-right font-mono text-slate-700 align-top border-l border-slate-200 bg-slate-50/50">
                            ${isDebit ? fmt(r.debit) : ''}
                        </td>
                        <td class="p-2.5 text-right font-mono text-slate-700 align-top border-l border-slate-200 bg-slate-50/50">
                            ${isCredit ? fmt(r.kredit) : ''}
                        </td>
                        <td class="p-2.5 text-center border-l border-slate-200 px-2">
                            ${actionContent}
                        </td>
                    </tr>`;
                    });

                    html += `</tbody></table></div>
                <div class="mt-4 text-xs text-slate-400 text-center italic border-t pt-2">
                    *Tampilan Jurnal Umum Standar Akuntansi (Double Entry)
                </div>`;

                    // B. BUKU BESAR (ACCORDION STYLE WITH TABLE)
                } else if (currentType === 'BUKU_BESAR') {
                    const groups = {};
                    rawData.forEach(r => { if (!groups[r.nama_akun]) groups[r.nama_akun] = []; groups[r.nama_akun].push(r); });

                    // Wrapper untuk scroll jika konten panjang
                    html += `<div class="space-y-4 max-h-[calc(100vh-280px)] overflow-y-auto custom-scrollbar pr-2">`;

                    Object.keys(groups).sort().forEach(akun => {
                        const kategori = akunKategori[akun] || '';
                        const isCreditNormal = ['Kewajiban', 'Ekuitas', 'Pendapatan', 'Hutang', 'Modal', 'Penjualan'].some(k => kategori.includes(k));

                        // Logic Saldo Awal
                        let rawSaldo = saldoAwalMap[akun] || 0;

                        // Jika Normal Kredit, Saldo = Kredit - Debit. (Jadi Saldo Awal Accounting (-100) dibaca 100)
                        // Tapi di DB kita simpan Debit +, Kredit -. (Net Debit).
                        // Jadi: Net Debit -100 (Credit 100).
                        // Kalau kita mau tampilkan Positive for Credit Balance: loop harus s -= (debit - kredit) aka s += (kredit - debit).

                        let displaySaldo = isCreditNormal ? -rawSaldo : rawSaldo; // Flip sign for display if credit normal
                        let runningSaldo = rawSaldo; // Keep raw tracking for math

                        let rows = '';

                        // FORCE SHOW Saldo Awal (Even if 0) for clarity
                        rows += `
                    <tr class="bg-yellow-50 border-b transition">
                        <td class="p-2.5 text-center text-slate-400 align-top">-</td>
                        <td class="p-2.5 font-bold text-slate-600 align-top">Saldo Awal ${isCreditNormal ? '(Normal Kredit)' : '(Normal Debit)'}</td>
                        <td class="p-2.5 text-right font-mono text-slate-500 border-l border-slate-100 align-top">-</td>
                        <td class="p-2.5 text-right font-mono text-slate-500 border-l border-slate-100 align-top">-</td>
                        <td class="p-2.5 text-right font-mono font-bold text-slate-700 border-l border-slate-100 bg-slate-50/30 align-top">
                            ${fmt(displaySaldo)}
                        </td>
                    </tr>`;

                        // TABLE HEADER
                        const tableHeader = `
                    <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse text-xs">
                        <thead>
                            <tr class="bg-slate-50 text-slate-500 uppercase tracking-widest border-b border-slate-200">
                                <th class="p-3 w-24 text-center">Tanggal</th>
                                <th class="p-3">Keterangan</th>
                                <th class="p-3 w-32 text-right border-l border-slate-100">Debit</th>
                                <th class="p-3 w-32 text-right border-l border-slate-100">Kredit</th>
                                <th class="p-3 w-32 text-right border-l border-slate-100 bg-slate-50">Saldo</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">`;

                        // Calculate & Generate Rows
                        groups[akun].forEach(r => {
                            // Update Running Balance (Raw Net Debit)
                            runningSaldo += (r.debit - r.kredit);

                            // Calculate Display
                            let sDisp = isCreditNormal ? -runningSaldo : runningSaldo;

                            const searchStr = `${r.keterangan} ${r.debit} ${r.kredit}`.toLowerCase();
                            const isDebit = r.debit > 0;
                            const isCredit = r.kredit > 0;

                            // Color logic: Negative is Red
                            const colorClass = sDisp < 0 ? 'text-red-600' : 'text-blue-700';

                            rows += `
                     <tr class="hover:bg-slate-50 transition report-item" data-search="${searchStr}">
                        <td class="p-2.5 text-center text-slate-500 align-top">${new Date(r.tanggal).toLocaleDateString('id-ID')}</td>
                        <td class="p-2.5 text-slate-700 italic align-top">${r.keterangan || '-'}</td>
                        <td class="p-2.5 text-right font-mono text-slate-700 border-l border-slate-100 align-top">${isDebit ? fmt(r.debit) : ''}</td>
                        <td class="p-2.5 text-right font-mono text-slate-700 border-l border-slate-100 align-top">${isCredit ? fmt(r.kredit) : ''}</td>
                        <td class="p-2.5 text-right font-mono font-bold ${colorClass} border-l border-slate-100 bg-slate-50/30 align-top">${fmt(sDisp)}</td>
                     </tr>`;
                        });

                        const tableFooter = `</tbody></table></div>`;
                        const searchGroup = `${akun} ${displaySaldo}`.toLowerCase(); // Use final displaySaldo

                        // Accordion Item
                        html += `
                 <details class="group bg-white border border-slate-200 rounded-lg overflow-hidden transition-all duration-300 open:shadow-md report-group mb-4" open data-search="${searchGroup}">
                    <summary class="flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100 cursor-pointer select-none list-none sticky top-0 z-10 border-b border-transparent group-open:border-slate-200">
                        <div class="flex items-center gap-3">
                            <div class="bg-white border rounded p-1 shadow-sm group-open:rotate-90 transition-transform">
                                 <i class="fas fa-chevron-right text-slate-400 text-xs"></i>
                            </div>
                            <div>
                                <span class="font-bold text-slate-700 text-sm block">${akun}</span>
                                <span class="text-[10px] text-slate-400 font-normal border px-1 rounded bg-slate-100">${isCreditNormal ? 'Saldo Normal: KREDIT' : 'Saldo Normal: DEBIT'}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">Saldo Akhir</div>
                            <div class="font-mono font-bold ${displaySaldo < 0 ? 'text-red-600' : 'text-blue-700'}">
                                ${fmt(displaySaldo)}
                            </div>
                        </div>
                    </summary>
                    <div class="bg-white p-2">
                        ${tableHeader}
                        ${rows}
                        ${tableFooter}
                    </div>
                 </details>`;
                    });

                    html += `</div>`; // Close Wrapper
                    // C. NERACA SALDO & LAINNYA (WITH VISUAL BARS)
                } else {
                    // Logic generic (Neraca Saldo, Laba Rugi, Neraca, Analisis)
                    const saldoMap = (currentType === 'NERACA_SALDO' || currentType === 'ARUS_KAS' || currentType === 'ANALISIS') ? saldos : filterSaldosByType(saldos, currentType);

                    // Cari nilai max (Skip untuk Arus Kas & Analisis karena punya logic sendiri)
                    let maxVal = 0;
                    if (currentType !== 'ARUS_KAS' && currentType !== 'ANALISIS' && saldoMap) {
                        Object.values(saldoMap).forEach(v => {
                            const n = Math.abs(currentType === 'NERACA_SALDO' ? (v.debit - v.kredit) : v);
                            if (n > maxVal) maxVal = n;
                        });
                    }

                    // GROUPING: Jika Neraca/Laba Rugi, pisahkan based on category
                    // C. NERACA SALDO (TABLE STYLE)
                    if (currentType === 'NERACA_SALDO') {

                        html += `
                    <div class="overflow-auto max-h-[calc(100vh-280px)] border rounded-lg shadow-inner relative custom-scrollbar bg-white">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-100 text-slate-600 text-xs uppercase tracking-wider border-b border-slate-200 sticky top-0 z-20 shadow-sm">
                                    <th class="p-3 bg-slate-100">Nama Akun</th>
                                    <th class="p-3 w-40 text-right bg-slate-100 border-l border-slate-200">Debit</th>
                                    <th class="p-3 w-40 text-right bg-slate-100 border-l border-slate-200">Kredit</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-slate-50">`;

                        let tD = 0, tK = 0;
                        if (saldoMap) {
                            Object.keys(saldoMap).sort().forEach(akun => {
                                const net = saldoMap[akun].debit - saldoMap[akun].kredit;
                                if (net === 0) return; // Skip zero balance

                                const isD = net > 0;
                                const nom = Math.abs(net);

                                if (isD) tD += nom; else tK += nom;

                                html += `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                            <td class="p-3 pl-4 font-medium text-slate-700">${akun}</td>
                            <td class="p-3 text-right font-mono text-slate-700 border-l border-slate-100">
                                ${isD ? fmt(nom) : ''}
                            </td>
                             <td class="p-3 text-right font-mono text-slate-700 border-l border-slate-100">
                                ${!isD ? fmt(nom) : ''}
                            </td>
                        </tr>`;
                            });
                        }

                        // Footer Total
                        const isBalanced = Math.abs(tD - tK) < 1;

                        html += `
                            </tbody>
                            <tfoot class="sticky bottom-0 z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                                <tr class="${isBalanced ? 'bg-slate-800 text-white' : 'bg-red-600 text-white'} text-sm font-bold">
                                    <td class="p-3 text-right uppercase tracking-[0.1em] text-xs opacity-90">Total Neraca Saldo</td>
                                    <td class="p-3 text-right font-mono border-l border-white/20">${fmt(tD)}</td>
                                    <td class="p-3 text-right font-mono border-l border-white/20">${fmt(tK)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    ${!isBalanced ? `<div class="bg-red-50 text-red-600 text-xs font-bold p-2 text-center mt-2 rounded border border-red-200"> Neraca Saldo Tidak Seimbang (Selisih: ${fmt(Math.abs(tD - tK))})</div>` : ''}
                    `;

                        // F. ARUS KAS (TABLE STYLE)
                    } else if (currentType === 'ARUS_KAS') {
                        // Keywords untuk deteksi akun Kas/Bank
                        const validCashRegex = /kas|bank|cash|tunai|bca|mandiri|bri|bni|cimb|danamon|permata|wallet|dompet/i;

                        let tableRows = '';
                        let totalMasuk = 0;
                        let totalKeluar = 0;
                        let hasData = false;

                        // Header Table
                        html += `
                    <div class="overflow-auto max-h-[calc(100vh-280px)] border rounded-lg shadow-inner relative custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-100 text-slate-600 text-xs uppercase tracking-wider border-b border-slate-200 sticky top-0 z-20 shadow-sm">
                                    <th class="p-3 bg-slate-100">Akun Kas / Bank</th>
                                    <th class="p-3 text-right bg-slate-100 border-l border-slate-200 text-emerald-600">Arus Masuk (Debit)</th>
                                    <th class="p-3 text-right bg-slate-100 border-l border-slate-200 text-rose-600">Arus Keluar (Kredit)</th>
                                    <th class="p-3 text-right bg-slate-100 border-l border-slate-200">Perubahan Bersih</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-slate-50 font-mono">`;

                        for (let [ak, v] of Object.entries(saldos)) {
                            if (ak.match(validCashRegex)) {
                                // Filter hanya yang ada mutasi
                                if (v.debit === 0 && v.kredit === 0) continue;

                                hasData = true;
                                totalMasuk += v.debit;
                                totalKeluar += v.kredit;
                                const net = v.debit - v.kredit;

                                const rowClass = net >= 0 ? 'text-blue-700' : 'text-orange-600';

                                tableRows += `
                            <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                                <td class="p-3 font-sans font-bold text-slate-700">${ak}</td>
                                <td class="p-3 text-right text-emerald-600 border-l border-slate-100 bg-emerald-50/20">
                                    ${v.debit > 0 ? fmt(v.debit) : '-'}
                                </td>
                                <td class="p-3 text-right text-rose-600 border-l border-slate-100 bg-rose-50/20">
                                    ${v.kredit > 0 ? fmt(v.kredit) : '-'}
                                </td>
                                <td class="p-3 text-right font-bold ${rowClass} border-l border-slate-100 bg-slate-50">
                                    ${fmt(net)}
                                </td>
                            </tr>`;
                            }
                        }

                        if (!hasData) {
                            tableRows = `<tr><td colspan="4" class="p-8 text-center text-slate-400 italic">Tidak ada mutasi arus kas pada periode ini.</td></tr>`;
                        }

                        html += tableRows;

                        // Footer Total
                        const netTotal = totalMasuk - totalKeluar;
                        html += `
                            </tbody>
                            <tfoot class="bg-slate-50 border-t-2 border-slate-200 font-bold text-sm shadow-[0_-2px_10px_rgba(0,0,0,0.05)] sticky bottom-0 z-20">
                                <tr>
                                    <td class="p-3 text-slate-600 uppercase tracking-widest text-right">Total Mutasi</td>
                                    <td class="p-3 text-right text-emerald-700 bg-emerald-100/50">${fmt(totalMasuk)}</td>
                                    <td class="p-3 text-right text-rose-700 bg-rose-100/50">${fmt(totalKeluar)}</td>
                                    <td class="p-3 text-right ${netTotal >= 0 ? 'text-blue-700' : 'text-orange-600'} bg-slate-100">${fmt(netTotal)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Summary Card -->
                    <div class="${netTotal >= 0 ? 'bg-gradient-to-r from-blue-600 to-indigo-600' : 'bg-gradient-to-r from-orange-500 to-red-600'} text-white p-6 rounded-xl shadow-lg flex justify-between items-center mt-6">
                        <div>
                            <div class="text-xs opacity-90 uppercase font-bold tracking-[0.2em] mb-1">Surplus / Defisit Kas Net</div>
                            <div class="text-3xl font-black tracking-tight">${fmt(netTotal)}</div>
                            <div class="text-[10px] mt-2 opacity-80 font-medium">*Total kenaikan/penurunan kas periode ini</div>
                        </div>
                        <div class="bg-white/20 p-3 rounded-lg backdrop-blur-sm">
                            <i class="fas fa-money-bill-transfer text-3xl"></i>
                        </div>
                    </div>
                    `;

                        // G. LABA RUGI (TABLE STYLE)
                    } else if (currentType === 'LABA_RUGI') {
                        const { inc, exp, incTotal, expTotal } = saldoMap;
                        const labaBersih = incTotal - expTotal;
                        const isProfit = labaBersih >= 0;

                        html += `
                    <div class="overflow-auto max-h-[calc(100vh-280px)] border rounded-lg shadow-inner relative custom-scrollbar bg-white">
                        <table class="w-full text-left border-collapse">
                             <!-- HEADER PENDAPATAN -->
                            <thead>
                                <tr class="bg-emerald-50 text-emerald-800 text-xs font-bold uppercase tracking-widest border-b border-emerald-100 sticky top-0 z-20 shadow-sm">
                                    <th class="p-3">Pendapatan (Revenue)</th>
                                    <th class="p-3 w-40 text-right">Nominal</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm border-b border-slate-100">`;

                        // List Pendapatan
                        if (Object.keys(inc).length === 0) {
                            html += `<tr><td colspan="2" class="p-4 text-center text-slate-400 italic font-mono text-xs">Belum ada data pendapatan</td></tr>`;
                        } else {
                            Object.entries(inc).forEach(([ak, val]) => {
                                html += `
                                <tr class="hover:bg-emerald-50/30 transition border-b border-slate-50">
                                    <td class="p-3 pl-6 text-slate-700 font-medium">${ak}</td>
                                    <td class="p-3 text-right font-mono text-slate-700">${fmt(val)}</td>
                                </tr>`;
                            });
                        }

                        // Total Pendapatan
                        html += `
                            <tr class="bg-emerald-100/50 font-bold text-emerald-800 text-sm">
                                <td class="p-3 text-right uppercase tracking-wider text-xs">Total Pendapatan</td>
                                <td class="p-3 text-right font-mono">${fmt(incTotal)}</td>
                            </tr>
                            </tbody>

                            <!-- HEADER BEBAN -->
                            <thead>
                                <tr class="bg-rose-50 text-rose-800 text-xs font-bold uppercase tracking-widest border-y border-rose-100 sticky top-10 z-10 shadow-sm">
                                    <th class="p-3">Beban Operasional (Expenses)</th>
                                    <th class="p-3 w-40 text-right">Nominal</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">`;

                        // List Beban
                        if (Object.keys(exp).length === 0) {
                            html += `<tr><td colspan="2" class="p-4 text-center text-slate-400 italic font-mono text-xs">Belum ada data beban</td></tr>`;
                        } else {
                            Object.entries(exp).forEach(([ak, val]) => {
                                html += `
                                <tr class="hover:bg-rose-50/30 transition border-b border-slate-50">
                                    <td class="p-3 pl-6 text-slate-700 font-medium">${ak}</td>
                                    <td class="p-3 text-right font-mono text-slate-700">${fmt(val)}</td>
                                </tr>`;
                            });
                        }

                        // Total Beban
                        html += `
                            <tr class="bg-rose-100/50 font-bold text-rose-800 text-sm border-b border-slate-200">
                                <td class="p-3 text-right uppercase tracking-wider text-xs">Total Beban</td>
                                <td class="p-3 text-right font-mono">(${fmt(expTotal)})</td>
                            </tr>
                            </tbody>
                            
                            <!-- NET PROFIT TOTAL -->
                            <tfoot class="sticky bottom-0 z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                                <tr class="${isProfit ? 'bg-indigo-600 text-white' : 'bg-orange-500 text-white'} text-base font-black">
                                    <td class="p-4 text-right uppercase tracking-[0.1em] text-xs opacity-90">Laba / Rugi Bersih</td>
                                    <td class="p-4 text-right font-mono text-xl">${fmt(labaBersih)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;

                        // H. NERACA (TABLE STYLE)
                    } else if (currentType === 'NERACA') {
                        const { ast, pas, astTotal, pasTotal } = saldoMap;
                        const isBalanced = Math.abs(astTotal - pasTotal) < 1; // Tolerance for float

                        html += `
                    <div class="overflow-auto max-h-[calc(100vh-280px)] border rounded-lg shadow-inner relative custom-scrollbar bg-white">
                        <table class="w-full text-left border-collapse">
                            
                            <!-- HEADER ASSET (AKTIVA) -->
                            <thead>
                                <tr class="bg-blue-50 text-blue-800 text-xs font-bold uppercase tracking-widest border-b border-blue-100 sticky top-0 z-20 shadow-sm">
                                    <th class="p-3">Aset (Aktiva)</th>
                                    <th class="p-3 w-40 text-right">Nominal</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm border-b border-slate-100">`;

                        if (Object.keys(ast).length === 0) {
                            html += `<tr><td colspan="2" class="p-4 text-center text-slate-400 italic font-mono text-xs">Belum ada data aset</td></tr>`;
                        } else {
                            Object.entries(ast).forEach(([ak, val]) => {
                                if (Math.abs(val) < 1) return; // SKIP ZERO BALANCE
                                html += `
                                <tr class="hover:bg-blue-50/30 transition border-b border-slate-50">
                                    <td class="p-3 pl-6 text-slate-700 font-medium">${ak}</td>
                                    <td class="p-3 text-right font-mono text-slate-700">${fmt(val)}</td>
                                </tr>`;
                            });
                        }

                        // Total Assets
                        html += `
                            <tr class="bg-blue-100/50 font-bold text-blue-800 text-sm">
                                <td class="p-3 text-right uppercase tracking-wider text-xs">Total Aset</td>
                                <td class="p-3 text-right font-mono">${fmt(astTotal)}</td>
                            </tr>
                            </tbody>

                            <!-- HEADER PASIVA (KEWAJIBAN + MODAL) -->
                            <thead>
                                <tr class="bg-indigo-50 text-indigo-800 text-xs font-bold uppercase tracking-widest border-y border-indigo-100 sticky top-10 z-10 shadow-sm">
                                    <th class="p-3">Liabilitas & Ekuitas (Pasiva)</th>
                                    <th class="p-3 w-40 text-right">Nominal</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">`;

                        if (Object.keys(pas).length === 0) {
                            html += `<tr><td colspan="2" class="p-4 text-center text-slate-400 italic font-mono text-xs">Belum ada data pasiva</td></tr>`;
                        } else {
                            Object.entries(pas).forEach(([ak, val]) => {
                                if (Math.abs(val) < 1) return; // SKIP ZERO BALANCE
                                html += `
                                <tr class="hover:bg-indigo-50/30 transition border-b border-slate-50">
                                    <td class="p-3 pl-6 text-slate-700 font-medium">${ak}</td>
                                    <td class="p-3 text-right font-mono text-slate-700">${fmt(val)}</td>
                                </tr>`;
                            });
                        }

                        // Total Pasiva
                        html += `
                            <tr class="bg-indigo-100/50 font-bold text-indigo-800 text-sm border-b border-slate-200">
                                <td class="p-3 text-right uppercase tracking-wider text-xs">Total Pasiva</td>
                                <td class="p-3 text-right font-mono">${fmt(pasTotal)}</td>
                            </tr>
                            </tbody>
                            
                            <!-- CHECK BALANCE -->
                            <tfoot class="sticky bottom-0 z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                                <tr class="${isBalanced ? 'bg-emerald-600 text-white' : 'bg-red-600 text-white'} text-base font-black">
                                    <td class="p-4 flex items-center gap-2">
                                        <i class="fas ${isBalanced ? 'fa-check-circle' : 'fa-exclamation-triangle'} text-lg opacity-80"></i>
                                        <span class="uppercase tracking-[0.1em] text-xs opacity-90">
                                            ${isBalanced ? 'Neraca Seimbang (Balance)' : 'Neraca Tidak Seimbang!'}
                                        </span>
                                    </td>
                                    <td class="p-4 text-right font-mono text-xl opacity-90">
                                         ${isBalanced ? 'OK' : 'Selisih: ' + fmt(astTotal - pasTotal)}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>`;

                        // I. ANALISIS & LAINNYA
                    } else if (currentType === 'ANALISIS') {
                        // CALCULATE VARIABLES
                        let currentAssets = 0, currentLiabilities = 0;
                        let totalRevenue = 0, totalExpense = 0;
                        let totalDebt = 0, totalEquity = 0;

                        for (let [ak, v] of Object.entries(saldos)) {
                            let net = v.debit - v.kredit;

                            // 1. Current Assets (Kas, Bank, Piutang, Persediaan)
                            if (ak.match(/kas|bank|piutang|persediaan/i)) currentAssets += net;

                            // 2. Current Liabilities (Hutang) - Normally Credit Balance (Negative net)
                            // We take absolute value for ratio calc
                            if (ak.match(/hutang/i)) currentLiabilities += Math.abs(net);

                            // 3. Profitability
                            let netPL = v.kredit - v.debit;
                            if (ak.match(/pendapatan|penjualan/i)) totalRevenue += netPL;
                            if (ak.match(/beban|biaya|gaji|listrik/i)) totalExpense += Math.abs(v.debit - v.kredit);
                        }

                        // RATIO CALCULATIONS
                        const currentRatio = currentLiabilities > 0 ? (currentAssets / currentLiabilities) : (currentAssets > 0 ? 99 : 0);
                        const netProfit = totalRevenue - totalExpense;
                        const netMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
                        const oprRatio = totalRevenue > 0 ? (totalExpense / totalRevenue) * 100 : 0;

                        // RENDER CARDS
                        html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">`;

                        // CARD 1: LIQUIDITY
                        let crColor = currentRatio >= 1.5 ? 'text-green-600' : (currentRatio >= 1.0 ? 'text-yellow-600' : 'text-red-600');
                        let crStatus = currentRatio >= 1.5 ? 'Sangat Sehat' : (currentRatio >= 1.0 ? 'Cukup Aman' : 'Waspada');
                        let crIcon = currentRatio >= 1.0 ? 'fa-check-circle' : 'fa-exclamation-triangle';

                        html += `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between h-48">
                    <div>
                        <h4 class="text-slate-500 font-bold text-xs uppercase tracking-wider mb-2">Likuiditas (Current Ratio)</h4>
                        <div class="text-4xl font-black ${crColor}">${currentRatio.toFixed(2)}x</div>
                        <div class="flex items-center gap-2 mt-2">
                            <i class="fas ${crIcon} ${crColor}"></i>
                            <span class="font-bold text-sm ${crColor}">${crStatus}</span>
                        </div>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-4 border-t pt-2">
                        Kemampuan membayar hutang jangka pendek dengan aset lancar. Target: > 1.0x
                    </div>
                </div>`;

                        // CARD 2: PROFITABILITY
                        let npmColor = netMargin >= 20 ? 'text-emerald-600' : (netMargin > 0 ? 'text-blue-600' : 'text-red-600');
                        let npmStatus = netMargin >= 20 ? 'High Profit' : (netMargin > 0 ? 'Profitable' : 'Loss');

                        html += `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between h-48">
                    <div>
                        <h4 class="text-slate-500 font-bold text-xs uppercase tracking-wider mb-2">Profitabilitas (Net Margin)</h4>
                        <div class="text-4xl font-black ${npmColor}">${netMargin.toFixed(1)}%</div>
                        <div class="flex items-center gap-2 mt-2">
                            <i class="fas fa-chart-pie ${npmColor}"></i>
                            <span class="font-bold text-sm ${npmColor}">${npmStatus}</span>
                        </div>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-4 border-t pt-2">
                        Persentase keuntungan bersih dari total pendapatan.
                    </div>
                </div>`;

                        // CARD 3: OPERATIONAL EFFICIENCY
                        let oprColor = oprRatio <= 60 ? 'text-green-600' : (oprRatio <= 85 ? 'text-yellow-600' : 'text-red-600');

                        html += `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between h-48">
                    <div>
                        <h4 class="text-slate-500 font-bold text-xs uppercase tracking-wider mb-2">Efisiensi (BOPO)</h4>
                        <div class="text-4xl font-black ${oprColor}">${oprRatio.toFixed(1)}%</div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="font-bold text-sm text-slate-600">dari Pendapatan</span>
                        </div>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-4 border-t pt-2">
                        Beban Operasional terhadap Pendapatan Operasional. Makin kecil makin efisien.
                    </div>
                </div>`;

                        html += `</div>`; // End Grid

                        // RECOMMENDATION SECTION
                        html += `
                <div class="mt-6 p-5 bg-indigo-50 rounded-xl border border-indigo-100">
                    <h4 class="font-bold text-indigo-900 mb-2"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Insight Keuangan</h4>
                    <p class="text-sm text-indigo-800 leading-relaxed">
                        Berdasarkan data periode ini, perusahaan mencatatkan <strong>${netMargin > 0 ? 'Keuntungan' : 'Kerugian'}</strong> sebesar <strong>${fmt(netProfit)}</strong>. 
                        Posisi likuiditas berada di level <strong>${crStatus}</strong>, yang berarti perusahaan ${currentRatio >= 1.0 ? 'mampu' : 'mungkin kesulitan'} memenuhi kewajiban jangka pendeknya saat ini.
                    </p>
                </div>`;

                        // J. NERACA LAJUR (NEW: 10 Columns)
                    } else if (currentType === 'NERACA_LAJUR') {
                        console.log("DEBUG: Start Neraca Lajur Render");
                        html += `
                    <div class="overflow-auto max-h-[calc(100vh-280px)] border rounded-lg shadow-inner relative custom-scrollbar bg-white">
                        <table class="w-full text-left border-collapse text-xs whitespace-nowrap">
                            <thead class="sticky top-0 z-20 shadow-sm">
                                <!-- Group Headers -->
                                <tr class="bg-slate-800 text-white font-bold uppercase tracking-wider text-[10px] text-center">
                                    <th class="p-2 border-r border-slate-700 w-64" rowspan="2">Nama Akun</th>
                                    <th class="p-2 border-r border-slate-700 bg-sky-900" colspan="2">Neraca Saldo</th>
                                    <th class="p-2 border-r border-slate-700 bg-amber-900" colspan="2">Penyesuaian (AJP)</th>
                                    <th class="p-2 border-r border-slate-700 bg-indigo-900" colspan="2">NS Disesuaikan</th>
                                    <th class="p-2 border-r border-slate-700 bg-emerald-900" colspan="2">Laba Rugi</th>
                                    <th class="p-2 bg-rose-900" colspan="2">Neraca</th>
                                </tr>
                                <!-- Sub Headers -->
                                <tr class="bg-slate-100 text-slate-600 font-bold uppercase tracking-wider text-[10px] text-center border-b border-slate-300">
                                    <th class="p-2 w-28 bg-sky-50 border-r border-slate-200">Debit</th>
                                    <th class="p-2 w-28 bg-sky-50 border-r border-slate-200">Kredit</th>
                                    <th class="p-2 w-28 bg-amber-50 border-r border-slate-200">Debit</th>
                                    <th class="p-2 w-28 bg-amber-50 border-r border-slate-200">Kredit</th>
                                    <th class="p-2 w-28 bg-indigo-50 border-r border-slate-200">Debit</th>
                                    <th class="p-2 w-28 bg-indigo-50 border-r border-slate-200">Kredit</th>
                                    <th class="p-2 w-28 bg-emerald-50 border-r border-slate-200">Debit</th>
                                    <th class="p-2 w-28 bg-emerald-50 border-r border-slate-200">Kredit</th>
                                    <th class="p-2 w-28 bg-rose-50 border-r border-slate-200">Debit</th>
                                    <th class="p-2 w-28 bg-rose-50">Kredit</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 font-mono text-slate-700">`;

                        let sumNS_D = 0, sumNS_K = 0;
                        let sumAJP_D = 0, sumAJP_K = 0;
                        let sumNSD_D = 0, sumNSD_K = 0;
                        let sumLR_D = 0, sumLR_K = 0;
                        let sumNR_D = 0, sumNR_K = 0;

                        if (!saldos) { console.error("DEBUG: Saldos is null"); throw new Error("Saldos is null"); }
                        console.log("DEBUG: Getting sortedAkun");
                        const sortedAkun = Object.keys(saldos).sort();

                        if (sortedAkun.length === 0) {
                            html += `<tr><td colspan="11" class="p-8 text-center text-slate-400 italic">Belum ada data transaksi</td></tr>`;
                        } else {
                            sortedAkun.forEach(ak => {
                                // console.log("DEBUG: Processing " + ak);
                                const v = saldos[ak];
                                const net = v.debit - v.kredit;
                                if (Math.abs(net) < 1) return; // Skip zero balance

                                // 1. Neraca Saldo (NS)
                                const ns_d = net > 0 ? net : 0;
                                const ns_k = net < 0 ? Math.abs(net) : 0;
                                sumNS_D += ns_d; sumNS_K += ns_k;

                                // 2. AJP (Adjustment) - Currently 0
                                const ajp_d = 0;
                                const ajp_k = 0;
                                sumAJP_D += ajp_d; sumAJP_K += ajp_k;

                                // 3. NS Disesuaikan (NSD) = NS + AJP
                                // Debits add to Debits, Credits add to Credits
                                const net_adj = (ns_d - ns_k) + (ajp_d - ajp_k);
                                const nsd_d = net_adj > 0 ? net_adj : 0;
                                const nsd_k = net_adj < 0 ? Math.abs(net_adj) : 0;
                                sumNSD_D += nsd_d; sumNSD_K += nsd_k;

                                // 4. Split to L/R or Neraca
                                // Fix Error: Ensure akunKategori is safe
                                let cat = '';
                                if (typeof akunKategori !== 'undefined' && akunKategori[ak]) {
                                    cat = akunKategori[ak].toLowerCase();
                                }

                                const isLR = cat.includes('pendapatan') || cat.includes('revenue') || cat.includes('penjualan') ||
                                    cat.includes('beban') || cat.includes('biaya') || cat.includes('hpp') || cat.includes('cost') || cat.includes('expense');

                                let lr_d = 0, lr_k = 0, nr_d = 0, nr_k = 0;

                                if (isLR) {
                                    lr_d = nsd_d; lr_k = nsd_k;
                                } else {
                                    nr_d = nsd_d; nr_k = nsd_k;
                                }
                                sumLR_D += lr_d; sumLR_K += lr_k;
                                sumNR_D += nr_d; sumNR_K += nr_k;

                                // RENDER ROW
                                html += `
                            <tr class="hover:bg-yellow-50 transition">
                                <td class="p-2 border-r border-slate-100 font-bold text-slate-600 bg-white sticky left-0 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] truncate max-w-xs" title="${ak}">
                                    ${ak}
                                </td>
                                <td class="p-2 text-right border-r border-slate-100 bg-sky-50/20 text-sky-700">${ns_d ? fmt(ns_d) : '-'}</td>
                                <td class="p-2 text-right border-r border-slate-100 bg-sky-50/20 text-sky-700">${ns_k ? fmt(ns_k) : '-'}</td>
                                
                                <td class="p-2 text-right border-r border-slate-100 bg-amber-50/20 text-amber-700">${ajp_d ? fmt(ajp_d) : '-'}</td>
                                <td class="p-2 text-right border-r border-slate-100 bg-amber-50/20 text-amber-700">${ajp_k ? fmt(ajp_k) : '-'}</td>
                                
                                <td class="p-2 text-right border-r border-slate-100 bg-indigo-50/20 text-indigo-700 font-bold">${nsd_d ? fmt(nsd_d) : '-'}</td>
                                <td class="p-2 text-right border-r border-slate-100 bg-indigo-50/20 text-indigo-700 font-bold">${nsd_k ? fmt(nsd_k) : '-'}</td>
                                
                                <td class="p-2 text-right border-r border-slate-100 bg-emerald-50/20 text-emerald-700">${lr_d ? fmt(lr_d) : '-'}</td>
                                <td class="p-2 text-right border-r border-slate-100 bg-emerald-50/20 text-emerald-700">${lr_k ? fmt(lr_k) : '-'}</td>
                                
                                <td class="p-2 text-right border-r border-slate-100 bg-rose-50/20 text-rose-700">${nr_d ? fmt(nr_d) : '-'}</td>
                                <td class="p-2 text-right bg-rose-50/20 text-rose-700">${nr_k ? fmt(nr_k) : '-'}</td>
                            </tr>`;
                            });
                        }
                        console.log("DEBUG: Finished processing rows");

                        // HITUNG LABA / RUGI BERSIH
                        // Laba = Kredit (Pendapatan) - Debit (Beban) di kolom L/R
                        // Jika Laba: Tambah ke Debit L/R (penyeimbang), Tambah ke Kredit Neraca (Modal bertambah)
                        // Jika Rugi: Tambah ke Kredit L/R (penyeimbang), Tambah ke Debit Neraca (Modal berkurang)

                        const laba = sumLR_K - sumLR_D;
                        const isUntung = laba >= 0;
                        const absLaba = Math.abs(laba);

                        // Baris Total Balance
                        html += `
                            </tbody>
                            <tfoot class="bg-slate-50 font-bold text-[10px] sticky bottom-0 z-20 shadow-inner">
                                <tr class="border-t-2 border-slate-300">
                                    <td class="p-2 text-right uppercase tracking-widest sticky left-0 z-10 bg-slate-50">Total</td>
                                    
                                    <td class="p-2 text-right text-sky-800 bg-sky-100">${fmt(sumNS_D)}</td>
                                    <td class="p-2 text-right text-sky-800 bg-sky-100">${fmt(sumNS_K)}</td>
                                    
                                    <td class="p-2 text-right text-amber-800 bg-amber-100">${fmt(sumAJP_D)}</td>
                                    <td class="p-2 text-right text-amber-800 bg-amber-100">${fmt(sumAJP_K)}</td>
                                    
                                    <td class="p-2 text-right text-indigo-800 bg-indigo-100">${fmt(sumNSD_D)}</td>
                                    <td class="p-2 text-right text-indigo-800 bg-indigo-100">${fmt(sumNSD_K)}</td>
                                    
                                    <td class="p-2 text-right text-emerald-800 bg-emerald-100">${fmt(sumLR_D)}</td>
                                    <td class="p-2 text-right text-emerald-800 bg-emerald-100">${fmt(sumLR_K)}</td>
                                    
                                    <td class="p-2 text-right text-rose-800 bg-rose-100">${fmt(sumNR_D)}</td>
                                    <td class="p-2 text-right text-rose-800 bg-rose-100">${fmt(sumNR_K)}</td>
                                </tr>`;

                        // Baris Laba Bersih
                        // Jika Untung: Debit L/R, Kredit Neraca
                        let lr_bal_d = isUntung ? absLaba : 0;
                        let lr_bal_k = isUntung ? 0 : absLaba;
                        let nr_bal_d = isUntung ? 0 : absLaba;
                        let nr_bal_k = isUntung ? absLaba : 0;

                        html += `
                                <tr class="border-t border-slate-200 text-blue-700 bg-blue-50/50">
                                    <td class="p-2 text-right uppercase tracking-widest sticky left-0 z-10 bg-blue-50 font-black italic">
                                        ${isUntung ? 'Laba Bersih' : 'Rugi Bersih'}
                                    </td>
                                    <td colspan="6" class="bg-slate-50"></td> <!-- Spacer -->
                                    <td class="p-2 text-right font-black border border-blue-200">${lr_bal_d > 0 ? fmt(lr_bal_d) : ''}</td>
                                    <td class="p-2 text-right font-black border border-blue-200">${lr_bal_k > 0 ? fmt(lr_bal_k) : ''}</td>
                                    <td class="p-2 text-right font-black border border-blue-200">${nr_bal_d > 0 ? fmt(nr_bal_d) : ''}</td>
                                    <td class="p-2 text-right font-black border border-blue-200">${nr_bal_k > 0 ? fmt(nr_bal_k) : ''}</td>
                                </tr>`;

                        // Baris Grand Total (Balance Check)
                        html += `
                                <tr class="bg-slate-800 text-white border-t-2 border-slate-600">
                                    <td class="p-2 text-right uppercase tracking-widest sticky left-0 z-10 bg-slate-800">Grand Total</td>
                                    <td colspan="6" class="bg-slate-800"></td> <!-- Spacer -->
                                    <td class="p-2 text-right text-emerald-300 font-black">${fmt(sumLR_D + lr_bal_d)}</td>
                                    <td class="p-2 text-right text-emerald-300 font-black">${fmt(sumLR_K + lr_bal_k)}</td>
                                    <td class="p-2 text-right text-rose-300 font-black">${fmt(sumNR_D + nr_bal_d)}</td>
                                    <td class="p-2 text-right text-rose-300 font-black">${fmt(sumNR_K + nr_bal_k)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>`;
                    }
                }

                html += `</div>`;
                document.getElementById("kontenScreen").innerHTML = html;
                document.getElementById('quickSearch').value = '';
            } catch (e) {
                console.error("Render Error:", e);
                // alert("Terjadi kesalahan tampilan: " + e.message);
                document.getElementById("kontenScreen").innerHTML = `<div class="text-red-600 p-4 border border-red-200 bg-red-50 rounded">Render Error: ${e.message}</div>`;
            }
        }

        // --- HELPER RENDERING ---
        function renderBarRow(label, val, suffix, pct, barColor, textColor) {
            const searchStr = `${label} ${val}`.toLowerCase();
            return `
        <div class="relative py-3 border-b border-slate-50 hover:bg-slate-50 group report-item" data-search="${searchStr}">
            <!-- Background Bar -->
            <div class="absolute inset-y-0 left-0 ${barColor} opacity-30 transition-all duration-500 rounded-r-lg" style="width: ${pct}%"></div>
            
            <div class="relative flex justify-between items-center px-3">
                <span class="font-bold text-slate-700 text-sm z-10">${label}</span>
                <span class="font-mono font-bold ${textColor} text-sm z-10">${fmt(val)} ${suffix}</span>
            </div>
        </div>`;
        }

        function filterSaldosByType(saldos, type) {
            // STRICT CATEGORY FILTER using akunKategori map
            if (type === 'LABA_RUGI') {
                let inc = {}, exp = {}, incTotal = 0, expTotal = 0;
                for (let [ak, v] of Object.entries(saldos)) {
                    let cat = (akunKategori[ak] || '').toLowerCase();
                    // Categories for Income (Pendapatan)
                    const isIncome = cat.includes('pendapatan') || cat.includes('income') || cat.includes('penjualan') || cat.includes('revenue');
                    // Categories for Expense (Beban/HPP)
                    const isExpense = cat.includes('beban') || cat.includes('biaya') || cat.includes('hpp') || cat.includes('cost') || cat.includes('expense');

                    if (isIncome) {
                        let net = v.kredit - v.debit;
                        inc[ak] = net; incTotal += net;
                    } else if (isExpense) {
                        let net = v.debit - v.kredit;
                        exp[ak] = net; expTotal += net;
                    }
                }
                return { inc, exp, incTotal, expTotal };
            }

            if (type === 'NERACA') {
                let ast = {}, pas = {}, astTotal = 0, pasTotal = 0;
                for (let [ak, v] of Object.entries(saldos)) {
                    let cat = (akunKategori[ak] || '').toLowerCase();
                    // Categories for Assets
                    const isAsset = cat.includes('aset') || cat.includes('asset') || cat.includes('harta') || cat.includes('aktiva') || cat.includes('kas') || cat.includes('bank') || cat.includes('piutang') || cat.includes('persediaan');
                    // Categories for Liabilities
                    const isLiability = cat.includes('kewajiban') || cat.includes('hutang') || cat.includes('utang') || cat.includes('liability');
                    // Categories for Equity
                    const isEquity = cat.includes('modal') || cat.includes('ekuitas') || cat.includes('equity') || cat.includes('laba') || cat.includes('prive');

                    if (isAsset) {
                        let net = v.debit - v.kredit;
                        ast[ak] = net; astTotal += net;
                    } else if (isLiability || isEquity) {
                        let net = v.kredit - v.debit;
                        pas[ak] = net; pasTotal += net;
                    }
                }
                return { ast, pas, astTotal, pasTotal };
            }
        }

        function filterLaporan() {
            const q = document.getElementById('quickSearch').value.toLowerCase();

            // Filter Items
            document.querySelectorAll('.report-item').forEach(el => {
                const txt = el.getAttribute('data-search') || '';
                if (txt.includes(q)) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });

            // Filter Groups (Accordion) - Jika ada child visible, parent visible
            document.querySelectorAll('.report-group').forEach(grp => {
                // Cek keyword di group header juga
                const grpTxt = grp.getAttribute('data-search') || '';
                const headerMatch = grpTxt.includes(q);

                // Cek children visible
                const hasVisibleChild = grp.querySelectorAll('.report-item:not(.hidden)').length > 0;

                if (headerMatch || hasVisibleChild) {
                    grp.classList.remove('hidden');
                    if (q.length > 0) grp.open = true; // Auto open if searching
                } else {
                    grp.classList.add('hidden');
                }
            });
        }

        function hitungSaldo() {
            const s = {};
            rawData.forEach(r => {
                if (!s[r.nama_akun]) s[r.nama_akun] = { debit: 0, kredit: 0 };
                s[r.nama_akun].debit += r.debit; s[r.nama_akun].kredit += r.kredit;
            });
            return s;
        }

        // ==========================================
        // 2. GENERATE PDF (PROFESIONAL) - LENGKAP
        // ==========================================
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
            const tglCetak = new Date().toLocaleDateString('id-ID');
            const periode = document.getElementById("subJudul").innerText;

            // KOP SURAT
            doc.setFontSize(16); doc.setFont("helvetica", "bold");
            doc.text("PT. NUSANTARA LAND DEVELOPMENT", 14, 15);
            doc.setFontSize(10); doc.setFont("helvetica", "normal");

            // --- GANTI ALAMAT DI BAWAH INI ---
            doc.text("Jl. Sunset Boulevard Blok 5B/16 CitraLand City, Centre Point of Indonesia (CPI) Kel. Maccini Sombala Kec. Tamalate, Makassar, 90224, Indonesia Phone: +624116004251", 14, 20);
            // ---------------------------------

            doc.text("Laporan Keuangan & Operasional Terintegrasi", 14, 25);
            doc.setLineWidth(0.5); doc.line(14, 28, 283, 28);

            // JUDUL
            doc.setFontSize(12); doc.setFont("helvetica", "bold");
            doc.text(document.getElementById("judulLap").innerText, 14, 35);
            doc.setFontSize(10); doc.setFont("helvetica", "italic");
            doc.text("Periode: " + periode, 14, 40);

            let body = [];
            let head = [];
            let colStyles = {};
            let finalY = 45;

            // LOGIKA PDF PER TIPE
            if (currentType === 'JURNAL') {
                head = [['Tanggal', 'No. Akun', 'Uraian', 'Ref', 'Debit', 'Kredit']];
                let tD = 0, tK = 0;
                rawData.forEach(r => {
                    tD += r.debit; tK += r.kredit;
                    const namaAkun = r.kredit > 0 ? `      ${r.nama_akun}` : r.nama_akun;
                    body.push([new Date(r.tanggal).toLocaleDateString('id-ID'), akunMap[r.nama_akun] || '', `${namaAkun}\n${r.keterangan || ''}`, r.nomor_referensi || '', r.debit > 0 ? fmtNum(r.debit) : '-', r.kredit > 0 ? fmtNum(r.kredit) : '-']);
                });
                body.push([{ content: 'TOTAL', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold' } }, fmtNum(tD), fmtNum(tK)]);
                colStyles = { 4: { halign: 'right' }, 5: { halign: 'right' } };
                printTable(doc, head, body, colStyles, finalY);

            } else if (currentType === 'BUKU_BESAR') {
                const groups = {};
                rawData.forEach(r => { if (!groups[r.nama_akun]) groups[r.nama_akun] = []; groups[r.nama_akun].push(r); });

                Object.keys(groups).sort().forEach(akun => {
                    // Cetak Judul Akun dulu
                    if (finalY > 180) { doc.addPage(); finalY = 20; }
                    doc.setFont("helvetica", "bold"); doc.setFontSize(10);
                    doc.text(`Akun: ${akun} [${akunMap[akun] || ''}]`, 14, finalY);
                    finalY += 2;

                    const kategori = akunKategori[akun] || '';
                    const isCreditNormal = ['Kewajiban', 'Ekuitas', 'Pendapatan', 'Hutang', 'Modal', 'Penjualan'].some(k => kategori.includes(k));

                    let subBody = [];
                    let rawSaldo = saldoAwalMap[akun] || 0;
                    let displaySaldo = isCreditNormal ? -rawSaldo : rawSaldo;

                    // Always show opening balance
                    subBody.push(['-', 'Saldo Awal', '-', '-', fmtNum(displaySaldo)]);

                    groups[akun].forEach(r => {
                        rawSaldo += (r.debit - r.kredit);
                        displaySaldo = isCreditNormal ? -rawSaldo : rawSaldo; // Recalculate display
                        subBody.push([new Date(r.tanggal).toLocaleDateString('id-ID'), r.keterangan, r.debit > 0 ? fmtNum(r.debit) : '-', r.kredit > 0 ? fmtNum(r.kredit) : '-', fmtNum(displaySaldo)]);
                    });

                    doc.autoTable({
                        startY: finalY + 1,
                        head: [['Tgl', 'Ket', 'Debit', 'Kredit', 'Saldo']],
                        body: subBody,
                        theme: 'grid',
                        columnStyles: { 2: { halign: 'right' }, 3: { halign: 'right' }, 4: { halign: 'right', fontStyle: 'bold' } },
                        margin: { left: 14, right: 14 }
                    });
                    finalY = doc.lastAutoTable.finalY + 10;
                });

            } else if (currentType === 'NERACA_SALDO') {
                head = [['No. Akun', 'Nama Akun', 'Debit', 'Kredit']];
                const saldos = hitungSaldo();
                let tD = 0, tK = 0;
                Object.keys(saldos).sort().forEach(akun => {
                    const net = saldos[akun].debit - saldos[akun].kredit;
                    if (net === 0) return;
                    const isD = net > 0; const nom = Math.abs(net);
                    if (isD) tD += nom; else tK += nom;
                    body.push([akunMap[akun] || '', akun, isD ? fmtNum(nom) : '-', !isD ? fmtNum(nom) : '-']);
                });
                body.push([{ content: 'TOTAL', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } }, fmtNum(tD), fmtNum(tK)]);
                colStyles = { 2: { halign: 'right' }, 3: { halign: 'right' } };
                printTable(doc, head, body, colStyles, finalY);

            } else if (currentType === 'LABA_RUGI') {
                const saldos = hitungSaldo();
                const { inc, exp, incTotal, expTotal } = filterSaldosByType(saldos, currentType);
                const labaBersih = incTotal - expTotal;

                // 1. PENDAPATAN
                body.push([{ content: 'PENDAPATAN', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [240, 253, 244] } }]);
                if (Object.keys(inc).length === 0) {
                    body.push(['Belum ada data pendapatan', '-']);
                } else {
                    Object.entries(inc).forEach(([ak, val]) => {
                        body.push([ak, fmtNum(val)]);
                    });
                }
                body.push([{ content: 'Total Pendapatan', styles: { fontStyle: 'bold' } }, { content: fmtNum(incTotal), styles: { fontStyle: 'bold', halign: 'right' } }]);

                // 2. BEBAN
                body.push([{ content: 'BEBAN OPERASIONAL', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [254, 242, 242] } }]);
                if (Object.keys(exp).length === 0) {
                    body.push(['Belum ada data beban', '-']);
                } else {
                    Object.entries(exp).forEach(([ak, val]) => {
                        body.push([ak, `(${fmtNum(val)})`]);
                    });
                }
                body.push([{ content: 'Total Beban', styles: { fontStyle: 'bold' } }, { content: `(${fmtNum(expTotal)})`, styles: { fontStyle: 'bold', halign: 'right' } }]);

                // NET
                body.push([{ content: 'LABA / RUGI BERSIH', styles: { fontStyle: 'bold', fillColor: [238, 242, 255] } }, { content: fmtNum(labaBersih), styles: { fontStyle: 'bold', halign: 'right', fillColor: [238, 242, 255] } }]);

                printTable(doc, [['Keterangan', 'Nominal']], body, { 1: { halign: 'right' } }, finalY);

            } else if (currentType === 'NERACA') {
                const saldos = hitungSaldo();
                const { ast, pas, astTotal, pasTotal } = filterSaldosByType(saldos, currentType);

                // 1. ASET
                body.push([{ content: 'ASET (AKTIVA)', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [239, 246, 255] } }]);
                Object.entries(ast).forEach(([ak, val]) => {
                    if (Math.abs(val) > 0) body.push([ak, fmtNum(val)]);
                });
                body.push([{ content: 'TOTAL ASET', styles: { fontStyle: 'bold' } }, { content: fmtNum(astTotal), styles: { fontStyle: 'bold', halign: 'right' } }]);

                // 2. PASIVA
                body.push([{ content: 'LIABILITAS & EKUITAS (PASIVA)', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [238, 242, 255] } }]);
                Object.entries(pas).forEach(([ak, val]) => {
                    if (Math.abs(val) > 0) body.push([ak, fmtNum(val)]);
                });
                body.push([{ content: 'TOTAL PASIVA', styles: { fontStyle: 'bold' } }, { content: fmtNum(pasTotal), styles: { fontStyle: 'bold', halign: 'right' } }]);

                // CHECK
                const balanceMsg = Math.abs(astTotal - pasTotal) < 1 ? 'BALANCE' : `TIDAK BALANCE (${fmtNum(astTotal - pasTotal)})`;
                body.push([{ content: 'STATUS NERACA', styles: { fontStyle: 'bold' } }, { content: balanceMsg, styles: { fontStyle: 'bold', halign: 'right', textColor: Math.abs(astTotal - pasTotal) < 1 ? [22, 163, 74] : [220, 38, 38] } }]);

                printTable(doc, [['Keterangan', 'Nominal']], body, { 1: { halign: 'right' } }, finalY);

            } else if (currentType === 'NERACA_LAJUR') {
                const saldos = hitungSaldo();
                let sumNS_D = 0, sumNS_K = 0;
                let sumAJP_D = 0, sumAJP_K = 0;
                let sumNSD_D = 0, sumNSD_K = 0;
                let sumLR_D = 0, sumLR_K = 0;
                let sumNR_D = 0, sumNR_K = 0;

                const sortedAkun = Object.keys(saldos).sort();

                sortedAkun.forEach(ak => {
                    const v = saldos[ak];
                    const net = v.debit - v.kredit;
                    if (Math.abs(net) < 1) return;

                    const ns_d = net > 0 ? net : 0;
                    const ns_k = net < 0 ? Math.abs(net) : 0;
                    sumNS_D += ns_d; sumNS_K += ns_k;

                    const ajp_d = 0; const ajp_k = 0;
                    sumAJP_D += ajp_d; sumAJP_K += ajp_k;

                    const net_adj = (ns_d - ns_k) + (ajp_d - ajp_k);
                    const nsd_d = net_adj > 0 ? net_adj : 0;
                    const nsd_k = net_adj < 0 ? Math.abs(net_adj) : 0;
                    sumNSD_D += nsd_d; sumNSD_K += nsd_k;

                    let cat = (akunKategori[ak] || '').toLowerCase();
                    const isLR = cat.includes('pendapatan') || cat.includes('revenue') || cat.includes('penjualan') ||
                        cat.includes('beban') || cat.includes('biaya') || cat.includes('hpp') || cat.includes('cost') || cat.includes('expense');

                    let lr_d = 0, lr_k = 0, nr_d = 0, nr_k = 0;
                    if (isLR) { lr_d = nsd_d; lr_k = nsd_k; } else { nr_d = nsd_d; nr_k = nsd_k; }
                    sumLR_D += lr_d; sumLR_K += lr_k;
                    sumNR_D += nr_d; sumNR_K += nr_k;

                    body.push([
                        ak,
                        ns_d ? fmtNum(ns_d) : '-', ns_k ? fmtNum(ns_k) : '-',
                        ajp_d ? fmtNum(ajp_d) : '-', ajp_k ? fmtNum(ajp_k) : '-',
                        nsd_d ? fmtNum(nsd_d) : '-', nsd_k ? fmtNum(nsd_k) : '-',
                        lr_d ? fmtNum(lr_d) : '-', lr_k ? fmtNum(lr_k) : '-',
                        nr_d ? fmtNum(nr_d) : '-', nr_k ? fmtNum(nr_k) : '-'
                    ]);
                });

                // Total Row
                body.push([
                    { content: 'TOTAL', styles: { fontStyle: 'bold' } },
                    { content: fmtNum(sumNS_D), styles: { fontStyle: 'bold', halign: 'right' } }, { content: fmtNum(sumNS_K), styles: { fontStyle: 'bold', halign: 'right' } },
                    { content: fmtNum(sumAJP_D), styles: { fontStyle: 'bold', halign: 'right' } }, { content: fmtNum(sumAJP_K), styles: { fontStyle: 'bold', halign: 'right' } },
                    { content: fmtNum(sumNSD_D), styles: { fontStyle: 'bold', halign: 'right' } }, { content: fmtNum(sumNSD_K), styles: { fontStyle: 'bold', halign: 'right' } },
                    { content: fmtNum(sumLR_D), styles: { fontStyle: 'bold', halign: 'right' } }, { content: fmtNum(sumLR_K), styles: { fontStyle: 'bold', halign: 'right' } },
                    { content: fmtNum(sumNR_D), styles: { fontStyle: 'bold', halign: 'right' } }, { content: fmtNum(sumNR_K), styles: { fontStyle: 'bold', halign: 'right' } },
                ]);

                // Laba / Rugi Row
                const laba = sumLR_K - sumLR_D;
                const isUntung = laba >= 0;
                const absLaba = Math.abs(laba);

                let lr_bal_d = isUntung ? absLaba : 0;
                let lr_bal_k = isUntung ? 0 : absLaba;
                let nr_bal_d = isUntung ? 0 : absLaba;
                let nr_bal_k = isUntung ? absLaba : 0;

                body.push([
                    { content: isUntung ? 'LABA BERSIH' : 'RUGI BERSIH', styles: { fontStyle: 'bold', textColor: [0, 0, 255] } },
                    { content: '', colSpan: 6 },
                    { content: lr_bal_d ? fmtNum(lr_bal_d) : '', styles: { fontStyle: 'bold', halign: 'right' } },
                    { content: lr_bal_k ? fmtNum(lr_bal_k) : '', styles: { fontStyle: 'bold', halign: 'right' } },
                    { content: nr_bal_d ? fmtNum(nr_bal_d) : '', styles: { fontStyle: 'bold', halign: 'right' } },
                    { content: nr_bal_k ? fmtNum(nr_bal_k) : '', styles: { fontStyle: 'bold', halign: 'right' } }
                ]);

                // HEADERS
                doc.autoTable({
                    startY: finalY,
                    head: [
                        [
                            { content: 'Nama Akun', rowSpan: 2, styles: { valign: 'middle', halign: 'center' } },
                            { content: 'Neraca Saldo', colSpan: 2, styles: { halign: 'center', fillColor: [50, 50, 50] } },
                            { content: 'Penyesuaian', colSpan: 2, styles: { halign: 'center', fillColor: [50, 50, 50] } },
                            { content: 'NS Disesuaikan', colSpan: 2, styles: { halign: 'center', fillColor: [50, 50, 50] } },
                            { content: 'Laba Rugi', colSpan: 2, styles: { halign: 'center', fillColor: [50, 50, 50] } },
                            { content: 'Neraca', colSpan: 2, styles: { halign: 'center', fillColor: [50, 50, 50] } }
                        ],
                        ['Debit', 'Kredit', 'Debit', 'Kredit', 'Debit', 'Kredit', 'Debit', 'Kredit', 'Debit', 'Kredit']
                    ],
                    body: body,
                    theme: 'grid',
                    styles: { fontSize: 6, cellPadding: 1, minCellHeight: 4, valign: 'middle' },
                    columnStyles: {
                        0: { cellWidth: 40 }, // Nama Akun
                    },
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold', lineWidth: 0.1 },
                    margin: { left: 5, right: 5 }
                });

            } else {
                // Fallback for Analisis/Arus Kas (Not implemented yet to keep it simple)
                doc.setFontSize(10);
                doc.text("Silakan lihat detail di layar aplikasi atau hubungi admin untuk format lengkap Laporan ini.", 14, 50);
            }

            // TTD
            finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 60;
            if (finalY > 170) { doc.addPage(); finalY = 20; }
            const xPos = 220;
            doc.setFont("helvetica", "normal");
            doc.text(`Makassar, ${tglCetak}`, xPos, finalY);
            doc.text("Disiapkan Oleh,", xPos, finalY + 5);
            doc.setFont("helvetica", "bold");
            doc.text("Finance Manager", xPos, finalY + 25);
            doc.setLineWidth(0.2); doc.line(xPos, finalY + 26, xPos + 40, finalY + 26);

            doc.save(`Laporan_${currentType}_NLD.pdf`);
        }

        function printTable(doc, head, body, colStyles, startY) {
            doc.autoTable({
                startY: startY,
                head: head, body: body, theme: 'grid',
                headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                columnStyles: colStyles,
                styles: { fontSize: 9, cellPadding: 2 }
            });
        }

        function hitungSaldo() {
            const s = {};
            if (!Array.isArray(rawData)) return s;
            rawData.forEach(r => {
                if (!s[r.nama_akun]) s[r.nama_akun] = { debit: 0, kredit: 0 };
                s[r.nama_akun].debit += r.debit; s[r.nama_akun].kredit += r.kredit;
            });
            return s;
        }

        // ==========================================
        // ==========================================
        // 4. SECURE JOURNAL EDITOR (NEW)
        // ==========================================
        let masterAkunCache = [];

        async function loadMasterAkun() {
            if (masterAkunCache.length > 0) return; // Use cache

            const { data, error } = await client.from('master_akun').select('nama_akun, kode_akun').order('kode_akun');
            if (error) {
                console.error("Gagal load master akun:", error.message);
                return;
            }
            masterAkunCache = data || [];

            // Populate Dropdown
            const sel = document.getElementById('edit_jurnal_akun');
            sel.innerHTML = '<option value="">-- Pilih Akun Valid --</option>';
            masterAkunCache.forEach(akun => {
                sel.innerHTML += `<option value="${akun.nama_akun}">${akun.kode_akun} - ${akun.nama_akun}</option>`;
            });
        }

        function openEditJurnal(id) {
            // Find Data
            const row = rawData.find(r => r.id === id);
            if (!row) return;

            // Load Master if empty
            loadMasterAkun();

            // Populate Form
            document.getElementById('edit_jurnal_id').value = row.id;
            document.getElementById('edit_jurnal_akun').value = row.nama_akun; // Must match exactly with option value
            document.getElementById('edit_jurnal_desc').value = row.keterangan;
            document.getElementById('edit_jurnal_debit').value = row.debit;
            document.getElementById('edit_jurnal_kredit').value = row.kredit;
            document.getElementById('edit_jurnal_reason').value = ''; // Reset reason

            document.getElementById('editJurnalModal').classList.remove('hidden');
        }

        function closeEditJurnal() {
            document.getElementById('editJurnalModal').classList.add('hidden');
        }

        document.getElementById('formEditJurnal').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Collect Data
            const id = document.getElementById('edit_jurnal_id').value;
            const akun = document.getElementById('edit_jurnal_akun').value;
            const desc = document.getElementById('edit_jurnal_desc').value;
            const debit = parseFloat(document.getElementById('edit_jurnal_debit').value) || 0;
            const kredit = parseFloat(document.getElementById('edit_jurnal_kredit').value) || 0;
            const reason = document.getElementById('edit_jurnal_reason').value;

            // Basic Validation
            if (!akun) { alert("Wajib memilih akun yang valid!"); return; }
            if (debit < 0 || kredit < 0) { alert("Nominal tidak boleh negatif!"); return; }
            if (debit === 0 && kredit === 0) { alert("Nominal Debit atau Kredit harus diisi!"); return; }
            if (!reason || reason.length < 5) { alert("Alasan perubahan wajib diisi dengan jelas!"); return; }

            // Get Current User
            const session = window.PNAuth?.getSession();
            const userName = session?.user?.full_name || 'Unknown User';

            if (!confirm(" Konfirmasi Perubahan Aman\n\nPerubahan ini akan dicatat dalam Audit Log.\nApakah Anda yakin ingin menyimpan?")) return;

            // Show Loading
            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Proses...`;
            btn.disabled = true;

            try {
                // CALL RPC
                const { data, error } = await client.rpc('update_jurnal_line', {
                    p_id: id,
                    p_akun: akun,
                    p_desc: desc,
                    p_debit: debit,
                    p_kredit: kredit,
                    p_reason: reason,
                    p_user_name: userName
                });

                if (error) throw error;

                if (data && data.success) {
                    alert(" SUKSES!\n" + data.message);
                    closeEditJurnal();
                    loadData(); // Refresh Table
                } else {
                    alert(" GAGAL: " + (data?.message || "Unknown error"));
                }

            } catch (err) {
                console.error(err);
                alert("Terjadi kesalahan sistem: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // ==========================================
        async function loadSetupSaldo() {
            switchView('setup-saldo');
            const tbody = document.getElementById("tbodySaldoAwal");
            tbody.innerHTML = `<tr><td colspan="4" class="p-10 text-center"><i class="fas fa-circle-notch fa-spin text-blue-500"></i> Memuat Akun...</td></tr>`;

            // Default info
            const today = new Date();
            document.getElementById("tglCutOff").valueAsDate = new Date(today.getFullYear(), 0, 1); // 1 Jan This Year default

            const { data, error } = await client.from('master_akun').select('*').order('kode_akun');
            if (error) {
                alert("Gagal memuat akun: " + error.message);
                return;
            }

            tbody.innerHTML = "";
            if (data) {
                data.forEach(akun => {
                    tbody.innerHTML += `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 font-mono font-bold text-xs text-slate-500">${akun.kode_akun || '-'}</td>
                    <td class="p-3 font-bold text-slate-700 text-xs">${akun.nama_akun}</td>
                    <td class="p-2">
                        <input type="number" class="inp-debit w-full border border-blue-200 rounded px-2 py-1.5 text-right font-mono text-sm focus:ring-1 focus:ring-blue-500 outline-none" 
                            placeholder="0" oninput="hitungBalanceLive()" data-akun="${akun.nama_akun}">
                    </td>
                    <td class="p-2">
                        <input type="number" class="inp-kredit w-full border border-red-200 rounded px-2 py-1.5 text-right font-mono text-sm focus:ring-1 focus:ring-red-500 outline-none" 
                            placeholder="0" oninput="hitungBalanceLive()" data-akun="${akun.nama_akun}">
                    </td>
                </tr>`;
                });
            }
            hitungBalanceLive();
        }

        function hitungBalanceLive() {
            let tD = 0, tK = 0;
            let count = 0;
            document.querySelectorAll('.inp-debit').forEach(inp => {
                const val = parseFloat(inp.value) || 0;
                tD += val;
                if (val > 0) count++;
            });
            document.querySelectorAll('.inp-kredit').forEach(inp => {
                const val = parseFloat(inp.value) || 0;
                tK += val;
                if (val > 0) count++;
            });

            document.getElementById("totalDebitSaldo").innerText = fmt(tD);
            document.getElementById("totalKreditSaldo").innerText = fmt(tK);
            document.getElementById("countInputSaldo").innerText = count / 2; // Rough estimate, or just count

            const stat = document.getElementById("balanceStatus");
            const btn = document.getElementById("btnSimpanSaldo");

            if (tD === tK && tD > 0) {
                stat.innerHTML = `<i class="fas fa-check-circle"></i> <span>BALANCE</span>`;
                stat.className = "flex items-center gap-1 text-green-600 font-bold bg-green-100 px-3 py-1 rounded-full";
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else if (tD === 0 && tK === 0) {
                stat.innerHTML = `<span>Siap Input</span>`;
                stat.className = "text-slate-400 italic text-xs";
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                const diff = Math.abs(tD - tK);
                stat.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>Tidak Balance (Selisih: ${fmt(diff)})</span>`;
                stat.className = "flex items-center gap-1 text-red-600 font-bold bg-red-100 px-3 py-1 rounded-full text-xs";
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        async function simpanSaldoAwal() {
            const btn = document.getElementById("btnSimpanSaldo");

            // KONFIRMASI STANDAR AKUNTANSI
            if (!confirm(" KONFIRMASI POSTING JURNAL\n\nAnda akan memposting Saldo Awal ke Buku Besar / Jurnal Umum.\n\nPastikan:\n1. Tanggal Cut-Off sudah benar.\n2. Total Debit & Kredit sudah BALANCE.\n\nLanjutkan Posting?")) return;

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memposting...`;

            try {
                const tgl = document.getElementById("tglCutOff").value;
                if (!tgl) throw new Error("Pilih tanggal Cut-Off terlebih dahulu!");

                // Kumpulkan Data
                const rows = [];
                const debits = document.querySelectorAll('.inp-debit');
                const kredits = document.querySelectorAll('.inp-kredit');

                for (let i = 0; i < debits.length; i++) {
                    const d = parseFloat(debits[i].value) || 0;
                    const k = parseFloat(kredits[i].value) || 0;
                    const akun = debits[i].getAttribute('data-akun');

                    if (d > 0 || k > 0) {
                        rows.push({
                            tanggal: tgl,
                            nama_akun: akun,
                            keterangan: `Saldo Awal (Cut-Off: ${tgl})`,
                            debit: d,
                            kredit: k,
                            nomor_referensi: 'OPENING_BALANCE' // Ubah jadi istilah standar
                        });
                    }
                }

                if (rows.length === 0) throw new Error("Belum ada saldo yang diinput.");

                // OPSIONAL: Hapus saldo awal lama di tanggal yang sama? 
                // Untuk keamanan, kita append saja dulu, biarkan user hapus manual jika duplikat
                // Atau hapus by nomor_referensi

                const { error } = await client.from('jurnal_umum').insert(rows);

                if (error) throw error;

                alert(" POSTING SUKSES!\n\nSaldo Awal telah tercatat di Jurnal Umum & Buku Besar.");
                // Clear inputs?
                debits.forEach(i => i.value = '');
                kredits.forEach(i => i.value = '');
                hitungBalanceLive();
                switchView('menu');

            } catch (err) {
                alert(" Gagal: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>

    <!-- SECURE DELETE JOURNAL MODAL -->
    <div id="deleteJurnalModal"
        class="fixed inset-0 bg-red-900/30 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-lg md:max-w-xl overflow-hidden transform transition-all scale-100 border border-red-200">

            <!-- Header -->
            <div class="bg-red-600 p-4 flex justify-between items-center text-white">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-full">
                        <i class="fas fa-exclamation-triangle text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg leading-tight">Hapus Transaksi</h3>
                        <p class="text-xs text-red-100 opacity-90">Penghapusan Grup Transaksi (Balance)</p>
                    </div>
                </div>
                <button onclick="closeDeleteModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition text-white/80 hover:text-white">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <div class="p-6 space-y-5">
                <input type="hidden" id="del_jurnal_ref">

                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                    <p class="text-red-800 font-bold text-sm mb-1"> Perhatian!</p>
                    <p class="text-xs text-red-600 leading-relaxed">
                        Anda akan menghapus sebuah <strong>Grup Transaksi</strong>. Sistem akan menghapus semua baris
                        jurnal yang memiliki Kode Referensi yang sama untuk menjaga Balance laporan keuangan.
                    </p>
                </div>

                <!-- List of Items to be Deleted -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Item yang akan
                        dihapus:</label>
                    <div
                        class="bg-slate-50 border border-slate-200 rounded-lg overflow-hidden max-h-40 overflow-y-auto custom-scrollbar">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-100 text-slate-500 font-bold border-b border-slate-200 sticky top-0">
                                <tr>
                                    <th class="p-2 w-1/2">Akun</th>
                                    <th class="p-2 text-right">Debit</th>
                                    <th class="p-2 text-right">Kredit</th>
                                </tr>
                            </thead>
                            <tbody id="listDeleteItems" class="divide-y divide-slate-100 font-mono text-slate-600">
                                <!-- Populated by JS -->
                            </tbody>
                            <tfoot class="bg-slate-100 border-t border-slate-200 font-bold">
                                <tr>
                                    <td class="p-2 text-center text-slate-500">TOTAL</td>
                                    <td class="p-2 text-right text-slate-700" id="totalDelDebit">0</td>
                                    <td class="p-2 text-right text-slate-700" id="totalDelKredit">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Reason -->
                <div>
                    <label
                        class="block text-xs font-bold text-red-600 mb-1.5 uppercase tracking-wider flex items-center justify-between">
                        <span>Alasan Penghapusan (Wajib)</span>
                    </label>
                    <input type="text" id="del_jurnal_reason"
                        class="w-full border border-red-200 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-red-500 bg-red-50/50 focus:bg-white placeholder-red-300 transition shadow-sm text-red-700"
                        placeholder="Contoh: Duplikasi, Batal Transaksi..." required>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeDeleteModal()"
                        class="px-5 py-2.5 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold transition">Batal</button>
                    <button type="button" onclick="executeDelete()"
                        class="px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-bold shadow-lg shadow-red-200 transition active:scale-95 flex items-center gap-2">
                        <i class="fas fa-trash-alt"></i>
                        <span>Hapus Permanen</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 5. DELETE GROUP LOGIC
        // ==========================================
        async function confirmDelete(id, ref) {
            // 1. Fetch Related Rows by REF
            const { data, error } = await client.from('jurnal_umum').select('*').eq('nomor_referensi', ref);

            if (error || !data || data.length === 0) {
                alert("Gagal load data grup: " + (error?.message || 'Data kosong'));
                return;
            }

            // 2. Populate Modal
            const tbody = document.getElementById('listDeleteItems');
            tbody.innerHTML = '';
            let tD = 0, tK = 0;

            data.forEach(r => {
                tD += r.debit;
                tK += r.kredit;
                tbody.innerHTML += `
                <tr class="hover:bg-red-50/50">
                    <td class="p-2 truncate max-w-[150px]" title="${r.nama_akun}">${r.nama_akun}</td>
                    <td class="p-2 text-right">${r.debit > 0 ? fmtNum(r.debit) : '-'}</td>
                    <td class="p-2 text-right">${r.kredit > 0 ? fmtNum(r.kredit) : '-'}</td>
                </tr>`;
            });

            document.getElementById('totalDelDebit').innerText = fmtNum(tD);
            document.getElementById('totalDelKredit').innerText = fmtNum(tK);
            document.getElementById('del_jurnal_ref').value = ref;
            document.getElementById('del_jurnal_reason').value = '';

            document.getElementById('deleteJurnalModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteJurnalModal').classList.add('hidden');
        }

        async function executeDelete() {
            const ref = document.getElementById('del_jurnal_ref').value;
            const reason = document.getElementById('del_jurnal_reason').value;

            if (!reason || reason.length < 5) {
                alert("Mohon isi alasan penghapusan dengan jelas (min. 5 karakter)!");
                return;
            }

            if (!confirm(` PERINGATAN TERAKHIR!\n\nAnda akan menghapus seluruh grup transaksi "${ref}".\nTindakan ini tidak dapat dibatalkan.\n\nLanjutkan menghapus?`)) return;

            // Show Loading (Optional UI feedback could be improved here)
            const btn = document.querySelector('#deleteJurnalModal button[onclick="executeDelete()"]');
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Menghapus...`;
            btn.disabled = true;

            try {
                // TODO: Idealnya catat ke 'deleted_jurnal_log' dulu (Audit Trail)
                // Di sini kita langsung hapus by ref

                // Opsional: Insert to Audit Log (Client side insert for simplicity, better via RPC)
                const auditPayload = {
                    action: 'DELETE_GROUP',
                    ref_code: ref,
                    reason: reason,
                    user: window.PNAuth?.getSession()?.user?.full_name || 'System',
                    timestamp: new Date().toISOString()
                };
                // await client.from('audit_log').insert(auditPayload); // If table exists

                // SINKRONISASI HAPUS MASTER AKTIVA
                // Jika referensi diawali 'AST-', berarti ini jurnal perolehan aset. Hapus juga asetnya.
                if (ref.startsWith('AST-')) {
                    const parts = ref.split('-');
                    if (parts.length >= 2) {
                        const assetId = parts[1];
                        // Delete Master Aktiva (Silent attempt)
                        const { error: errAst } = await client.from('master_aktiva').delete().eq('id', assetId);
                        if (errAst) console.warn("Sinkronisasi hapus aset gagal:", errAst);
                        else console.log("Sinkronisasi hapus aset sukses:", assetId);
                    }
                }

                const { error } = await client.from('jurnal_umum').delete().eq('nomor_referensi', ref);

                if (error) throw error;

                alert(" PENGHAPUSAN SUKSES!\nData transaksi telah dihapus.");
                closeDeleteModal();
                loadData(); // Refresh Grid

            } catch (err) {
                alert(" GAGAL HAPUS: " + err.message);
            } finally {
                btn.innerHTML = `<i class="fas fa-trash-alt"></i> <span>Hapus Permanen</span>`;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>