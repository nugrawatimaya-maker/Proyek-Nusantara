<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penyusunan RAB - CV. Sunrise Kontraktor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="supabase.js"></script>
    <script src="app_config.js"></script>
    <script src="auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #e2e8f0;
        }

        .input-cell {
            background: transparent;
            width: 100%;
            height: 100%;
            outline: none;
            padding: 4px 8px;
        }

        .input-cell:focus {
            background: #f0f9ff;
        }
    </style>
</head>

<body class="text-slate-800">
    <header class="glass-header fixed top-0 w-full z-50 px-6 py-3 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <a href="cv_sunrise.html"
                class="flex items-center justify-center w-10 h-10 bg-slate-100 hover:bg-slate-200 rounded-xl text-slate-500 transition">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <p class="text-[10px] uppercase font-bold text-emerald-600 tracking-wider">Modul Estimator</p>
                <h1 class="text-lg font-black text-slate-800 leading-tight">Penyusunan RAB</h1>
            </div>
        </div>
        <div>
            <button onclick="downloadPDF()"
                class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-700 shadow-sm transition flex items-center gap-2">
                <i class="fas fa-print"></i> Cetak PDF
            </button>
        </div>
    </header>

    <main class="pt-24 pb-12 px-4 md:px-8 max-w-6xl mx-auto">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nama Proyek</label>
                    <input type="text" id="inpNamaProyek" value="Renovasi Dapur"
                        class="w-full font-bold text-lg text-slate-800 border-b border-dashed border-slate-300 focus:border-emerald-500 outline-none pb-1">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Klien / Pemilik</label>
                    <input type="text" id="inpKlien" value="Didin"
                        class="w-full font-bold text-lg text-slate-800 border-b border-dashed border-slate-300 focus:border-emerald-500 outline-none pb-1">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Lokasi</label>
                    <input type="text" id="inpLokasi" value="Perumahan Sunrise City Maros"
                        class="w-full font-bold text-lg text-slate-800 border-b border-dashed border-slate-300 focus:border-emerald-500 outline-none pb-1">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left" id="rabTable">
                    <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3 text-center w-12">No</th>
                            <th class="px-4 py-3">Uraian Pekerjaan</th>
                            <th class="px-4 py-3 text-center w-24">Vol</th>
                            <th class="px-4 py-3 text-center w-20">Sat</th>
                            <th class="px-4 py-3 text-right w-40">Harga Satuan</th>
                            <th class="px-4 py-3 text-right w-40">Jumlah Harga</th>
                            <th class="px-4 py-3 text-center w-16">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="rabTableBody"></tbody>
                    <tfoot class="bg-slate-50 font-bold text-slate-700">
                        <tr>
                            <td colspan="5" class="px-4 py-3 text-right">TOTAL BIAYA KONSTRUKSI</td>
                            <td class="px-4 py-3 text-right text-emerald-700" id="grandTotal">Rp 0</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="5" class="px-4 py-1 text-right text-xs text-slate-500">JASA KONTRAKTOR (10%)
                            </td>
                            <td class="px-4 py-1 text-right text-xs text-slate-500" id="feeTotal">Rp 0</td>
                            <td></td>
                        </tr>
                        <tr class="bg-emerald-100 text-emerald-900 border-t-2 border-emerald-500">
                            <td colspan="5" class="px-4 py-3 text-right">GRAND TOTAL</td>
                            <td class="px-4 py-3 text-right" id="finalTotal">Rp 0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex gap-2">
                <button id="btnAddRow"
                    class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-100 transition shadow-sm">
                    <i class="fas fa-plus mr-1"></i> Tambah Baris
                </button>
                <button id="btnAddCategory"
                    class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-100 transition shadow-sm">
                    <i class="fas fa-layer-group mr-1"></i> Tambah Kategori
                </button>
                <div class="flex-grow"></div>
                <button id="btnSave"
                    class="px-6 py-2 bg-emerald-600 text-white rounded-lg text-sm font-bold hover:bg-emerald-700 transition shadow-sm">
                    <i class="fas fa-save mr-1"></i> Simpan RAB
                </button>
            </div>
        </div>
    </main>

    <script>
        console.log("RAB Script Parsing...");

        // --- STATE ---
        let currentRabId = null;
        let rabDetails = [];
        let isSaving = false;

        // Formatter
        const formatCurrency = (n) => new Intl.NumberFormat('id-ID').format(n);

        // Make functions global
        window.addRow = addRow;
        window.addCategory = addCategory;
        window.deleteRow = deleteRow;
        window.updateItem = updateItem;
        window.saveRAB = saveRAB;
        window.downloadPDF = downloadPDF;

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded");

            const btnAddRow = document.getElementById('btnAddRow');
            if (btnAddRow) btnAddRow.addEventListener('click', addRow);
            else console.error("btnAddRow not found");

            const btnAddCategory = document.getElementById('btnAddCategory');
            if (btnAddCategory) btnAddCategory.addEventListener('click', addCategory);
            else console.error("btnAddCategory not found");

            const btnSave = document.getElementById('btnSave');
            if (btnSave) btnSave.addEventListener('click', saveRAB);
            else console.error("btnSave not found");

            // Check Supabase Client
            if (typeof client === 'undefined') {
                console.warn("Supabase Client is undefined! Ensure supabase.js and app_config.js are loaded.");
            }

            // Check URL Params
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (id) {
                console.log("Loading RAB ID:", id);
                currentRabId = id;
                loadRAB(id);
            } else {
                console.log("Initializing New RAB");
                initDefaultData();
            }
        });

        function initDefaultData() {
            rabDetails = [
                { is_header: true, label: 'PEKERJAAN PERSIAPAN' },
                { is_header: false, uraian_pekerjaan: '', volume: 1, satuan: 'Ls', harga_satuan: 0 }
            ];
            renderTable();
        }

        async function loadRAB(id) {
            try {
                if (typeof client === 'undefined') return;

                const { data: header, error: errHead } = await client.from('sem_rab_header').select('*').eq('id', id).single();
                if (errHead) throw errHead;

                if (document.getElementById('inpNamaProyek')) document.getElementById('inpNamaProyek').value = header.nama_proyek || '';
                if (document.getElementById('inpKlien')) document.getElementById('inpKlien').value = header.nama_klien || '';
                if (document.getElementById('inpLokasi')) document.getElementById('inpLokasi').value = header.lokasi_proyek || '';

                const { data: details, error: errDet } = await client.from('sem_rab_detail').select('*').eq('rab_id', id).order('urutan', { ascending: true });
                if (errDet) throw errDet;

                rabDetails = [];
                let lastCat = null;
                (details || []).forEach(d => {
                    const cat = d.kategori || 'UMUM';
                    if (cat !== lastCat) {
                        rabDetails.push({ is_header: true, label: cat });
                        lastCat = cat;
                    }
                    rabDetails.push({
                        id: d.id,
                        is_header: false,
                        uraian_pekerjaan: d.uraian_pekerjaan,
                        volume: d.volume,
                        satuan: d.satuan,
                        harga_satuan: d.harga_satuan
                    });
                });

                if (rabDetails.length === 0) initDefaultData();
                else renderTable();

            } catch (e) {
                alert("Gagal memuat RAB: " + e.message);
                console.error(e);
            }
        }

        async function saveRAB() {
            if (isSaving) return;
            console.log("Saving RAB...");
            if (typeof client === 'undefined') { alert("Database disconnected. Cek koneksi Supabase."); return; }

            const btn = document.getElementById('btnSave');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            isSaving = true;

            try {
                const namaProyek = document.getElementById('inpNamaProyek').value;
                const namaKlien = document.getElementById('inpKlien').value;
                const lokasi = document.getElementById('inpLokasi').value;

                if (!namaProyek) throw new Error("Nama Proyek wajib diisi!");

                const hasItems = rabDetails.some(d => !d.is_header);
                if (!hasItems) throw new Error("RAB masih kosong! Tambahkan item pekerjaan.");

                const invalidItems = rabDetails.filter(d => !d.is_header && (d.volume <= 0 || d.harga_satuan <= 0));
                if (invalidItems.length > 0) {
                    if (!confirm(`Ada ${invalidItems.length} item dengan Volume atau Harga 0. Lanjutkan simpan?`)) {
                        isSaving = false;
                        btn.innerHTML = originalContent;
                        return; // Cancel save
                    }
                }

                // 1. Upsert Header
                const payloadHeader = {
                    nama_proyek: namaProyek,
                    nama_klien: namaKlien,
                    lokasi_proyek: lokasi,
                    total_biaya: parseRupiah(document.getElementById('grandTotal').innerText),
                    updated_by: (typeof PNAuth !== 'undefined') ? PNAuth.getSession()?.user?.id : null
                };

                if (currentRabId) payloadHeader.id = currentRabId;

                const { data: savedHead, error: errHead } = await client.from('sem_rab_header').upsert(payloadHeader).select().single();
                if (errHead) throw errHead;
                currentRabId = savedHead.id;

                // 2. Prepare Details Payload
                let currentCat = 'UMUM';
                let processItems = [];
                let orderCounter = 0;

                rabDetails.forEach(row => {
                    if (row.is_header) {
                        currentCat = row.label || 'UMUM';
                    } else {
                        processItems.push({
                            rab_id: currentRabId,
                            id: row.id, // ID if exists (for upsert)
                            kategori: currentCat,
                            uraian_pekerjaan: row.uraian_pekerjaan || '',
                            volume: row.volume || 0,
                            satuan: row.satuan || '',
                            harga_satuan: row.harga_satuan || 0,
                            urutan: orderCounter++
                        });
                    }
                });

                // Upsert Items
                const { error: errDet } = await client.from('sem_rab_detail').upsert(processItems);
                if (errDet) throw errDet;

                await loadRAB(currentRabId);
                alert("âœ… RAB Berhasil Disimpan!");

                const newUrl = new URL(window.location);
                newUrl.searchParams.set('id', currentRabId);
                window.history.pushState({}, '', newUrl);

            } catch (e) {
                alert("Gagal menyimpan: " + e.message);
                console.error(e);
            } finally {
                btn.innerHTML = '<i class="fas fa-save mr-1"></i> Simpan RAB';
                isSaving = false;
            }
        }

        function renderTable() {
            const tbody = document.getElementById('rabTableBody');
            if (!tbody) { console.error("tbody not found"); return; }
            tbody.innerHTML = '';

            let itemIndex = 1;
            rabDetails.forEach((item, index) => {
                const tr = document.createElement('tr');
                if (item.is_header) {
                    tr.className = "bg-emerald-50 font-bold text-emerald-800";
                    tr.innerHTML = `
                        <td class="px-4 py-2 text-center"><i class="fas fa-layer-group text-emerald-300"></i></td>
                        <td colspan="5" class="p-0 border-r border-slate-100">
                             <input type="text" class="input-cell font-bold text-emerald-800 uppercase" 
                                    value="${item.label || ''}" 
                                    onchange="updateItem(${index}, 'label', this.value)" 
                                    placeholder="NAMA KATEGORI PEKERJAAN">
                        </td>
                        <td class="text-center"><button onclick="deleteRow(${index})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button></td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td class="px-4 py-2 text-center text-slate-400">${itemIndex++}</td>
                        <td class="p-0 border-r border-slate-100"><input type="text" class="input-cell" value="${item.uraian_pekerjaan || ''}" onchange="updateItem(${index}, 'uraian_pekerjaan', this.value)" placeholder="Item pekerjaan..."></td>
                        <td class="p-0 border-r border-slate-100"><input type="number" class="input-cell text-center" value="${item.volume || 0}" oninput="updateItem(${index}, 'volume', this.value)"></td>
                        <td class="p-0 border-r border-slate-100"><input type="text" class="input-cell text-center" value="${item.satuan || ''}" onchange="updateItem(${index}, 'satuan', this.value)"></td>
                        <td class="p-0 border-r border-slate-100"><input type="number" class="input-cell text-right" value="${item.harga_satuan || 0}" oninput="updateItem(${index}, 'harga_satuan', this.value)"></td>
                        <td class="px-4 py-2 text-right font-bold text-slate-700 row-total">${formatCurrency((item.volume || 0) * (item.harga_satuan || 0))}</td>
                        <td class="text-center"><button onclick="deleteRow(${index})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button></td>
                    `;
                }
                tbody.appendChild(tr);
            });
            calcGrandTotal();
        }

        function addRow() {
            rabDetails.push({ is_header: false, uraian_pekerjaan: '', volume: 1, satuan: 'Ls', harga_satuan: 0 });
            renderTable();
        }

        function addCategory() {
            rabDetails.push({ is_header: true, label: 'KATEGORI BARU' });
            rabDetails.push({ is_header: false, uraian_pekerjaan: '', volume: 1, satuan: 'Ls', harga_satuan: 0 });
            renderTable();
        }

        async function deleteRow(index) {
            const item = rabDetails[index];
            if (!confirm("Apakah Anda yakin ingin menghapus baris ini?")) return;

            if (item.is_header) {
                // Category logic
                const deleteChildren = confirm("Hapus kategori beserta semua item di bawahnya?\nOK: Hapus Semua.\nCancel: Hapus Header Saja.");

                if (deleteChildren) {
                    let count = 1;
                    const idsToDelete = [];
                    // Find children
                    while (index + count < rabDetails.length && !rabDetails[index + count].is_header) {
                        if (rabDetails[index + count].id) idsToDelete.push(rabDetails[index + count].id);
                        count++;
                    }

                    if (idsToDelete.length > 0 && typeof client !== 'undefined') {
                        const { error } = await client.from('sem_rab_detail').delete().in('id', idsToDelete);
                        if (error) { alert("Gagal hapus item DB: " + error.message); return; }
                    }
                    rabDetails.splice(index, count);
                } else {
                    rabDetails.splice(index, 1);
                }
            } else {
                // Item logic
                if (item.id && typeof client !== 'undefined') {
                    const { error } = await client.from('sem_rab_detail').delete().eq('id', item.id);
                    if (error) { alert("Gagal hapus DB: " + error.message); return; }
                }
                rabDetails.splice(index, 1);
            }
            renderTable();
        }

        function updateItem(index, key, value) {
            if (!rabDetails[index]) return;
            if (key === 'volume' || key === 'harga_satuan') value = parseFloat(value) || 0;
            rabDetails[index][key] = value;
            if (key === 'volume' || key === 'harga_satuan') renderTable();
        }

        function calcGrandTotal() {
            let sum = 0;
            rabDetails.forEach(d => {
                if (!d.is_header) {
                    sum += (d.volume || 0) * (d.harga_satuan || 0);
                }
            });
            const fee = sum * 0.1;
            const final = sum + fee;
            const elGrand = document.getElementById('grandTotal');
            const elFee = document.getElementById('feeTotal');
            const elFinal = document.getElementById('finalTotal');
            if (elGrand) elGrand.innerText = 'Rp ' + formatCurrency(sum);
            if (elFee) elFee.innerText = 'Rp ' + formatCurrency(fee);
            if (elFinal) elFinal.innerText = 'Rp ' + formatCurrency(final);
        }

        function parseRupiah(str) { return parseFloat(str.replace(/[^0-9,-]+/g, "").replace(',', '.')) || 0; }

        function downloadPDF() {
            if (typeof window.jspdf === 'undefined') { alert("Library PDF belum siap."); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Rencana Anggaran Biaya (RAB)", 14, 20);
            doc.autoTable({
                head: [['No', 'Uraian', 'Vol', 'Sat', 'Harga', 'Total']],
                body: rabDetails.map(item => item.is_header ? [{ content: item.label, colSpan: 6 }] : ['', item.uraian_pekerjaan, item.volume, item.satuan, formatCurrency(item.harga_satuan), formatCurrency((item.volume || 0) * (item.harga_satuan || 0))]),
                startY: 30
            });
            doc.save('RAB.pdf');
        }
    </script>
</body>

</html>