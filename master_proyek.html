<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Master Data Proyek</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans text-gray-800 p-6 min-h-screen pb-96">

  <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-city text-blue-600 mr-2"></i>Daftar Proyek & RAB</h1>
      <p class="text-gray-500">Monitoring Budget (RAB) vs Realisasi Lapangan</p>
    </div>
    <a href="stok_proyek.html" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded shadow text-sm font-bold flex items-center gap-2">
      <i class="fas fa-arrow-left"></i> Kembali ke Gudang
    </a>
  </div>

  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <div class="lg:col-span-1">
      <div class="bg-white p-6 rounded-lg shadow-lg sticky top-6">
        <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">‚ûï Proyek Baru</h2>
        
        <form id="formProyek" class="space-y-4">
          
          <div>
            <label class="block text-xs font-bold text-gray-600 mb-1">Pilih Kavling / Nama Proyek</label>
            <select id="pilihNamaProyek" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white font-bold text-gray-700" onchange="toggleInputManual()">
                <option value="MANUAL" class="font-bold text-blue-600">‚ûï Input Nama Manual (Proyek Baru)</option>
                <option disabled>----------------------------------</option>
                <option disabled>Memuat daftar blok...</option>
            </select>

            <div id="manualInputPanel" class="hidden border border-blue-200 bg-blue-50 rounded mt-3 p-3 space-y-1 shadow-inner">
              <label for="inputManualNama" class="text-[11px] font-semibold text-blue-800 uppercase tracking-wide">Nama Proyek Manual</label>
              <input type="text" id="inputManualNama" class="w-full border border-blue-300 rounded p-2 bg-white font-bold text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: Jalan Koridor Blok A dan B">
              <p class="text-[10px] text-blue-700/70">Contoh: Jalan Koridor Blok A dan B</p>
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-600 mb-1">Kategori Proyek</label>
            <select id="kategoriSelect" class="w-full border p-2 rounded bg-white mb-2" onchange="cekKategori()">
              <option value="Bangunan Rumah">Bangunan Rumah</option>
              <option value="Infrastruktur">Infrastruktur (Jalan/Drainase)</option>
              <option value="Fasilitas Umum">Fasilitas Umum</option>
              <option value="Renovasi">Renovasi</option>
              <option value="LAINNYA">-- Isi Kategori Lain --</option>
            </select>
            <input type="text" id="kategoriLain" class="hidden w-full border p-2 rounded bg-blue-50 border-blue-300 text-blue-800 placeholder-blue-300" placeholder="Tulis kategori manual...">
          </div>

          <div id="boxUploadRAB" class="hidden bg-orange-50 p-3 rounded border border-orange-200">
             <label class="block text-xs font-bold text-orange-800 mb-1">üìÇ Upload File RAB (Infrastruktur)</label>
             <input type="file" id="fileRAB" class="w-full text-xs text-gray-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-orange-600 file:text-white hover:file:bg-orange-700">
             <p class="text-[10px] text-gray-400 mt-1 italic">*Wajib untuk proyek infrastruktur</p>
          </div>

          <div class="grid grid-cols-1 gap-3">
              <div>
                <label class="block text-xs font-bold text-gray-600 mb-1">RAB Material</label>
                <div class="relative">
                  <span class="absolute left-3 top-2 text-gray-500 font-bold">Rp</span>
                  <input type="number" id="rabMaterial" class="w-full border p-2 pl-10 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" value="0" required oninput="updateNilaiTotal()">
                </div>
              </div>

              <div>
                <label class="block text-xs font-bold text-gray-600 mb-1">RAB Upah Tukang</label>
                <div class="relative">
                  <span class="absolute left-3 top-2 text-gray-500 font-bold">Rp</span>
                  <input type="number" id="rabUpahTukang" class="w-full border p-2 pl-10 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" value="0" required oninput="updateNilaiTotal()">
                </div>
              </div>

              <div class="bg-blue-50 border border-blue-200 rounded p-3">
                <label class="block text-xs font-bold text-blue-800 mb-1">Total Nilai Proyek (RAB)</label>
                <div class="relative">
                  <span class="absolute left-3 top-2 text-blue-700 font-bold">Rp</span>
                  <input type="number" id="nilaiProyek" class="w-full border p-2 pl-10 rounded outline-none bg-white font-bold text-blue-800" placeholder="0" value="0" readonly>
                </div>
                <div class="text-[11px] text-blue-700 mt-1 font-bold" id="nilaiTotalPreview">Rp 0</div>
              </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-600 mb-1">Tanggal Mulai (Start)</label>
            <input type="date" id="tglMulai" class="w-full border p-2 rounded" required>
          </div>

          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded shadow transition">
            Simpan Proyek
          </button>
        </form>
      </div>
    </div>

    <div class="lg:col-span-2">
      <div class="bg-white rounded-lg shadow-lg border border-gray-200 flex flex-col h-[600px]"> 
        <div class="p-4 bg-slate-800 text-white flex justify-between items-center shadow-md z-20 rounded-t-lg shrink-0">
          <div class="flex items-center gap-2">
             <i class="fas fa-list-ul text-blue-400"></i>
             <h3 class="font-bold text-lg tracking-wide">Daftar Proyek Berjalan</h3>
          </div>
          <span class="text-xs bg-blue-500 text-white border border-blue-400 px-3 py-1 rounded-full font-bold shadow-sm" id="totalProyek">0 Proyek</span>
        </div>
        
        <div class="grid grid-cols-2 gap-4 p-4 bg-blue-50/50 border-b border-gray-200 shrink-0">
            <div class="bg-white p-3 rounded border border-blue-100 shadow-sm flex flex-col">
                <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Total Nilai Proyek (RAB)</span>
                <span class="text-xl font-bold text-blue-700 mt-1" id="grandTotalRAB">Rp 0</span>
            </div>
            <div class="bg-white p-3 rounded border border-orange-100 shadow-sm flex flex-col">
                <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Total Realisasi (Act)</span>
                <span class="text-xl font-bold text-orange-600 mt-1" id="grandTotalRealisasi">Rp 0</span>
            </div>
        </div>
        
        <div class="overflow-y-auto flex-grow bg-gray-50 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
          <table class="w-full text-left text-sm relative">
            
            <thead class="bg-gray-100 uppercase text-[10px] font-black text-gray-600 sticky top-0 z-10 shadow-sm">
  <tr>
    <th class="p-4 bg-gray-100">Unit / Proyek</th>
    <th class="p-4 text-right bg-gray-100">RAB (Budget)</th>
    <th class="p-4 text-right bg-red-50 text-red-700 border-x">Real: Upah</th>
    <th class="p-4 text-right bg-red-50 text-red-700 border-x">Real: Mat</th>
    <th class="p-4 text-center w-16 bg-gray-100">Aksi</th>
  </tr>
</thead>

            <tbody id="tabelProyek" class="divide-y divide-gray-100 bg-white">
              <tr><td colspan="5" class="p-6 text-center text-gray-400"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>Menghitung Realisasi...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="p-3 bg-blue-50/50 border-t text-[11px] text-gray-500 flex gap-2 items-start shrink-0 rounded-b-lg">
            <i class="fas fa-info-circle mt-0.5 text-blue-400"></i>
            <span>Scroll ke bawah untuk melihat proyek lainnya.</span>
        </div>
      </div>
    </div>

  </div>

  <script>
    // --- KONFIGURASI SUPABASE ---
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    async function catatLog(tipe, pesan, icon = 'fa-info-circle') {
        const user = "Admin";
        try {
            const { error } = await client.from('activity_logs').insert([{
                user_name: user,
                tipe: tipe,
                aktivitas: pesan,
                icon: icon
            }]);
            if(error) console.error("Gagal mencatat log:", error);
        } catch (e) {
            console.error("Error Log:", e);
        }
    }
    const fmt = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

    // --- INISIALISASI ---
    loadReferensiBlok();
    loadProyek();

    // 1. FUNGSI LOAD DATA PROYEK
    async function loadProyek() {
      // 1. Ambil data master proyek
      const { data: proyeks, error } = await client.from('master_proyek').select('*').order('nama_proyek', { ascending: true });
      if (error) return console.error(error);
      
      const tbody = document.getElementById("tabelProyek");
      const grandRABEl = document.getElementById("grandTotalRAB");
      const grandRealEl = document.getElementById("grandTotalRealisasi");
      tbody.innerHTML = "";

      // 2. Ambil data Upah & Material
      const { data: upahData } = await client.from('transaksi_upah').select('kavling, nilai_bayar');
      const { data: materialData } = await client
          .from('verifikasi_material')
          .select('nama_proyek, total_biaya, status');

      const realUpahMap = {};
      const realMatMap = {};

      // Memetakan Upah
      if(upahData) {
          upahData.forEach(u => {
              const unitId = (u.kavling || "").toString().replace(/\s+/g, '').toUpperCase();
              realUpahMap[unitId] = (realUpahMap[unitId] || 0) + Number(u.nilai_bayar);
          });
      }

      // JURUS SAKTI: Memetakan Material
      if(materialData) {
          materialData.forEach(m => {
              if(m.status !== 'REJECTED') {
                  const unitId = (m.nama_proyek || "").toString().replace(/\s+/g, '').toUpperCase();
                  realMatMap[unitId] = (realMatMap[unitId] || 0) + Number(m.total_biaya);
              }
          });
      }
      
      let sumRAB = 0;
      let sumRealisasiTotal = 0; 
      let countAktif = 0;

      proyeks.forEach(p => {
        const isAktif = p.status === 'BERJALAN';
        if(isAktif) countAktif++;

        const rab = Number(p.nilai_proyek) || 0;
        const unitKunci = (p.nama_proyek || "").toString().replace(/\s+/g, '').toUpperCase(); // Kunci Pencocokan Global
        
        const rUpah = realUpahMap[unitKunci] || 0; 
        const rMat = realMatMap[unitKunci] || 0;   
        
        sumRAB += rab;
        sumRealisasiTotal += (rUpah + rMat);

        const btnStatus = isAktif
          ? `<button onclick="toggleStatus(${p.id}, '${p.status}', '${p.nama_proyek}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1.5 rounded-lg text-[10px] font-black transition-all flex items-center gap-1 shadow-sm border border-red-200">
                <i class="fas fa-power-off"></i> MATIKAN
             </button>`
          : `<button onclick="toggleStatus(${p.id}, '${p.status}', '${p.nama_proyek}')" class="bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-3 py-1.5 rounded-lg text-[10px] font-black transition-all flex items-center gap-1 shadow-sm border border-emerald-200">
                <i class="fas fa-play text-[8px]"></i> AKTIFKAN
             </button>`;

        tbody.innerHTML += `
          <tr class="hover:bg-gray-50 border-b ${!isAktif ? 'opacity-60 bg-gray-50' : ''}">
            <td class="p-3">
              <div class="font-bold text-gray-800">${p.nama_proyek}</div>
              <span class="text-[9px] font-black uppercase tracking-wider px-2 py-0.5 rounded ${isAktif ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                ${isAktif ? '‚óè BERJALAN' : '‚óã NONAKTIF'}
              </span>
            </td>
            <td class="p-3 text-right font-mono font-bold text-slate-500">${fmt(rab)}</td>
            <td class="p-3 text-right bg-red-50/20 font-mono font-bold text-red-600">${fmt(rUpah)}</td>
            <td class="p-3 text-right bg-red-50/20 font-mono font-bold text-red-600">${fmt(rMat)}</td>
            <td class="p-4 flex flex-col items-center gap-2">
                ${btnStatus}
                <button onclick="hapusProyek(${p.id}, '${p.nama_proyek}')" class="text-slate-300 hover:text-red-600 transition-all text-xs flex items-center gap-1">
                    <i class="fas fa-trash-alt"></i> <span class="text-[9px] font-bold">HAPUS</span>
                </button>
            </td>
          </tr>`;
      });

      // Sinkronkan ke Dashboard Atas
      if (grandRABEl) grandRABEl.innerText = fmt(sumRAB);
      if (grandRealEl) grandRealEl.innerText = fmt(sumRealisasiTotal);
      document.getElementById("totalProyek").innerText = proyeks.length + " Proyek";
      if(document.getElementById("totalProyekBerjalan")) {
          document.getElementById("totalProyekBerjalan").innerText = countAktif + " Unit";
      }
    }

    // JURUS KONTROL STATUS: Aktifkan atau Nonaktifkan Proyek
    async function toggleStatus(id, currentStatus, nama) {
        const nextStatus = currentStatus === 'BERJALAN' ? 'NONAKTIF' : 'BERJALAN';
        const aksi = nextStatus === 'BERJALAN' ? 'MENGAKTIFKAN' : 'MENONAKTIFKAN';
        
        const confirmMsg = `‚ö†Ô∏è KONFIRMASI KEPUTUSAN:\n\nAnda akan ${aksi} unit proyek: ${nama}.\n\n(Unit yang nonaktif tidak akan muncul di menu pengajuan upah & alokasi material)`;

        if(confirm(confirmMsg)) {
            const { error } = await client.from('master_proyek').update({ status: nextStatus }).eq('id', id);
            if(!error) {
                await catatLog('PROYEK', `Status ${nama} diubah menjadi ${nextStatus}`, 'fa-sync');
                alert(`‚úÖ Status ${nama} berhasil diperbarui.`);
                loadProyek(); 
            } else {
                alert("‚ùå Gagal: " + error.message);
            }
        }
    }

    // 2. LOGIKA FORM INPUT
    function updateNilaiTotal() {
        const m = parseInt(document.getElementById("rabMaterial").value || 0);
        const u = parseInt(document.getElementById("rabUpahTukang").value || 0);
        const total = m + u;
        document.getElementById("nilaiProyek").value = total;
        document.getElementById("nilaiTotalPreview").innerText = fmt(total);
    }

    // 3. AMBIL DATA BLOK (Dropdown)
    async function loadReferensiBlok() {
        const select = document.getElementById("pilihNamaProyek");
        const { data } = await client.from('referensi_blok').select('id').order('id');
        
        // Reset isi dropdown agar tidak double jika dipanggil ulang
        select.innerHTML = `
          <option value="" selected disabled>-- Pilih Blok / Proyek --</option>
          <option value="MANUAL" class="font-bold text-blue-600">‚ûï Input Nama Manual (Proyek Baru)</option>
          <option disabled>----------------------------------</option>
        `;

        if(data) {
            data.sort((a,b)=>a.id.localeCompare(b.id,undefined,{numeric:true})).forEach(b => {
                const opt = document.createElement("option"); 
                opt.value = "Blok " + b.id; 
                opt.text = "Blok " + b.id; 
                select.appendChild(opt);
            });
        }

        // Pastikan UI sinkron
        toggleInputManual();
    }

    // 4. TOGGLE INPUT MANUAL (PERBAIKAN UTAMA)
    function toggleInputManual() {
        const dropdown = document.getElementById("pilihNamaProyek");
        const panel = document.getElementById("manualInputPanel");
        const input = document.getElementById("inputManualNama");
        const kategoriSelect = document.getElementById("kategoriSelect");
        const opsiRumah = kategoriSelect?.querySelector('option[value="Bangunan Rumah"]');

        const val = dropdown.value;

        if (val === "MANUAL") {
            panel.classList.remove("hidden");
            panel.style.display = "block";
            input.required = true;
            input.focus();

            if (opsiRumah) {
                opsiRumah.disabled = true;
                opsiRumah.classList.add("text-gray-300", "italic");
            }

            if (kategoriSelect.value === "Bangunan Rumah") {
                kategoriSelect.value = "Infrastruktur";
                cekKategori();
            }
        } else {
            panel.classList.add("hidden");
            panel.style.display = "none";
            input.required = false;

            if (opsiRumah) {
                opsiRumah.disabled = false;
                opsiRumah.classList.remove("text-gray-300", "italic");
            }
        }
    }

    // 5. CEK KATEGORI LAIN / INFRASTRUKTUR
    function cekKategori() {
        const v = document.getElementById("kategoriSelect").value;
        const l = document.getElementById("kategoriLain");
        const b = document.getElementById("boxUploadRAB");
        
        l.classList.add("hidden"); 
        b.classList.add("hidden");
        
        if(v === "LAINNYA") l.classList.remove("hidden");
        if(v === "Infrastruktur") b.classList.remove("hidden");
    }

    // 6. SIMPAN DATA KE SUPABASE
    document.getElementById("formProyek").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // Ambil Nilai Form
        const selNama = document.getElementById("pilihNamaProyek").value;
        let nama = selNama === "MANUAL" ? document.getElementById("inputManualNama").value : selNama;
        
        const katSelect = document.getElementById("kategoriSelect").value;
        const kat = katSelect === "LAINNYA" ? document.getElementById("kategoriLain").value : katSelect;
        
        // Pastikan angka di-parse dengan benar
        const rabM = parseInt(document.getElementById("rabMaterial").value) || 0;
        const rabU = parseInt(document.getElementById("rabUpahTukang").value) || 0;
        const tot = parseInt(document.getElementById("nilaiProyek").value) || 0;
        
        const tgl = document.getElementById("tglMulai").value;
        const file = document.getElementById("fileRAB").files[0];
        const lokasi = file ? "RAB_" + file.name : ""; // Simulasi nama file

        if (!nama) { alert("Nama Proyek harus diisi!"); return; }

        // Insert ke Database
        const { error } = await client.from('master_proyek').insert([{
            nama_proyek: nama, 
            kategori: kat, 
            nilai_proyek: tot, 
            rab_material: rabM,       // Kolom Baru
            rab_upah_tukang: rabU,    // Kolom Baru
            tanggal_mulai: tgl, 
            lokasi: lokasi, 
            status: 'BERJALAN'
        }]);

        if(error) {
            alert("Error Gagal Simpan: " + error.message + "\n\n(Cek apakah kolom 'rab_material' & 'rab_upah_tukang' sudah dibuat di Supabase?)");
        } else { 
            catatLog('PROYEK', `Menambahkan proyek baru: ${nama}`, 'fa-building');
            alert("Berhasil Simpan Proyek!"); 
            location.reload(); 
        }
    });

    // 7. HAPUS DATA
    async function hapusProyek(id, nama) {
        if(confirm(`Yakin hapus proyek: ${nama}?`)) {
            const { error } = await client.from('master_proyek').delete().eq('id', id);
            if(error) alert("Gagal hapus: " + error.message);
            else loadProyek();
        }
    }
  </script>
</body>
</html>
