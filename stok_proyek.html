<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Gudang - Stok Proyek</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 p-6">

  <div class="max-w-6xl mx-auto mb-6 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Gudang Proyek</h1>
      <p class="text-gray-500">Monitoring Material & Pencatatan Pemakaian</p>
    </div>
    <div class="flex gap-2">
      <button onclick="bukaModalPakai()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded shadow font-bold flex items-center gap-2">
        ðŸ”¨ Catat Pemakaian
      </button>
      <a href="inventory_req.html" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded shadow text-sm flex items-center">Menu Request</a>
    </div>
  </div>

  <div class="max-w-6xl mx-auto mb-8">
    <h3 class="font-bold text-gray-700 mb-3 text-lg border-b pb-2">ðŸ“¦ Saldo Material Saat Ini</h3>
    <div id="gridStok" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
      <div class="p-10 text-center text-gray-400 col-span-full">Memuat data stok...</div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto bg-white rounded shadow p-6">
    <h3 class="font-bold text-gray-700 mb-4">ðŸ“œ Kartu Stok (Riwayat Keluar/Masuk)</h3>
    <table class="w-full text-left border-collapse text-sm">
      <thead class="bg-gray-50 uppercase text-xs font-bold text-gray-600">
        <tr>
          <th class="p-3 border-b">Tanggal</th>
          <th class="p-3 border-b">Barang</th>
          <th class="p-3 border-b">Jenis Transaksi</th>
          <th class="p-3 border-b text-right">Jumlah</th>
          <th class="p-3 border-b">Keterangan</th>
        </tr>
      </thead>
      <tbody id="tabelHistory">
        <tr><td colspan="5" class="p-4 text-center">Memuat history...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="modalPakai" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
      <h2 class="text-xl font-bold mb-4 text-orange-600">Catat Pemakaian Material</h2>
      
      <div class="space-y-3">
        <div>
          <label class="block text-xs font-bold mb-1">Pilih Material</label>
          <select id="pilihBarang" class="w-full border p-2 rounded"></select>
        </div>
        <div>
          <label class="block text-xs font-bold mb-1">Jumlah Dipakai</label>
          <input type="number" id="jumlahPakai" class="w-full border p-2 rounded" placeholder="0">
        </div>
        <div>
          <label class="block text-xs font-bold mb-1">Untuk Pekerjaan (Keterangan)</label>
          <textarea id="ketPakai" class="w-full border p-2 rounded" placeholder="Cth: Pengecoran Zona A"></textarea>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button onclick="document.getElementById('modalPakai').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Batal</button>
        <button onclick="simpanPemakaian()" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 font-bold">Simpan</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    async function loadStok() {
      const { data, error } = await client.from('master_stok').select('*').order('nama_barang');
      const container = document.getElementById("gridStok");
      const select = document.getElementById("pilihBarang");
      
      container.innerHTML = "";
      select.innerHTML = "<option value=''>-- Pilih Barang --</option>";

      if(!data || data.length === 0) {
        container.innerHTML = "<div class='col-span-full text-center p-4 bg-white rounded'>Belum ada stok barang. Lakukan GRN dulu.</div>";
        return;
      }

      data.forEach(item => {
        const card = `
          <div class="bg-white p-5 rounded border-l-4 ${item.total_stok > 0 ? 'border-green-500' : 'border-red-500'} shadow hover:shadow-md transition">
            <h4 class="font-bold text-lg text-gray-800 truncate">${item.nama_barang}</h4>
            <div class="flex justify-between items-end mt-4">
              <span class="text-3xl font-bold text-gray-900">${item.total_stok}</span>
              <span class="text-sm font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">${item.satuan}</span>
            </div>
            <p class="text-xs text-gray-400 mt-2">Update: ${new Date(item.last_updated).toLocaleDateString()}</p>
          </div>
        `;
        container.innerHTML += card;

        const opt = document.createElement('option');
        opt.value = item.id;
        opt.text = `${item.nama_barang} (Sisa: ${item.total_stok} ${item.satuan})`;
        opt.setAttribute('data-stok', item.total_stok);
        select.appendChild(opt);
      });
    }

    async function loadHistory() {
      const { data } = await client
        .from('stok_history')
        .select(`*, master_stok(nama_barang, satuan)`)
        .order('created_at', { ascending: false })
        .limit(20);

      const tbody = document.getElementById("tabelHistory");
      tbody.innerHTML = "";

      (data || []).forEach(row => {
        const isMasuk = row.jenis_transaksi.includes('MASUK');
        const warnaBadge = isMasuk ? "bg-green-100 text-green-800" : "bg-orange-100 text-orange-800";
        const tanda = isMasuk ? "+" : "-";

        tbody.innerHTML += `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-3">${new Date(row.created_at).toLocaleString()}</td>
            <td class="p-3 font-bold">${row.master_stok?.nama_barang || 'Barang Dihapus'}</td>
            <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${warnaBadge}">${row.jenis_transaksi}</span></td>
            <td class="p-3 text-right font-mono font-bold ${isMasuk ? 'text-green-600' : 'text-orange-600'}">
              ${tanda} ${row.jumlah}
            </td>
            <td class="p-3 text-gray-500 italic">${row.keterangan || '-'}</td>
          </tr>
        `;
      });
    }

    function bukaModalPakai() {
      document.getElementById("modalPakai").classList.remove("hidden");
    }

    async function simpanPemakaian() {
      const barangId = document.getElementById("pilihBarang").value;
      const jumlah = Number(document.getElementById("jumlahPakai").value);
      const ket = document.getElementById("ketPakai").value;
      const select = document.getElementById("pilihBarang");
      const sisaStok = Number(select.options[select.selectedIndex]?.getAttribute('data-stok') || 0);

      if (!barangId || jumlah <= 0) { alert("Data tidak lengkap!"); return; }
      if (jumlah > sisaStok) { alert(`Stok tidak cukup! Sisa hanya ${sisaStok}`); return; }

      const { error: errUp } = await client
        .from('master_stok')
        .update({ total_stok: sisaStok - jumlah, last_updated: new Date() })
        .eq('id', barangId);

      if(errUp) { alert("Gagal update stok"); return; }

      await client.from('stok_history').insert([{
        barang_id: barangId,
        jenis_transaksi: 'KELUAR (PEMAKAIAN)',
        jumlah: jumlah,
        keterangan: ket
      }]);

      alert("âœ… Pemakaian berhasil dicatat!");
      document.getElementById("modalPakai").classList.add("hidden");
      document.getElementById("jumlahPakai").value = "";
      document.getElementById("ketPakai").value = "";
      
      loadStok();
      loadHistory();
    }

    loadStok();
    loadHistory();
  </script>
</body>
</html>
