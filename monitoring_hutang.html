<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Command Center - Nusantara Land</title>

    <script src="supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="app_config.js"></script> <!-- Import Config -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Glassmorphism Cards */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-enter {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div
                    class="bg-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-200">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div>
                    <h1 class="text-lg font-extrabold text-slate-800 tracking-tight leading-tight">CONTROL DATA HUTANG
                    </h1>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Finance & Accounting
                        Module</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='dashboard_finance.html'"
                    class="px-4 py-2 text-xs font-bold text-slate-500 hover:text-slate-800 transition bg-slate-100 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>Dashboard
                </button>
                <button onclick="refreshData()"
                    class="bg-indigo-50 text-indigo-600 w-10 h-10 rounded-lg hover:bg-indigo-100 transition flex items-center justify-center">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto w-full p-6 space-y-6">

        <!-- VIEW: MENU (DEFAULT) -->
        <div id="view-menu" class="animate-enter">
            <h3 class="text-slate-500 font-bold text-sm uppercase tracking-wider mb-6 ml-1">Modul Hutang (AP)</h3>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Card Overview -->
                <div onclick="switchApp('overview')"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48">
                    <div
                        class="w-16 h-16 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-3xl mb-4 group-hover:rotate-12 transition">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Overview</h3>
                    <p class="text-xs text-slate-400 mt-1">Metrik & Analisa</p>
                </div>

                <!-- Card Hutang Vendor -->
                <div onclick="switchApp('vendor')"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48">
                    <div
                        class="w-16 h-16 rounded-2xl bg-emerald-100 text-emerald-600 flex items-center justify-center text-3xl mb-4 group-hover:rotate-12 transition">
                        <i class="fas fa-store"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Hutang Vendor</h3>
                    <p class="text-xs text-slate-400 mt-1">Daftar Tagihan PO</p>
                </div>

                <!-- Card Hutang Bank -->
                <div onclick="switchApp('bank')"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48">
                    <div
                        class="w-16 h-16 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center text-3xl mb-4 group-hover:rotate-12 transition">
                        <i class="fas fa-landmark"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Hutang Bank</h3>
                    <p class="text-xs text-slate-400 mt-1">Pinjaman & Bunga</p>
                </div>

                <!-- Card Hutang Lahan -->
                <div onclick="alert('Modul Hutang Lahan segera hadir!')"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 opacity-75 grayscale hover:grayscale-0">
                    <div
                        class="w-16 h-16 rounded-2xl bg-orange-100 text-orange-600 flex items-center justify-center text-3xl mb-4">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Hutang Lahan</h3>
                    <p class="text-xs text-slate-400 mt-1">Termin Tanah</p>
                </div>

                <!-- Card Reimburse -->
                <div onclick="alert('Modul Reimburse segera hadir!')"
                    class="glass-panel p-6 flex flex-col items-center justify-center text-center hover:scale-105 cursor-pointer group h-48 opacity-75 grayscale hover:grayscale-0">
                    <div
                        class="w-16 h-16 rounded-2xl bg-pink-100 text-pink-600 flex items-center justify-center text-3xl mb-4">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 text-lg">Reimburse</h3>
                    <p class="text-xs text-slate-400 mt-1">Klaim Karyawan</p>
                </div>
            </div>
        </div>

        <!-- VIEW: OVERVIEW -->
        <div id="view-overview" class="hidden space-y-6 animate-enter">
            <button onclick="switchApp('menu')"
                class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-bold transition">
                <i class="fas fa-arrow-left"></i> Kembali ke Menu
            </button>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="glass-panel p-5 border-l-4 border-indigo-600">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Total Hutang (Outstanding)</p>
                            <h3 class="text-2xl font-black text-slate-800 mt-1" id="kpiTotal">Rp 0</h3>
                        </div>
                        <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600"><i class="fas fa-wallet"></i></div>
                    </div>
                    <div class="mt-3 text-xs text-slate-500 flex items-center gap-1">
                        <i class="fas fa-file-invoice"></i> <span id="kpiCount">0</span> Faktur Belum Lunas
                    </div>
                </div>

                <div class="glass-panel p-5 border-l-4 border-red-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Jatuh Tempo (Overdue)</p>
                            <h3 class="text-2xl font-black text-red-600 mt-1" id="kpiOverdue">Rp 0</h3>
                        </div>
                        <div class="p-2 bg-red-50 rounded-lg text-red-600"><i class="fas fa-exclamation-circle"></i>
                        </div>
                    </div>
                    <p class="mt-3 text-[10px] font-bold text-red-400 bg-red-50 inline-block px-2 py-1 rounded">
                        PRIORITAS PEMBAYARAN</p>
                </div>

                <div class="glass-panel p-5 border-l-4 border-orange-400">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Akan Jatuh Tempo (7 Hari)</p>
                            <h3 class="text-2xl font-black text-orange-600 mt-1" id="kpiDueSoon">Rp 0</h3>
                        </div>
                        <div class="p-2 bg-orange-50 rounded-lg text-orange-600"><i class="fas fa-clock"></i></div>
                    </div>
                    <div class="mt-3 text-xs text-slate-500">Persiapkan Cashflow</div>
                </div>

                <div class="glass-panel p-5 border-l-4 border-emerald-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Hutang Lancar (>30 Hari)</p>
                            <h3 class="text-2xl font-black text-emerald-600 mt-1" id="kpiSafe">Rp 0</h3>
                        </div>
                        <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600"><i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-slate-500">Aman Terkendali</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass-panel p-5 col-span-2">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-indigo-500"></i> Analisa Umur Hutang (Aging Schedule)
                    </h3>
                    <div id="chartAging" class="w-full h-[250px]"></div>
                </div>

                <div class="glass-panel p-5">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <i class="fas fa-users text-indigo-500"></i> Top 5 Vendor Exposure
                    </h3>
                    <div id="chartVendor" class="w-full h-[250px]"></div>
                </div>
            </div>
        </div>

        <!-- VIEW: VENDOR LIST -->
        <div id="view-vendor" class="hidden space-y-6 animate-enter">
            <button onclick="switchApp('menu')"
                class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-bold transition">
                <i class="fas fa-arrow-left"></i> Kembali ke Menu
            </button>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Total Pembelian -->
                <div
                    class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Pembelian</p>
                        <h3 class="text-lg font-black text-slate-800" id="statTotalBeli">Rp 0</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                </div>

                <!-- Total Lunas -->
                <div
                    class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Lunas</p>
                        <h3 class="text-lg font-black text-emerald-600" id="statTotalLunas">Rp 0</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center">
                        <i class="fas fa-check-double"></i>
                    </div>
                </div>

                <!-- Belum Dibayar -->
                <div
                    class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Belum Dibayar</p>
                        <h3 class="text-lg font-black text-red-600" id="statTotalHutang">Rp 0</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-red-50 text-red-600 flex items-center justify-center">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                </div>
            </div>
            <div
                class="glass-panel p-3 sticky top-24 z-40 shadow-sm space-y-3 md:space-y-0 md:flex md:items-center md:gap-4 md:justify-between">

                <!-- SMART FILTER SYSTEM -->
                <div
                    class="flex-1 flex flex-col md:flex-row gap-2 md:items-center bg-slate-50 p-2 rounded-xl border border-slate-200">

                    <!-- 1. Kategori Filter -->
                    <div class="relative min-w-[180px]">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-filter text-indigo-500"></i>
                        </div>
                        <select id="smartFilterCategory" onchange="renderFilterInputs()"
                            class="pl-10 pr-4 py-2 w-full bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 appearance-none cursor-pointer hover:bg-slate-50 transition">
                            <option value="SEARCH">üîç Cari Text (PO/Vendor)</option>
                            <option value="STATUS_PAY">üí≥ Status Pembayaran</option>
                            <option value="DUE_DATE">üìÖ Jatuh Tempo</option>
                            <option value="PO_DATE">üìÑ Tanggal PO</option>
                            <option value="STATUS_TIME">üö® Status Waktu (Overdue)</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                        </div>
                    </div>

                    <!-- 2. Dynamic Inputs Container -->
                    <div id="dynamicFilterInputs" class="flex-1 flex items-center gap-2 w-full">
                        <!-- Default: Search Text -->
                        <div class="relative w-full">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                            <input type="text" id="inpSearch" onkeyup="if(event.key === 'Enter') applySmartFilter()"
                                placeholder="Ketik No. PO, Nama Vendor, atau Proyek..."
                                class="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>

                    <!-- 3. Tombol Terapkan -->
                    <button onclick="applySmartFilter()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg shadow-sm transition transform hover:scale-105"
                        title="Terapkan Filter">
                        <i class="fas fa-search"></i>
                    </button>

                    <!-- Reset -->
                    <button onclick="resetFilters()" class="text-slate-400 hover:text-red-500 p-2 transition"
                        title="Reset Filter">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>

                <!-- ACTIONS & SORT -->
                <div class="flex items-center gap-2 justify-end">

                    <select id="sortBy" onchange="applySmartFilter()"
                        class="bg-white border border-slate-200 text-xs font-bold text-slate-600 py-2 px-3 rounded-lg outline-none focus:border-indigo-500 w-32 md:w-auto">
                        <option value="date_asc">üìÖ Tempo (Terdekat)</option>
                        <option value="date_desc">üìÖ Tempo (Terlama)</option>
                        <option value="amount_desc">üí∞ Nilai (Terbesar)</option>
                        <option value="amount_asc">üí∞ Nilai (Terkecil)</option>
                    </select>

                    <button onclick="downloadPDF()"
                        class="bg-rose-100 hover:bg-rose-200 text-rose-600 px-3 py-2 rounded-lg text-xs font-bold transition flex items-center gap-1">
                        <i class="fas fa-file-pdf"></i>
                    </button>

                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button onclick="switchView('list')" id="btnViewList"
                            class="px-3 py-1.5 rounded text-xs font-bold transition bg-white text-indigo-600 shadow-sm">
                            <i class="fas fa-list"></i>
                        </button>
                        <button onclick="switchView('group')" id="btnViewGroup"
                            class="px-3 py-1.5 rounded text-xs font-bold transition text-slate-500 hover:text-slate-800">
                            <i class="fas fa-layer-group mr-1"></i> Vendor
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass-panel overflow-hidden min-h-[400px]">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead
                            class="bg-slate-50 text-slate-500 font-extrabold uppercase text-[10px] tracking-wider border-b border-slate-200">
                            <tr id="tableHeader">
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="divide-y divide-slate-100 bg-white">
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20">
                    <div class="bg-slate-100 p-4 rounded-full text-slate-300 text-4xl mb-3">
                        <i class="fas fa-search"></i>
                    </div>
                    <p class="text-slate-500 font-bold">Tidak ada data ditemukan</p>
                </div>
            </div>

        </div>

        <!-- VIEW: HUTANG BANK -->
        <div id="view-bank" class="hidden space-y-6 animate-enter">
            <button onclick="switchApp('menu')"
                class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-bold transition">
                <i class="fas fa-arrow-left"></i> Kembali ke Menu
            </button>

            <div class="glass-panel p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i class="fas fa-landmark text-blue-600"></i> Monitoring Hutang Bank
                        </h2>
                        <p class="text-sm text-slate-500">Daftar pinjaman modal kerja & investasi</p>
                    </div>
                    <button onclick="document.getElementById('modalTambahBank').classList.remove('hidden')"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg shadow-blue-200 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> Tambah Hutang
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead
                            class="bg-slate-50 text-slate-500 font-extrabold uppercase text-[10px] tracking-wider border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Nama Bank / No. PK</th>
                                <th class="px-6 py-4 text-center">Jenis</th>
                                <th class="px-6 py-4 text-center">Bunga / Tenor</th>
                                <th class="px-6 py-4 text-right">Plafon (Limit)</th>
                                <th class="px-6 py-4 text-right text-red-600">Sisa Hutang</th>
                                <th class="px-6 py-4 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="bankTableBody" class="divide-y divide-slate-100 bg-white">
                            <!-- Data populated by JS -->
                        </tbody>
                        <tfoot class="bg-slate-50 font-bold text-slate-700">
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-right">Total Exposure:</td>
                                <td class="px-6 py-4 text-right text-red-600" id="totalHutangBank">Rp 0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- MODAL TAMBAH BANK -->
        <div id="modalTambahBank"
            class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm transition-opacity">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-enter">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-slate-800">Catat Hutang Baru</h3>
                    <button onclick="document.getElementById('modalTambahBank').classList.add('hidden')"
                        class="text-slate-400 hover:text-red-500 font-bold text-xl">&times;</button>
                </div>

                <form onsubmit="simpanHutangBank(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Bank</label>
                        <input type="text" name="nama_bank" required placeholder="Contoh: Bank Mandiri"
                            class="w-full border border-slate-300 rounded-lg px-3 py-2 font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jenis Kredit</label>
                            <select name="jenis_pinjaman"
                                class="w-full border border-slate-300 rounded-lg px-3 py-2 font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="KMK">Modal Kerja (KMK)</option>
                                <option value="INVESTASI">Investasi / Term Loan</option>
                                <option value="KUR">KUR</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">No. Perjanjian</label>
                            <input type="text" name="no_perjanjian" required placeholder="No. PK"
                                class="w-full border border-slate-300 rounded-lg px-3 py-2 font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Plafon (Rp)</label>
                            <input type="number" name="plafon_limit" required
                                class="w-full border border-slate-300 rounded-lg px-3 py-2 font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bunga (% p.a)</label>
                            <input type="number" step="0.01" name="bunga_persen" required
                                class="w-full border border-slate-300 rounded-lg px-3 py-2 font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tenor (Bulan)</label>
                            <input type="number" name="tenor_bulan" required
                                class="w-full border border-slate-300 rounded-lg px-3 py-2 font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tanggal Akad</label>
                            <input type="date" name="tanggal_akad" required
                                class="w-full border border-slate-300 rounded-lg px-3 py-2 font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition mt-4">
                        <i class="fas fa-save mr-2"></i> Simpan Data
                    </button>
                </form>
            </div>
        </div>
    </main>



    <script>
        // --- VARIABLES ---
        let rawData = [];
        let filteredData = [];
        let currentView = 'list';
        let chartAgingInstance = null;
        let chartVendorInstance = null;
        let client = null;

        // --- NAVIGATION (Defined FIRST so it always exists) ---
        window.switchApp = function (appName) {
            // Safety Check
            if (!client && appName !== 'menu') {
                alert("Koneksi database belum siap. Coba refresh halaman.");
                return;
            }

            // Hide All
            ['view-menu', 'view-overview', 'view-vendor', 'view-bank'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // Show Target
            const target = document.getElementById(`view-${appName}`);
            if (target) target.classList.remove('hidden');

            // Logic per View
            if (appName === 'overview') {
                setTimeout(() => {
                    if (chartAgingInstance) chartAgingInstance.updateOptions({});
                    if (chartVendorInstance) chartVendorInstance.updateOptions({});
                }, 100);
            }
            if (appName === 'bank') {
                if (typeof refreshBankData === 'function') refreshBankData();
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 1. Check Config
                if (typeof activeConfig === 'undefined' || typeof supabase === 'undefined') {
                    throw new Error("Library / Config gagal dimuat.");
                }

                // 2. Init Client
                const supabaseUrl = activeConfig.URL;
                const supabaseKey = activeConfig.KEY;
                client = supabase.createClient(supabaseUrl, supabaseKey);

                // 3. Load Data
                await refreshData();

            } catch (err) {
                console.error("Critical Init Error:", err);
                alert("Sistem Error: " + err.message + "\nPeriksa koneksi internet Anda.");

                // Show Error visual
                document.body.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-screen text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <h1 class="text-xl font-bold">Gagal Memuat Aplikasi</h1>
                        <p>${err.message}</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-slate-200 rounded text-black font-bold">Coba Lagi</button>
                    </div>
                `;
            }
        });




        // --- CORE FUNCTIONS (Updated) ---


        // --- MODUL HUTANG BANK ---
        async function refreshBankData() {
            const tbody = document.getElementById('bankTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-400">Loading data...</td></tr>';

            const { data, error } = await client.from('hutang_bank').select('*').order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500 font-bold">Gagal mengambil data</td></tr>';
                return;
            }

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-400">Belum ada data hutang bank.</td></tr>';
                document.getElementById('totalHutangBank').innerText = "Rp 0";
                return;
            }

            let totalExposure = 0;
            tbody.innerHTML = '';

            data.forEach(item => {
                totalExposure += (item.sisa_hutang || 0);

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-50 last:border-none transition";
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-700">${item.nama_bank}</div>
                        <div class="text-xs text-slate-500 font-mono">${item.no_perjanjian}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-bold">${item.jenis_pinjaman}</span>
                    </td>
                    <td class="px-6 py-4 text-center text-xs font-bold text-slate-600">
                        <div>Bunga: ${item.bunga_persen}%</div>
                        <div class="text-slate-400">${item.tenor_bulan} Bulan</div>
                    </td>
                    <td class="px-6 py-4 text-right font-bold text-slate-500 text-xs">
                        ${fmt(item.plafon_limit)}
                    </td>
                    <td class="px-6 py-4 text-right font-black text-red-600 text-sm">
                        ${fmt(item.sisa_hutang)}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-1 rounded text-[10px] font-bold ${item.status === 'AKTIF' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'}">
                            ${item.status}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('totalHutangBank').innerText = fmt(totalExposure);
        }

        async function simpanHutangBank(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const rawData = Object.fromEntries(formData.entries());

            // Convert numeric
            const payload = {
                ...rawData,
                plafon_limit: Number(rawData.plafon_limit),
                bunga_persen: Number(rawData.bunga_persen),
                tenor_bulan: Number(rawData.tenor_bulan),
                sisa_hutang: Number(rawData.plafon_limit), // Default sisa = plafon
                status: 'AKTIF'
            };

            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            btn.disabled = true;

            try {
                const { error } = await client.from('hutang_bank').insert([payload]);
                if (error) throw error;

                alert("‚úÖ Berhasil menyimpan data hutang!");
                document.getElementById('modalTambahBank').classList.add('hidden');
                form.reset();
                refreshBankData();

            } catch (err) {
                alert("‚ùå Gagal simpan: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function refreshData() {
            const btn = document.querySelector('.fa-sync-alt');
            if (btn) btn.classList.add('fa-spin');

            // Asumsi: View database Anda bernama ap_monitoring_vw
            // Kolom yang diharapkan: nomor_po, nama_vendor, nama_proyek, tanggal_po, jatuh_tempo, total_tagihan, status_po
            const { data, error } = await client
                .from('ap_monitoring_vw')
                .select('*');

            if (error) {
                console.error("Error loading data:", error);
                alert("Gagal memuat data hutang. Periksa koneksi.");
            } else {
                rawData = data || [];
                // Pre-calculate aging fields for faster filtering
                const today = new Date();
                rawData = rawData.map(item => {
                    const today = new Date();
                    const jt = new Date(item.jatuh_tempo);
                    const diffTime = jt - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    let status = 'SAFE';
                    let bucket = '> 60 Hari';

                    if (diffDays < 0) { status = 'OVERDUE'; bucket = 'Overdue'; }
                    else if (diffDays <= 7) { status = 'WARNING'; bucket = '0 - 7 Hari'; }
                    else if (diffDays <= 30) { status = 'SAFE'; bucket = '8 - 30 Hari'; }
                    else if (diffDays <= 60) { status = 'SAFE'; bucket = '31 - 60 Hari'; }

                    // --- FALLBACK RECOVERY & CLEANING ---
                    let recoveredFile = item.file_nota;

                    // 1. Clean if it contains legacy prefix "Nota:" (Common in old data)
                    if (recoveredFile && typeof recoveredFile === 'string' && recoveredFile.includes('Nota:')) {
                        try {
                            const parts = recoveredFile.split('|')[0];
                            recoveredFile = parts.replace('Nota:', '').trim();
                        } catch (e) { }
                    }

                    // 2. If still empty, try to fetch from keteangan
                    if (!recoveredFile && item.keterangan && item.keterangan.includes('Nota:')) {
                        try {
                            const parts = item.keterangan.split('|')[0];
                            recoveredFile = parts.replace('Nota:', '').trim();
                        } catch (e) {
                            console.warn("Failed to recover file from keterangan", e);
                        }
                    }

                    // Logic Bayar
                    const isLunas = item.status_po === 'LUNAS';
                    const bayarStatus = isLunas ? 'LUNAS' : 'BELUM_LUNAS';

                    // Use recoveredFile instead of item.file_nota
                    return {
                        ...item,
                        file_nota: recoveredFile,
                        _diffDays: diffDays,
                        _status: status,
                        _bucket: bucket,
                        _bayar: bayarStatus
                    };
                });

                applyFilters();
            }

            if (btn) btn.classList.remove('fa-spin');
        }

        // --- PAYMENT LOGIC ---
        let currentPayPO = null;
        let currentPayAmount = 0;

        async function markInvoicePaid(poNumber) {
            // Find data locally first to get amount
            const item = filteredData.find(d => d.nomor_po === poNumber);
            if (!item) return alert("Data tidak ditemukan.");

            currentPayPO = poNumber;
            currentPayAmount = item.total_tagihan || 0;

            // UI Setup
            document.getElementById('paySubtitle').innerText = `Pembayaran Tagihan: ${poNumber}`;
            document.getElementById('payAmount').innerText = fmt(currentPayAmount);
            document.getElementById('modalBayar').classList.remove('hidden');

            // Generate Accounts if empty
            const selInfo = document.getElementById('payAccount');
            if (selInfo.options.length <= 1) {
                await loadBankAccounts();
            }
        }

        function tutupModalBayar() {
            document.getElementById('modalBayar').classList.add('hidden');
            document.getElementById('payRef').value = '';
            document.getElementById('payMethod').value = 'BANK';
            togglePayInput();
        }

        function togglePayInput() {
            const method = document.getElementById('payMethod').value;
            const secBank = document.getElementById('secBank');
            const secCek = document.getElementById('secCek');

            if (method === 'BANK' || method === 'CASH') {
                secBank.classList.remove('hidden');
                secCek.classList.add('hidden');
            } else {
                secBank.classList.add('hidden');
                secCek.classList.remove('hidden');
            }
        }

        async function loadBankAccounts() {
            const select = document.getElementById('payAccount');
            select.innerHTML = '<option value="">Memuat data...</option>';

            try {
                // FETCH COA: Aset Lancar (Bank & Kas)
                const { data: akunData, error } = await client
                    .from('master_akun')
                    .select('kode_akun, nama_akun')
                    .eq('kategori', 'Aset Lancar')
                    .order('kode_akun', { ascending: true });

                select.innerHTML = '<option value="">-- Pilih Akun Bank / Kas --</option>';

                if (!error && akunData && akunData.length > 0) {
                    akunData.forEach(acc => {
                        const opt = document.createElement('option');
                        opt.value = acc.nama_akun;
                        opt.innerText = `${acc.kode_akun} - ${acc.nama_akun}`;
                        select.appendChild(opt);
                    });
                } else {
                    // Fallback
                    const generics = ['Bank BCA', 'Bank Mandiri', 'Bank BNI', 'Kas Besar', 'Kas Kecil'];
                    generics.forEach(g => {
                        const opt = document.createElement('option');
                        opt.value = g;
                        opt.innerText = g;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error("Load Bank Error:", e);
                select.innerHTML = '<option value="MANUAL">Input Manual di Keterangan</option>';
            }
        }

        async function prosesBayar() {
            if (!currentPayPO) return;

            const method = document.getElementById('payMethod').value;
            let detailBayar = '';
            let isCek = false;
            let bankSumber = '';
            let refNomor = '';

            if (method === 'BANK' || method === 'CASH') {
                const acc = document.getElementById('payAccount').value;
                if (!acc) return alert("Pilih Akun Sumber Dana terlebih dahulu!");
                detailBayar = `${method}: ${acc}`;
                bankSumber = acc;
            } else {
                isCek = true;
                const ref = document.getElementById('payRef').value;
                if (!ref) return alert("Isi Nomor Register Cek/BG!");
                detailBayar = `${method}: ${ref}`;
                refNomor = ref;
                bankSumber = 'Cek/BG (Pending)';
            }

            if (!confirm(`Konfirmasi Pembayaran?\n\nPO: ${currentPayPO}\nMetode: ${detailBayar}\nNominal: ${fmt(currentPayAmount)}\n\nLanjutkan?`)) return;

            const btn = document.getElementById('btnProsesBayar');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
            btn.disabled = true;

            try {
                // 1. UPDATE Status PO ke LUNAS
                const { error: errUpdate } = await client
                    .from('purchase_order')
                    .update({
                        status_po: 'LUNAS',
                        updated_at: new Date(),
                        keterangan: `LUNAS (${new Date().toLocaleDateString('id-ID')}). ${detailBayar}`
                    })
                    .eq('nomor_po', currentPayPO);

                if (errUpdate) throw errUpdate;

                // 2. INSERT KE TABLE TRANSAKSI
                // Fetch Vendor Name
                const currentItem = filteredData.find(d => d.nomor_po === currentPayPO);
                const vendorName = currentItem ? currentItem.nama_vendor : 'Vendor';

                let ketTrans = `Pembayaran PO ${currentPayPO} - ${vendorName}`;

                // Logic Formatting for Monitoring Cek
                if (isCek) {
                    ketTrans = `${vendorName} (Ref: ${refNomor})`; // Format required by monitoring_cek.html
                }

                const payloadTrans = {
                    tanggal: new Date(),
                    keterangan: ketTrans,
                    jumlah: currentPayAmount,
                    jenis_transaksi: 'KELUAR',
                    bank_sumber: bankSumber,
                    kode_akun: '2-1100', // Hutang Usaha / Generic
                    no_bukti: currentPayPO
                };

                const { error: errTrans } = await client.from('transaksi').insert([payloadTrans]);
                if (errTrans) {
                    console.warn("Gagal insert transaksi:", errTrans);
                    alert("‚ö†Ô∏è PO Lunas, tapi gagal catat di Cashflow/Cek.\nError: " + errTrans.message);
                } else {
                    alert("‚úÖ Pembayaran Berhasil Disimpan & Dicatat di Pembukuan!");
                }

                tutupModalBayar();
                refreshData();

            } catch (err) {
                console.error("Payment Error:", err);
                alert("Gagal memproses pembayaran: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function deleteInvoice(poNumber) {
            if (!confirm(`‚ö†Ô∏è PERINGATAN HAPUS\n\nAnda yakin ingin MENGHAPUS PERMANEN Tagihan ${poNumber}?\nData yang dihapus tidak bisa dikembalikan.\n\nLanjutkan menghapus?`)) return;

            try {
                const { error } = await client
                    .from('purchase_order')
                    .delete()
                    .eq('nomor_po', poNumber);

                if (error) throw error;

                alert("‚úÖ Berhasil! Tagihan telah dihapus.");
                refreshData(); // Refresh list

            } catch (err) {
                console.error("Error delete:", err);
                alert("Gagal menghapus: " + err.message);
            }
        }



        // --- SMART FILTER SYSTEM ---

        const smartFilterConfig = {
            'SEARCH': {
                placeholder: 'Ketik No. PO, Nama Vendor, atau Proyek...',
                html: `<div class="relative w-full">
                        <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                        <input type="text" id="inpSearch" onkeyup="if(event.key === 'Enter') applySmartFilter()" 
                            placeholder="Ketik No. PO, Nama Vendor, atau Proyek..." 
                            class="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                       </div>`
            },
            'STATUS_PAY': {
                html: `<select id="inpStatusPay" onchange="applySmartFilter()" class="w-full py-2 px-3 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="ALL">üìÇ Semua Status Bayar</option>
                        <option value="BELUM_LUNAS">‚≠ï Belum Lunas</option>
                        <option value="LUNAS">‚úÖ Sudah Lunas</option>
                       </select>`
            },
            'DUE_DATE': {
                html: `<div class="flex items-center gap-2 w-full">
                        <input type="date" id="inpStartDate" class="w-1/2 py-2 px-3 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                        <span class="font-bold text-slate-400">-</span>
                        <input type="date" id="inpEndDate" class="w-1/2 py-2 px-3 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                       </div>`
            },
            'PO_DATE': {
                html: `<div class="flex items-center gap-2 w-full">
                        <input type="date" id="inpStartDate" class="w-1/2 py-2 px-3 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                        <span class="font-bold text-slate-400">-</span>
                        <input type="date" id="inpEndDate" class="w-1/2 py-2 px-3 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                       </div>`
            },
            'STATUS_TIME': {
                html: `<select id="inpStatusTime" onchange="applySmartFilter()" class="w-full py-2 px-3 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="ALL">üìÇ Semua Status Waktu</option>
                        <option value="OVERDUE">üî¥ Terlambat (Overdue)</option>
                        <option value="WARNING">üü† Segera Jatuh Tempo (Warning)</option>
                        <option value="SAFE">üü¢ Aman (Safe)</option>
                       </select>`
            }
        };

        function renderFilterInputs() {
            const cat = document.getElementById('smartFilterCategory').value;
            const container = document.getElementById('dynamicFilterInputs');
            const config = smartFilterConfig[cat];

            if (config) {
                container.innerHTML = config.html;
                // Animate entry
                container.classList.remove('animate-fade-in-down');
                void container.offsetWidth; // trigger reflow
                container.classList.add('animate-fade-in-down');
            }
        }

        function resetFilters() {
            document.getElementById('smartFilterCategory').value = 'SEARCH';
            renderFilterInputs();
            applySmartFilter();
        }

        function applySmartFilter() {
            const cat = document.getElementById('smartFilterCategory').value;
            const sortType = document.getElementById('sortBy').value;

            // 1. Filtering Logic
            filteredData = rawData.filter(item => {
                let match = true;

                if (cat === 'SEARCH') {
                    const keyword = (document.getElementById('inpSearch')?.value || '').toLowerCase();
                    match = (item.nomor_po || '').toLowerCase().includes(keyword) ||
                        (item.nama_vendor || '').toLowerCase().includes(keyword) ||
                        (item.nama_proyek || '').toLowerCase().includes(keyword);
                }
                else if (cat === 'STATUS_PAY') {
                    const val = document.getElementById('inpStatusPay').value;
                    if (val !== 'ALL') match = (item._bayar === val);
                }
                else if (cat === 'STATUS_TIME') {
                    const val = document.getElementById('inpStatusTime').value;
                    if (val !== 'ALL') match = (item._status === val);
                }
                else if (cat === 'DUE_DATE' || cat === 'PO_DATE') {
                    const startRaw = document.getElementById('inpStartDate').value;
                    const endRaw = document.getElementById('inpEndDate').value;

                    if (startRaw || endRaw) {
                        // DUE_DATE -> jatuh_tempo, PO_DATE -> tanggal_po
                        const dateRef = cat === 'DUE_DATE' ? item.jatuh_tempo : item.tanggal_po;
                        if (!dateRef) {
                            match = false;
                        } else {
                            const d = new Date(dateRef); d.setHours(0, 0, 0, 0);

                            if (startRaw) {
                                const s = new Date(startRaw); s.setHours(0, 0, 0, 0);
                                if (d < s) match = false;
                            }
                            if (endRaw) {
                                const e = new Date(endRaw); e.setHours(0, 0, 0, 0);
                                if (d > e) match = false;
                            }
                        }
                    }
                }

                return match;
            });

            // 2. Sorting
            filteredData.sort((a, b) => {
                if (sortType === 'date_asc') return new Date(a.jatuh_tempo) - new Date(b.jatuh_tempo);
                if (sortType === 'date_desc') return new Date(b.jatuh_tempo) - new Date(a.jatuh_tempo);
                if (sortType === 'amount_desc') return b.total_tagihan - a.total_tagihan;
                if (sortType === 'amount_asc') return a.total_tagihan - b.total_tagihan;
                return 0;
            });

            // 3. Stats Calculation (Always reflects current VIEWED data)
            const totalBeli = filteredData.reduce((sum, item) => sum + (item.total_tagihan || 0), 0);
            const totalLunas = filteredData.filter(i => i._bayar === 'LUNAS').reduce((sum, item) => sum + (item.total_tagihan || 0), 0);
            const totalHutang = filteredData.filter(i => i._bayar !== 'LUNAS').reduce((sum, item) => sum + (item.total_tagihan || 0), 0);

            document.getElementById('statTotalBeli').innerText = fmt(totalBeli);
            document.getElementById('statTotalLunas').innerText = fmt(totalLunas);
            document.getElementById('statTotalHutang').innerText = fmt(totalHutang);

            updateKPIs();
            renderCharts();
            renderTable();
        }

        // Legacy support alias if needed, or simply replaced.
        const applyFilters = applySmartFilter;



        // --- RENDERING ---

        function updateKPIs() {
            let total = 0, overdue = 0, warning = 0, safe = 0;

            filteredData.forEach(d => {
                const val = d.total_tagihan || 0;
                total += val;
                if (d._status === 'OVERDUE') overdue += val;
                if (d._status === 'WARNING') warning += val;
                if (d._diffDays > 30) safe += val;
            });

            document.getElementById('kpiTotal').innerText = fmt(total);
            document.getElementById('kpiOverdue').innerText = fmt(overdue);
            document.getElementById('kpiDueSoon').innerText = fmt(warning);
            document.getElementById('kpiSafe').innerText = fmt(safe);
            document.getElementById('kpiCount').innerText = filteredData.length;
        }

        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            const thead = document.getElementById('tableHeader');
            const empty = document.getElementById('emptyState');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            if (currentView === 'list') {
                // Header List
                thead.innerHTML = `
                    <th class="px-6 py-4">PO Info</th>
                    <th class="px-6 py-4">Proyek</th>
                    <th class="px-6 py-4">Tanggal</th>
                    <th class="px-6 py-4 text-center">Jatuh Tempo</th>
                    <th class="px-6 py-4 text-center">Umur (Hari)</th>
                    <th class="px-6 py-4 text-right">Nilai Tagihan</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4 text-center">Aksi / Bukti</th>
                `;

                filteredData.forEach(item => {
                    const statusConfig = {
                        'OVERDUE': { bg: 'bg-red-100', text: 'text-red-700', label: 'TERLAMBAT' },
                        'WARNING': { bg: 'bg-orange-100', text: 'text-orange-700', label: 'SEGERA' },
                        'SAFE': { bg: 'bg-emerald-100', text: 'text-emerald-700', label: 'AMAN' }
                    };

                    let s = statusConfig[item._status];
                    // Override badge if LUNAS
                    if (item._bayar === 'LUNAS') {
                        s = { bg: 'bg-emerald-600', text: 'text-white', label: 'LUNAS' };
                    }

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition animate-enter border-b border-slate-50 last:border-none";

                    // Button Logic
                    const btnLunasClass = item._bayar === 'LUNAS'
                        ? 'bg-slate-100 text-slate-300 border-slate-100 cursor-not-allowed'
                        : 'bg-emerald-50 text-emerald-600 hover:bg-emerald-100 hover:text-emerald-700 border-emerald-100';

                    const btnLunasAction = item._bayar === 'LUNAS' ? '' : `onclick="markInvoicePaid('${item.nomor_po}')"`;

                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-700">${item.nama_vendor}</div>
                            <div class="text-[11px] text-indigo-500 font-mono font-bold flex items-center gap-2">
                                <i class="fas fa-file-contract"></i> ${item.nomor_po}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded inline-block">
                                ${item.nama_proyek || '-'}
                            </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-col gap-1 text-[11px]">
                                <div class="text-slate-600">
                                    <span class="font-bold text-slate-400 w-8 inline-block">PO:</span> 
                                    ${item.tanggal_po ? new Date(item.tanggal_po).toLocaleDateString('id-ID') : '-'}
                                </div>
                                <div class="text-slate-600">
                                    <span class="font-bold text-slate-400 w-8 inline-block">GRN:</span> 
                                    ${item.updated_at ? new Date(item.updated_at).toLocaleDateString('id-ID') : '-'}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center text-xs font-bold text-slate-600">
                            ${new Date(item.jatuh_tempo).toLocaleDateString('id-ID')}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="font-mono font-bold text-xs ${item._diffDays < 0 ? 'text-red-600' : 'text-slate-600'}">
                                ${item._diffDays} Hari
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right font-black text-slate-700 text-sm">
                            ${fmt(item.total_tagihan)}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-[10px] font-extrabold tracking-wide ${s.bg} ${s.text}">
                                ${s.label}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-center gap-2">
                                <!-- Cek Dokumen -->
                                <button onclick="bukaModalDokumen('${item.nomor_po}', '${item.nama_vendor}', '${item.file_po || ''}', '${item.file_nota || ''}')" 
                                        class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:text-indigo-700 flex items-center justify-center transition shadow-sm border border-indigo-100"
                                        title="Cek Dokumen & Bukti">
                                        <i class="fas fa-paperclip text-sm"></i>
                                </button>

                                <!-- Set Lunas -->
                                <button ${btnLunasAction} 
                                        class="w-8 h-8 rounded-lg ${btnLunasClass} flex items-center justify-center transition shadow-sm border"
                                        title="${item._bayar === 'LUNAS' ? 'Sudah Lunas' : 'Tandai Status LUNAS'}">
                                        <i class="fas fa-check text-sm"></i>
                                </button>

                                <!-- Hapus -->
                                <button onclick="deleteInvoice('${item.nomor_po}')" 
                                        class="w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 flex items-center justify-center transition shadow-sm border border-red-100"
                                        title="Hapus Tagihan Permanen">
                                        <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                // Header Group (Vendor Summary)
                thead.innerHTML = `
                    <th class="px-6 py-4">Vendor</th>
                    <th class="px-6 py-4 text-center">Jumlah PO</th>
                    <th class="px-6 py-4 text-right">Total Hutang</th>
                    <th class="px-6 py-4 text-right text-red-600">Total Overdue</th>
                    <th class="px-6 py-4 text-center">Aksi</th>
                `;

                // Group logic
                const groups = {};
                filteredData.forEach(item => {
                    const v = item.nama_vendor;
                    if (!groups[v]) groups[v] = { name: v, total: 0, count: 0, overdue: 0 };
                    groups[v].total += item.total_tagihan;
                    groups[v].count += 1;
                    if (item._status === 'OVERDUE') groups[v].overdue += item.total_tagihan;
                });

                // Convert to array and sort by total
                const groupArr = Object.values(groups).sort((a, b) => b.total - a.total);

                groupArr.forEach(g => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition animate-enter";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-bold text-slate-700">${g.name}</td>
                        <td class="px-6 py-4 text-center text-xs font-bold bg-slate-50/50">${g.count} Transaksi</td>
                        <td class="px-6 py-4 text-right font-black text-indigo-900">${fmt(g.total)}</td>
                        <td class="px-6 py-4 text-right font-bold text-red-600">${g.overdue > 0 ? fmt(g.overdue) : '-'}</td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="filterByVendor('${g.name}')" class="text-xs bg-white border border-slate-200 text-indigo-600 px-3 py-1 rounded hover:bg-indigo-50 font-bold transition">
                                Detail
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function renderCharts() {
            // 1. Prepare Aging Data
            const buckets = { 'Overdue': 0, '0-30 Hari': 0, '31-60 Hari': 0, '> 60 Hari': 0 };
            filteredData.forEach(d => {
                if (d._diffDays < 0) buckets['Overdue'] += d.total_tagihan;
                else if (d._diffDays <= 30) buckets['0-30 Hari'] += d.total_tagihan;
                else if (d._diffDays <= 60) buckets['31-60 Hari'] += d.total_tagihan;
                else buckets['> 60 Hari'] += d.total_tagihan;
            });

            // 2. Prepare Vendor Data (Top 5)
            const vendorMap = {};
            filteredData.forEach(d => vendorMap[d.nama_vendor] = (vendorMap[d.nama_vendor] || 0) + d.total_tagihan);
            const topVendors = Object.entries(vendorMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // --- ApexCharts Config ---

            // Chart Aging (Bar)
            const agingOptions = {
                series: [{ name: 'Total Nilai', data: Object.values(buckets) }],
                chart: { type: 'bar', height: 250, toolbar: { show: false }, fontFamily: 'Plus Jakarta Sans' },
                colors: ['#ef4444', '#f97316', '#3b82f6', '#10b981'],
                plotOptions: { bar: { borderRadius: 4, columnWidth: '50%', distributed: true } },
                dataLabels: { enabled: false },
                xaxis: { categories: Object.keys(buckets), labels: { style: { fontWeight: 700 } } },
                yaxis: { labels: { formatter: (val) => new Intl.NumberFormat('id-ID', { notation: "compact" }).format(val) } },
                legend: { show: false },
                tooltip: { y: { formatter: (val) => fmt(val) } }
            };

            // Chart Vendor (Donut)
            const vendorOptions = {
                series: topVendors.map(v => v[1]),
                labels: topVendors.map(v => v[0]),
                chart: { type: 'donut', height: 250, fontFamily: 'Plus Jakarta Sans' },
                colors: ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#0ea5e9'],
                plotOptions: { pie: { donut: { size: '65%', labels: { show: true, total: { show: true, label: 'Top 5', formatter: () => '' } } } } },
                dataLabels: { enabled: false },
                legend: { position: 'bottom', fontSize: '10px' },
                tooltip: { y: { formatter: (val) => fmt(val) } }
            };

            // Render / Update
            if (chartAgingInstance) { chartAgingInstance.updateOptions(agingOptions); }
            else {
                chartAgingInstance = new ApexCharts(document.querySelector("#chartAging"), agingOptions);
                chartAgingInstance.render();
            }

            if (chartVendorInstance) { chartVendorInstance.updateOptions(vendorOptions); }
            else {
                chartVendorInstance = new ApexCharts(document.querySelector("#chartVendor"), vendorOptions);
                chartVendorInstance.render();
            }

        }

        // --- PDF DOWNLOAD ---
        function downloadPDF() {
            if (!filteredData || filteredData.length === 0) {
                alert("Tidak ada data untuk di-download.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

            // Header
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Laporan Monitoring Hutang Vendor", 14, 20);

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')}`, 14, 26);
            doc.text(`Total Baris: ${filteredData.length} data`, 14, 31);

            // Table Columns
            const columns = ["Vendor", "No. PO", "Proyek", "Jatuh Tempo", "Umur", "Status", "Tagihan (Rp)"];

            // Table Rows
            const rows = filteredData.map(item => [
                item.nama_vendor,
                item.nomor_po,
                item.nama_proyek || '-',
                new Date(item.jatuh_tempo).toLocaleDateString('id-ID'),
                `${item._diffDays} Hari`,
                item._status === 'OVERDUE' ? 'OVERDUE' : (item._bayar === 'LUNAS' ? 'LUNAS' : item._status),
                fmt(item.total_tagihan)
            ]);

            // Summary Footer
            let totalTagihan = filteredData.reduce((sum, item) => sum + (item.total_tagihan || 0), 0);
            rows.push(["", "", "", "", "", "TOTAL", fmt(totalTagihan)]);

            // Generate Table
            doc.autoTable({
                head: [columns],
                body: rows,
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229], textColor: 255, fontStyle: 'bold' }, // Indigo-600
                alternateRowStyles: { fillColor: [248, 250, 252] },
                styles: { fontSize: 8, cellPadding: 3 },
                columnStyles: {
                    6: { halign: 'right', fontStyle: 'bold' } // Kolom Tagihan rata kanan
                },
                didParseCell: function (data) {
                    // Highlight Overdue Rows
                    if (data.section === 'body' && data.row.raw[5] === 'OVERDUE') {
                        data.cell.styles.textColor = [220, 38, 38]; // Red
                    }
                    // Highlight Total Row
                    if (data.section === 'body' && data.row.index === rows.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [241, 245, 249];
                    }
                }
            });

            // Save
            doc.save(`Laporan_Hutang_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // --- UI INTERACTION ---

        function switchView(view) {
            currentView = view;
            const btnList = document.getElementById('btnViewList');
            const btnGroup = document.getElementById('btnViewGroup');

            if (view === 'list') {
                btnList.className = "px-3 py-1.5 rounded text-xs font-bold transition bg-white text-indigo-600 shadow-sm";
                btnGroup.className = "px-3 py-1.5 rounded text-xs font-bold transition text-slate-500 hover:text-slate-800";
            } else {
                btnGroup.className = "px-3 py-1.5 rounded text-xs font-bold transition bg-white text-indigo-600 shadow-sm";
                btnList.className = "px-3 py-1.5 rounded text-xs font-bold transition text-slate-500 hover:text-slate-800";
            }
            renderTable();
        }

        function filterByVendor(vendorName) {
            document.getElementById('searchInput').value = vendorName;
            switchView('list');
            applyFilters();
        }

        // --- INIT ---
        // document.addEventListener('DOMContentLoaded', init); // Moved to top


        let currentDocPO = '';
        let currentDocNota = '';

        function bukaModalDokumen(noPO, vendor, filePO, fileNota) {
            document.getElementById('docTitle').innerText = `Verifikasi Dokumen: ${vendor}`;
            document.getElementById('docSubtitle').innerText = `No. Referensi: ${noPO}`;

            currentDocPO = filePO;
            currentDocNota = fileNota;

            document.getElementById('modalDokumen').classList.remove('hidden');
            switchTab('PO');
        }

        function tutupModalDokumen() {
            document.getElementById('modalDokumen').classList.add('hidden');
            document.getElementById('docFrame').src = '';
            document.getElementById('docImage').src = '';
        }

        function switchTab(jenis) {
            const tabPO = document.getElementById('tabPO');
            const tabNota = document.getElementById('tabNota');

            if (jenis === 'PO') {
                tabPO.className = "px-4 py-2 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600 transition bg-indigo-50/50";
                tabNota.className = "px-4 py-2 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition";
                renderDokumen(currentDocPO);
            } else {
                tabNota.className = "px-4 py-2 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600 transition bg-indigo-50/50";
                tabPO.className = "px-4 py-2 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition";
                renderDokumen(currentDocNota);
            }
        }

        function renderDokumen(filePath) {
            const frame = document.getElementById('docFrame');
            const img = document.getElementById('docImage');
            const empty = document.getElementById('docEmpty');
            const emptyText = document.getElementById('docEmptyText');
            const btnDown = document.getElementById('btnDownload');
            const loader = document.getElementById('loaderDoc');
            const defaultMessage = 'Dokumen tidak dilampirkan';

            frame.classList.add('hidden');
            img.classList.add('hidden');
            emptyText.innerText = defaultMessage;
            empty.classList.add('hidden');
            loader.classList.add('hidden');
            btnDown.classList.add('hidden');

            console.log("DEBUG RENDER: ", filePath);
            if (!filePath || filePath === 'null' || filePath === 'undefined' || filePath.trim() === '') {
                // alert("DEBUG: File Path is EMPTY (" + filePath + ")"); 
                emptyText.innerText = `File tidak ditemukan (Path: ${filePath})`;
                empty.classList.remove('hidden');
                return;
            }

            loader.classList.remove('hidden');
            btnDown.classList.remove('hidden');
            btnDown.href = '#';

            let publicUrl = '';
            // CHECK IF IT IS ALREADY A FULL URL (ImageKit / External)
            if (filePath.startsWith('http://') || filePath.startsWith('https://')) {
                publicUrl = filePath;
            } else {
                // FALLBACK: Legacy Supabase Storage
                // Assuming 'nota grn' bucket for backward compatibility. 
                // Note: PO files might be in a different bucket ('purchase_orders'?), 
                // but currently the code forced 'nota grn' for everything. 
                // Ideally we should distinguish, but let's fix the Nota display first.
                publicUrl = client.storage.from('nota grn').getPublicUrl(filePath).data.publicUrl;
            }

            console.log("Resolved URL:", publicUrl);
            btnDown.href = publicUrl;

            const ext = filePath.split('.').pop().toLowerCase();

            setTimeout(() => {
                loader.classList.add('hidden');
                if (ext === 'pdf') {
                    frame.src = publicUrl;
                    frame.classList.remove('hidden');
                } else if (['jpg', 'jpeg', 'png', 'webp'].includes(ext)) {
                    img.src = publicUrl;
                    img.classList.remove('hidden');
                } else {
                    emptyText.innerText = 'Format file tidak didukung preview.';
                    empty.classList.remove('hidden');
                }
            }, 500);
        }

    </script>

    <div id="modalDokumen"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm transition-opacity">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden animate-enter">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="font-bold text-lg text-slate-800" id="docTitle">Verifikasi Dokumen</h3>
                    <p class="text-xs text-slate-500" id="docSubtitle">No. PO: -</p>
                </div>
                <button onclick="tutupModalDokumen()"
                    class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:bg-red-50 transition flex items-center justify-center font-bold">‚úï</button>
            </div>

            <div class="flex border-b border-slate-200 bg-white px-4 pt-2 gap-2">
                <button onclick="switchTab('PO')" id="tabPO"
                    class="px-4 py-2 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600 transition">
                    <i class="fas fa-file-contract mr-2"></i>Purchase Order (PO)
                </button>
                <button onclick="switchTab('NOTA')" id="tabNota"
                    class="px-4 py-2 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>Nota / Invoice
                </button>
            </div>

            <div class="flex-grow bg-slate-100 p-4 relative flex justify-center items-center overflow-hidden">
                <div id="loaderDoc" class="hidden absolute inset-0 flex items-center justify-center bg-slate-100 z-10">
                    <i class="fas fa-circle-notch fa-spin text-3xl text-indigo-500"></i>
                </div>

                <iframe id="docFrame" class="w-full h-full rounded-lg shadow-sm bg-white border hidden" src=""></iframe>
                <img id="docImage" class="h-full w-auto object-contain rounded-lg shadow-sm hidden" src="">

                <div id="docEmpty" class="text-center">
                    <div
                        class="bg-slate-200 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400 text-2xl">
                        <i class="fas fa-file-slash"></i>
                    </div>
                    <p id="docEmptyText" class="text-slate-500 font-bold">Dokumen tidak dilampirkan</p>
                </div>
            </div>

            <div class="p-4 border-t bg-white flex justify-between items-center">
                <p class="text-xs text-slate-400 italic">*Pastikan nominal dan item sesuai sebelum membayar.</p>
                <a id="btnDownload" href="#" target="_blank"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 flex items-center gap-2">
                    <i class="fas fa-download"></i> Unduh File Asli
                </a>
            </div>
        </div>
    </div>

    <!-- MODAL PEMBAYARAN -->
    <div id="modalBayar"
        class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-enter">
            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                <div>
                    <h3 class="font-bold text-lg text-slate-800">Konfirmasi Pembayaran</h3>
                    <p class="text-xs text-slate-500" id="paySubtitle">PO: -</p>
                </div>
                <button onclick="tutupModalBayar()"
                    class="text-slate-400 hover:text-red-500 font-bold text-xl">&times;</button>
            </div>

            <div class="space-y-4">
                <!-- Pilihan Metode -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Metode Pembayaran</label>
                    <select id="payMethod" onchange="togglePayInput()"
                        class="w-full border border-slate-300 rounded-lg px-3 py-2 font-bold focus:ring-2 focus:ring-green-500 outline-none text-slate-700">
                        <option value="BANK">üè¶ Transfer Bank</option>
                        <option value="CEK">üìú Cek / Giro (BG)</option>
                        <option value="CASH">üíµ Tunai / Kas Kecil</option>
                    </select>
                </div>

                <!-- Section: Akun Bank (Untuk Transfer) -->
                <div id="secBank" class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase">Pilih Akun Bank</label>
                    <div class="relative">
                        <i class="fas fa-credit-card absolute left-3 top-3 text-slate-400 text-xs"></i>
                        <select id="payAccount"
                            class="w-full border border-slate-300 rounded-lg pl-9 pr-3 py-2 font-bold focus:ring-2 focus:ring-green-500 outline-none text-slate-700 appearance-none bg-white">
                            <option value="">Mengambil data akun...</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-slate-400 text-xs"></i>
                    </div>
                </div>

                <!-- Section: Input Manual (Untuk Cek/BG) -->
                <div id="secCek" class="space-y-2 hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase">Nomor Register Cek / BG</label>
                    <div class="relative">
                        <i class="fas fa-money-check absolute left-3 top-3 text-slate-400 text-xs"></i>
                        <input type="text" id="payRef" placeholder="Contoh: BG-12345678"
                            class="w-full border border-slate-300 rounded-lg pl-9 pr-3 py-2 font-bold focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                    <p class="text-[10px] text-orange-500 italic">*Pastikan nomor Cek/BG sudah benar.</p>
                </div>

                <!-- Info Nominal -->
                <div class="bg-slate-50 p-3 rounded-lg flex justify-between items-center border border-slate-200 mt-2">
                    <span class="text-xs font-bold text-slate-500">Total Bayar:</span>
                    <span class="text-lg font-black text-slate-800" id="payAmount">Rp 0</span>
                </div>

                <div class="pt-2">
                    <button onclick="prosesBayar()" id="btnProsesBayar"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg shadow-green-200 transition flex items-center justify-center gap-2">
                        <i class="fas fa-check-circle"></i> PROSES PEMBAYARAN
                    </button>
                </div>
            </div>
        </div>
</body>

</html>