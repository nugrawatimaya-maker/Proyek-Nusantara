<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HR Dashboard System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app_config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Check Auth: HR + Global Roles
        PNAuth.requireAuth(['hr', 'finance', 'direksi', 'superadmin']);

        // --- POPULATE HEADER ---
        document.addEventListener('DOMContentLoaded', () => {
            const session = PNAuth.getSession();
            if (session) {
                document.getElementById('nav-user-name').innerText = session.user.full_name;
                document.getElementById('nav-user-role').innerText = session.user.role.toUpperCase();
            }
        });
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdfa;
            /* Teal-50 */
        }

        /* Soft Gradient Background untuk Header */
        .header-bg {
            background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%);
        }

        /* Card Menu Style ala Odoo */
        .menu-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* Skeleton Loading */
        .skeleton {
            background: #e2e8f0;
            background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
            border-radius: 5px;
            background-size: 200% 100%;
            animation: 1.5s shine linear infinite;
        }

        @keyframes shine {
            to {
                background-position-x: -200%;
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col text-slate-800">

    <nav class="bg-white border-b border-teal-100 px-6 py-3 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="bg-teal-600 text-white p-2 rounded-lg">
                <i class="fas fa-users text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-teal-900 text-lg leading-tight">HR Integrated System</h1>
                <p class="text-[10px] text-teal-500 font-medium tracking-wider uppercase">Human Resources Module</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-slate-400 hover:text-teal-600 transition" title="Home / Portal">
                <i class="fas fa-home text-lg"></i>
            </a>
            <div class="text-right hidden sm:block">
                <p class="text-sm font-bold text-slate-700" id="nav-user-name">Guest</p>
                <p class="text-xs text-teal-500" id="nav-user-role">Online</p>
            </div>
            <div class="w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center text-teal-600">
                <i class="fas fa-user-tie"></i>
            </div>
            <button onclick="PNAuth.logout()"
                class="bg-slate-100 hover:bg-red-50 text-slate-500 hover:text-red-500 p-2 rounded-full transition"
                title="Logout">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </nav>

    <main class="flex-grow p-6 max-w-7xl mx-auto w-full space-y-8">

        <!-- VIEW: MENU (Default) -->
        <div id="view-menu">
            <h3 class="text-slate-500 font-bold text-sm uppercase tracking-wider mb-4 ml-1">HR Apps</h3>

            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">

                <!-- OVERVIEW / DASHBOARD -->
                <div onclick="switchView('overview')"
                    class="menu-card bg-white p-6 rounded-2xl border border-teal-50 shadow-sm flex flex-col items-center justify-center text-center group">
                    <div
                        class="h-14 w-14 rounded-2xl bg-teal-100 text-teal-600 flex items-center justify-center mb-3 group-hover:scale-110 transition">
                        <i class="fas fa-chart-pie text-2xl"></i>
                    </div>
                    <h4 class="font-bold text-slate-700 group-hover:text-teal-700">Overview</h4>
                    <p class="text-[10px] text-slate-400 mt-1">Statistik Utama</p>
                </div>

                <!-- DATA PEGAWAI -->
                <div onclick="switchView('pegawai')"
                    class="menu-card bg-white p-6 rounded-2xl border border-teal-50 shadow-sm flex flex-col items-center justify-center text-center group">
                    <div
                        class="h-14 w-14 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center mb-3 group-hover:scale-110 transition">
                        <i class="fas fa-id-badge text-2xl"></i>
                    </div>
                    <h4 class="font-bold text-slate-700 group-hover:text-blue-700">Data Pegawai</h4>
                    <p class="text-[10px] text-slate-400 mt-1">Database Karyawan</p>
                </div>

                <!-- PAYROLL -->
                <div onclick="switchView('payroll')"
                    class="menu-card bg-white p-6 rounded-2xl border border-teal-50 shadow-sm flex flex-col items-center justify-center text-center group">
                    <div
                        class="h-14 w-14 rounded-2xl bg-emerald-100 text-emerald-600 flex items-center justify-center mb-3 group-hover:scale-110 transition">
                        <i class="fas fa-money-check-alt text-2xl"></i>
                    </div>
                    <h4 class="font-bold text-slate-700 group-hover:text-emerald-700">Payroll</h4>
                    <p class="text-[10px] text-slate-400 mt-1">Penggajian</p>
                </div>

                <!-- KPI -->
                <div onclick="switchView('kpi')"
                    class="menu-card bg-white p-6 rounded-2xl border border-teal-50 shadow-sm flex flex-col items-center justify-center text-center group">
                    <div
                        class="h-14 w-14 rounded-2xl bg-amber-100 text-amber-600 flex items-center justify-center mb-3 group-hover:scale-110 transition">
                        <i class="fas fa-star text-2xl"></i>
                    </div>
                    <h4 class="font-bold text-slate-700 group-hover:text-amber-700">KPI & Bonus</h4>
                    <p class="text-[10px] text-slate-400 mt-1">Penilaian Kinerja</p>
                </div>

            </div>
        </div>

        <!-- VIEW: OVERVIEW (Was dashboard) -->
        <div id="view-overview" class="hidden space-y-6">
            <button onclick="switchView('menu')"
                class="flex items-center gap-2 text-slate-500 hover:text-teal-600 font-bold transition">
                <i class="fas fa-arrow-left"></i> Kembali ke Menu
            </button>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-teal-50">
                    <div class="text-xs text-gray-400 font-bold uppercase mb-2">Total Pegawai</div>
                    <div class="text-4xl font-black text-slate-800" id="statPegawai">0</div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-teal-50">
                    <div class="text-xs text-gray-400 font-bold uppercase mb-2">Payroll Bulan Ini</div>
                    <div class="text-2xl font-black text-teal-600" id="statPayroll">Rp 0</div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-teal-50">
                    <div class="text-xs text-gray-400 font-bold uppercase mb-2">Rata-rata KPI</div>
                    <div class="text-4xl font-black text-amber-500" id="statKPI">0.0</div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-teal-50">
                    <div class="text-xs text-gray-400 font-bold uppercase mb-2">Status Aktif</div>
                    <div class="text-4xl font-black text-emerald-600" id="statAktif">0</div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-teal-50 h-96">
                <h3 class="font-bold text-slate-700 mb-4">Sebaran Pegawai per Divisi</h3>
                <div class="relative h-full w-full">
                    <canvas id="chartDivisi"></canvas>
                </div>
            </div>
        </div>

        <!-- VIEW: PEGAWAI -->
        <div id="view-pegawai" class="hidden space-y-6">
            <button onclick="switchView('menu')"
                class="flex items-center gap-2 text-slate-500 hover:text-teal-600 font-bold transition">
                <i class="fas fa-arrow-left"></i> Kembali ke Menu
            </button>

            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-teal-50">
                <h2 class="text-lg font-bold text-slate-700">Database Karyawan</h2>
                <button onclick="modalPegawai()"
                    class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg shadow font-bold text-sm transition transform hover:-translate-y-1">
                    <i class="fas fa-plus-circle mr-1"></i> Tambah Pegawai
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-teal-50 overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-teal-50/50 font-bold text-slate-600 uppercase border-b border-teal-100">
                        <tr>
                            <th class="p-4">Nama & Jabatan</th>
                            <th class="p-4">Divisi</th>
                            <th class="p-4 text-right">Gaji Pokok + Tunjangan</th>
                            <th class="p-4 text-center">Status</th>
                            <th class="p-4 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="listPegawai" class="divide-y divide-teal-50">
                        <tr>
                            <td colspan="5" class="p-6 text-center text-gray-400">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: PAYROLL -->
        <div id="view-payroll" class="hidden space-y-6">
            <button onclick="switchView('menu')"
                class="flex items-center gap-2 text-slate-500 hover:text-teal-600 font-bold transition">
                <i class="fas fa-arrow-left"></i> Kembali ke Menu
            </button>

            <div
                class="bg-white p-6 rounded-xl shadow-sm border border-teal-50 flex flex-wrap gap-4 items-end justify-between">
                <div class="flex gap-4 items-end">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">Periode Gaji</label>
                        <input type="month" id="filterPeriode"
                            class="border border-slate-200 p-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
                            onchange="loadPayroll()">
                    </div>
                    <button onclick="generatePayroll()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">
                        <i class="fas fa-sync-alt mr-1"></i> Generate Slip Gaji
                    </button>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-400 uppercase font-bold tracking-wider">Total Pengeluaran</div>
                    <div class="text-2xl font-black text-teal-600" id="totalGajiPeriode">Rp 0</div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-teal-50 overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-teal-50/50 font-bold text-slate-600 uppercase border-b border-teal-100">
                        <tr>
                            <th class="p-4">Karyawan</th>
                            <th class="p-4 text-right">Total Gaji (THP)</th>
                            <th class="p-4 text-center">Status Bayar</th>
                            <th class="p-4 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="listPayroll" class="divide-y divide-teal-50"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: KPI -->
        <div id="view-kpi" class="hidden space-y-6">
            <button onclick="switchView('menu')"
                class="flex items-center gap-2 text-slate-500 hover:text-teal-600 font-bold transition">
                <i class="fas fa-arrow-left"></i> Kembali ke Menu
            </button>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-teal-50 mb-4">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i class="fas fa-edit text-teal-500"></i> Input Penilaian KPI
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="kpiPegawai"
                        class="border border-slate-200 p-2 rounded-lg text-sm md:col-span-1 focus:outline-none focus:ring-2 focus:ring-teal-500"></select>
                    <input type="text" id="kpiPeriode" placeholder="Cth: Q1 2024"
                        class="border border-slate-200 p-2 rounded-lg text-sm md:col-span-1 focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <input type="number" id="kpiSkor" placeholder="Skor (0-100)"
                        class="border border-slate-200 p-2 rounded-lg text-sm md:col-span-1 focus:outline-none focus:ring-2 focus:ring-teal-500"
                        min="0" max="100">
                    <button onclick="simpanKPI()"
                        class="bg-teal-600 text-white font-bold rounded-lg text-sm shadow hover:bg-teal-700 transition">Simpan
                        Nilai</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-teal-50 overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-teal-50/50 font-bold text-slate-600 uppercase border-b border-teal-100">
                        <tr>
                            <th class="p-4">Pegawai</th>
                            <th class="p-4">Periode</th>
                            <th class="p-4 text-center">Skor</th>
                            <th class="p-4 text-center">Predikat</th>
                        </tr>
                    </thead>
                    <tbody id="listKPI" class="divide-y divide-teal-50"></tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- MODAL ADD EMPLOYEE -->
    <div id="modalAdd"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl w-96 shadow-2xl border border-teal-100">
            <h2 class="text-xl font-bold mb-6 text-teal-800">Data Pegawai</h2>
            <form id="formPegawai" class="space-y-4">
                <input type="hidden" id="editId" value="">

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">Nama Lengkap</label>
                    <input type="text" id="namaEmp"
                        class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none" required>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">Jabatan</label>
                    <input type="text" id="jabatanEmp"
                        class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none" required>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">Divisi</label>
                    <select id="divisiEmp"
                        class="w-full border p-2 rounded-lg bg-white focus:ring-2 focus:ring-teal-500 outline-none">
                        <option value="Operasional">Operasional</option>
                        <option value="Finance">Finance</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Gudang">Gudang</option>
                        <option value="HRGA">HRGA</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">Gaji Pokok</label>
                        <input type="number" id="gajiEmp"
                            class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">Tunjangan</label>
                        <input type="number" id="tunjanganEmp"
                            class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                            value="0">
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="document.getElementById('modalAdd').classList.add('hidden')"
                        class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-medium transition">Batal</button>
                    <button type="submit"
                        class="px-4 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 shadow transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Gunakan window.client dari app_config.js
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(n);

        // --- NAVIGATION LOGIC ---
        function switchView(viewName) {
            // Hide all views first
            const views = ['menu', 'overview', 'pegawai', 'payroll', 'kpi'];
            views.forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });

            // Show requested view
            const el = document.getElementById(`view-${viewName}`);
            if (el) el.classList.remove('hidden');

            // Load data accordingly
            if (viewName === 'overview') loadStats();
            if (viewName === 'pegawai') loadPegawai();
            if (viewName === 'payroll') { document.getElementById('filterPeriode').valueAsDate = new Date(); loadPayroll(); }
            if (viewName === 'kpi') loadKPI();
        }

        // --- 1. PEGAWAI LOGIC ---
        function modalPegawai(data = null) {
            document.getElementById('modalAdd').classList.remove('hidden');
            document.getElementById('formPegawai').reset();
            document.getElementById('editId').value = "";

            const title = document.querySelector('#modalAdd h2');
            const submitBtn = document.querySelector('#formPegawai button[type="submit"]');

            if (data) {
                title.innerText = "Edit Data Pegawai";
                submitBtn.innerText = "Update";

                document.getElementById('editId').value = data.id;
                document.getElementById('namaEmp').value = data.nama;
                document.getElementById('jabatanEmp').value = data.jabatan;
                document.getElementById('divisiEmp').value = data.divisi;
                document.getElementById('gajiEmp').value = data.gaji_pokok;
                document.getElementById('tunjanganEmp').value = data.tunjangan;
            } else {
                title.innerText = "Data Pegawai Baru";
                submitBtn.innerText = "Simpan";
            }
        }

        document.getElementById('formPegawai').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = e.submitter;
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const editId = document.getElementById('editId').value;
                const payload = {
                    nama: document.getElementById('namaEmp').value,
                    jabatan: document.getElementById('jabatanEmp').value,
                    divisi: document.getElementById('divisiEmp').value,
                    gaji_pokok: document.getElementById('gajiEmp').value || 0,
                    tunjangan: document.getElementById('tunjanganEmp').value || 0,
                    status_karyawan: 'AKTIF'
                };

                if (!editId) {
                    payload.tanggal_masuk = new Date();
                    // INSERT
                    const { error } = await window.client.from('hr_employees').insert([payload]);
                    if (error) throw error;
                    alert('Data berhasil disimpan!');
                } else {
                    // UPDATE
                    const { error } = await window.client.from('hr_employees').update(payload).eq('id', editId);
                    if (error) throw error;
                    alert('Data berhasil diperbarui!');
                }

                document.getElementById('modalAdd').classList.add('hidden');
                document.getElementById('formPegawai').reset();
                loadPegawai();

            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        async function loadPegawai() {
            const { data, error } = await window.client.from('hr_employees').select('*').order('nama');
            const tbody = document.getElementById('listPegawai');
            tbody.innerHTML = '';

            if (data) {
                data.forEach(emp => {
                    tbody.innerHTML += `
                    <tr class="hover:bg-teal-50 border-b border-teal-50">
                        <td class="p-4">
                            <div class="font-bold text-slate-700">${emp.nama}</div>
                            <div class="text-xs text-slate-500">${emp.jabatan}</div>
                        </td>
                        <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600">${emp.divisi}</span></td>
                        <td class="p-4 text-right font-mono text-slate-600">${formatRupiah(emp.gaji_pokok + emp.tunjangan)}</td>
                        <td class="p-4 text-center">
                            <span class="text-xs font-bold ${emp.status_karyawan === 'AKTIF' ? 'text-emerald-600 bg-emerald-100' : 'text-rose-600 bg-rose-100'} px-2 py-1 rounded">${emp.status_karyawan}</span>
                        </td>
                        <td class="p-4 text-center">
                            <button onclick='editPegawai(${JSON.stringify(emp)})' class="text-blue-500 hover:text-blue-700 mr-2 transition"><i class="fas fa-edit"></i></button>
                            <button onclick="hapusPegawai(${emp.id})" class="text-rose-400 hover:text-rose-600 transition"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                });

                // Isi dropdown KPI juga (Global used in KPI view)
                const selKPI = document.getElementById('kpiPegawai');
                if (selKPI) {
                    selKPI.innerHTML = '<option value="">-- Pilih Pegawai --</option>';
                    data.forEach(e => selKPI.innerHTML += `<option value="${e.id}">${e.nama}</option>`);
                }
            }
        }


        function editPegawai(dataLine) {
            modalPegawai(dataLine);
        }

        async function hapusPegawai(id) {
            if (confirm('Hapus data pegawai ini?')) {
                await client.from('hr_employees').delete().eq('id', id);
                loadPegawai();
            }
        }

        // --- 2. PAYROLL LOGIC ---
        async function generatePayroll() {
            const periode = document.getElementById('filterPeriode').value;
            if (!periode) return alert("Pilih periode dulu!");

            if (!confirm(`Buat slip gaji untuk semua karyawan aktif periode ${periode}?`)) return;

            // 1. Ambil Karyawan Aktif
            const { data: emps } = await client.from('hr_employees').select('*').eq('status_karyawan', 'AKTIF');

            // 2. Cek duplikat payroll
            const { data: exist } = await client.from('hr_payroll').select('employee_id').eq('periode', periode);
            const existIds = exist.map(x => x.employee_id);

            // 3. Buat Payload
            const payload = [];
            emps.forEach(e => {
                if (!existIds.includes(e.id)) {
                    payload.push({
                        employee_id: e.id,
                        periode: periode,
                        gaji_bersih: e.gaji_pokok + e.tunjangan, // Rumus sederhana
                        status_bayar: 'PENDING'
                    });
                }
            });

            if (payload.length > 0) {
                await client.from('hr_payroll').insert(payload);
                alert(`Berhasil generate ${payload.length} slip gaji.`);
                loadPayroll();
            } else {
                alert('Semua karyawan sudah memiliki slip gaji bulan ini.');
            }
        }

        async function loadPayroll() {
            const periode = document.getElementById('filterPeriode').value;
            const { data } = await client.from('hr_payroll').select('*, hr_employees(nama, jabatan)').eq('periode', periode).order('id');

            const tbody = document.getElementById('listPayroll');
            tbody.innerHTML = '';
            let total = 0;

            if (data && data.length > 0) {
                data.forEach(p => {
                    total += p.gaji_bersih;
                    let btnAction = '';
                    if (p.status_bayar === 'PENDING') {
                        btnAction = `<button onclick="bayarGaji(${p.id})" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-xs transition">Bayar</button>`;
                    } else {
                        btnAction = `<button onclick="alert('Cetak slip...')" class="bg-slate-500 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs transition"><i class="fas fa-print"></i> Slip</button>`;
                    }

                    tbody.innerHTML += `
                    <tr class="border-b border-teal-50">
                        <td class="p-4 font-bold text-slate-700">${p.hr_employees?.nama} <div class="text-xs font-normal text-slate-400">${p.hr_employees?.jabatan}</div></td>
                        <td class="p-4 text-right font-mono text-slate-600">${formatRupiah(p.gaji_bersih)}</td>
                        <td class="p-4 text-center">
                            <span class="text-xs font-bold ${p.status_bayar === 'LUNAS' ? 'text-emerald-600 bg-emerald-100' : 'text-amber-600 bg-amber-100'} px-2 py-1 rounded">${p.status_bayar}</span>
                        </td>
                        <td class="p-4 text-center">${btnAction}</td>
                    </tr>
                `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-gray-400">Belum ada payroll periode ini. Klik Generate.</td></tr>`;
            }
            document.getElementById('totalGajiPeriode').innerText = formatRupiah(total);
        }

        async function bayarGaji(id) {
            if (confirm('Tandai gaji ini sudah dibayar?')) {
                await client.from('hr_payroll').update({ status_bayar: 'LUNAS', tanggal_bayar: new Date() }).eq('id', id);
                loadPayroll();
            }
        }

        // --- 3. KPI LOGIC ---
        async function simpanKPI() {
            const empId = document.getElementById('kpiPegawai').value;
            const skor = document.getElementById('kpiSkor').value;
            const periode = document.getElementById('kpiPeriode').value;

            if (!empId || !skor) return alert('Lengkapi data!');

            await client.from('hr_kpi').insert([{
                employee_id: empId,
                skor: skor,
                periode_kpi: periode
            }]);
            alert('Nilai tersimpan!');
            loadKPI();
        }

        async function loadKPI() {
            const { data } = await client.from('hr_kpi').select('*, hr_employees(nama)').order('created_at', { ascending: false });
            const tbody = document.getElementById('listKPI');
            tbody.innerHTML = '';

            if (data) {
                data.forEach(k => {
                    let color = 'text-rose-600';
                    let predikat = 'Kurang';
                    if (k.skor >= 70) { color = 'text-amber-600'; predikat = 'Cukup'; }
                    if (k.skor >= 85) { color = 'text-emerald-600'; predikat = 'Sangat Baik'; }

                    tbody.innerHTML += `
                    <tr class="border-b border-teal-50">
                        <td class="p-4 font-bold text-slate-700">${k.hr_employees?.nama}</td>
                        <td class="p-4 text-slate-600">${k.periode_kpi}</td>
                        <td class="p-4 text-center font-bold text-lg ${color}">${k.skor}</td>
                        <td class="p-4 text-center"><span class="text-xs border px-2 py-1 rounded ${color} border-current font-bold">${predikat}</span></td>
                    </tr>
                `;
                });
            }
        }

        // --- 4. DASHBOARD STATS ---
        async function loadStats() {
            // 1. Total Pegawai
            const { count: countEmp, data: allEmp } = await client.from('hr_employees').select('divisi', { count: 'exact' });
            document.getElementById('statPegawai').innerText = countEmp || 0;
            document.getElementById('statAktif').innerText = countEmp || 0; // Sementara sama

            // 2. Payroll Bulan Ini (Ambil periode YYYY-MM sekarang)
            const date = new Date();
            const periode = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const { data: payrolls } = await client.from('hr_payroll').select('gaji_bersih').eq('periode', periode);

            let totalPayroll = 0;
            if (payrolls) payrolls.forEach(p => totalPayroll += p.gaji_bersih);
            document.getElementById('statPayroll').innerText = formatRupiah(totalPayroll);

            // 3. Rata-rata KPI (Semua waktu atau filter periode tertentu)
            const { data: kpis } = await client.from('hr_kpi').select('skor');
            let avgKPI = 0;
            if (kpis && kpis.length > 0) {
                const totalSkor = kpis.reduce((acc, curr) => acc + curr.skor, 0);
                avgKPI = (totalSkor / kpis.length).toFixed(1);
            }
            document.getElementById('statKPI').innerText = avgKPI;

            // 4. Render Chart
            renderChart(allEmp);
        }

        let chartInstance = null;
        function renderChart(employees) {
            const ctx = document.getElementById('chartDivisi').getContext('2d');

            // Group by Divisi
            const counts = {};
            if (employees) {
                employees.forEach(e => {
                    counts[e.divisi] = (counts[e.divisi] || 0) + 1;
                });
            }


            const labels = Object.keys(counts);
            const data = Object.values(counts);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#0d9488', // Teal
                            '#3b82f6', // Blue
                            '#f59e0b', // Yellow
                            '#10b981', // Green
                            '#6366f1', // Indigo
                            '#ef4444'  // Red
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }
    </script>
</body>

</html>