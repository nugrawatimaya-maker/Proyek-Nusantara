<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kas Masuk - Finance</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f0fdf4; } /* Nuansa Hijau Segar */
    .btn-gradient { background: linear-gradient(135deg, #16a34a, #15803d); }
    .btn-gradient:hover { background: linear-gradient(135deg, #15803d, #14532d); }
  </style>
</head>
<body class="p-6 text-gray-800">

  <header class="max-w-xl mx-auto mb-6 flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
    <div>
      <h1 class="text-xl font-bold text-gray-900">Kas Masuk</h1>
      <p class="text-xs text-gray-500">Catat Pendapatan & Penerimaan Dana</p>
    </div>
    <a href="dashboard_operasional.html" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-full text-sm font-bold transition">
      <i class="fas fa-arrow-left mr-1"></i> Dashboard
    </a>
  </header>

  <main class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
    
    <div class="space-y-5">
      
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">Tanggal Terima</label>
        <input type="date" id="tanggal" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-green-500 outline-none bg-green-50 text-gray-800 font-bold">
      </div>

      <div class="grid grid-cols-1 gap-4">
        
        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
            <label class="block text-xs font-bold text-green-800 mb-1 uppercase"><i class="fas fa-wallet mr-1"></i> Masuk ke Rekening (Debit)</label>
            <select id="akunTarget" class="w-full border p-2 rounded-lg font-bold text-gray-700 bg-white focus:ring-2 focus:ring-green-500">
              <option value="">-- Memuat Bank... --</option>
              </select>
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">Sumber Pendapatan (Kredit)</label>
            <select id="akunSumber" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-green-500 bg-white">
              <option value="">-- Memuat Akun... --</option>
              </select>
            <p class="text-[10px] text-gray-400 mt-1 ml-1">*Pilih Pendapatan Usaha, Modal, atau Lain-lain</p>
        </div>

      </div>

      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">Jumlah Diterima (Rp)</label>
        <input type="number" id="jumlah" class="w-full border border-green-300 p-3 rounded-xl focus:ring-2 focus:ring-green-500 text-2xl font-bold text-green-700 placeholder-gray-300 text-right" placeholder="0">
      </div>

      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">Keterangan</label>
        <textarea id="keterangan" rows="2" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-green-500" placeholder="Contoh: DP Rumah Blok A1 a.n Bpk Budi"></textarea>
      </div>

      <div id="statusBox" class="hidden p-3 rounded-lg text-sm font-bold text-center"></div>

      <button id="btnSimpan" onclick="simpanTransaksi()" class="w-full btn-gradient text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex justify-center items-center gap-2">
        <i class="fas fa-download"></i> SIMPAN PENERIMAAN
      </button>

    </div>
  </main>

  <script>
    // --- SETUP KONEKSI SUPABASE ---
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    // Set Default Tanggal
    document.getElementById("tanggal").valueAsDate = new Date();
    
    // 1. LOAD MASTER AKUN
    async function loadAkun() {
      const { data } = await client.from('master_akun').select('nama_akun').order('nama_akun');
      
      const selTarget = document.getElementById("akunTarget"); // Bank/Kas (Debit)
      const selSumber = document.getElementById("akunSumber"); // Pendapatan (Kredit)
      
      // Reset
      selTarget.innerHTML = '<option value="">-- Pilih Rekening Penerima --</option>';
      selSumber.innerHTML = '<option value="">-- Pilih Sumber Dana --</option>';

      if(data) {
        data.forEach(akun => {
            const n = akun.nama_akun;
            const lower = n.toLowerCase();

            // LOGIKA PEMISAHAN:
            // Akun yang mengandung kata "Kas", "Bank", "Mandiri", "BCA" masuk ke Target (Debit)
            if(lower.includes('kas') || lower.includes('bank') || lower.includes('mandiri') || lower.includes('bca')) {
                selTarget.innerHTML += `<option value="${n}">${n}</option>`;
            } else {
                // Sisanya (Pendapatan, Modal, Piutang, dll) masuk ke Sumber (Kredit)
                selSumber.innerHTML += `<option value="${n}">${n}</option>`;
            }
        });
      }
    }
    loadAkun();

    // 2. SIMPAN TRANSAKSI (INTEGRASI AKUNTANSI)
    async function simpanTransaksi() {
      const btn = document.getElementById("btnSimpan");
      const statusBox = document.getElementById("statusBox");

      const tgl = document.getElementById("tanggal").value;
      const akunDb = document.getElementById("akunTarget").value; // Debit (Bank)
      const akunCr = document.getElementById("akunSumber").value; // Kredit (Pendapatan)
      const jum = Number(document.getElementById("jumlah").value);
      const ket = document.getElementById("keterangan").value;

      // Validasi
      if(!tgl || !akunDb || !akunCr || jum <= 0) {
        alert("Mohon lengkapi semua data transaksi!"); return;
      }
      if(!confirm(`Terima dana Rp ${jum.toLocaleString()} ke ${akunDb}?`)) return;

      // UI Loading
      btn.disabled = true;
      btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Menyimpan...`;

      try {
        const refNo = "IN-" + Date.now(); // ID Referensi Unik

        // A. JURNAL UMUM (PENTING: Agar Laporan Keuangan Update)
        // Debit: Kas/Bank (Harta Bertambah)
        // Kredit: Pendapatan/Modal (Bertambah)
        const jurnalData = [
            {
                tanggal: tgl,
                nomor_referensi: refNo, // Wajib ada sesuai perbaikan DB sebelumnya
                keterangan: ket,
                nama_akun: akunDb,
                debit: jum,
                kredit: 0
            },
            {
                tanggal: tgl,
                nomor_referensi: refNo,
                keterangan: ket,
                nama_akun: akunCr,
                debit: 0,
                kredit: jum
            }
        ];

        const { error: errJurnal } = await client.from('jurnal_umum').insert(jurnalData);
        if(errJurnal) throw new Error("Gagal Jurnal: " + errJurnal.message);

        // B. TRANSAKSI (Untuk Laporan Cashflow Sederhana & Rekonsiliasi)
        const { error: errTrans } = await client.from('transaksi').insert([{
            tanggal: tgl,
            jenis_transaksi: 'MASUK',
            akun: akunCr,        // Akun Lawan (Sumber)
            bank_sumber: akunDb, // Bank Penerima
            jumlah: jum,
            keterangan: ket
        }]);
        if(errTrans) throw new Error("Gagal Transaksi: " + errTrans.message);

        // Sukses
        statusBox.className = "p-3 rounded-lg text-sm font-bold text-center bg-green-100 text-green-700 block mb-3";
        statusBox.innerHTML = `✅ Berhasil! Uang masuk tercatat.<br><span class='text-xs font-normal'>Ref: ${refNo}</span>`;
        
        setTimeout(() => {
            location.reload();
        }, 1500);

      } catch (e) {
        console.error(e);
        statusBox.className = "p-3 rounded-lg text-sm font-bold text-center bg-red-100 text-red-700 block mb-3";
        statusBox.innerText = "❌ Error: " + e.message;
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-download"></i> SIMPAN PENERIMAAN`;
      }
    }
  </script>
</body>
</html>