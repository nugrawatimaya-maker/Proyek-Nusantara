<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kas Masuk & Approval</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f0fdf4;
            font-family: "Segoe UI", sans-serif;
            padding-bottom: 80px;
        }

        /* Tema Hijau untuk Pemasukan */
        .bg-theme {
            background-color: #16a34a;
        }

        .text-theme {
            color: #16a34a;
        }

        .border-theme {
            border-color: #16a34a;
        }

        .hover-theme:hover {
            background-color: #15803d;
        }

        /* Tweaking Select2 agar mirip input Tailwind */
        .select2-container .select2-selection--single {
            height: 42px !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 0.5rem !important;
            display: flex !important;
            align-items: center !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px !important;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>

    <nav
        class="bg-white border-b border-green-100 px-6 py-4 sticky top-0 z-40 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div
                class="bg-green-600 text-white w-10 h-10 flex items-center justify-center rounded-xl shadow-lg shadow-green-200">
                <i class="fas fa-wallet text-lg"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800 leading-tight">Kas Masuk & Verifikasi</h1>
                <p class="text-xs text-slate-500">Terima Dana -> Cek Mutasi -> Validasi</p>
            </div>
        </div>
        <a href="dashboard_operasional.html"
            class="bg-slate-100 text-slate-500 w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-200 transition">
            <i class="fas fa-arrow-left"></i>
        </a>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">

        <!-- HEADER & UPLOAD -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-green-100 p-3 rounded-full text-green-600">
                        <i class="fas fa-wallet text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Input Penerimaan</h2>
                        <p class="text-slate-500 text-sm">Upload Bukti Transfer untuk Auto-Input.</p>
                    </div>
                </div>

                <!-- FILE UPLOAD BUTTON -->
                <div class="relative w-full md:w-auto">
                    <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="processOCR(this)">
                    <label for="file-upload"
                        class="cursor-pointer bg-green-50 hover:bg-green-100 text-green-700 font-bold py-2 px-4 rounded-lg border border-green-200 flex items-center gap-2 transition w-full justify-center md:w-auto">
                        <i class="fas fa-camera"></i> SCAN BUKTI TRANSFER
                    </label>
                </div>
            </div>

            <!-- OCR PREVIEW & STATUS -->
            <div id="ocrPreviewBox"
                class="hidden mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200 flex gap-4 items-start animate-fade-in-up">
                <img id="ocrPreview" class="w-24 h-24 object-cover rounded-lg border shadow-sm">
                <div class="flex-1">
                    <div id="ocrStatus" class="text-sm font-bold text-slate-500 mb-2 flex items-center gap-2">
                        <i class="fas fa-circle-notch fa-spin text-green-500"></i> Membaca gambar...
                    </div>
                    <p class="text-xs text-slate-400">Sistem sedang mengekstrak Tanggal, Nominal, dan Bank Tujuan secara
                        otomatis.</p>
                </div>
            </div>

            <!-- FORM -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- LEFT COL -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Tanggal Terima</label>
                        <input type="date" id="tanggal"
                            class="w-full border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:ring-green-500 focus:border-green-500">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Masuk ke Rekening (Debit) <span
                                class="text-red-500">*</span></label>
                        <select id="akunTarget"
                            class="w-full border-slate-300 rounded-lg p-3 outline-none text-slate-700 font-bold bg-green-50/50 border border-green-200 focus:border-green-500">
                            <option value="">-- Pilih Bank/Kas --</option>
                        </select>
                        <p class="text-[10px] text-slate-400 mt-1">Pilih Kas/Bank penerima dana (Auto-detect dari OCR).
                        </p>
                    </div>

                    <!-- NEW FIELD: NAMA PENGIRIM -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Nama Pengirim / Penyetor</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-user text-slate-400"></i>
                            </div>
                            <input type="text" id="namaPengirim"
                                class="w-full pl-10 pr-4 py-2.5 border-slate-300 rounded-lg text-slate-700 focus:ring-green-500 focus:border-green-500"
                                placeholder="Auto-detect dari bukti transfer...">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Nominal (Rp) <span
                                class="text-red-500">*</span></label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-slate-400 font-bold">Rp</span>
                            <input type="number" id="jumlah"
                                class="w-full pl-10 pr-4 py-2.5 border-slate-300 rounded-lg font-mono font-bold text-lg text-slate-800 focus:ring-green-500 focus:border-green-500"
                                placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- RIGHT COL -->
                <div class="space-y-4">
                    <!-- Removed Sumber Pendapatan (Kredit) as per user request -->

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Terkait Proyek (Opsional)</label>
                        <select id="pilihProyek"
                            class="w-full border-slate-300 rounded-lg p-2.5 focus:ring-green-500 focus:border-green-500">
                            <option value="">-- Umum / Non Proyek --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Keterangan / Berita <span
                                class="text-red-500">*</span></label>
                        <textarea id="keterangan"
                            class="w-full border-slate-300 rounded-lg p-3 text-sm focus:ring-green-500 focus:border-green-500"
                            rows="3" placeholder="Contoh: Pelunasan Blok A1..."></textarea>
                    </div>
                </div>
            </div>

            <!-- FOOTER ACTION -->
            <div class="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                <button onclick="simpanDraft()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-green-200 transition flex items-center gap-2 transform active:scale-95">
                    <i class="fas fa-paper-plane"></i> KIRIM KE ACCOUNTING (VERIFIKASI)
                </button>
            </div>
        </div>

        <!-- INFO -->
        <div class="text-center text-slate-400 text-xs">
            <p>Data yang diinput akan masuk antrian <span class="font-bold text-slate-600">Verifikasi Kas Masuk</span>
                di Dashboard Accounting.</p>
        </div>

    </div>

    <script>
        const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
        const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN";
        const client = window.client || supabase.createClient(supabaseUrl, supabaseKey); // Reuse if shared
        const fmt = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(n);

        // Cache Options untuk Dropdown di Tabel
        let optBank = "";
        // let optPendapatan = ""; // Removed

        // --- 1. INIT & LOAD DATA ---
        document.getElementById("tanggal").valueAsDate = new Date();

        async function init() {
            await loadMasterData();
        }

        async function loadMasterData() {
            console.log("Memulai Load Data...");

            const { data: akun, error: errAkun } = await client
                .from('master_akun')
                .select('nama_akun, kategori')
                .order('kode_akun', { ascending: true });

            if (errAkun) {
                console.error(errAkun);
                return alert("Gagal mengambil data akun.");
            }

            const selTarget = document.getElementById("akunTarget");
            // const selSumber = document.getElementById("akunSumber"); // Removed

            selTarget.innerHTML = '<option value="">-- Pilih Bank/Kas --</option>';
            // selSumber.innerHTML = '<option value="">-- Pilih Sumber --</option>'; // Removed

            let htmlBank = "";
            optBank = "";

            if (akun) {
                akun.forEach(a => {
                    const n = a.nama_akun;
                    if (n.match(/kas|bank|mandiri|bca|bri|bni|btn/i)) {
                        const opt = `<option value="${n}">${n}</option>`;
                        htmlBank += opt;
                        optBank += opt;
                    }
                });
            }

            selTarget.innerHTML += htmlBank;

            const { data: proyek } = await client.from('master_proyek').select('nama_proyek').eq('status', 'BERJALAN').order('nama_proyek');
            const selProyek = document.getElementById("pilihProyek");
            if (proyek) {
                selProyek.innerHTML = '<option value="">-- Umum / Non Proyek --</option>';
                proyek.forEach(p => {
                    selProyek.innerHTML += `<option value="${p.nama_proyek}">${p.nama_proyek}</option>`;
                });
            }

            setTimeout(() => {
                console.log("Mengaktifkan Select2...");

                // if ($('#akunSumber').data('select2')) $('#akunSumber').select2('destroy'); // Removed
                if ($('#akunTarget').data('select2')) $('#akunTarget').select2('destroy');
                if ($('#pilihProyek').data('select2')) $('#pilihProyek').select2('destroy');

                // ('#akunSumber').select2({ ... }); // Removed

                $('#akunTarget').select2({
                    placeholder: "-- Pilih Bank --",
                    templateResult: formatBankOption,
                    width: '100%'
                });

                $('#pilihProyek').select2({
                    placeholder: "-- Cari Proyek --",
                    width: '100%'
                });

            }, 100);
        }

        function formatBankOption(state) {
            if (!state.id) return state.text;
            let icon = '<i class="fas fa-university text-slate-400"></i>';
            if (state.text.toLowerCase().includes('bca')) icon = '<i class="fas fa-wallet text-blue-600"></i>';
            else if (state.text.toLowerCase().includes('mandiri')) icon = '<i class="fas fa-wallet text-yellow-600"></i>';
            return $(`<span>${icon} ${state.text}</span>`);
        }

        // --- OCR LOGIC (SMART PARSE) ---
        // ... (OCR Logic remains same, removed for brevity in this chunk check) ...

        async function processOCR(input) {
            const file = input.files[0];
            if (!file) return;

            const statusEl = document.getElementById('ocrStatus');
            const previewEl = document.getElementById('ocrPreview');
            const previewBox = document.getElementById('ocrPreviewBox');

            // Show Preview
            previewEl.src = URL.createObjectURL(file);
            previewBox.classList.remove('hidden');

            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin text-green-500"></i> Sedang membaca struk...';

            try {
                // Run Tesseract
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'eng',
                    { logger: m => console.log(m) }
                );

                console.log("OCR Result Raw:", text);

                // --- SMART PARSE LOGIC ---
                const lines = text.split('\n').filter(line => line.trim() !== '');
                let candidateAmounts = [];
                let foundDate = null;
                let foundBank = null;
                let foundSender = null;

                // Prepare Bank Matchers
                // 1. Map DOM Options to check available banks (Name & Account Number)
                const domBanks = document.getElementById("akunTarget").options;
                const availableAccounts = [];
                for (let i = 0; i < domBanks.length; i++) {
                    const val = domBanks[i].value;
                    const txt = domBanks[i].text.toUpperCase();
                    // We assume values usually contain the Bank Name
                    if (val) {
                        availableAccounts.push({
                            value: val,
                            text: txt,
                            // Try to extract keywords from the option text itself if needed
                            keywords: [val.toUpperCase(), txt.replace(/[^A-Z]/g, ' ')]
                        });
                    }
                }

                // Bank Aliases
                const bankAliases = {
                    'BCA': ['BCA', 'CENTRAL ASIA'],
                    'BRI': ['BRI', 'RAKYAT INDONESIA', 'BR1'],
                    'MANDIRI': ['MANDIRI'],
                    'BNI': ['BNI', 'NEGARA INDONESIA'],
                    'BSI': ['BSI', 'SYARIAH INDONESIA'],
                    'CIMB': ['CIMB', 'NIAGA'],
                    'DANAMON': ['DANAMON'],
                    'PERMATA': ['PERMATA']
                };

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const lower = line.toLowerCase();
                    const cleanLine = lower.trim();

                    // 1. AMOUNT DETECTION
                    if (!cleanLine.includes('saldo') && !cleanLine.includes('biaya') && !cleanLine.includes('tax')) {
                        const numbers = line.match(/[0-9]+[.,]?[0-9]+[.,]?[0-9]*/g);
                        if (numbers) {
                            for (let rawNum of numbers) {
                                let cleanNum = rawNum.replace(/[^0-9,.]/g, '');
                                let val = 0;
                                if (cleanNum.includes('.') && cleanNum.includes(',')) {
                                    if (cleanNum.lastIndexOf(',') > cleanNum.lastIndexOf('.')) val = parseFloat(cleanNum.replace(/\./g, '').replace(',', '.'));
                                    else val = parseFloat(cleanNum.replace(/,/g, ''));
                                } else if ((cleanNum.match(/\./g) || []).length > 1) {
                                    val = parseFloat(cleanNum.replace(/\./g, ''));
                                } else if ((cleanNum.match(/,/g) || []).length > 1) {
                                    val = parseFloat(cleanNum.replace(/,/g, ''));
                                } else {
                                    val = parseFloat(cleanNum.replace(/[,.]/g, ''));
                                    if (cleanNum.match(/[,.]00$/)) val = val / 100;
                                }

                                if (val > 1000 && val < 50000000000) {
                                    let score = 0;
                                    if (lower.includes('total') || lower.includes('jumlah') || lower.includes('transfer') || lower.includes('amount')) score += 5;
                                    if (lower.includes('rp') || lower.includes('idr')) score += 3;
                                    if (!rawNum.includes('.') && !rawNum.includes(',') && rawNum.length >= 10) score -= 10;
                                    candidateAmounts.push({ val, score, raw: rawNum });
                                }
                            }
                        }
                    }

                    // 2. DATE DETECTION
                    if (!foundDate) {
                        const dMatch = line.match(/(?:^|\s)(\d{1,2})[\s\/\-\.]+(jan|feb|mar|apr|mei|jun|jul|agu|sep|okt|nov|des|january|february|march|april|may|june|july|august|september|october|november|december|[0-9]{2})[\s\/\-\.]+(\d{4})(?:\s|$)/i);
                        if (dMatch) {
                            let day = dMatch[1];
                            let month = dMatch[2];
                            let year = dMatch[3];
                            const months = { jan: 1, feb: 2, mar: 3, apr: 4, mei: 5, may: 5, jun: 6, jul: 7, agu: 8, aug: 8, sep: 9, okt: 10, oct: 10, nov: 11, des: 12, dec: 12 };
                            let monthIdx = parseInt(month);
                            if (isNaN(monthIdx)) {
                                for (let k in months) {
                                    if (month.toLowerCase().startsWith(k)) monthIdx = months[k];
                                }
                            }
                            if (!isNaN(monthIdx)) foundDate = `${year}-${String(monthIdx).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        }
                    }

                    // 3. SENDER NAME (Lookahead)
                    if (!foundSender) {
                        if (lower.includes('sumber dana') || lower.includes('sumber rekening')) {
                            if (i + 1 < lines.length) {
                                let potentialName = lines[i + 1].trim();
                                if (potentialName.length > 3 && !potentialName.match(/bank|transfer|rp|idr/i)) foundSender = potentialName;
                            }
                        }
                        else if (lower.includes('dari') || lower.includes('pengirim')) {
                            const match = line.match(/(?:dari|pengirim)[:\s]+([a-zA-Z\s\.]+)/i);
                            if (match && match[1].trim().length > 3) foundSender = match[1].trim();
                        }
                    }

                    // 4. TARGET BANK DETECTION (Context + Account Number)
                    if (!foundBank) {
                        // Priority: Check near "Tujuan" / "Ke Bank" keywords
                        if (lower.includes('tujuan') || lower.includes('ke bank') || lower.includes('penerima')) {
                            // Grab Context (This line + Next 3 lines)
                            const contextText = [line, lines[i + 1] || '', lines[i + 2] || '', lines[i + 3] || ''].join(' ').toUpperCase();

                            // 4A. Match by Account Number (digits only > 6 length)
                            // This assumes 'akunTarget' options might contain the account number if we loaded it,
                            // OR we rely on Bank Name matching primarily now.

                            // 4B. Match by Bank Name / Alias
                            for (let acc of availableAccounts) {
                                // Check Alias
                                // acc.value might be "BCA", "KAS BANK BRI", etc.
                                // We check if any Alias matches the Context Text

                                let matched = false;
                                for (const [key, aliases] of Object.entries(bankAliases)) {
                                    // If the Dropdown Option relates to this Bank Key (e.g. Option "KAS BRI" contains "BRI")
                                    if (acc.text.includes(key) || acc.value.toUpperCase().includes(key)) {
                                        // Check if Context Text contains any Alias for this Bank
                                        for (let alias of aliases) {
                                            if (contextText.includes(alias)) {
                                                foundBank = acc.value; // Found it!
                                                matched = true;
                                                break;
                                            }
                                        }
                                    }
                                    if (matched) break;
                                }
                                if (foundBank) break;
                            }
                        }
                    }
                } // End Loop

                // Fallback: If still no bank found, scan WHOLE text for specific bank names present in our list
                if (!foundBank) {
                    const fullText = text.toUpperCase();
                    for (let acc of availableAccounts) {
                        // Simple check: does the text contain the Option Value?
                        // e.g. "BCA"
                        // But be careful of "Bank Lain"
                        // Only check strict keys
                        for (const [key, aliases] of Object.entries(bankAliases)) {
                            if (acc.value.toUpperCase().includes(key)) {
                                // This option is type 'Key'. Does text have 'Key'?
                                // To confirm it's the TARGET, usually Target comes AFTER Source.
                                // But let's just default to finding it if present.
                                if (fullText.includes(key)) {
                                    // Potential match, but weak. Let's start with it.
                                    // Better than nothing.
                                    foundBank = acc.value;
                                    break;
                                }
                            }
                        }
                        if (foundBank) break;
                    }
                }

                // --- APPLY ---
                let report = [];

                if (candidateAmounts.length > 0) {
                    candidateAmounts.sort((a, b) => b.score - a.score);
                    const bestAmount = candidateAmounts[0].val;
                    document.getElementById('jumlah').value = bestAmount;
                    report.push(`Nominal: Rp ${bestAmount.toLocaleString('id-ID')}`);
                }

                if (foundDate) {
                    document.getElementById('tanggal').value = foundDate;
                    report.push(`Tanggal: ${foundDate}`);
                }

                if (foundBank) {
                    $('#akunTarget').val(foundBank).trigger('change');
                    report.push(`Bank Tujuan: ${foundBank}`);
                }

                if (foundSender) {
                    document.getElementById('namaPengirim').value = foundSender;
                    report.push(`Pengirim: ${foundSender}`);
                }

                if (report.length > 0) {
                    statusEl.innerHTML = `<i class="fas fa-check-circle text-green-600"></i> Selesai! <br> <span class="text-xs text-slate-600 font-normal">${report.join(', ')}</span>`;
                } else {
                    statusEl.innerHTML = `<i class="fas fa-exclamation-circle text-orange-500"></i> Data tidak terdeteksi lengkap.`;
                }

            } catch (e) {
                console.error(e);
                statusEl.innerHTML = `<i class="fas fa-exclamation-triangle text-red-500"></i> Error reading receipt.`;
            }
        }

        // --- 2. SIMPAN DRAFT (INPUT) ---
        async function simpanDraft() {
            const tgl = document.getElementById("tanggal").value;
            const akunDb = document.getElementById("akunTarget").value; // Bank
            // const akunCr = document.getElementById("akunSumber").value; // Removed - will be set during verification
            const proyek = document.getElementById("pilihProyek").value;
            const jml = Number(document.getElementById("jumlah").value);
            let ket = document.getElementById("keterangan").value;
            const sender = document.getElementById("namaPengirim").value;

            if (!tgl || !akunDb || jml <= 0) return alert("Data belum lengkap!");

            // Append Sender to Keterangan if exists
            if (sender) {
                ket = `${ket} [Dari: ${sender}]`;
            }

            // INSERT KE TRANSAKSI DENGAN STATUS 'DRAFT_MASUK'
            const { error } = await client.from('transaksi').insert([{
                tanggal: tgl,
                jenis_transaksi: 'DRAFT_MASUK',
                akun: null,          // Disimpan: NULL (Akan diisi saat Verifikasi)
                bank_sumber: akunDb, // Disimpan: Bank Penerima (Debit)
                nama_proyek: proyek || null,
                jumlah: jml,
                keterangan: ket
            }]);

            if (error) alert("Error: " + error.message);
            else {
                alert("✅ Draft Penerimaan tersimpan! Segera verifikasi.");
                window.location.reload();
            }
        }

        // --- 3. LOAD TABEL DRAFT (VERIFIKASI) ---
        async function loadDraft() {
            const tbody = document.getElementById("listDraft");
            tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center"><i class="fas fa-spinner fa-spin text-green-500"></i></td></tr>`;

            // Ambil hanya yang DRAFT_MASUK
            const { data, error } = await client
                .from('transaksi')
                .select('*')
                .eq('jenis_transaksi', 'DRAFT_MASUK')
                .order('tanggal', { ascending: false });

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-400 italic">Tidak ada antrian penerimaan dana.</td></tr>`;
                return;
            }

            tbody.innerHTML = "";
            data.forEach(tr => {
                const badgeProyek = tr.nama_proyek ? `<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded font-bold border border-blue-200 mt-1 inline-block">${tr.nama_proyek}</span>` : "";

                // Dropdown Edit di Tabel (Supaya Finance bisa koreksi kalau Admin salah pilih akun)
                const ddBank = `<select onchange="updateDraft(${tr.id}, 'bank_sumber', this.value)" class="w-full text-xs border border-green-200 rounded p-1 bg-green-50 font-bold text-green-800">
                                ${optBank.replace(`value="${tr.bank_sumber}"`, `value="${tr.bank_sumber}" selected`)}
                            </select>`;

                const ddSumber = `<select onchange="updateDraft(${tr.id}, 'akun', this.value)" class="w-full text-xs border border-slate-200 rounded p-1 bg-white text-slate-700">
                                ${optPendapatan.replace(`value="${tr.akun}"`, `value="${tr.akun}" selected`)}
                              </select>`;

                tbody.innerHTML += `
                <tr class="hover:bg-slate-50 border-b transition">
                    <td class="p-3">
                        <div class="text-xs text-slate-500 mb-1">${new Date(tr.tanggal).toLocaleDateString('id-ID')}</div>
                        <div class="font-bold text-slate-700 text-sm">${tr.keterangan}</div>
                        ${badgeProyek}
                    </td>
                    <td class="p-3 w-40">${ddBank}</td>
                    <td class="p-3 w-40">${ddSumber}</td>
                    <td class="p-3 text-right font-bold text-green-600">${fmt(tr.jumlah)}</td>
                    <td class="p-3 text-center">
                        <button onclick="postingJurnal(${tr.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded shadow text-xs font-bold transition flex items-center gap-1 mx-auto mb-2 w-full justify-center">
                            <i class="fas fa-check-circle"></i> TERIMA
                        </button>
                        <button onclick="hapusDraft(${tr.id})" class="text-red-400 hover:text-red-600 text-[10px] underline">Hapus</button>
                    </td>
                </tr>
            `;
            });
        }

        // --- 4. UPDATE EDIT DI TEMPAT ---
        async function updateDraft(id, col, val) {
            await client.from('transaksi').update({ [col]: val }).eq('id', id);
            // Tidak perlu reload agar UX lancar
        }

        // --- 5. POSTING (EKSEKUSI FINAL) ---
        async function postingJurnal(id) {
            if (!confirm("Validasi data ini? Saldo Kas akan bertambah.")) return;

            // Ambil Data Latest
            const { data: tr } = await client.from('transaksi').select('*').eq('id', id).single();
            if (!tr) return;

            const refNo = "IN-" + tr.id;

            // Buat Jurnal Umum (DEBIT BANK, KREDIT PENDAPATAN)
            const jurnalPayload = [
                {
                    tanggal: tr.tanggal,
                    nomor_referensi: refNo,
                    keterangan: tr.nama_proyek ? `${tr.keterangan} [${tr.nama_proyek}]` : tr.keterangan,
                    nama_akun: tr.bank_sumber, // DEBIT: Bank/Kas bertambah
                    debit: tr.jumlah,
                    kredit: 0,
                    project_code: tr.nama_proyek
                },
                {
                    tanggal: tr.tanggal,
                    nomor_referensi: refNo,
                    keterangan: tr.nama_proyek ? `${tr.keterangan} [${tr.nama_proyek}]` : tr.keterangan,
                    nama_akun: tr.akun, // KREDIT: Pendapatan bertambah
                    debit: 0,
                    kredit: tr.jumlah,
                    project_code: tr.nama_proyek
                }
            ];

            // Eksekusi
            const { error: errJ } = await client.from('jurnal_umum').insert(jurnalPayload);

            if (errJ) {
                alert("Gagal Posting Jurnal: " + errJ.message);
            } else {
                // Update Status Transaksi jadi 'MASUK' (Final)
                await client.from('transaksi').update({ jenis_transaksi: 'MASUK' }).eq('id', id);
                alert("✅ Dana berhasil divalidasi dan dijurnal!");
                loadDraft();
            }
        }

        // --- 6. HAPUS DRAFT ---
        async function hapusDraft(id) {
            if (confirm("Yakin menghapus draft ini?")) {
                await client.from('transaksi').delete().eq('id', id);
                loadDraft();
            }
        }

        init();
    </script>
</body>

</html>