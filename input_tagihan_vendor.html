<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Input Tagihan & Vendor</title>
  <style>
    :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; }
    body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; }
    
    .header { background: #fff; padding: 16px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .header h2 { margin: 0; font-size: 18px; color: var(--primary); }

    .container { max-width: 600px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    label { display: block; font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 6px; margin-top: 12px; }
    input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
    input:focus, select:focus { outline: 2px solid var(--primary); border-color: var(--primary); }
    
    .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    .btn-secondary { background: #e2e8f0; color: #334155; margin-top: 0; margin-bottom: 10px; }
    
    /* Modal */
    dialog { border: none; border-radius: 12px; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    dialog::backdrop { background: rgba(0,0,0,0.5); }
    
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

  <div class="header">
    <h2>Aplikasi Tagihan</h2>
  </div>

  <div class="container">
    <button class="btn btn-secondary" onclick="openVendorModal()">+ Tambah Vendor Baru</button>

    <div class="card">
      <h3 style="margin-top:0;">Input Tagihan</h3>
      <form id="tagihanForm" method="POST" target="hidden_iframe" enctype="multipart/form-data">
        
        <label>Tanggal Nota</label>
        <input type="date" id="tanggal" name="tanggal" required />

        <label>Pilih Vendor</label>
        <select id="vendorSelect" name="vendor" required>
          <option value="">-- Loading Vendor... --</option>
        </select>

        <input type="hidden" name="action" value="simpan_tagihan">
        <input type="hidden" id="hiddenMaterial" name="material">
        <input type="hidden" id="hiddenTop" name="top">

        <label>Jatuh Tempo (Otomatis)</label>
        <input type="text" id="jatuhTempo" name="jatuhTempo" readonly style="background:#f1f5f9" />

        <label>Total Rupiah</label>
        <input type="number" name="total" placeholder="Contoh: 1500000" required />

        <label>Foto Nota</label>
        <input type="file" name="bukti" accept="image/*,.pdf" required />

        <button type="submit" class="btn">Kirim Data</button>
      </form>
    </div>
  </div>

  <dialog id="vendorDialog">
    <form method="dialog">
      <h3 style="margin-top:0">Vendor Baru</h3>
      
      <label>Nama Vendor</label>
      <input type="text" id="newVendorName" placeholder="PT..." />

      <label>Material</label>
      <input type="text" id="newVendorMat" placeholder="Pasir, Semen..." />

      <label>TOP (Termin)</label>
      <select id="newVendorTop"></select>

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('vendorDialog').close()">Batal</button>
        <button type="button" class="btn" onclick="simpanVendor()">Simpan</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast">Pesan...</div>
  
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script>
    // ==========================================
    // PASTE URL APPS SCRIPT ANDA DI BAWAH INI !!
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby35BUkEx44e226aMxqdQqHGR-44jYysKje3x-LKmv581Tv41C6Hshqq8LTIhVOW40B/exec"; 
    // Contoh: "https://script.google.com/macros/s/AKfycbx.../exec"

    const LOCAL_VENDOR_KEY = "master_vendor_v2";
    const vendorSelect = document.getElementById("vendorSelect");
    const topSelect = document.getElementById("newVendorTop");

    // 1. INIT SAAT LOAD
    window.onload = function() {
      if(SCRIPT_URL.includes("GANTI_DENGAN")) {
        alert("PERHATIAN: Anda belum mengganti SCRIPT_URL di dalam kode HTML!");
      }

      // Isi Dropdown TOP 15-120
      for(let i=15; i<=120; i++){
        let opt = document.createElement("option");
        opt.value = i + " hari";
        opt.textContent = i + " hari";
        topSelect.appendChild(opt);
      }
      
      loadVendorsToSelect();
      document.getElementById("tagihanForm").action = SCRIPT_URL;
    };

    // 2. LOAD VENDORS DARI LOCALSTORAGE
    function loadVendorsToSelect() {
      let vendors = JSON.parse(localStorage.getItem(LOCAL_VENDOR_KEY) || "[]");
      
      if(vendors.length === 0) {
        vendorSelect.innerHTML = "<option value=''>-- Belum ada vendor --</option>";
      } else {
        vendorSelect.innerHTML = "<option value=''>-- Pilih Vendor --</option>";
        vendors.forEach(v => {
          // Kita simpan info lengkap di atribut data
          let opt = document.createElement("option");
          opt.value = v.name;
          opt.textContent = v.name;
          opt.dataset.material = v.material;
          opt.dataset.top = v.top;
          vendorSelect.appendChild(opt);
        });
      }
    }

    // 3. LOGIKA JATUH TEMPO
    vendorSelect.addEventListener("change", function() {
      let opt = vendorSelect.options[vendorSelect.selectedIndex];
      if(opt && opt.dataset.top) {
        // Isi hidden input untuk dikirim ke spreadsheet
        document.getElementById("hiddenMaterial").value = opt.dataset.material;
        document.getElementById("hiddenTop").value = opt.dataset.top;

        // Hitung Tanggal
        let tgl = document.getElementById("tanggal").value;
        if(tgl) hitungJatuhTempo(tgl, opt.dataset.top);
      }
    });

    document.getElementById("tanggal").addEventListener("change", function() {
      let opt = vendorSelect.options[vendorSelect.selectedIndex];
      if(opt && opt.dataset.top) hitungJatuhTempo(this.value, opt.dataset.top);
    });

    function hitungJatuhTempo(tglStr, topStr) {
      let days = parseInt(topStr);
      let d = new Date(tglStr);
      d.setDate(d.getDate() + days);
      document.getElementById("jatuhTempo").value = d.toISOString().split("T")[0];
    }

    // 4. SIMPAN VENDOR BARU
    function openVendorModal() {
      document.getElementById("vendorDialog").showModal();
    }

    function simpanVendor() {
      let name = document.getElementById("newVendorName").value.trim();
      let mat = document.getElementById("newVendorMat").value;
      let top = document.getElementById("newVendorTop").value;

      if(!name) return alert("Nama vendor wajib diisi");

      // Cek Duplikat Lokal
      let vendors = JSON.parse(localStorage.getItem(LOCAL_VENDOR_KEY) || "[]");
      if(vendors.some(v => v.name.toLowerCase() === name.toLowerCase())) {
        return alert("Nama vendor sudah ada!");
      }

      // 1. Simpan Lokal
      vendors.push({name: name, material: mat, top: top});
      localStorage.setItem(LOCAL_VENDOR_KEY, JSON.stringify(vendors));
      
      // 2. Kirim ke Server (Background)
      let formData = new FormData();
      formData.append("action", "simpan_vendor");
      formData.append("vendorName", name);
      formData.append("vendorMaterial", mat);
      formData.append("vendorTop", top);
      fetch(SCRIPT_URL, { method: "POST", body: formData, mode: "no-cors" });

      // 3. Reset UI
      loadVendorsToSelect();
      document.getElementById("vendorDialog").close();
      document.getElementById("newVendorName").value = "";
      showToast("Vendor berhasil ditambahkan!");
    }

    // 5. HANDLING SUBMIT TAGIHAN
    document.getElementById("tagihanForm").addEventListener("submit", function() {
      showToast("Sedang mengirim data...");
      setTimeout(() => {
        this.reset();
        showToast("Data Terkirim! Cek Spreadsheet.");
        document.getElementById("jatuhTempo").value = "";
      }, 2000);
    });

    function showToast(msg) {
      let t = document.getElementById("toast");
      t.innerText = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 3000);
    }
  </script>
</body>
</html>