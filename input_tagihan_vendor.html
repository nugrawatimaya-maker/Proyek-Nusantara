<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Input Tagihan & Vendor</title>
  <style>
    :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; }
    
    .header { background: #fff; padding: 16px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center; }
    .header h2 { margin: 0; font-size: 18px; color: var(--primary); }
    .refresh-icon { cursor: pointer; font-size: 18px; }

    .container { max-width: 600px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    label { display: block; font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 6px; margin-top: 12px; }
    input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
    input:focus, select:focus { outline: 2px solid var(--primary); border-color: var(--primary); }
    
    .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    .btn-secondary { background: #e2e8f0; color: #334155; margin-top: 0; margin-bottom: 10px; }
    
    /* Modal */
    dialog { border: none; border-radius: 12px; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    dialog::backdrop { background: rgba(0,0,0,0.5); }
    
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 100; text-align: center; font-size: 14px; min-width: 200px; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

  <div class="header">
    <h2>Aplikasi Tagihan</h2>
    <span class="refresh-icon" onclick="syncVendorsFromSpreadsheet(true)" title="Refresh Data">üîÑ</span>
  </div>

  <div class="container">
    <button class="btn btn-secondary" onclick="openVendorModal()">+ Tambah Vendor Baru</button>

    <div class="card">
      <h3 style="margin-top:0;">Input Tagihan</h3>
      <form id="tagihanForm" method="POST" target="hidden_iframe" enctype="multipart/form-data">
        
        <label>Tanggal Nota</label>
        <input type="date" id="tanggal" name="tanggal" required />

        <label>Pilih Vendor</label>
        <select id="vendorSelect" name="vendor" required>
          <option value="">-- Memuat Data... --</option>
        </select>

        <input type="hidden" name="action" value="simpan_tagihan">
        <input type="hidden" id="hiddenMaterial" name="material">
        <input type="hidden" id="hiddenTop" name="top">

        <label>Jatuh Tempo (Otomatis)</label>
        <input type="text" id="jatuhTempo" name="jatuhTempo" readonly style="background:#f1f5f9" />

        <label>Total Rupiah</label>
        <input type="number" name="total" placeholder="Contoh: 1500000" required />

        <label>Foto Nota</label>
        <input type="file" name="bukti" accept="image/*,.pdf" required />

        <button type="submit" class="btn">Kirim Data</button>
      </form>
    </div>
  </div>

  <dialog id="vendorDialog">
    <form method="dialog">
      <h3 style="margin-top:0">Vendor Baru</h3>
      
      <label>Nama Vendor</label>
      <input type="text" id="newVendorName" placeholder="PT..." />

      <label>Material</label>
      <input type="text" id="newVendorMat" placeholder="Pasir, Semen..." />

      <label>TOP (Termin)</label>
      <select id="newVendorTop"></select>

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('vendorDialog').close()">Batal</button>
        <button type="button" class="btn" onclick="simpanVendor()">Simpan</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast">Pesan...</div>
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script>
    // --- GANTI URL INI DENGAN URL DEPLOY ANDA ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby35BUkEx44e226aMxqdQqHGR-44jYysKje3x-LKmv581Tv41C6Hshqq8LTIhVOW40B/exec"; 

    const LOCAL_VENDOR_KEY = "master_vendor_v3"; // Key baru biar fresh
    const vendorSelect = document.getElementById("vendorSelect");
    const topSelect = document.getElementById("newVendorTop");

    // 1. INIT SAAT LOAD
    window.onload = function() {
      // Setup Dropdown Angka 15-120
      for(let i=15; i<=120; i++){
        let opt = document.createElement("option");
        opt.value = i + " hari";
        opt.textContent = i + " hari";
        topSelect.appendChild(opt);
      }
      
      // Load data lokal dulu (biar cepat tampil)
      renderVendorOptions();
      
      // Tarik data terbaru dari Spreadsheet (Background)
      syncVendorsFromSpreadsheet();

      document.getElementById("tagihanForm").action = SCRIPT_URL;
    };

    // 2. FUNGSI FETCH DATA DARI SPREADSHEET (PENTING!)
    function syncVendorsFromSpreadsheet(showNotif = false) {
      if(showNotif) showToast("üîÑ Sinkronisasi data...");
      
      fetch(SCRIPT_URL)
        .then(response => response.json())
        .then(data => {
          if (Array.isArray(data) && data.length > 0) {
            // Simpan ke HP
            localStorage.setItem(LOCAL_VENDOR_KEY, JSON.stringify(data));
            // Update Tampilan
            renderVendorOptions();
            if(showNotif) showToast("‚úÖ Data Vendor Terupdate!");
          } else {
             console.log("Data kosong atau format salah");
          }
        })
        .catch(error => {
          console.error("Gagal ambil data:", error);
          if(showNotif) showToast("‚ùå Gagal koneksi internet");
        });
    }

    // 3. RENDER DROPDOWN (DARI LOCAL STORAGE)
    function renderVendorOptions() {
      let vendors = JSON.parse(localStorage.getItem(LOCAL_VENDOR_KEY) || "[]");
      
      // Simpan pilihan yang sedang dipilih user (jika ada) agar tidak reset saat refresh
      let currentVal = vendorSelect.value; 

      if(vendors.length === 0) {
        vendorSelect.innerHTML = "<option value=''>-- Belum ada data (Online dulu) --</option>";
      } else {
        vendorSelect.innerHTML = "<option value=''>-- Pilih Vendor --</option>";
        vendors.forEach(v => {
          let opt = document.createElement("option");
          opt.value = v.name;
          opt.textContent = v.name;
          opt.dataset.material = v.material;
          opt.dataset.top = v.top;
          vendorSelect.appendChild(opt);
        });
      }

      if(currentVal) vendorSelect.value = currentVal;
    }

    // 4. LOGIKA JATUH TEMPO
    vendorSelect.addEventListener("change", function() {
      let opt = vendorSelect.options[vendorSelect.selectedIndex];
      if(opt && opt.dataset.top) {
        document.getElementById("hiddenMaterial").value = opt.dataset.material;
        document.getElementById("hiddenTop").value = opt.dataset.top;
        
        let tgl = document.getElementById("tanggal").value;
        if(tgl) hitungJatuhTempo(tgl, opt.dataset.top);
      }
    });

    document.getElementById("tanggal").addEventListener("change", function() {
      let opt = vendorSelect.options[vendorSelect.selectedIndex];
      if(opt && opt.dataset.top) hitungJatuhTempo(this.value, opt.dataset.top);
    });

    function hitungJatuhTempo(tglStr, topStr) {
      let days = parseInt(topStr);
      if(isNaN(days)) return;
      let d = new Date(tglStr);
      d.setDate(d.getDate() + days);
      document.getElementById("jatuhTempo").value = d.toISOString().split("T")[0];
    }

    // 5. SIMPAN VENDOR BARU
    function openVendorModal() {
      document.getElementById("vendorDialog").showModal();
    }

    function simpanVendor() {
      let name = document.getElementById("newVendorName").value.trim();
      let mat = document.getElementById("newVendorMat").value;
      let top = document.getElementById("newVendorTop").value;

      if(!name) return alert("Nama vendor wajib diisi");

      // Cek Duplikat Lokal
      let vendors = JSON.parse(localStorage.getItem(LOCAL_VENDOR_KEY) || "[]");
      if(vendors.some(v => v.name.toLowerCase() === name.toLowerCase())) {
        return alert("Nama vendor sudah ada!");
      }

      // Optimis UI: Simpan Lokal Langsung
      vendors.push({name: name, material: mat, top: top});
      localStorage.setItem(LOCAL_VENDOR_KEY, JSON.stringify(vendors));
      renderVendorOptions();
      
      // Kirim ke Server
      let formData = new FormData();
      formData.append("action", "simpan_vendor");
      formData.append("vendorName", name);
      formData.append("vendorMaterial", mat);
      formData.append("vendorTop", top);
      fetch(SCRIPT_URL, { method: "POST", body: formData, mode: "no-cors" });

      document.getElementById("vendorDialog").close();
      document.getElementById("newVendorName").value = "";
      showToast("Vendor ditambahkan!");
    }

    // 6. HANDLING SUBMIT TAGIHAN
    document.getElementById("tagihanForm").addEventListener("submit", function() {
      showToast("Mengirim data...");
      setTimeout(() => {
        this.reset();
        showToast("‚úÖ Data Terkirim!");
        document.getElementById("jatuhTempo").value = "";
      }, 2000);
    });

    function showToast(msg) {
      let t = document.getElementById("toast");
      t.innerText = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 3000);
    }
  </script>
</body>
</html>