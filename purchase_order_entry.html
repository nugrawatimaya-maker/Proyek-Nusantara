<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Finance - Purchase Order (PO)</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    /* Custom Checkbox */
    .chk-item { transform: scale(1.5); cursor: pointer; accent-color: #2563eb; }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 p-6">

  <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-blue-800">Finance Approval (PO)</h1>
      <p class="text-sm text-gray-500">Penerbitan & Pencetakan Purchase Order Profesional</p>
    </div>
    <div class="space-x-3">
        <a href="master_vendor.html" class="text-sm bg-pink-100 text-pink-700 px-3 py-1 rounded hover:bg-pink-200"><i class="fas fa-users"></i> Kelola Vendor</a>
        <a href="dashboard_finance.html" class="text-sm text-blue-600 hover:underline">← Kembali ke Dashboard</a>
    </div>
  </div>

  <div class="max-w-7xl mx-auto bg-white rounded-lg shadow overflow-hidden mb-10 border-l-4 border-yellow-400 relative">
    <div class="p-4 bg-yellow-50 border-b border-yellow-100 flex justify-between items-center sticky top-0 z-10">
        <h3 class="font-bold text-yellow-800"><i class="fas fa-clock mr-2"></i>Antrian Request (Belum Ada PO)</h3>
        
        <button id="btnBatch" onclick="siapkanBatch()" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow font-bold text-sm flex items-center gap-2 animate-bounce">
            <i class="fas fa-layer-group"></i> Proses PO (<span id="countBatch">0</span> Item)
        </button>
    </div>

    <table class="w-full text-left border-collapse">
      <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-bold">
        <tr>
          <th class="p-4 text-center w-10"><input type="checkbox" id="chkAll" class="chk-item" onclick="toggleAll(this)"></th>
          <th class="p-4">Tanggal & Staff</th>
          <th class="p-4">Barang diminta & Stok Gudang</th>
          <th class="p-4 w-40 text-right">Status</th>
        </tr>
      </thead>
      <tbody id="tabelAntrian" class="text-sm divide-y divide-gray-100">
        <tr><td colspan="4" class="p-6 text-center text-gray-400">Sedang memuat data...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="max-w-7xl mx-auto bg-white rounded-lg shadow overflow-hidden mb-10 border-l-4 border-blue-600">
    <div class="p-4 bg-blue-50 border-b border-blue-100 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-2">
            <h3 class="font-bold text-blue-800"><i class="fas fa-history mr-2"></i>Arsip PO</h3>
        </div>

        <div class="flex items-center gap-2 bg-white p-2 rounded shadow-sm border">
            <span class="text-xs font-bold text-gray-500">Periode:</span>
            <input type="date" id="filterMulai" class="border rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
            <span class="text-xs text-gray-400">s/d</span>
            <input type="date" id="filterAkhir" class="border rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
            
            <button onclick="cariRiwayat()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded text-xs font-bold transition flex items-center gap-2">
                <i class="fas fa-search"></i> Tampilkan
            </button>
        </div>

    </div>

    <table class="w-full text-left border-collapse">
      <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-bold">
        <tr>
          <th class="p-4">No. PO / Tanggal</th>
          <th class="p-4">Vendor</th>
          <th class="p-4 text-center">Jml Item</th>
          <th class="p-4 text-right">Grand Total</th>
          <th class="p-4 text-center">Status</th>
          <th class="p-4 text-center">Aksi</th>
        </tr>
      </thead>
      <tbody id="tabelRiwayat" class="text-sm divide-y divide-gray-100">
        <tr><td colspan="6" class="p-8 text-center text-gray-400 italic">Silakan pilih tanggal dan klik 'Tampilkan' untuk melihat arsip.</td></tr>
      </tbody>
    </table>
  </div>

  <div id="modalBatch" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center backdrop-blur-sm">
    <div class="bg-white w-full max-w-4xl p-6 rounded-xl shadow-2xl relative max-h-[95vh] overflow-auto border border-gray-200">
        <button onclick="tutupModalBatch()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
        
        <div class="flex items-center gap-3 mb-6 border-b pb-4">
            <div class="bg-blue-100 p-2 rounded-full text-blue-600"><i class="fas fa-file-invoice-dollar fa-lg"></i></div>
            <h2 class="text-xl font-bold text-gray-800">Penerbitan Purchase Order</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded-lg border">
            <div class="md:col-span-2">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Vendor</label>
                <select id="batchVendor" class="w-full border p-2 rounded font-bold text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none" onchange="autoIsiTempoBatch(this)">
                    <option value="">-- Pilih Vendor Database --</option>
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jatuh Tempo Pembayaran</label>
                <input type="date" id="batchTempo" class="w-full border p-2 rounded text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                <p class="text-[10px] text-blue-500 mt-1 italic" id="batchInfoTop">Otomatis dari data vendor</p>
            </div>
        </div>

        <h3 class="font-bold text-gray-700 mb-2 text-sm uppercase tracking-wide">Rincian & Harga Item</h3>
        <div class="overflow-x-auto border rounded-lg mb-6">
            <table class="w-full text-sm">
                <thead class="bg-gray-100 font-bold text-gray-600">
                    <tr>
                        <th class="p-3 text-left">Nama Barang</th>
                        <th class="p-3 text-center">Qty</th>
                        <th class="p-3 w-48 text-right">Harga Satuan (Rp)</th>
                        <th class="p-3 w-48 text-right">Subtotal</th>
                    </tr>
                </thead>
                <tbody id="bodyBatchInput" class="divide-y"></tbody>
                <tfoot class="bg-gray-50">
                    <tr>
                        <td colspan="3" class="p-3 text-right font-bold text-gray-600">GRAND TOTAL EST.</td>
                        <td class="p-3 text-right font-bold text-blue-700 text-lg" id="batchGrandTotal">Rp 0</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="text-right flex justify-end gap-3">
            <button onclick="tutupModalBatch()" class="px-5 py-2 text-gray-500 hover:text-gray-800 font-bold text-sm">Batal</button>
            <button id="btnTerbitkan" onclick="terbitkanPO()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2 transition hover:scale-105">
                <i class="fas fa-save"></i> <span>Simpan & Download PDF</span>
            </button>
        </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    const fmt = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    const fmtNum = (n) => new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(n);

    let listVendor = [];
    let listPending = [];
    let selectedIds = [];
    let batchData = [];

    // --- INIT ---
    function init() {
        loadVendors();
        loadPendingRequests();

        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById("filterAkhir").value = today.toISOString().split('T')[0];
        document.getElementById("filterMulai").value = firstDay.toISOString().split('T')[0];
    }
    
    // 1. LOAD DATA
    async function loadVendors() {
        const { data } = await client.from('master_vendor').select('*').order('nama_vendor');
        if (data) listVendor = data;
    }

    async function loadPendingRequests() {
      const { data } = await client.from('inventory_req').select('*').eq('status', 'PENDING').order('created_at');
      listPending = data || [];
      const tbody = document.getElementById("tabelAntrian");
      tbody.innerHTML = "";

      if (listPending.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400 italic">Tidak ada permintaan pending.</td></tr>`;
        return;
      }

      // Cek Stok Gudang
      const itemNames = listPending.map(item => item.nama_barang);
      const { data: stockData } = await client.from('master_stok').select('nama_barang, total_stok').in('nama_barang', itemNames);
      const stockMap = {};
      if(stockData) stockData.forEach(s => stockMap[s.nama_barang] = s.total_stok);

      listPending.forEach(item => {
        const sisa = stockMap[item.nama_barang] || 0;
        const stokBadge = sisa === 0 
            ? `<span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded border border-red-200">Stok: 0</span>` 
            : `<span class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded border border-green-200">Stok: ${sisa}</span>`;

        tbody.innerHTML += `
          <tr class="hover:bg-yellow-50 border-b transition">
            <td class="p-4 text-center"><input type="checkbox" class="chk-item" value="${item.id}" onchange="cekCentang()"></td>
            <td class="p-4">
              <div class="font-bold text-gray-700">${new Date(item.created_at).toLocaleDateString('id-ID')}</div>
              <div class="text-xs text-gray-500"><i class="fas fa-user-circle"></i> ${item.pengorder}</div>
            </td>
            <td class="p-4">
              <div class="font-bold text-gray-800">${item.nama_barang}</div>
              <div class="flex items-center gap-2 mt-1">
                  <span class="text-xs bg-gray-200 px-2 py-0.5 rounded font-bold">Req: ${item.jumlah} ${item.satuan}</span>
                  ${stokBadge}
              </div>
            </td>
            <td class="p-4 text-right"><span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded">Pending Approval</span></td>
          </tr>`;
      });
    }

    // 2. LOGIKA PILIH BATCH
    function toggleAll(source) {
        document.querySelectorAll('.chk-item').forEach(chk => { if(chk !== source) chk.checked = source.checked; });
        cekCentang();
    }
    function cekCentang() {
        const checked = document.querySelectorAll('.chk-item:checked:not(#chkAll)');
        selectedIds = Array.from(checked).map(c => c.value);
        const btn = document.getElementById("btnBatch");
        document.getElementById("countBatch").innerText = selectedIds.length;
        if (selectedIds.length > 0) btn.classList.remove("hidden"); else btn.classList.add("hidden");
    }

    // 3. SETUP BATCH (MODAL)
    function siapkanBatch() {
        // Isi Dropdown Vendor
        const selVendor = document.getElementById("batchVendor");
        selVendor.innerHTML = '<option value="">-- Pilih Vendor Database --</option>';
        listVendor.forEach(v => {
            selVendor.innerHTML += `<option value="${v.nama_vendor}" data-top="${v.top_hari}" data-alamat="${v.alamat || '-'}">${v.nama_vendor}</option>`;
        });

        const tbody = document.getElementById("bodyBatchInput");
        tbody.innerHTML = "";
        const selectedItems = listPending.filter(item => selectedIds.includes(String(item.id)));
        
        selectedItems.forEach((item, idx) => {
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-3">
                        <div class="font-bold text-gray-700">${item.nama_barang}</div>
                        <input type="hidden" id="bid-${idx}" value="${item.id}">
                        <input type="hidden" id="bnama-${idx}" value="${item.nama_barang}">
                        <input type="hidden" id="bqty-${idx}" value="${item.jumlah}">
                        <input type="hidden" id="bsat-${idx}" value="${item.satuan}">
                        <input type="hidden" id="bstaff-${idx}" value="${item.pengorder}">
                    </td>
                    <td class="p-3 text-center text-sm font-bold bg-gray-50">${item.jumlah} ${item.satuan}</td>
                    <td class="p-3">
                        <input type="number" id="bharga-${idx}" class="w-full border p-2 rounded text-right focus:border-blue-500 outline-none" placeholder="0" onkeyup="hitungTotalBatch()">
                    </td>
                    <td class="p-3 text-right font-bold text-gray-700" id="bsub-${idx}">Rp 0</td>
                </tr>
            `;
        });
        document.getElementById("modalBatch").classList.remove("hidden");
        document.getElementById("batchGrandTotal").innerText = "Rp 0";
    }

    function hitungTotalBatch() {
        let grandTotal = 0;
        for(let i=0; i<selectedIds.length; i++) {
            const qty = Number(document.getElementById(`bqty-${i}`).value);
            const harga = Number(document.getElementById(`bharga-${i}`).value);
            const sub = qty * harga;
            grandTotal += sub;
            document.getElementById(`bsub-${i}`).innerText = fmt(sub);
        }
        document.getElementById("batchGrandTotal").innerText = fmt(grandTotal);
    }

    function autoIsiTempoBatch(selectEl) {
        const top = parseInt(selectEl.options[selectEl.selectedIndex].getAttribute('data-top') || 0);
        const t = new Date(); t.setDate(t.getDate() + top);
        document.getElementById("batchTempo").value = t.toISOString().split('T')[0];
        document.getElementById("batchInfoTop").innerText = top > 0 ? `Term: ${top} Hari (Auto)` : "Pembayaran Tunai";
    }

    function tutupModalBatch() { document.getElementById("modalBatch").classList.add("hidden"); }

    // 4. TERBITKAN PO & DOWNLOAD PDF
    async function terbitkanPO() {
        const vendorEl = document.getElementById("batchVendor");
        const vendorName = vendorEl.value;
        const vendorAddress = vendorEl.options[vendorEl.selectedIndex].getAttribute('data-alamat') || '';
        const tempo = document.getElementById("batchTempo").value;

        if(!vendorName || !tempo) { alert("Harap lengkapi Vendor & Jatuh Tempo!"); return; }

        batchData = [];
        let grandTotal = 0;
        const count = selectedIds.length;
        const nomorPO = "PO-" + Math.floor(100000 + Math.random() * 900000);
        const tglPO = new Date().toISOString().split('T')[0];

        // Collect Data
        for(let i=0; i<count; i++) {
            const harga = Number(document.getElementById(`bharga-${i}`).value);
            if(harga <= 0) { alert("Harga item tidak boleh 0!"); return; }
            
            const item = {
                reqId: document.getElementById(`bid-${i}`).value,
                nama: document.getElementById(`bnama-${i}`).value,
                qty: document.getElementById(`bqty-${i}`).value,
                satuan: document.getElementById(`bsat-${i}`).value,
                staff: document.getElementById(`bstaff-${i}`).value,
                harga: harga,
                total: harga * Number(document.getElementById(`bqty-${i}`).value)
            };
            grandTotal += item.total;
            batchData.push(item);
        }

        const btn = document.getElementById("btnTerbitkan");
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Menyimpan...`;
        btn.disabled = true;

        try {
            // A. SIMPAN KE DB
            const payload = batchData.map(d => ({
                req_id: d.reqId, nomor_po: nomorPO, nama_vendor: vendorName,
                harga_satuan: d.harga, total_harga: d.total, jatuh_tempo: tempo, status: 'OPEN'
            }));
            const { error } = await client.from('purchase_order').insert(payload);
            if(error) throw error;

            // B. UPDATE STATUS REQUEST
            const reqIds = batchData.map(d => d.reqId);
            await client.from('inventory_req').update({ status: 'PO DIBUAT' }).in('id', reqIds);

            // C. GENERATE PDF LANGSUNG
            const pdfData = {
                noPO: nomorPO,
                tgl: tglPO,
                vendor: vendorName,
                vendorAlamat: vendorAddress,
                tempo: tempo,
                items: batchData,
                grandTotal: grandTotal
            };
            generatePOPdf(pdfData);

            alert("✅ PO Berhasil Diterbitkan! PDF sedang didownload.");
            tutupModalBatch();
            document.querySelectorAll('.chk-item').forEach(c => c.checked = false);
            cekCentang();
            await loadPendingRequests();
            await cariRiwayat();

        } catch (e) {
            alert("Gagal: " + e.message);
            btn.innerHTML = "Coba Lagi"; btn.disabled = false;
        }
    }

    // 5. PDF GENERATOR ENGINE (JSPDF + AutoTable) - VERSI PRO
    function generatePOPdf(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, A4

        // --- KOP SURAT ---
        // Logo (Placeholder)
        // doc.addImage("logo.png", "PNG", 15, 10, 20, 20); 

        doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("PT. NUSANTARA LAND DEVELOPMENT", 15, 20);
        
        doc.setFontSize(9); doc.setFont("helvetica", "normal");
        doc.text("Perumahan Sunrise City Maros", 15, 25);
        doc.text("082022872224 | Didin", 15, 30);
        
        doc.setLineWidth(0.5); doc.line(15, 35, 195, 35); // Garis

        // --- JUDUL DOKUMEN ---
        doc.setFontSize(18); doc.setFont("helvetica", "bold");
        doc.text("PURCHASE ORDER", 105, 45, { align: "center" });

        // --- INFO PO & VENDOR (2 KOLOM) ---
        doc.setFontSize(10); doc.setFont("helvetica", "bold");
        
        // Kolom Kiri (Vendor)
        doc.text("KEPADA:", 15, 55);
        doc.setFont("helvetica", "normal");
        doc.text(data.vendor, 15, 60);
        doc.setFontSize(9);
        doc.text(data.vendorAlamat || "(Alamat tidak terdata)", 15, 65, { maxWidth: 80 });

        // Kolom Kanan (Detail PO)
        doc.setFontSize(10); doc.setFont("helvetica", "bold");
        doc.text("DETAIL PESANAN:", 120, 55);
        
        doc.setFont("helvetica", "normal");
        doc.text(`Nomor PO      : ${data.noPO}`, 120, 60);
        doc.text(`Tanggal       : ${new Date(data.tgl).toLocaleDateString('id-ID')}`, 120, 65);
        doc.text(`Jatuh Tempo   : ${new Date(data.tempo).toLocaleDateString('id-ID')}`, 120, 70);

        // --- TABEL BARANG ---
        const head = [['No', 'Deskripsi Barang', 'Qty', 'Harga Satuan', 'Total']];
        const body = data.items.map((item, index) => [
            index + 1,
            item.nama,
            `${item.qty} ${item.satuan}`,
            fmtNum(item.harga),
            fmtNum(item.total)
        ]);

        // Tambah Baris Total
        body.push([
            { content: 'GRAND TOTAL', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } },
            { content: fmt(data.grandTotal), styles: { fontStyle: 'bold', fillColor: [240, 240, 240] } }
        ]);

        doc.autoTable({
            startY: 80,
            head: head,
            body: body,
            theme: 'grid',
            headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
            columnStyles: {
                0: { halign: 'center', cellWidth: 10 },
                2: { halign: 'center' },
                3: { halign: 'right' },
                4: { halign: 'right' }
            },
            styles: { fontSize: 9, cellPadding: 3 }
        });

        // --- FOOTER TANDA TANGAN ---
        let finalY = doc.lastAutoTable.finalY + 20;
        if(finalY > 250) { doc.addPage(); finalY = 20; }

        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        
        // Kiri (Dibuat)
        doc.text("Dibuat Oleh,", 30, finalY);
        doc.text("( Sri Wahyuni )", 30, finalY + 25);

        // Kanan (Disetujui)
        doc.text("Disetujui Oleh,", 140, finalY);
        doc.text("( Direktur )", 140, finalY + 25);

        // Footer Note
        doc.setFontSize(8); doc.setFont("helvetica", "italic");
        doc.text("* Dokumen ini diterbitkan secara digital oleh sistem NLD Corp.", 105, 285, { align: "center" });

        doc.save(`${data.noPO}_${data.vendor}.pdf`);
    }

    async function cariRiwayat() {
        const tglMulai = document.getElementById("filterMulai").value;
        const tglAkhir = document.getElementById("filterAkhir").value;
        const tbody = document.getElementById("tabelRiwayat");

        if(!tglMulai || !tglAkhir) { alert("Harap pilih periode tanggal!"); return; }

        tbody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-gray-400"><i class="fas fa-spinner fa-spin text-blue-500"></i> Mengambil data dari server...</td></tr>`;

        const { data, error } = await client
            .from('purchase_order')
            .select('nomor_po, created_at, nama_vendor, jatuh_tempo, status, total_harga, req_id')
            .gte('created_at', `${tglMulai} 00:00:00`)
            .lte('created_at', `${tglAkhir} 23:59:59`)
            .order('created_at', { ascending: false });

        if(error) {
            tbody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-red-500">Error: ${error.message}</td></tr>`;
            return;
        }

        tbody.innerHTML = "";
        if(!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400 bg-gray-50 italic">Tidak ditemukan PO pada periode ${tglMulai} s/d ${tglAkhir}.</td></tr>`;
            return;
        }

        const groups = {};
        data.forEach(row => {
            if(!groups[row.nomor_po]) groups[row.nomor_po] = { 
                tgl: row.created_at, 
                vendor: row.nama_vendor, 
                tempo: row.jatuh_tempo, 
                status: row.status, 
                grandTotal: 0, 
                itemsCount: 0 
            };
            groups[row.nomor_po].grandTotal += row.total_harga;
            groups[row.nomor_po].itemsCount += 1;
        });

        Object.keys(groups).forEach(noPO => {
            const g = groups[noPO];
            
            tbody.innerHTML += `
                <tr class="hover:bg-blue-50 border-b group transition">
                    <td class="p-4 font-bold text-gray-800">${noPO} <br> <span class="text-xs text-gray-500 font-normal">${new Date(g.tgl).toLocaleDateString('id-ID')}</span></td>
                    <td class="p-4 text-gray-700">${g.vendor}</td>
                    <td class="p-4 text-center"><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold border">${g.itemsCount} Item</span></td>
                    <td class="p-4 text-right font-bold font-mono text-green-700">${fmt(g.grandTotal)}</td>
                    <td class="p-4 text-center"><span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200">${g.status}</span></td>
                    <td class="p-4 text-center flex justify-center gap-2">
                        <button onclick='fetchDetailAndPrint("${noPO}", event)' class="bg-gray-800 text-white px-3 py-1 rounded text-xs hover:bg-black transition shadow" title="Download PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        <button onclick='hapusPO("${noPO}")' class="bg-white text-red-600 border border-red-200 px-3 py-1 rounded text-xs hover:bg-red-50 transition shadow" title="Hapus Permanen">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>`;
        });
    }

    async function hapusPO(nomorPO) {
        if(!confirm(`⚠️ PERINGATAN KERAS:\n\nAnda akan menghapus ${nomorPO}.\n\nData permintaan barang ini akan DIHAPUS PERMANEN dan TIDAK AKAN KEMBALI ke antrian.\n\nApakah Anda yakin?`)) return;

        try {
            const { data: poItems } = await client.from('purchase_order').select('req_id').eq('nomor_po', nomorPO);
            
            if (poItems && poItems.length > 0) {
                const reqIds = poItems.map(item => item.req_id).filter(Boolean);

                const { error: errDeletePO } = await client.from('purchase_order').delete().eq('nomor_po', nomorPO);
                if(errDeletePO) throw new Error("Gagal menghapus data PO: " + errDeletePO.message);

                const { error: errDeleteReq } = await client.from('inventory_req')
                    .delete()
                    .in('id', reqIds);
                
                if(errDeleteReq) throw new Error("Gagal menghapus data Request: " + errDeleteReq.message);
            } else {
                await client.from('purchase_order').delete().eq('nomor_po', nomorPO);
            }

            alert("✅ PO dan Permintaan Barang terkait telah DIHAPUS PERMANEN.");
            cariRiwayat();
            loadPendingRequests();
        } catch (err) {
            alert("Terjadi kesalahan: " + err.message);
        }
    }

    async function fetchDetailAndPrint(nomorPO, event) {
        const btn = event?.currentTarget || (event?.target && event.target.closest('button'));
        const originalContent = btn?.innerHTML;
        if(btn) {
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            btn.disabled = true;
        }

        try {
            const { data: poData } = await client.from('purchase_order').select('*').eq('nomor_po', nomorPO);
            if(!poData || poData.length === 0) throw new Error("Data PO tidak ditemukan");

            const reqIds = poData.map(i => i.req_id).filter(Boolean);
            let reqData = [];
            if(reqIds.length > 0) {
                const res = await client.from('inventory_req').select('id, nama_barang, satuan').in('id', reqIds);
                if(res.error) throw new Error("Gagal mengambil data request");
                reqData = res.data || [];
            }

            const mapInfo = {};
            reqData.forEach(d => mapInfo[d.id] = d);

            const itemsFormatted = poData.map(i => {
                const info = mapInfo[i.req_id] || { nama_barang: 'Item (Terhapus)', satuan: 'Unit' };
                const price = Number(i.harga_satuan) || 0;
                const total = Number(i.total_harga) || 0;
                return {
                    nama: info.nama_barang,
                    qty: price > 0 ? total / price : 0,
                    satuan: info.satuan,
                    harga: price,
                    total: total
                };
            });

            const grandTotal = itemsFormatted.reduce((sum, item) => sum + item.total, 0);
            const pdfData = {
                noPO: nomorPO,
                tgl: poData[0].created_at,
                vendor: poData[0].nama_vendor,
                vendorAlamat: "",
                tempo: poData[0].jatuh_tempo,
                items: itemsFormatted,
                grandTotal: grandTotal
            };

            generatePOPdf(pdfData);
        } catch (err) {
            alert("Gagal print: " + err.message);
        } finally {
            if(btn) {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }
    }

    init();
  </script>
</body>
</html>
