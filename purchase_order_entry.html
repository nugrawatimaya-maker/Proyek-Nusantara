<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Finance - Terbitkan PO</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-800 p-6">

  <div class="max-w-6xl mx-auto mb-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-blue-800">Finance Approval (PO)</h1>
      <p class="text-sm text-gray-500">Menunggu persetujuan & penerbitan PO</p>
    </div>
    <a href="inventory_req.html" class="text-sm text-blue-600 hover:underline">← Lihat Menu Gudang</a>
  </div>

  <div class="max-w-6xl mx-auto bg-white rounded-lg shadow overflow-hidden">
    <table class="w-full text-left border-collapse">
      <thead class="bg-blue-50 text-blue-900 uppercase text-xs font-bold">
        <tr>
          <th class="p-4">Tanggal & Staff</th>
          <th class="p-4">Barang diminta</th>
          <th class="p-4 w-48">Vendor Supplier</th>
          <th class="p-4 w-32">Harga Satuan</th>
          <th class="p-4 w-32">Jatuh Tempo</th>
          <th class="p-4 text-center">Aksi</th>
        </tr>
      </thead>
      <tbody id="tabelAntrian" class="text-sm divide-y divide-gray-100">
        <tr><td colspan="6" class="p-6 text-center text-gray-400">Sedang memuat data permintaan...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // --- KONEKSI SUPABASE ---
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    // --- 1. AMBIL DATA REQUEST (Hanya yang statusnya PENDING) ---
    async function loadPendingRequests() {
      const { data, error } = await client
        .from('inventory_req')
        .select('*')
        .eq('status', 'PENDING') // KUNCI: Hanya ambil yang belum diproses
        .order('created_at', { ascending: true }); // Yang lama di atas

      const tbody = document.getElementById("tabelAntrian");
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500 font-bold bg-gray-50">✅ Tidak ada permintaan pending. Semua aman!</td></tr>`;
        return;
      }

      data.forEach(item => {
        // Kita buat Baris Tabel yang isinya INPUT FORM langsung
        const tr = document.createElement('tr');
        tr.className = "hover:bg-blue-50 transition";
        tr.innerHTML = `
          <td class="p-4 align-top">
            <div class="font-bold">${new Date(item.created_at).toLocaleDateString()}</div>
            <div class="text-xs text-gray-500">${item.pengorder}</div>
          </td>
          <td class="p-4 align-top">
            <div class="font-bold text-lg text-gray-800">${item.nama_barang}</div>
            <div class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded inline-block font-bold">
              Butuh: ${item.jumlah} ${item.satuan}
            </div>
          </td>
          
          <td class="p-4 align-top">
            <input type="text" id="vendor-${item.id}" placeholder="Nama Toko/Vendor" class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-300">
          </td>

          <td class="p-4 align-top">
            <input type="number" id="harga-${item.id}" placeholder="Rp 0" class="w-full border p-2 rounded text-sm mb-1">
            <div class="text-xs text-gray-400">Total nanti dihitung otomatis</div>
          </td>

          <td class="p-4 align-top">
            <input type="date" id="tempo-${item.id}" class="w-full border p-2 rounded text-sm">
          </td>

          <td class="p-4 align-top text-center">
            <button onclick="prosesPO(${item.id}, '${item.nama_barang}', ${item.jumlah})" 
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow text-xs">
              Terbitkan PO
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- 2. FUNGSI PROSES PO (Dua Langkah) ---
    async function prosesPO(reqId, namaBarang, jumlah) {
      // A. Ambil nilai dari inputan
      const vendor = document.getElementById(`vendor-${reqId}`).value;
      const hargaSatuan = document.getElementById(`harga-${reqId}`).value;
      const jatuhTempo = document.getElementById(`tempo-${reqId}`).value;

      // Validasi: Jangan biarkan kosong
      if (!vendor || !hargaSatuan || !jatuhTempo) {
        alert("Mohon lengkapi Vendor, Harga, dan Tanggal Jatuh Tempo!");
        return;
      }

      const totalHarga = Number(hargaSatuan) * Number(jumlah);
      const nomorPO = "PO-" + Math.floor(1000 + Math.random() * 9000); // Generate Nomor PO Acak (Contoh: PO-4092)

      if(!confirm(`Terbitkan ${nomorPO} untuk ${namaBarang} seharga Rp ${totalHarga.toLocaleString()}?`)) return;

      // B. LANGKAH 1: Simpan ke tabel purchase_order
      const { error: errPO } = await client.from('purchase_order').insert([{
        req_id: reqId,
        nomor_po: nomorPO,
        nama_vendor: vendor,
        harga_satuan: hargaSatuan,
        total_harga: totalHarga,
        jatuh_tempo: jatuhTempo,
        status: 'OPEN'
      }]);

      if (errPO) {
        alert("Gagal buat PO: " + errPO.message);
        return;
      }

      // C. LANGKAH 2: Update status di inventory_req jadi 'PO DIBUAT'
      // Supaya permintaan ini HILANG dari daftar pending
      const { error: errUpdate } = await client
        .from('inventory_req')
        .update({ status: 'PO DIBUAT' })
        .eq('id', reqId);

      if (errUpdate) {
        alert("PO jadi tapi gagal update status req: " + errUpdate.message);
      } else {
        alert(`✅ Sukses! ${nomorPO} telah diterbitkan.`);
        loadPendingRequests(); // Refresh tabel agar data tadi hilang
      }
    }

    // Jalankan saat buka
    loadPendingRequests();
  </script>
</body>
</html>