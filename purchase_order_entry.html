<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Draft Purchase Order</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style>
    :root{ --bg:#f4f6fa; --card:#ffffff; --border:#d9e1ef; --text:#0f172a; --muted:#5f6b7c; --primary:#2563eb; --success:#10b981; --danger:#ef4444; }
    *{box-sizing:border-box;}
    body{ margin:0; font-family:"Segoe UI",Arial,sans-serif; background:var(--bg); color:var(--text); }
    
    /* HEADER */
    header{ padding:20px 28px; background:var(--card); box-shadow:0 4px 20px rgba(15,23,42,0.08); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; }
    .header-left h1{margin:0;font-size:22px;}
    .header-left p{margin:4px 0 0;color:var(--muted); font-size: 13px;}
    .header-right { display: flex; align-items: center; gap: 15px; }

    /* NOTIFIKASI */
    .notif-wrapper { position: relative; cursor: pointer; margin-right: 10px; }
    .bell-icon { font-size: 24px; }
    .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 11px; font-weight: bold; height: 18px; width: 18px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid #fff; }
    .notif-dropdown { position: absolute; top: 140%; right: 0; width: 350px; background: white; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; flex-direction: column; overflow: hidden; z-index: 1000; }
    .notif-dropdown.show { display: flex; }
    .notif-header { padding: 12px 16px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 13px; color: var(--muted); display: flex; justify-content: space-between; }
    .notif-list { max-height: 350px; overflow-y: auto; margin: 0; padding: 0; list-style: none; }
    .notif-item { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; gap: 10px; transition: background 0.2s; }
    .notif-item:hover { background: #f8fafc; }
    .notif-content { flex: 1; }
    .req-title { font-weight: 700; font-size: 14px; color: var(--primary); }
    .req-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
    
    .btn-lihat { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; }
    .btn-hapus { background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; margin-left: 6px; }
    .back-btn{ border:none; border-radius:8px; padding:8px 16px; font-weight:600; background:#e7eaf5; color:var(--text); cursor:pointer; font-size: 13px; }

    /* FORM & TABLE */
    main{ max-width:900px; margin:30px auto 60px; padding:0 20px; }
    .card{ background:var(--card); border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(15,23,42,0.08); border:1px solid var(--border); }
    .card h2{ margin:0 0 20px; font-size:18px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .full-width { grid-column: 1 / -1; }
    label{ display:block; font-weight:600; font-size:13px; margin-bottom:6px; color:var(--text); }
    select, input { width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border); font-size:14px; background:#fff; }
    
    .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .items-table th { text-align: left; padding: 10px; background: #f1f5f9; font-size: 13px; border-bottom: 2px solid var(--border); }
    .items-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; }
    .btn-add-row { background: #eff6ff; color: var(--primary); border: 1px dashed var(--primary); width: 100%; padding: 10px; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    .save-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 25px; cursor: pointer; }

    /* MODAL POPUP */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal-box { background: white; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; max-height: 80vh; }
    .modal-header { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 0; overflow-y: auto; flex: 1; }
    .checklist-table { width: 100%; border-collapse: collapse; }
    .checklist-table th, .checklist-table td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; text-align: left; font-size: 13px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 10px; }
    
    /* PRINT TEMPLATE (HIDDEN) */
    #po-template-container { position: absolute; left: -9999px; }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>Draft Purchase Order</h1>
      <p>Buat PO baru atau proses permintaan dari Inventory</p>
    </div>
    <div class="header-right">
      <div class="notif-wrapper" onclick="toggleNotif()">
        <span class="bell-icon">ðŸ””</span>
        <div id="notifBadge" class="badge" style="display:none;">0</div>
        
        <div id="notifDropdown" class="notif-dropdown">
          <div class="notif-header">
            <span>Daftar Permintaan</span>
            <span style="font-size:11px; cursor:pointer;" onclick="syncWithServer()">ðŸ”„ Refresh Data</span>
          </div>
          <ul id="notifList" class="notif-list"></ul>
        </div>
      </div>
      <button class="back-btn" onclick="window.location.href='dashboard_operasional.html'">Kembali</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Formulir Purchase Order</h2>
      
    <div class="form-grid">
        <div class="full-width">
          <label>PO untuk Proyek</label>
          <select id="projectSelect">
            <option value="">-- Pilih proyek --</option>
            <option value="Sunrise City Pinrang">Sunrise City Pinrang</option>
            <option value="Sunrise City Maros">Sunrise City Maros</option>
            <option value="Sunrise City Parepare">Sunrise City Parepare</option>
            <option value="Kost Sunrise">Kost Sunrise</option>
          </select>
        </div>

        <div class="full-width">
          <label>Kepada Vendor</label>
          <select id="vendorSelect"><option value="">-- Memuat vendor... --</option></select>
        </div>

        <div class="full-width">
          <label>Tanggal PO</label>
          <input type="date" id="poDate">
        </div>
        <div class="full-width">
          <label>Jatuh Tempo</label>
          <input type="date" id="dueDate">
        </div>
      </div>

      <label>Rincian Barang</label>
      <table class="items-table">
        <thead>
          <tr>
            <th width="40%">Nama Barang</th>
            <th width="15%">Qty</th>
            <th width="15%">Satuan</th>
            <th width="25%">Harga (@)</th>
            <th width="5%"></th>
          </tr>
        </thead>
        <tbody id="poItemsBody"></tbody>
      </table>
      <button type="button" class="btn-add-row" onclick="addTableRow()">+ Tambah Baris Manual</button>

      <button class="save-btn" onclick="savePurchaseOrder()">ðŸ’¾ Simpan & Cetak PDF</button>
    </section>
  </main>

  <div id="modalRequestList" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <h3>ðŸ“‹ Pilih Barang untuk PO</h3>
        <button onclick="closeRequestModal()" style="border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
      </div>
      <div class="modal-body">
        <div style="padding:10px 20px; background:#fff7ed; color:#c2410c; font-size:12px;">
          <strong>ID:</strong> <span id="modalBatchId"></span> | <strong>Pengorder:</strong> <span id="modalSender"></span>
        </div>
        <table class="checklist-table">
          <thead><tr><th width="30"><input type="checkbox" onchange="toggleAll(this)" checked></th><th>Barang</th><th>Qty</th></tr></thead>
          <tbody id="modalItemsBody"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button onclick="closeRequestModal()" style="padding:10px; border:1px solid #ccc; background:white; border-radius:6px;">Batal</button>
        <button onclick="importSelectedItems()" style="padding:10px 20px; border:none; background:var(--primary); color:white; border-radius:6px;">Masukan ke PO</button>
      </div>
    </div>
  </div>

  <div id="po-template-container">
    <div id="po-template" style="padding:20px; font-family:Arial; font-size:12px; color:black;">
       <h2 style="border-bottom:2px solid #c5a059; padding-bottom:10px;">PURCHASE ORDER</h2>
       <table>
       <tr><td>No:</td><td id="printPoNumber"></td></tr>
       <tr><td>Tanggal:</td><td id="printPoDate"></td></tr>
       <tr><td>Vendor:</td><td id="printVendorName"></td></tr>
        <tr><td>JT Pembayaran:</td><td id="printDueDate"></td></tr>
       </table>
       <br>
       <table style="width:100%; border-collapse:collapse;" border="1">
         <thead><tr style="background:#eee;"><th>No</th><th>Barang</th><th>Qty</th><th>Satuan</th><th>Harga</th><th>Total</th></tr></thead>
         <tbody id="printItemsBody"></tbody>
       </table>
       <br>
       <div style="text-align:right;"><strong>Total: <span id="printGrandTotal"></span></strong></div>
    </div>
  </div>

  <script>
    // --- KONFIGURASI ---
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby35BUkEx44e226aMxqdQqHGR-44jYysKje3x-LKmv581Tv41C6Hshqq8LTIhVOW40B/exec";
    const DEFAULT_TOP_DAYS = 30;
    
    // --- INIT ---
    let currentBatchItems = [];
    let currentBatchId = "";
    let globalVendorData = [];

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('poDate').valueAsDate = new Date();
      loadVendors();
      
      // Load Notifikasi: Coba Lokal dulu, kalau kosong Sync ke Server
      const localBatches = JSON.parse(localStorage.getItem('po_request_batches') || "[]");
      if(localBatches.length > 0) {
        renderNotif(localBatches);
      } else {
        syncWithServer(); // Auto sync jika cache kosong
      }
      const poDateEl = document.getElementById('poDate');
      const dueEl = document.getElementById('dueDate');
      if(poDateEl) poDateEl.addEventListener('change', updateDueDate);
      if(dueEl) dueEl.addEventListener('change', () => {}); // allow manual edit, no action
      document.getElementById('vendorSelect').addEventListener('change', updateDueDate);
      updateDueDate();
    });

    // --- 1. NOTIFIKASI & SYNC ---
    async function syncWithServer() {
       const badge = document.getElementById('notifBadge');
       const list = document.getElementById('notifList');
       list.innerHTML = '<li class="notif-item">ðŸ”„ Mengambil data dari server...</li>';
       
       try {
         const res = await fetch(APPS_SCRIPT_URL + "?action=get_po_requests&t=" + Date.now());
         const json = await res.json();
         const rows = json.data || [];

         // Group by RequestID (Format Batch)
         const groups = {};
         rows.forEach(r => {
           // Asumsi ID seperti REQ-173...
           // Jika ID sama, masukkan ke satu grup
           const id = r.requestId;
           if(!groups[id]) {
             groups[id] = { 
               id: id, 
               date: r.timestamp, 
               sender: r.requester || "Gudang", 
               items: [], 
               status: 'Unread' 
             };
           }
           groups[id].items.push(r);
         });

         const batches = Object.values(groups);
         // Update LocalStorage agar sinkron
         localStorage.setItem('po_request_batches', JSON.stringify(batches));
         renderNotif(batches);
         
       } catch(e) {
         list.innerHTML = '<li class="notif-item" style="color:red;">Gagal koneksi server</li>';
       }
    }

    function renderNotif(batches) {
      const pending = batches.filter(b => b.status === 'Unread');
      const badge = document.getElementById('notifBadge');
      const list = document.getElementById('notifList');
      
      if(pending.length > 0) {
        badge.style.display = 'flex';
        badge.textContent = pending.length;
        list.innerHTML = pending.map(b => `
        <li class="notif-item">
            <div class="notif-content">
              <div class="req-title">Permintaan Barang</div>
              <div class="req-meta">ID: ${b.id} | ${b.items.length} Item</div>
              <div class="req-meta">Oleh: ${b.sender}</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button class="btn-lihat" onclick="openBatchModal('${b.id}')">Lihat</button>
              <button class="btn-hapus" onclick="dismissNotification('${b.id}')">Hapus</button>
            </div>
          </li>
        `).join('');
      } else {
        badge.style.display = 'none';
        list.innerHTML = '<li class="notif-item" style="color:#999; justify-content:center;">Tidak ada permintaan baru</li>';
      }
    }

    function dismissNotification(id) {
      const batches = JSON.parse(localStorage.getItem('po_request_batches') || "[]");
      const updated = batches.filter(b => b.id !== id);
      localStorage.setItem('po_request_batches', JSON.stringify(updated));
      renderNotif(updated);
    }

    function toggleNotif() { document.getElementById('notifDropdown').classList.toggle('show'); }

    // --- 2. MODAL & IMPORT ---
    function openBatchModal(id) {
      const batches = JSON.parse(localStorage.getItem('po_request_batches') || "[]");
      const batch = batches.find(b => b.id === id);
      if(!batch) return;

      currentBatchId = id;
      currentBatchItems = batch.items;
      
      document.getElementById('modalBatchId').innerText = batch.id;
      document.getElementById('modalSender').innerText = batch.sender;
      
      const tbody = document.getElementById('modalItemsBody');
      tbody.innerHTML = batch.items.map((item, idx) => `
        <tr>
          <td><input type="checkbox" class="chk-item" value="${idx}" checked></td>
          <td>${item.item || item.item}</td>
          <td>${item.qty} ${item.unit || ''}</td>
        </tr>
      `).join('');

      document.getElementById('modalRequestList').classList.add('show');
      document.getElementById('notifDropdown').classList.remove('show');
    }

    function closeRequestModal() { document.getElementById('modalRequestList').classList.remove('show'); }
    function toggleAll(src) { document.querySelectorAll('.chk-item').forEach(c => c.checked = src.checked); }

    function importSelectedItems() {
      const checks = document.querySelectorAll('.chk-item:checked');
      if(checks.length === 0) return alert("Pilih minimal 1 barang");

      checks.forEach(c => {
        const item = currentBatchItems[c.value];
        addTableRow(item.item || item.item, item.qty, item.unit);
      });

      // Tandai sudah dibaca
      const batches = JSON.parse(localStorage.getItem('po_request_batches') || "[]");
      const updated = batches.map(b => b.id === currentBatchId ? {...b, status: 'Processed'} : b);
      localStorage.setItem('po_request_batches', JSON.stringify(updated));
      
      renderNotif(updated);
      closeRequestModal();
    }

    // --- 3. TABEL PO & VENDOR ---
    async function loadVendors() {
      const sel = document.getElementById('vendorSelect');
      try {
        const res = await fetch(APPS_SCRIPT_URL + "?action=get_vendors");
        const json = await res.json();
        // Fallback jika API mengembalikan array kosong atau error
        const vendors = Array.isArray(json) ? json : (json.data || []); 
        
        if(vendors.length > 0) {
           sel.innerHTML = '<option value="">-- Pilih Vendor --</option>' + 
             vendors.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
          globalVendorData = vendors;
          updateDueDate();
        } else {
           sel.innerHTML = '<option value="">Data Vendor Kosong</option>';
        }
      } catch(e) { sel.innerHTML = '<option value="">Gagal muat vendor</option>'; }
    }

    function parseTopDays(top) {
      const digits = String(top||"").match(/\\d+/);
      return digits ? parseInt(digits[0], 10) : DEFAULT_TOP_DAYS;
    }

    function updateDueDate() {
      const poDate = document.getElementById('poDate');
      const dueDate = document.getElementById('dueDate');
      if(!poDate || !dueDate) return;
      const base = poDate.value ? new Date(poDate.value) : null;
      if(!base || isNaN(base)) return;
      const vendorName = document.getElementById('vendorSelect').value;
      const vendor = globalVendorData.find(v => v.name === vendorName);
      const topDays = vendor ? parseTopDays(vendor.top) : DEFAULT_TOP_DAYS;
      const due = new Date(base);
      due.setDate(due.getDate() + topDays);
      dueDate.value = due.toISOString().split('T')[0];
    }

    function addTableRow(name="", qty=1, unit="") {
      const tbody = document.getElementById('poItemsBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${name}" placeholder="Nama Barang"></td>
        <td><input type="number" value="${qty}" class="qty-inp" oninput="calcRow(this)"></td>
        <td><input type="text" value="${unit}" placeholder="Unit"></td>
        <td><input type="number" value="0" class="prc-inp" oninput="calcRow(this)"></td>
        <td><button onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;">&times;</button></td>
      `;
      tbody.appendChild(tr);
    }

    function calcRow(el) { /* Placeholder hitung total */ }

    // --- 4. SIMPAN PO ---
    function savePurchaseOrder() {
       const vendor = document.getElementById('vendorSelect').value;
       const proj = document.getElementById('projectSelect').value;
       if(!vendor || !proj) return alert("Pilih Vendor & Proyek!");
       
       // ... LOGIKA SIMPAN PDF (Sama seperti sebelumnya) ...
       // (Disederhanakan agar muat di jawaban)
       
       const items = [];
       document.querySelectorAll('#poItemsBody tr').forEach((tr, i) => {
          const inps = tr.querySelectorAll('input');
          items.push(`<tr><td>${i+1}</td><td>${inps[0].value}</td><td>${inps[1].value}</td><td>${inps[2].value}</td><td>${inps[3].value}</td><td>-</td></tr>`);
       });

       document.getElementById('printPoNumber').innerText = "PO-" + Date.now();
       document.getElementById('printPoDate').innerText = document.getElementById('poDate').value;
       document.getElementById('printVendorName').innerText = vendor;
       const dueVal = document.getElementById('dueDate').value;
       document.getElementById('printDueDate').innerText = dueVal ? new Date(dueVal).toLocaleDateString() : "-";
       document.getElementById('printItemsBody').innerHTML = items.join('');

       const el = document.getElementById('po-template');
       html2pdf().from(el).save();
       
       alert("PO Disimpan & PDF Diunduh");
       setTimeout(() => location.reload(), 2000);
    }
  </script>
</body>
</html>
