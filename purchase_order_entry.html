<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Finance - Approval & Cetak PO</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style>
    .kertas-po {
      width: 210mm;
      min-height: 297mm;
      padding: 20mm;
      background: white;
      margin: 0 auto;
      color: #000 !important;
      font-family: 'Times New Roman', Times, serif;
      position: relative;
    }
    .kertas-po * { border-color: #000 !important; }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 p-6">

  <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-blue-800">Finance Approval (PO)</h1>
      <p class="text-sm text-gray-500">Pilih Vendor dari Database & Terbitkan PO</p>
    </div>
    <div class="space-x-3">
        <a href="master_vendor.html" class="text-sm bg-pink-100 text-pink-700 px-3 py-1 rounded hover:bg-pink-200">üë• Kelola Vendor</a>
        <a href="inventory_req.html" class="text-sm text-blue-600 hover:underline">‚Üê Lihat Menu Gudang</a>
    </div>
  </div>

  <div class="max-w-7xl mx-auto bg-white rounded-lg shadow overflow-hidden mb-10">
    <table class="w-full text-left border-collapse">
      <thead class="bg-blue-50 text-blue-900 uppercase text-xs font-bold">
        <tr>
          <th class="p-4">Tanggal & Staff</th>
          <th class="p-4">Barang diminta</th>
          <th class="p-4 w-64">Pilih Vendor (Database)</th> <th class="p-4 w-32">Harga Satuan</th>
          <th class="p-4 w-40">Jatuh Tempo</th>
          <th class="p-4 text-center">Aksi</th>
        </tr>
      </thead>
      <tbody id="tabelAntrian" class="text-sm divide-y divide-gray-100">
        <tr><td colspan="6" class="p-6 text-center text-gray-400">Sedang memuat data...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="modalPreview" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex flex-col justify-center items-center p-4">
    <div class="bg-white p-3 rounded-t-lg w-full max-w-4xl flex justify-between items-center border-b">
      <h3 class="font-bold text-lg text-gray-800">üìÑ Review Dokumen PO</h3>
      <div class="flex gap-2">
        <button onclick="tutupPreview()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-bold text-sm">Batal</button>
        <button onclick="simpanDanCetak()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white font-bold text-sm flex items-center gap-2">
          <span id="btnText">‚úÖ Konfirmasi & Download PDF</span>
        </button>
      </div>
    </div>
    <div class="bg-gray-500 w-full max-w-4xl overflow-auto h-full p-8 rounded-b-lg flex justify-center">
      <div id="areaCetak" class="kertas-po shadow-2xl">
        
        <div class="flex flex-col items-center text-center border-b-4 border-double border-black pb-4 mb-6">
          <img src="logo.png" alt="[ LOGO ]" class="h-20 mb-2 object-contain" onerror="this.style.display='none'">
          <h1 class="text-3xl font-extrabold uppercase tracking-widest" style="font-family: serif;">NLD CORP</h1>
          <h2 class="text-lg font-bold uppercase tracking-wide">PT. NUSANTARA LAND DEVELOPMENT</h2>
          <div class="text-xs mt-2 font-medium leading-tight">
            <p>HQ Delft Apartement, Jl. Sunset Boulevard Blok 5B/16 Citra Land City, CPI Makassar</p>
            <p>Telp : 0411- 6004251</p>
          </div>
        </div>

        <div class="flex justify-between items-start mb-8 border-b border-black pb-4">
          <div><h2 class="text-2xl font-bold underline">PURCHASE ORDER</h2><p class="text-sm">Surat Pemesanan Barang</p></div>
          <div class="text-right"><p class="text-xl font-bold" id="printNoPO">PO-XXXX</p><p class="text-sm" id="printTanggal">Tanggal: -</p></div>
        </div>

        <div class="flex justify-between mb-8 text-sm">
          <div class="w-1/2 pr-4">
            <p class="font-bold uppercase text-xs mb-1">Kepada Vendor:</p>
            <p class="font-bold text-lg" id="printVendor">Nama Vendor</p>
            <p>Mohon kirimkan barang sesuai rincian berikut.</p>
          </div>
          <div class="w-1/2 pl-4 border-l border-black">
            <p class="font-bold uppercase text-xs mb-1">Jatuh Tempo:</p>
            <p class="font-bold text-lg" id="printTempo">-</p>
          </div>
        </div>

        <table class="w-full text-left border border-black mb-8 text-sm">
          <thead class="bg-gray-200 uppercase text-xs font-bold">
            <tr>
              <th class="p-2 border border-black text-center w-10">No</th>
              <th class="p-2 border border-black">Deskripsi Barang</th>
              <th class="p-2 border border-black text-center">Qty</th>
              <th class="p-2 border border-black text-right">Harga</th>
              <th class="p-2 border border-black text-right">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="p-2 border border-black text-center">1</td>
              <td class="p-2 border border-black font-bold" id="printBarang">-</td>
              <td class="p-2 border border-black text-center" id="printQty">-</td>
              <td class="p-2 border border-black text-right" id="printHarga">-</td>
              <td class="p-2 border border-black text-right font-bold" id="printTotal">-</td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="bg-gray-100"><td colspan="4" class="p-2 border border-black text-right font-bold uppercase">Grand Total</td><td class="p-2 border border-black text-right font-bold text-lg" id="printGrandTotal">-</td></tr>
          </tfoot>
        </table>

        <div class="flex justify-between mt-16 text-center text-sm">
          <div class="w-40"><p class="mb-20">Dibuat Oleh,</p><p class="font-bold border-b border-black pb-1" id="printStaff">Finance</p></div>
          <div class="w-40"><p class="mb-20">Disetujui Oleh,</p><p class="font-bold border-b border-black pb-1">Manager Ops</p></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(num);

    let tempPO = {};
    let listVendor = []; // Menyimpan data vendor dari DB

    // 1. LOAD DATA VENDOR DARI DATABASE
    async function loadVendors() {
      const { data } = await client.from('master_vendor').select('*').order('nama_vendor');
      if (data) listVendor = data;
    }

    // 2. LOAD REQUEST + BIKIN DROPDOWN
    async function loadData() {
      // Pastikan Vendor diload dulu
      await loadVendors();

      const { data } = await client.from('inventory_req').select('*').eq('status', 'PENDING').order('created_at');
      const tbody = document.getElementById("tabelAntrian");
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500 font-bold bg-gray-50">‚úÖ Tidak ada permintaan pending.</td></tr>`;
        return;
      }

      data.forEach(item => {
        // Buat Opsi Dropdown Vendor
        let optionsHtml = `<option value="">-- Pilih Vendor --</option>`;
        listVendor.forEach(v => {
          // Kita simpan TOP di atribut data-top agar mudah dihitung
          optionsHtml += `<option value="${v.nama_vendor}" data-top="${v.top_hari}">${v.nama_vendor} (TOP: ${v.top_hari} Hari)</option>`;
        });

        tbody.innerHTML += `
          <tr class="hover:bg-blue-50 border-b">
            <td class="p-4 align-top">
              <div class="font-bold">${new Date(item.created_at).toLocaleDateString()}</div>
              <div class="text-xs text-gray-500">${item.pengorder}</div>
            </td>
            <td class="p-4 align-top">
              <div class="font-bold text-lg">${item.nama_barang}</div>
              <div class="text-xs bg-yellow-100 px-2 py-1 rounded inline-block">Jml: ${item.jumlah} ${item.satuan}</div>
            </td>
            
            <td class="p-4 align-top">
              <select id="vendor-${item.id}" class="w-full border p-2 rounded text-sm bg-white focus:ring-2 focus:ring-blue-300" onchange="autoIsiTempo('${item.id}', this)">
                ${optionsHtml}
              </select>
            </td>

            <td class="p-4 align-top"><input type="number" id="harga-${item.id}" placeholder="Rp" class="w-full border p-2 rounded text-sm"></td>
            
            <td class="p-4 align-top">
                <input type="date" id="tempo-${item.id}" class="w-full border p-2 rounded text-sm bg-gray-50">
                <div id="infoTop-${item.id}" class="text-[10px] text-gray-500 mt-1 italic"></div>
            </td>
            
            <td class="p-4 align-top text-center">
              <button onclick="bukaPreview('${item.id}', '${item.nama_barang}', '${item.jumlah}', '${item.satuan}', '${item.pengorder}')" 
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow text-xs w-full">
                Review
              </button>
            </td>
          </tr>`;
      });
    }

    // --- FUNGSI BARU: HITUNG JATUH TEMPO OTOMATIS ---
    function autoIsiTempo(reqId, selectEl) {
      const selectedOption = selectEl.options[selectEl.selectedIndex];
      const topHari = parseInt(selectedOption.getAttribute('data-top') || 0);
      
      // Hitung tanggal hari ini + TOP
      const today = new Date();
      today.setDate(today.getDate() + topHari);
      
      // Format ke YYYY-MM-DD untuk input date
      const tglStr = today.toISOString().split('T')[0];
      
      document.getElementById(`tempo-${reqId}`).value = tglStr;
      
      // Info teks kecil
      const infoDiv = document.getElementById(`infoTop-${reqId}`);
      if(topHari > 0) infoDiv.innerText = `Otomatis set +${topHari} hari (TOP)`;
      else infoDiv.innerText = "Cash / Tunai";
    }

    // --- FUNGSI PREVIEW & SIMPAN (Sama seperti sebelumnya) ---
    function bukaPreview(reqId, namaBarang, jumlah, satuan, pengorder) {
      const vendor = document.getElementById(`vendor-${reqId}`).value;
      const hargaSatuan = document.getElementById(`harga-${reqId}`).value;
      const jatuhTempo = document.getElementById(`tempo-${reqId}`).value;

      if (!vendor || !hargaSatuan || !jatuhTempo) { alert("Data belum lengkap!"); return; }

      const totalHarga = Number(hargaSatuan) * Number(jumlah);
      const nomorPO = "PO-" + Math.floor(100000 + Math.random() * 900000);

      tempPO = { reqId, nomorPO, vendor, hargaSatuan, totalHarga, jatuhTempo, namaBarang, jumlah, satuan, pengorder };

      document.getElementById('printNoPO').innerText = nomorPO;
      document.getElementById('printTanggal').innerText = new Date().toLocaleDateString('id-ID');
      document.getElementById('printVendor').innerText = vendor;
      document.getElementById('printTempo').innerText = new Date(jatuhTempo).toLocaleDateString('id-ID');
      document.getElementById('printBarang').innerText = namaBarang;
      document.getElementById('printQty').innerText = `${jumlah} ${satuan}`;
      document.getElementById('printHarga').innerText = formatRupiah(hargaSatuan);
      document.getElementById('printTotal').innerText = formatRupiah(totalHarga);
      document.getElementById('printGrandTotal').innerText = formatRupiah(totalHarga);
      document.getElementById('printStaff').innerText = pengorder;

      document.getElementById('modalPreview').classList.remove('hidden');
      document.getElementById('modalPreview').classList.add('flex');
    }

    function tutupPreview() {
      document.getElementById('modalPreview').classList.add('hidden');
      document.getElementById('modalPreview').classList.remove('flex');
    }

    async function simpanDanCetak() {
      const btn = document.getElementById('btnText');
      btn.innerText = "‚è≥ Memproses...";
      
      const { error } = await client.from('purchase_order').insert([{
        req_id: tempPO.reqId, nomor_po: tempPO.nomorPO, nama_vendor: tempPO.vendor,
        harga_satuan: tempPO.hargaSatuan, total_harga: tempPO.totalHarga, jatuh_tempo: tempPO.jatuhTempo, status: 'OPEN'
      }]);

      if (error) { alert("Error: " + error.message); return; }
      await client.from('inventory_req').update({ status: 'PO DIBUAT' }).eq('id', tempPO.reqId);

      const element = document.getElementById('areaCetak');
      await html2pdf().set({ margin:0, filename: `${tempPO.nomorPO}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'mm', format:'a4'} }).from(element).save();

      alert("Sukses!");
      tutupPreview();
      loadData();
      btn.innerText = "‚úÖ Konfirmasi & Download PDF";
    }

    loadData();
  </script>
</body>
</html>