<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jurnal Memorial - NLD Corp</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans text-gray-800 p-6">

  <div class="max-w-5xl mx-auto mb-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-indigo-900"><i class="fas fa-book mr-2"></i>Jurnal Memorial</h1>
      <p class="text-sm text-gray-500">Pencatatan Non-Kas (Penyusutan, Koreksi, dll)</p>
    </div>
    <a href="dashboard_operasional.html" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded shadow text-sm font-bold">
      <i class="fas fa-arrow-left"></i> Dashboard
    </a>
  </div>

  <div class="max-w-5xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 border-b pb-4">
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">Tanggal Transaksi</label>
        <input type="date" id="tanggal" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500">
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">Keterangan / Uraian</label>
        <input type="text" id="keterangan" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500" placeholder="Cth: Penyusutan Aset Bulan Mei">
      </div>
    </div>

    <div class="overflow-x-auto mb-4">
      <table class="w-full text-left border-collapse">
        <thead class="bg-indigo-50 text-indigo-900 text-xs uppercase font-bold">
          <tr>
            <th class="p-3 border">Akun Perkiraan</th>
            <th class="p-3 border w-40 text-right">Debit (Rp)</th>
            <th class="p-3 border w-40 text-right">Kredit (Rp)</th>
            <th class="p-3 border w-10 text-center"><i class="fas fa-trash"></i></th>
          </tr>
        </thead>
        <tbody id="bodyJurnal">
          </tbody>
        <tfoot class="bg-gray-50 font-bold text-sm">
          <tr>
            <td class="p-3 text-right">TOTAL</td>
            <td class="p-3 text-right" id="totalDebit">0</td>
            <td class="p-3 text-right" id="totalKredit">0</td>
            <td></td>
          </tr>
          <tr>
            <td class="p-3 text-right text-gray-500">Status Balance:</td>
            <td colspan="2" class="p-3 text-center">
                <span id="statusBalance" class="bg-gray-200 text-gray-500 px-3 py-1 rounded text-xs font-bold">Belum Input</span>
            </td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <button onclick="tambahBaris()" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-4 py-2 rounded text-sm font-bold border border-indigo-200">
        <i class="fas fa-plus"></i> Tambah Baris
    </button>

    <div class="mt-8 text-right border-t pt-4">
        <button id="btnSimpan" onclick="simpanJurnal()" disabled class="bg-gray-400 text-white px-8 py-3 rounded shadow font-bold cursor-not-allowed transition">
            <i class="fas fa-save"></i> POSTING JURNAL
        </button>
    </div>

  </div>

  <script>
    // 1. SETUP SUPABASE
    const supabaseUrl = "https://nbpxmramqufvxiikxbve.supabase.co";
    const supabaseKey = "sb_publishable_peLRGV8YGA5djczYBgLnkQ_buXXBknN"; 
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    let akunOptions = ""; // Menyimpan HTML opsi akun biar ringan

    // Set Tanggal Hari Ini
    document.getElementById("tanggal").valueAsDate = new Date();

    // 2. LOAD AKUN DARI DB
    async function init() {
        const { data, error } = await client.from('master_akun').select('nama_akun').order('nama_akun');
        if(data) {
            data.forEach(item => {
                akunOptions += `<option value="${item.nama_akun}">${item.nama_akun}</option>`;
            });
            // Tambah 2 baris default
            tambahBaris();
            tambahBaris();
        }
    }

    // 3. FUNGSI TAMBAH BARIS
    function tambahBaris() {
        const tbody = document.getElementById("bodyJurnal");
        const rowId = Date.now() + Math.random(); // ID unik dummy
        
        const html = `
            <tr class="border-b bg-white hover:bg-gray-50 transition" id="row-${rowId}">
                <td class="p-2 border">
                    <select class="w-full border p-2 rounded bg-white text-sm focus:ring-2 focus:ring-indigo-300 input-akun">
                        <option value="">-- Pilih Akun --</option>
                        ${akunOptions}
                    </select>
                </td>
                <td class="p-2 border">
                    <input type="number" class="w-full border p-2 rounded text-right font-mono text-sm focus:ring-2 focus:ring-blue-300 input-debit" 
                    placeholder="0" oninput="hitung()" value="0">
                </td>
                <td class="p-2 border">
                    <input type="number" class="w-full border p-2 rounded text-right font-mono text-sm focus:ring-2 focus:ring-green-300 input-kredit" 
                    placeholder="0" oninput="hitung()" value="0">
                </td>
                <td class="p-2 border text-center">
                    <button onclick="hapusBaris('row-${rowId}')" class="text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', html);
    }

    function hapusBaris(id) {
        document.getElementById(id).remove();
        hitung();
    }

    // 4. HITUNG BALANCE & VALIDASI
    function hitung() {
        let sumD = 0;
        let sumK = 0;

        document.querySelectorAll('.input-debit').forEach(el => sumD += Number(el.value));
        document.querySelectorAll('.input-kredit').forEach(el => sumK += Number(el.value));

        // Tampilkan Format Rupiah
        const fmt = (n) => n.toLocaleString('id-ID');
        document.getElementById("totalDebit").innerText = fmt(sumD);
        document.getElementById("totalKredit").innerText = fmt(sumK);

        const statusEl = document.getElementById("statusBalance");
        const btn = document.getElementById("btnSimpan");
        const selisih = sumD - sumK;

        if (sumD > 0 && selisih === 0) {
            // BALANCE (SEIMBANG)
            statusEl.className = "bg-green-100 text-green-700 px-4 py-1 rounded text-sm font-bold border border-green-200";
            statusEl.innerHTML = `<i class="fas fa-check-circle"></i> BALANCE (Seimbang)`;
            
            // Aktifkan Tombol Simpan
            btn.disabled = false;
            btn.className = "bg-indigo-700 hover:bg-indigo-800 text-white px-8 py-3 rounded shadow-lg font-bold transition transform hover:-translate-y-1";
        } else {
            // TIDAK SEIMBANG
            statusEl.className = "bg-red-100 text-red-700 px-4 py-1 rounded text-sm font-bold border border-red-200";
            statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Selisih: Rp ${fmt(selisih)}`;
            
            // Matikan Tombol Simpan
            btn.disabled = true;
            btn.className = "bg-gray-400 text-white px-8 py-3 rounded shadow font-bold cursor-not-allowed opacity-70";
        }
    }

    // 5. SIMPAN KE DATABASE
    async function simpanJurnal() {
        if(!confirm("Apakah data sudah benar? Data akan masuk ke Laporan Keuangan.")) return;

        const btn = document.getElementById("btnSimpan");
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Menyimpan...`;
        btn.disabled = true;

        const tgl = document.getElementById("tanggal").value;
        const ket = document.getElementById("keterangan").value || "Jurnal Memorial";
        const refNo = "JM-" + Date.now(); // Nomor Ref Unik (Memorial)

        let payload = [];
        
        // Loop setiap baris tabel
        const rows = document.querySelectorAll("#bodyJurnal tr");
        rows.forEach(row => {
            const akun = row.querySelector(".input-akun").value;
            const deb = Number(row.querySelector(".input-debit").value);
            const kre = Number(row.querySelector(".input-kredit").value);

            if(akun && (deb > 0 || kre > 0)) {
                payload.push({
                    tanggal: tgl,
                    nomor_referensi: refNo,
                    keterangan: ket,
                    nama_akun: akun,
                    debit: deb,
                    kredit: kre
                });
            }
        });

        try {
            const { error } = await client.from('jurnal_umum').insert(payload);
            if(error) throw error;

            alert("âœ… Jurnal Berhasil Diposting!");
            location.reload(); // Reset halaman

        } catch (e) {
            alert("Gagal: " + e.message);
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-save"></i> POSTING JURNAL`;
        }
    }

    init();
  </script>
</body>
</html>