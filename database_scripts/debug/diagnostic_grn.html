<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Diagnostic V3: Stock Consistency</title>
    <script src="../supabase.js"></script>
    <script src="../app_config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto space-y-8">

        <div class="bg-white p-6 rounded shadow">
            <h1 class="text-2xl font-bold mb-4 text-emerald-800">Diagnostic V3: Stock Consistency Check</h1>
            <p>Verifying if 'TERIMA GRN' transactions actually updated the Master Stock.</p>
            <button onclick="checkConsistency()"
                class="bg-emerald-600 text-white px-4 py-2 mt-4 rounded font-bold hover:bg-emerald-700">Run Consistency
                Check</button>
        </div>

        <div class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">Recent 'TERIMA GRN' vs Current Stock</h2>
            <div class="overflow-auto max-h-96">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="p-2 border">Time</th>
                            <th class="p-2 border">Item Name</th>
                            <th class="p-2 border">Qty In (GRN)</th>
                            <th class="p-2 border">Current Total Stock</th>
                            <th class="p-2 border">Project</th>
                            <th class="p-2 border">Analysis</th>
                        </tr>
                    </thead>
                    <tbody id="tblConsistency"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">Debug Last 5 POs</h2>
            <pre id="debugPO" class="text-xs bg-gray-900 text-green-400 p-4 rounded overflow-auto"></pre>
        </div>

    </div>

    <script>
        const client = window.client;

        async function checkConsistency() {
            if (!client) return;

            // 1. Get Recent GRN History
            const { data: history, error } = await client
                .from('stok_history')
                .select(`
                    id, created_at, jumlah, jenis_transaksi,
                    master_stok ( id, nama_barang, total_stok, nama_proyek )
                `)
                .eq('jenis_transaksi', 'TERIMA GRN')
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) return alert("Error fetching history: " + error.message);

            const tbody = document.getElementById('tblConsistency');
            tbody.innerHTML = '';

            history.forEach(row => {
                const stok = row.master_stok;
                const current = stok ? stok.total_stok : 0;
                const received = row.jumlah;

                // Logic: If we received 10, current stock should be at least 10 (unless sold).
                // If current is 0, it's suspicious.
                const isSuspicious = current < received;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 border text-xs text-gray-500">${new Date(row.created_at).toLocaleString()}</td>
                    <td class="p-2 border font-bold">${stok ? stok.nama_barang : '(Deleted Item)'}</td>
                    <td class="p-2 border text-green-600 font-bold">+${received}</td>
                    <td class="p-2 border font-bold ${isSuspicious ? 'text-red-600 bg-red-100' : 'text-gray-800'}">${current}</td>
                    <td class="p-2 border text-xs">${stok ? stok.nama_proyek : '-'}</td>
                    <td class="p-2 border text-xs">${isSuspicious ? '⚠️ Stock < Received' : 'OK'}</td>
                `;
                tbody.appendChild(tr);
            });

            // 2. Debug POs
            const { data: pos } = await client
                .from('purchase_order')
                .select('*')
                .eq('status', 'DITERIMA')
                .order('created_at', { ascending: false })
                .limit(5);

            document.getElementById('debugPO').innerText = JSON.stringify(pos, null, 2);
        }

        if (window.client) checkConsistency();
    </script>
</body>

</html>