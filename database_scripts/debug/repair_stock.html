<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Repair Stock</title>
    <script src="../supabase.js"></script>
    <script src="../app_config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
        <h1 class="text-2xl font-bold mb-4 text-red-800">Repair Stock: Besi 10 Full</h1>
        <p class="mb-4">Current verification step: Attempting to update stock ID 118 to 31 (Test Increment).</p>
        <button onclick="tryUpdate()" class="bg-red-600 text-white px-4 py-2 rounded font-bold hover:bg-red-700">Try
            Update (+1)</button>
        <div id="log" class="mt-4 p-4 bg-gray-900 text-green-400 font-mono text-xs rounded h-40 overflow-auto"></div>
    </div>

    <script>
        const client = window.client;

        function log(msg) {
            const el = document.getElementById('log');
            el.innerHTML += `<div>> ${msg}</div>`;
        }

        async function tryUpdate() {
            if (!client) return log("Client missing");

            // 1. Get Current
            const { data: current, error: errGet } = await client
                .from('master_stok')
                .select('total_stok')
                .eq('id', 118)
                .single();

            if (errGet) return log("Read Error: " + errGet.message);
            log("Current Stock: " + current.total_stok);

            const newVal = (current.total_stok || 0) + 1;
            log("Attempting update to: " + newVal);

            // 2. Update
            const { data: updated, error: errUpdate } = await client
                .from('master_stok')
                .update({ total_stok: newVal })
                .eq('id', 118)
                .select();

            if (errUpdate) {
                log("UPDATE FAILED: " + errUpdate.message);
                log("Likely Cause: RLS / Permissions");
            } else {
                log("UPDATE SUCCESS!");
                log("New Data: " + JSON.stringify(updated));
                // Revert
                await client.from('master_stok').update({ total_stok: current.total_stok }).eq('id', 118);
                log("Reverted changes.");
            }
        }
    </script>
</body>

</html>